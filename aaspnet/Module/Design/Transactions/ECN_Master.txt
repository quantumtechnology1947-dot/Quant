=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/ECN_Master.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="ECN_Master.aspx.cs" Inherits="Module_Design_Transactions_ECN_Master" Title="ERP"  Theme="Default" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

 <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />    
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

<table class="fontcss" cellpadding="0" cellspacing="0" width="60%">
              <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)" colspan="2">
        &nbsp;<b>ECN</b></td>
        </tr>
            <tr>
                <td colspan="4">
                     <asp:GridView ID="GridView1"  runat="server"
                    AutoGenerateColumns="False"  PageSize="15" Width="100%" DataKeyNames="Id" 
                    CssClass="yui-datatable-theme" onrowcommand="GridView1_RowCommand" ShowFooter="True"  >
                
                         <PagerSettings PageButtonCount="40" />
                
                <Columns>
                        <asp:TemplateField HeaderText="SN" SortExpression="Id">
                       <ItemTemplate>
                    <%# Container.DataItemIndex+1 %>
                </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="2%" />
                        </asp:TemplateField>
                                               
             
                                               
                       <asp:TemplateField >
                        <ItemTemplate>
                            <asp:CheckBox ID="CheckBox1" runat="server" AutoPostBack="true" 
                                OnCheckedChanged="CheckBox1_CheckedChanged" />
                        </ItemTemplate>
                       
                            <ItemStyle HorizontalAlign="Center" Width="2%" />
        </asp:TemplateField>
                                               
                        <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="false">
                        <ItemTemplate>
                        <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>'>    </asp:Label>                                  </ItemTemplate>
                          <ItemStyle HorizontalAlign="Center" />
                        </asp:TemplateField>
                        
                     
                                               
                         <asp:TemplateField HeaderText="Description" >
                        <ItemTemplate>
                        <asp:Label ID="lblDesc" runat="server" Text='<%#Eval("Types") %>'>    </asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="Left" Width="65%" />   
                             
                               <FooterTemplate>
                                
                              
                                     
                                     
                            </FooterTemplate> <FooterStyle HorizontalAlign="Right" />
                                                                      
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Remarks" >
                        
                        
                        <ItemTemplate>
                          <asp:TextBox ID="TxtRemarks" CssClass="box3"  Width="95%"  runat="server"></asp:TextBox>  
                       
                     
                         </ItemTemplate>   <ItemStyle Width="28%" />
                        <FooterTemplate>                                                       
                                     
                                       <asp:Button ID="BtnInsert" runat="server" Width="45px" ValidationGroup="A" OnClientClick="return confirmationAdd()" CommandName="Ins" CssClass="redbox" 
                                     Text="Insert"  />
                            </FooterTemplate> <FooterStyle HorizontalAlign="Right" />
                      
                        </asp:TemplateField>
                       
                        
                     
                                
                        
                        
                </Columns>
                
                <EmptyDataTemplate>
                                    <table width="100%" class="fontcss"><tr><td align="center" >
                                    <asp:Label ID="Label1" runat="server"  Text="No  data found to display" Font-Bold="true"
    Font-Names="Calibri" ForeColor="red"></asp:Label></td></tr>
    </table>
                                    </EmptyDataTemplate>
                                            <FooterStyle Wrap="True">
                                            </FooterStyle>
                    
                </asp:GridView></td>
               
            </tr>
            <tr>
             <td style="height:22px" align="center" colspan="4">
                <asp:Button ID="BtnCancel" runat="server" Width="50px" Text="Cancel" onclick="BtnCancel_Click" CssClass="redbox" /></td>
            </tr>
            </table>
   

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/ECN_Master.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_Design_Transactions_ECN_Master : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    SqlConnection con;
 
    int CompId = 0;
    int FinYearId = 0;
    string sid = "";
    string connStr = "";
    string WONo = "";
    int ItemId = 0;
    int childId = 0;
    double Qty = 0;
    int PId = 0;
    int AssblyNo = 0;
    protected void Page_Load(object sender, EventArgs e)
    {
        FinYearId = Convert.ToInt32(Session["finyear"]);
        CompId = Convert.ToInt32(Session["compid"]);
        sid = Session["username"].ToString();
        WONo = Request.QueryString["WONo"].ToString();
        ItemId=Convert.ToInt32(Request.QueryString["ItemId"]);
        AssblyNo = Convert.ToInt32(Request.QueryString["asslyNo"]);
        childId = Convert.ToInt32(Request.QueryString["CId"]);       
        PId = Convert.ToInt32(Request.QueryString["ParentId"]);
        Qty = Convert.ToDouble(Request.QueryString["Qty"]);
        if (!Page.IsPostBack)
        {
            this.loaddata();
        }

    }

    public void loaddata()
    {
        connStr = fun.Connection();
        con = new SqlConnection(connStr);
        string StrSql = fun.select("*", "tblDG_ECN_Reason", "CompId='"+CompId+"'");        
        SqlCommand cmdsupId = new SqlCommand(StrSql, con);
        SqlDataAdapter dasupId = new SqlDataAdapter(cmdsupId);
        DataSet DSSql = new DataSet();        
        dasupId.Fill(DSSql);
        GridView1.DataSource = DSSql;
        GridView1.DataBind();

    }


    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    { 
    
    }
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    { 
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);

     try
        {
            int u = 1;
            string CDate = fun.getCurrDate();
            string CTime = fun.getCurrTime();
            string MId = "";
            int y = 0;
            if (e.CommandName == "Ins")
            {
                foreach (GridViewRow grv in GridView1.Rows)
                {
                    if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                    {
                        con.Open();
                        string Id = ((Label)grv.FindControl("lblId")).Text;
                        string remarks=((TextBox)grv.FindControl("TxtRemarks")).Text;                        
                        if (u == 1)
                        {

                            int BOMMId = 0;
                            string strcmd = fun.insert("tblDG_BOMItem_Temp", "CompId,SessionId,WONo,ItemId,Qty,ChildId,ECNFlag", "'" + CompId + "','" + sid + "','" +WONo+ "','" + ItemId + "','" + Qty + "','" + childId + "','1'");
                            SqlCommand cmdgrid = new SqlCommand(strcmd, con);
                            cmdgrid.ExecuteNonQuery();
                            string getBomId = fun.select("Id", "tblDG_BOMItem_Temp", "CompId='" + CompId + "' Order by Id Desc");
                            SqlCommand cmdBOM = new SqlCommand(getBomId, con);
                            SqlDataAdapter daBOM = new SqlDataAdapter(cmdBOM);
                            DataSet DSBOM = new DataSet();
                            daBOM.Fill(DSBOM);
                            BOMMId = Convert.ToInt32(DSBOM.Tables[0].Rows[0]["Id"]);

                            string sqlecn = fun.insert("tblDG_ECN_Master_Temp", "MId,SysDate,SysTime,CompId,FinYearId,SessionId,ItemId,WONo,PId,CId", "'" + BOMMId + "','" + CDate + "','" + CTime + "','" + CompId + "','" + FinYearId + "','" + sid + "','" + ItemId + "','" + WONo + "','" + PId + "','" + childId + "'");
                            SqlCommand cmdECN = new SqlCommand(sqlecn, con);
                            cmdECN.ExecuteNonQuery();
                            u = 0;
                            string getId = fun.select("Id", "tblDG_ECN_Master_Temp", "CompId='" + CompId + "' Order by Id Desc");
                            SqlCommand cmd5 = new SqlCommand(getId, con);
                            SqlDataAdapter daAmd5 = new SqlDataAdapter(cmd5);
                            DataSet DSAmd5 = new DataSet();
                            daAmd5.Fill(DSAmd5); 
                            MId = DSAmd5.Tables[0].Rows[0]["Id"].ToString();
                         }

                        string sqlecn1 = fun.insert("tblDG_ECN_Details_Temp", "MId,ECNReason,Remarks", "'" + MId + "','" +Id+ "','" + remarks + "'");                   
                        SqlCommand cmdECN1 = new SqlCommand(sqlecn1, con);
                        cmdECN1.ExecuteNonQuery();
                        con.Close();
                        y++;                      
                    }
                }
                if (y > 0)
                {
                    Response.Redirect("BOM_WoItems.aspx?WONo=" + WONo + "&PId=" + PId + "&CId=" + childId + "&ItemId=" + AssblyNo + "&ModId=3&SubModId=26");
                }
                else
                {
                    this.loaddata();
                }
            }

        }
     catch (Exception ex)
        {
        }
    }
    protected void BtnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("BOM_WoItems.aspx?WONo=" + WONo + "&PId=" + PId + "&CId=" + childId + "&ItemId=" + AssblyNo + "&ModId=3&SubModId=26");
    }
}
