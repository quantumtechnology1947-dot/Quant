=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustPO_PrintFrame.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="CustPO_PrintFrame.aspx.cs" Inherits="Module_SalesDistribution_Transactions_CustPO_PrintFrame" Theme="Default" %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>ERP</title>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</head>
<body>
    <form id="form1" runat="server">
    <div>
     <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server" BestFitPage=True
        AutoDataBind="true" ReuseParameterValuesOnRefresh="True" ClientTarget=Auto />
    <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
    </CR:CrystalReportSource>
  
    </div>
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustPO_PrintFrame.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;
public partial class Module_SalesDistribution_Transactions_CustPO_PrintFrame : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    string connStr1 = "";
    SqlConnection myConnection;
    private ReportDocument report = new ReportDocument();
    string custId = "";
    string regdate = "";
    string PODate = "";
    string prdate = "";
    string PORecDate = "";
    string RegCity = "";
    string RegState = "";
    string RegCountry = "";
    string WorkCity = "";
    string WorkState = "";
    string WorkCountry = "";
    string DelCity = "";
    string DelState = "";
    string DelCountry = "";
    string regcity = "";
    string regstate = "";
    string regcountry = "";
    string workcity = "";
    string workstate = "";
    string workcountry = "";
    string delcity = "";
    string delstate = "";
    string delcountry = "";
    string strcustId = "";
    string strenqId = "";

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            connStr1 = fun.Connection();
            myConnection = new SqlConnection(connStr1);
            try
            {

                myConnection.Open();
                CompId = Convert.ToInt32(Session["compid"]);
                strcustId = Request.QueryString["PONo"].ToString();
                strenqId = Request.QueryString["EnqId"].ToString();

                // To pass values in crystal report from  SD_Cust_PO_Master
                string selectQuery = "SELECT *  FROM SD_Cust_PO_Master WHERE PONo='" + strcustId + "' And EnqId='" + strenqId + "' And CompId='" + CompId + "' ";
                SqlCommand myCommand = new SqlCommand(selectQuery, myConnection);
                SqlDataAdapter ad = new SqlDataAdapter(myCommand);

                DataSet ds = new DataSet();
                ad.Fill(ds, "SD_Cust_PO_Master");
                string reportPath = Server.MapPath("~/Module/SalesDistribution/Transactions/Reports/CustPO.rpt");
                report.Load(reportPath);
                report.SetDataSource(ds);
                //Registration Date 
                if (ds.Tables[0].Rows.Count > 0)
                {
                    custId = ds.Tables[0].Rows[0]["CustomerId"].ToString();
                    regdate = ds.Tables[0].Rows[0]["PODate"].ToString();
                    PODate = fun.FromDateDMY(regdate);
                    prdate = ds.Tables[0].Rows[0]["POReceivedDate"].ToString();
                    PORecDate = fun.FromDate(prdate);
                }
                // To get City,State and country from SD_Cust_Master

                string strCsc = "SELECT *  FROM SD_Cust_master WHERE EnqId='" + strenqId + "'And CompId='" + CompId + "' ";
                SqlCommand cmdcust = new SqlCommand(strCsc, myConnection);
                SqlDataAdapter adcust = new SqlDataAdapter(cmdcust);
                DataSet dscust = new DataSet();
                adcust.Fill(dscust, "SD_Cust_master");
                if (dscust.Tables[0].Rows.Count > 0)
                {
                    RegCity = dscust.Tables[0].Rows[0]["RegdCity"].ToString();
                    RegState = dscust.Tables[0].Rows[0]["RegdState"].ToString();
                    RegCountry = dscust.Tables[0].Rows[0]["RegdCountry"].ToString();
                    WorkCity = dscust.Tables[0].Rows[0]["WorkCity"].ToString();
                    WorkState = dscust.Tables[0].Rows[0]["WorkState"].ToString();
                    WorkCountry = dscust.Tables[0].Rows[0]["WorkCountry"].ToString();
                    DelCity = dscust.Tables[0].Rows[0]["MaterialDelCity"].ToString();
                    DelState = dscust.Tables[0].Rows[0]["MaterialDelState"].ToString();
                    DelCountry = dscust.Tables[0].Rows[0]["MaterialDelCountry"].ToString();
                }
                //Regd
                string selectregCt = "SELECT CityName FROM tblCity WHERE CityId='" + RegCity + "' ";
                SqlCommand myCmdct = new SqlCommand(selectregCt, myConnection);
                SqlDataAdapter adct = new SqlDataAdapter(myCmdct);
                DataSet Dsct = new DataSet();
                adct.Fill(Dsct);

                string selectregSt = "SELECT StateName FROM tblState WHERE SId='" + RegState + "' ";
                SqlCommand myCmdst = new SqlCommand(selectregSt, myConnection);
                SqlDataAdapter adst = new SqlDataAdapter(myCmdst);
                DataSet Dsst = new DataSet();
                adst.Fill(Dsst);

                string selectregCnt = "SELECT CountryName FROM tblCountry WHERE CId='" + RegCountry + "' ";
                SqlCommand myCmdcnt = new SqlCommand(selectregCnt, myConnection);
                SqlDataAdapter adcnt = new SqlDataAdapter(myCmdcnt);
                DataSet Dscnt = new DataSet();
                adcnt.Fill(Dscnt);
                if (Dsct.Tables[0].Rows.Count > 0)
                {
                    regcity = Dsct.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst.Tables[0].Rows.Count > 0)
                {
                    regstate = Dsst.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt.Tables[0].Rows.Count > 0)
                {
                    regcountry = Dscnt.Tables[0].Rows[0]["CountryName"].ToString();
                }
                //Work 

                string selectregCt1 = "SELECT CityName FROM tblCity WHERE CityId='" + WorkCity + "' ";
                SqlCommand myCmdct1 = new SqlCommand(selectregCt1, myConnection);
                SqlDataAdapter adct1 = new SqlDataAdapter(myCmdct1);
                DataSet Dsct1 = new DataSet();
                adct1.Fill(Dsct1);

                string selectregSt1 = "SELECT StateName FROM tblState WHERE SId='" + WorkState + "' ";
                SqlCommand myCmdst1 = new SqlCommand(selectregSt1, myConnection);
                SqlDataAdapter adst1 = new SqlDataAdapter(myCmdst1);
                DataSet Dsst1 = new DataSet();
                adst1.Fill(Dsst1);

                string selectregCnt1 = "SELECT CountryName FROM tblCountry WHERE CId='" + WorkCountry + "' ";
                SqlCommand myCmdcnt1 = new SqlCommand(selectregCnt1, myConnection);
                SqlDataAdapter adcnt1 = new SqlDataAdapter(myCmdcnt1);
                DataSet Dscnt1 = new DataSet();
                adcnt1.Fill(Dscnt1);
                if (Dsct1.Tables[0].Rows.Count > 0)
                {
                    workcity = Dsct1.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst1.Tables[0].Rows.Count > 0)
                {
                    workstate = Dsst1.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt1.Tables[0].Rows.Count > 0)
                {
                    workcountry = Dscnt1.Tables[0].Rows[0]["CountryName"].ToString();
                }
                // Del

                string selectregCt2 = "SELECT CityName FROM tblCity WHERE CityId='" + DelCity + "' ";
                SqlCommand myCmdct2 = new SqlCommand(selectregCt2, myConnection);
                SqlDataAdapter adct2 = new SqlDataAdapter(myCmdct2);
                DataSet Dsct2 = new DataSet();
                adct2.Fill(Dsct2);

                string selectregSt2 = "SELECT StateName FROM tblState WHERE SId='" + DelState + "' ";
                SqlCommand myCmdst2 = new SqlCommand(selectregSt2, myConnection);
                SqlDataAdapter adst2 = new SqlDataAdapter(myCmdst2);
                DataSet Dsst2 = new DataSet();
                adst2.Fill(Dsst2);

                string selectregCnt2 = "SELECT CountryName FROM tblCountry WHERE CId='" + DelCountry + "' ";
                SqlCommand myCmdcnt2 = new SqlCommand(selectregCnt2, myConnection);
                SqlDataAdapter adcnt2 = new SqlDataAdapter(myCmdcnt2);
                DataSet Dscnt2 = new DataSet();
                adcnt1.Fill(Dscnt2);
                if (Dsct2.Tables[0].Rows.Count > 0)
                {
                    delcity = Dsct2.Tables[0].Rows[0]["CityName"].ToString();
                }

                if (Dsst2.Tables[0].Rows.Count > 0)
                {
                    delstate = Dsst2.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt2.Tables[0].Rows.Count > 0)
                {
                    delcountry = Dscnt2.Tables[0].Rows[0]["CountryName"].ToString();
                }
                report.SetParameterValue("RegCity", regcity);
                report.SetParameterValue("RegState", regstate);
                report.SetParameterValue("RegCountry", regcountry);

                report.SetParameterValue("WrkCity", workcity);
                report.SetParameterValue("WrkState", workstate);
                report.SetParameterValue("WrkCountry", workcountry);

                report.SetParameterValue("DelCity", delcity);
                report.SetParameterValue("DelState", delstate);
                report.SetParameterValue("DelCountry", delcountry);

                report.SetParameterValue("PODate", PODate);
                report.SetParameterValue("PORecDate", PORecDate);

                //// To Show Company Name on Crystal Report           
                string Company = fun.getCompany(CompId);
                report.SetParameterValue("Company", Company);
                CrystalReportViewer1.ReportSource = report;
                Session["ReportDocument"] = report;

            }
            catch (Exception ex)
            {

            }
            finally
            {
                myConnection.Close();
            }


           
        }

        else
        {
            ReportDocument doc = (ReportDocument)Session["ReportDocument"];
            CrystalReportViewer1.ReportSource = doc;
        }
    }



    protected void Page_Load(object sender, EventArgs e)
    {
        

    }
}
