=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialPlanning/Transactions/Planning_Delete.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Planning_Delete.aspx.cs" Inherits="Module_MaterialPlanning_Transactions_Planning_Delete" Title="ERP"  Theme ="Default" %>
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
 <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

 <table width="100%" align="center" cellpadding="0" cellspacing="0" Class="fontcss">
        <tr>
            <td>
                <table width="100%" align="center" cellpadding="0" cellspacing="0">
                    <tr >                   
                        <td height="21px" style="background:url(../../../images/hdbg.JPG)"  class="fontcsswhite" >&nbsp;<strong>Material Planning - Delete</strong>
                       
                        </td>
                    </tr>   
              </table>
                
                <table width="100%" align="center" cellpadding="0" cellspacing="0" class="box3">
                    <tr>
        <td align="left" height="25" >
        
          
            <asp:DropDownList ID="DrpField" runat="server" 
                 AutoPostBack="True" 
                CssClass="box3" onselectedindexchanged="DrpField_SelectedIndexChanged">
               <%-- <asp:ListItem Value="Select">Select</asp:ListItem>--%>
                <asp:ListItem Value="1">WO No</asp:ListItem>
                <asp:ListItem Value="0">Customer Name</asp:ListItem>              
               <asp:ListItem Value="2">PO No</asp:ListItem>
               <asp:ListItem Value="3">Enq Id</asp:ListItem>
            </asp:DropDownList>
         
            <asp:TextBox ID="Txtsearch" runat="server" Width="150px" CssClass="box3"></asp:TextBox>
              <asp:TextBox ID="txtCustName" runat="server"   Visible="false" Width="350px"></asp:TextBox>
            
              <cc1:AutoCompleteExtender ID="txtCustName_AutoCompleteExtender" runat="server" 
                                DelimiterCharacters="" Enabled="True" ServiceMethod="GetCompletionList" 
                                ServicePath="" TargetControlID="txtCustName" UseContextKey="True"
                                 CompletionInterval="100" CompletionSetCount="2" FirstRowSelected="True" MinimumPrefixLength="1" ShowOnlyCurrentWordInCompletionListItem="True" CompletionListItemCssClass="bg" CompletionListHighlightedItemCssClass="bgtext" CompletionListCssClass="almt">
                            </cc1:AutoCompleteExtender>
           
           
        
              &nbsp;<asp:Button ID="Button1" runat="server" CssClass="redbox" 
                onclick="Button1_Click" Text="Search" />
            
        
        
              &nbsp;<asp:Label ID="lblmsg" runat="server" 
                style="color: #CC0000; font-weight: 700"></asp:Label>
            
        
        
              </td>
        </tr>

             <tr>
            <td>                     
  
                     <asp:GridView ID="GridView1"  runat="server" PageSize="17" 
                    AllowPaging="True"  CssClass="yui-datatable-theme"
                    AllowSorting="True" AutoGenerateColumns="False"
                    DataKeyNames="WONo" RowStyle-HorizontalAlign ="Center"
     
                     Width="100%" onpageindexchanging="GridView1_PageIndexChanging" >
           
<RowStyle HorizontalAlign="Center"></RowStyle>
           
            <Columns>
            <asp:TemplateField HeaderText="SN">
                                    <ItemTemplate><%#Container.DataItemIndex+1  %></ItemTemplate>
                                    <HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" />
                                    </asp:TemplateField>
 <asp:BoundField DataField="FinYear" HeaderText="Fin Yrs">
                                        <ItemStyle Width="8%" HorizontalAlign="Center" />
                                    </asp:BoundField>
                                    <asp:BoundField DataField="CustomerName" 
                    HeaderText="Customer Name" >
                                        <ItemStyle HorizontalAlign="Left" Width="25%" />
                </asp:BoundField>
                                  <asp:BoundField DataField="CustomerId" HeaderText="Code" >
                                      <ItemStyle HorizontalAlign="Center" />
                </asp:BoundField>
                                  <asp:BoundField DataField="EnqId" HeaderText="Enquiry No" >
                                      <ItemStyle HorizontalAlign="Center" Width="8%" />
                </asp:BoundField>
                                  <asp:BoundField DataField="PONo" HeaderText="PO No" >
                                      <ItemStyle HorizontalAlign="Left" />
                </asp:BoundField>
                                  <asp:HyperLinkField DataNavigateUrlFields="WONo" 
                    HeaderText="WO No" 
                    DataNavigateUrlFormatString="~/Module/MaterialPlanning/Transactions/Planning_Delete_Plan.aspx?WONo={0}&amp;ModId=4&amp;SubModId=33" 
                    DataTextField="WONo" >
                                      <ItemStyle HorizontalAlign="Center" />
                </asp:HyperLinkField>
                                  <asp:BoundField DataField="SysDate" HeaderText="Gen. Date" >
                                      <ItemStyle HorizontalAlign="Center" />
                </asp:BoundField>
                                  <asp:BoundField DataField="EmployeeName" HeaderText="Gen. By" >
                            
                                      <ItemStyle HorizontalAlign="Left" Width="32%" />
                </asp:BoundField>
                            
            </Columns>
            <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>
           
            
           
      </asp:GridView>
                    </td>
             </tr>
              </table>
            </td>
        </tr>
        
        </table>

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialPlanning/Transactions/Planning_Delete.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_MaterialPlanning_Transactions_Planning_Delete : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int FinYearId = 0;
    int CompId = 0;
    string No = "";
    string Cuid = "";
    string SId = "";
    string str = "";
    SqlConnection con;
    protected void Page_Load(object sender, EventArgs e)
    {
       try
        {
            FinYearId = Convert.ToInt32(Session["finyear"]);
            CompId = Convert.ToInt32(Session["compid"]);
            SId = Session["username"].ToString();
            str = fun.Connection();
            con = new SqlConnection(str);

            if (!IsPostBack)
            {
                
                txtCustName.Visible = false;
                this.BindData(No, Cuid);
            }

            if (!String.IsNullOrEmpty(Request.QueryString["msg"]))
            {
                string plNo = Request.QueryString["msg"].ToString();
                string mystring1 = string.Empty;
                mystring1 = "Plan No:" + plNo + " has been generated";
                lblmsg.Text = mystring1;

            }

            else
            {
                lblmsg.Text = "";
            }

        }

        catch (Exception ex) { }

    }

    protected void DrpField_SelectedIndexChanged(object sender, EventArgs e)
    {
        if (DrpField.SelectedValue == "0")
        {
            Txtsearch.Visible = false;
            txtCustName.Visible = true;
            txtCustName.Text = "";
            this.BindData(No, Cuid);
        }
        else
        {
            Txtsearch.Visible = true;
            Txtsearch.Text = "";
            txtCustName.Visible = false;
            this.BindData(No, Cuid);
        }
    }


    public void BindData(string no, string CuId)
    {
       try
        {

            con.Open();
            string x = "";
            if (DrpField.SelectedValue == "1")
            {
                if (Txtsearch.Text != "")
                {
                    x = " AND WONo='" + Txtsearch.Text + "'";
                }
            }
            if (DrpField.SelectedValue == "2")
            {
                if (Txtsearch.Text != "")
                {
                    x = " AND PONo='" + Txtsearch.Text + "'";
                }
            }
            if (DrpField.SelectedValue == "3")
            {
                if (Txtsearch.Text != "")
                {
                    x = " AND EnqId='" + Txtsearch.Text + "'";
                }
            }
            if (DrpField.SelectedValue == "Select")
            {
                Txtsearch.Visible = true;
                //Txtsearch.Enabled = false;
                txtCustName.Visible = false;
            }
            //else if(DrpField.SelectedValue != "Select")
            //{
            //    Txtsearch.Enabled = true;
            //}


            string y = "";
            if (DrpField.SelectedValue == "0")
            {
                if (txtCustName.Text != "")
                {
                    y = " AND CustomerId='" + fun.getCode(txtCustName.Text) + "'";
                }
            }

            string sql = fun.select("Id,CustomerId,SessionId,EnqId,WONo,PONo,FinYearId,SysDate", "SD_Cust_WorkOrder_Master", "CompId='" + CompId + "' and FinYearId<='" + FinYearId + "'" + x + y + "Order By Id Desc");
            SqlCommand cmd = new SqlCommand(sql, con);
            SqlDataAdapter da = new SqlDataAdapter(cmd);
            DataSet DS = new DataSet();
            da.Fill(DS);

            DataTable dt = new DataTable();
            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("FinYear", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("CustomerName", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("CustomerId", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("EnqId", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("PONo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("SysDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("EmployeeName", typeof(string)));

            DataRow dr;
            for (int i = 0; i < DS.Tables[0].Rows.Count; i++)
            {
                dr = dt.NewRow();
                if (DS.Tables[0].Rows.Count > 0)
                {
                    string sqlcust = fun.select("CustomerName", "SD_Cust_master", "CustomerId='" + DS.Tables[0].Rows[i]["CustomerId"].ToString() + "' AND CompId='" + CompId + "'");
                    SqlCommand cmdcust = new SqlCommand(sqlcust, con);
                    SqlDataAdapter dacust = new SqlDataAdapter(cmdcust);
                    DataSet DScust = new DataSet();
                    dacust.Fill(DScust);


                    string sql2 = fun.select("Title+'. '+EmployeeName As EmployeeName", "tblHR_OfficeStaff", "CompId='" + CompId + "'AND EmpId='" + DS.Tables[0].Rows[i]["SessionId"].ToString() + "'");
                    SqlCommand cmd2 = new SqlCommand(sql2, con);
                    SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                    DataSet DS2 = new DataSet();
                    da2.Fill(DS2);

                    string sqlFin = fun.select("FinYear", "tblFinancial_master", "FinYearId='" + DS.Tables[0].Rows[i]["FinYearId"] + "' AND CompId='" + CompId + "'");
                    SqlCommand cmdFinYr = new SqlCommand(sqlFin, con);
                    SqlDataAdapter daFin = new SqlDataAdapter(cmdFinYr);
                    DataSet DSFin = new DataSet();
                    daFin.Fill(DSFin);
                    string SysDt = fun.FromDateDMY(DS.Tables[0].Rows[i]["SysDate"].ToString());

                    dr[0] = DS.Tables[0].Rows[i]["Id"].ToString();
                    if (DSFin.Tables[0].Rows.Count > 0)
                    {
                        dr[1] = DSFin.Tables[0].Rows[0]["FinYear"].ToString();
                    }
                    if (DScust.Tables[0].Rows.Count > 0)
                    {
                        dr[2] = DScust.Tables[0].Rows[0]["CustomerName"].ToString();
                    }
                    dr[3] = DS.Tables[0].Rows[i]["CustomerId"].ToString();
                    dr[4] = DS.Tables[0].Rows[i]["EnqId"].ToString();
                    dr[5] = DS.Tables[0].Rows[i]["PONo"].ToString();
                    dr[6] = DS.Tables[0].Rows[i]["WONo"].ToString();
                    dr[7] = SysDt;
                    if (DS2.Tables[0].Rows.Count > 0)
                    {
                        dr[8] = DS2.Tables[0].Rows[0]["EmployeeName"].ToString();
                    }
                    string StrSql = fun.select("Id,WONo", "tblDG_BOM_Master", "WONo='" + DS.Tables[0].Rows[i]["WONO"].ToString() + "' And CompId='" + CompId + "' And FinYearId<='" + FinYearId + "'");
                    SqlCommand CMD = new SqlCommand(StrSql, con);
                    SqlDataAdapter DDA = new SqlDataAdapter(CMD);
                    DataSet DS3 = new DataSet();
                    DDA.Fill(DS3);
                    if (DS3.Tables[0].Rows.Count > 0)
                    {
                        string sql4 = fun.select("Id", "tblMP_Material_Master", "CompId='" + CompId + "' and FinYearId<='" + FinYearId + "' And WONo='" + DS3.Tables[0].Rows[0]["WONo"].ToString() + "'");
                        SqlCommand cmd4 = new SqlCommand(sql4, con);
                        SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
                        DataSet DS4 = new DataSet();
                        da4.Fill(DS4);
                        if (DS4.Tables[0].Rows.Count > 0)
                        {
                            dt.Rows.Add(dr);
                            dt.AcceptChanges();
                        }
                    }
                }
            }
            GridView1.DataSource = dt;
            GridView1.DataBind();
        }

        catch (Exception ex) { }
    }


    [System.Web.Services.WebMethodAttribute(), System.Web.Script.Services.ScriptMethodAttribute()]
    public static string[] GetCompletionList(string prefixText, int count, string contextKey)
    {
        clsFunctions fun = new clsFunctions();
        string connStr = fun.Connection();
        DataSet ds = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        int CompId = Convert.ToInt32(HttpContext.Current.Session["compid"]);
        con.Open();
        string cmdStr = fun.select("CustomerId,CustomerName", "SD_Cust_master", "CompId='" + CompId + "'");
        SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
        da.Fill(ds, "SD_Cust_master");
        con.Close();
        string[] main = new string[0];
        for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        {
            if (ds.Tables[0].Rows[i].ItemArray[1].ToString().ToLower().StartsWith(prefixText.ToLower()))
            {
                Array.Resize(ref main, main.Length + 1);
                main[main.Length - 1] = ds.Tables[0].Rows[i].ItemArray[1].ToString() + " [" + ds.Tables[0].Rows[i].ItemArray[0].ToString() + "]";
                //if (main.Length == 10)
                //    break;
            }
        }
        Array.Sort(main);
        return main;
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        try
        {
            string custid = fun.getCode(txtCustName.Text);
            this.BindData(Txtsearch.Text, custid);
        }
        catch (Exception ex) { }
    }
    protected void GridView1_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {

        GridView1.PageIndex = e.NewPageIndex;
        this.BindData(No, Cuid);
    }
      
}
