=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Reports/Search_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Search_Details.aspx.cs" Inherits="Module_Inventory_Reports_Search_Details" Title="ERP" Theme="Default"  %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
<link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />

    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>   
  

    <style type="text/css">
        .style2
        {
            width: 100%;
        }
        
   </style>
  
  

</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
<script  type="text/javascript">

    var GridId = "<%=GridView1.ClientID %>";
    var ScrollHeight = 300;
    window.onload = function () {
        var grid = document.getElementById(GridId);
        var gridWidth = grid.offsetWidth;
        var gridHeight = grid.offsetHeight;
        var headerCellWidths = new Array();
        for (var i = 0; i < grid.getElementsByTagName("TH").length; i++) {
            headerCellWidths[i] = grid.getElementsByTagName("TH")[i].offsetWidth;
                    }
        grid.parentNode.appendChild(document.createElement("div"));
        var parentDiv = grid.parentNode; 
        var table = document.createElement("table");
        for (i = 0; i < grid.attributes.length; i++) {
            if (grid.attributes[i].specified && grid.attributes[i].name != "id") {
                table.setAttribute(grid.attributes[i].name, grid.attributes[i].value);
            }
        }
        table.style.cssText = grid.style.cssText;
        table.style.width = gridWidth + "px";
        table.appendChild(document.createElement("tbody"));
        table.getElementsByTagName("tbody")[0].appendChild(grid.getElementsByTagName("TR")[0]);
        var cells = table.getElementsByTagName("TH");
 
        var gridRow = grid.getElementsByTagName("TR")[0];
        for (var i = 0; i < cells.length; i++) {
            var width;
            if (headerCellWidths[i] > gridRow.getElementsByTagName("TD")[i].offsetWidth) {
                width = headerCellWidths[i];
            }
            else {
                width = gridRow.getElementsByTagName("TD")[i].offsetWidth;
            }
            cells[i].style.width = parseInt(width - 3) + "px";
            gridRow.getElementsByTagName("TD")[i].style.width = parseInt(width - 3) + "px";
        }
        parentDiv.removeChild(grid); 
        var dummyHeader = document.createElement("div");
        dummyHeader.appendChild(table);
        parentDiv.appendChild(dummyHeader);
        var scrollableDiv = document.createElement("div");
        if(parseInt(gridHeight) > ScrollHeight){
             gridWidth = parseInt(gridWidth) + 17;
        }
        scrollableDiv.style.cssText = "overflow:auto;height:" + ScrollHeight + "px;width:" + gridWidth + "px";
        scrollableDiv.appendChild(grid);
        parentDiv.appendChild(scrollableDiv);
    }


</script>
<div > 
 <div >
     <strong>&nbsp; Select column to show in the GridView:</strong>&nbsp;<b>&nbsp;Check All:</b> <asp:CheckBox ID="checkAll" runat="server" 
         AutoPostBack="True" oncheckedchanged="checkAll_CheckedChanged" />   
     
     <table class="style2">
         <tr>
             <td valign="top">
                 <asp:Panel ID="Panel2" BorderWidth="1"  BorderStyle="Solid"  runat="server"> 
                 <table width="100%"><tr><td align="center">
                     <asp:Label ID="lblGIN" runat="server" style="font-weight: 700" ></asp:Label></td></tr></table>
                 <asp:CheckBoxList ID="chkFields" runat="server" DataTextField="Column_name" 
                             DataValueField="Column_name" RepeatColumns="12" RepeatDirection="Horizontal" 
                             RepeatLayout="Table" />
                 </asp:Panel>    
                
              
              </td>
             
             
             
         </tr>
     </table>
        
     <asp:Button ID="btnSub" CssClass="redbox" runat="server" Text="Show" OnClick="ShowGrid" />  
     &nbsp;<asp:Button ID="btnExport" runat="server" CssClass="redbox" 
         onclick="btnExport_Click" Text="Export To Excel" />
&nbsp;<asp:Button ID="btnCancel" runat="server" CssClass="redbox" Text="Cancel" onclick="btnCancel_Click" />
<br />
 </div> 
 <asp:Panel ID="Panel1" ScrollBars="Auto" Height="370px"   runat="server">   
      <asp:GridView ID="GridView1" runat="server"   EnableViewState="false" AutoGenerateColumns="false" />   
 </asp:Panel>
</div>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Reports/Search_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using System.IO;

public partial class Module_Inventory_Reports_Search_Details : System.Web.UI.Page
{   
    clsFunctions fun = new clsFunctions();
    string _connStr = ConfigurationManager.ConnectionStrings["LocalSqlServer"].ConnectionString;
    int flag = 0; 
    string FirstCond = string.Empty;
    string Supcode = string.Empty;
    string Itemcode = string.Empty;   
    string ACHead = string.Empty;
    int CompId = 0;
    string WONo = string.Empty;
    string FromDate = string.Empty;
    string ToDate = string.Empty;
    string StrDate = string.Empty;   
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            CompId = Convert.ToInt32(Session["compid"]);           

            if (!string.IsNullOrEmpty(Request.QueryString["RAd"]))
            {
                flag = Convert.ToInt32(Request.QueryString["RAd"]);
            }
            if (!string.IsNullOrEmpty(Request.QueryString["type"]) && !string.IsNullOrEmpty(Request.QueryString["No"]))
            { 
                switch (Convert.ToInt32(Request.QueryString["type"]))
                {
                   
                    case 1:
                        FirstCond = " And GINNo='" + Request.QueryString["No"].ToString() + "'";
                        break;
                    case 2:
                        FirstCond = " And GRRNo='" + Request.QueryString["No"].ToString() + "'";
                        break;
                    case 3:
                        FirstCond = " And GQNNo='" + Request.QueryString["No"].ToString() + "'";
                        break;
                    case 4:
                        FirstCond = " And GSNNo='" + Request.QueryString["No"].ToString() + "'";
                        break;
                    case 5:
                        FirstCond = " And PONo='" + Request.QueryString["No"].ToString() + "'";
                        break; 
                }
            }
                      

            if (!string.IsNullOrEmpty(Request.QueryString["FDate"]) && !string.IsNullOrEmpty(Request.QueryString["TDate"]))
            {
                FromDate = fun.FromDate(Request.QueryString["FDate"]);
                ToDate = fun.FromDate(Request.QueryString["TDate"]);

                if (flag == 0)
                {
                    StrDate = " And Date between '" + FromDate + "' And '" + ToDate + "'";
                }
                if (flag == 1)
                {
                    StrDate = " And GINDate between '" + FromDate + "' And '" + ToDate + "'";
                }
                if (flag == 2)
                {
                    StrDate = " And GRRDate between '" + FromDate + "' And '" + ToDate + "'";
                }
                                
                if (flag == 3)
                {
                    StrDate = " And GQNDate between '" + FromDate + "' And '" + ToDate + "'";
                }
                if (flag == 4)
                {
                    StrDate = " And GSNDate between '" + FromDate + "' And '" + ToDate + "'";
                }
            }


            if (!string.IsNullOrEmpty(Request.QueryString["SupId"]))
            {
                Supcode = " And Code='" + Request.QueryString["SupId"].ToString() + "'";
            }

            if (!string.IsNullOrEmpty(Request.QueryString["Code"]))
            {
                Itemcode = " And ItemCode='" + Request.QueryString["Code"].ToString() + "'";
            }
            if (!string.IsNullOrEmpty(Request.QueryString["WONo"]))
            {
                WONo = " And WONo='" + Request.QueryString["WONo"].ToString() + "'";
            }

            if (!string.IsNullOrEmpty(Request.QueryString["accval"]))
            {
                if (Convert.ToInt32(Request.QueryString["accval"]) != 0)
                {
                    string AHSymb = string.Empty;
                    using (SqlConnection conn = new SqlConnection(_connStr))
                    {
                        string sql2 = fun.select("Symbol", "AccHead", "Id='" + Request.QueryString["accval"] + "'");

                        SqlCommand cmd1 = new SqlCommand(sql2, conn);
                        SqlDataAdapter DA = new SqlDataAdapter(cmd1);
                        DataSet DS = new DataSet();
                        DA.Fill(DS);
                        if (DS.Tables[0].Rows.Count > 0)
                        {
                            AHSymb = DS.Tables[0].Rows[0][0].ToString();
                        }
                    }
                    ACHead = " And ACHead='" + AHSymb + "'";
                }
            }


            if (!IsPostBack)
            {
                BindTableColumns(); 
                chkFields.Items[0].Selected = true;
                chkFields.Items[1].Selected = true;
                chkFields.Items[2].Selected = true;
                chkFields.Items[3].Selected = true;
                chkFields.Items[4].Selected = true;
            }
            if (flag != 4)
            {
                chkFields.Items[40].Attributes.Add("style", "display:none;");
                chkFields.Items[41].Attributes.Add("style", "display:none;");
                chkFields.Items[42].Attributes.Add("style", "display:none;");
            }
            else
            {
                chkFields.Items[36].Attributes.Add("style", "display:none;");
                chkFields.Items[37].Attributes.Add("style", "display:none;");
            }

        }

      catch(Exception ex )
        {
            
        }
    }
    protected void ShowGrid(object sender, EventArgs e)
    {
    try
        {
            int count = 0;            
            foreach (ListItem item in chkFields.Items)
            {
                if (item.Selected)
                {
                    BoundField b = new BoundField();
                    b.DataField = item.Value;
                    b.HeaderText = item.Text;                                            
                    GridView1.Columns.Add(b);
                    count++;
                }
            }                
            
            if (count > 0)
            {
                
                this.GetData(); 
                
            }
        }
      catch(Exception ex)
        {
        }
    }
    private void BindTableColumns()
    {
       // try
        {
            DataTable table = new DataTable();            
            using (SqlConnection conn = new SqlConnection(_connStr))
            {

                if (flag != 4)
                {
                    using (SqlCommand cmd = new SqlCommand("sp_columns", conn))
                    {
                        cmd.CommandType = CommandType.StoredProcedure;

                        cmd.Parameters.AddWithValue("@table_name", "View_PO_PR_SPR_GIN");

                        using (SqlDataAdapter ad = new SqlDataAdapter(cmd))
                        {
                            ad.Fill(table);
                        }
                    }
                    if (table.Rows.Count > 0)
                    {
                        chkFields.DataSource = table;
                        chkFields.DataBind();
                    }
                    chkFields.Items[0].Text = "Sr No";
                    chkFields.Items[1].Text = "Item Code";
                    chkFields.Items[4].Text = "Stock Qty";
                    chkFields.Items[5].Text = "PR No";
                    chkFields.Items[6].Text = "PR Date";
                    chkFields.Items[7].Text = "PR Qty";
                    chkFields.Items[8].Text = "SPR No";
                    chkFields.Items[9].Text = "SPR Date";
                    chkFields.Items[10].Text = "SPR Qty";
                    chkFields.Items[11].Text = "PO NO";
                    chkFields.Items[12].Text = "PO Date";
                    chkFields.Items[13].Text = "WO No";
                    chkFields.Items[14].Text = "PO Qty";
                    chkFields.Items[17].Text = "Supplier Name";
                    chkFields.Items[18].Text = "Del. Date";
                    chkFields.Items[20].Text = "Authorized By";
                    chkFields.Items[21].Text = "Authorized Date";
                    chkFields.Items[22].Text = "Authorized Time";
                    chkFields.Items[23].Text = "GIN No";
                    chkFields.Items[24].Text = "GIN. Date";
                    chkFields.Items[25].Text = "Challan No";
                    chkFields.Items[26].Text = "Challan Date";
                    chkFields.Items[27].Text = "Gate Entery No";
                    chkFields.Items[28].Text = "Mode of Transport";
                    chkFields.Items[29].Text = "Vehicle No";
                    chkFields.Items[30].Text = "Challan Qty";
                    chkFields.Items[31].Text = "GIN Qty";
                    chkFields.Items[32].Text = "GRR No";
                    chkFields.Items[33].Text = "GRR Date";
                    chkFields.Items[34].Text = "GRR Qty";
                    chkFields.Items[35].Text = "GQN No";
                    chkFields.Items[36].Text = "GQN Date";
                    chkFields.Items[37].Text = "Accepted Qty";
                    chkFields.Items[38].Text = "Rejected Qty";
                    chkFields.Items[39].Text = "Ac Head";


                }
                else
                {

                    using (SqlCommand cmd = new SqlCommand("sp_columns", conn))
                    {
                        cmd.CommandType = CommandType.StoredProcedure;

                        cmd.Parameters.AddWithValue("@table_name", "View_PO_PR_SPR_GSN");

                        using (SqlDataAdapter ad = new SqlDataAdapter(cmd))
                        {
                            ad.Fill(table);
                        }
                    }
                    if (table.Rows.Count > 0)
                    {
                        chkFields.DataSource = table;
                        chkFields.DataBind();
                    }
                    chkFields.Items[0].Text = "Sr No";
                    chkFields.Items[1].Text = "Item Code";
                    chkFields.Items[4].Text = "Stock Qty";
                    chkFields.Items[5].Text = "PR No";
                    chkFields.Items[6].Text = "PR Date";
                    chkFields.Items[7].Text = "PR Qty";
                    chkFields.Items[8].Text = "SPR No";
                    chkFields.Items[9].Text = "SPR Date";
                    chkFields.Items[10].Text = "SPR Qty";
                    chkFields.Items[11].Text = "PO NO";
                    chkFields.Items[12].Text = "PO Date";
                    chkFields.Items[13].Text = "WO No";
                    chkFields.Items[14].Text = "PO Qty";
                    chkFields.Items[17].Text = "Supplier Name";
                    chkFields.Items[18].Text = "Del. Date";
                    chkFields.Items[20].Text = "Authorized By";
                    chkFields.Items[21].Text = "Authorized Date";
                    chkFields.Items[22].Text = "Authorized Time";
                    chkFields.Items[23].Text = "GIN No";
                    chkFields.Items[24].Text = "GIN. Date";
                    chkFields.Items[25].Text = "Challan No";
                    chkFields.Items[26].Text = "Challan Date";
                    chkFields.Items[27].Text = "Gate Entery No";
                    chkFields.Items[28].Text = "Mode of Transport";
                    chkFields.Items[29].Text = "Vehicle No";
                    chkFields.Items[30].Text = "Challan Qty";
                    chkFields.Items[31].Text = "GIN Qty";
                    chkFields.Items[32].Text = "Ac Head";
                    chkFields.Items[33].Text = "GSN No";
                    chkFields.Items[34].Text = "GSN Date";
                    chkFields.Items[35].Text = "GSN Qty";                    

                } 
            }
        }
        //catch(Exception ex)
        {
        }

    }
    private void GetData()
    {
       try
        {
            DataTable table = new DataTable();
            using (SqlConnection conn = new SqlConnection(_connStr))
            {
                string sql = ""; 
                string Strpar = string.Empty;
                int count = 0;
                if (flag != 4)
                {  
                    for (int i = 23; i < chkFields.Items.Count; i++)
                    {
                        if (chkFields.Items[i].Selected == true)
                        {
                            count++;
                        }
                    }

                    if (chkFields.Items[0].Selected == true)
                    {
                        Strpar = "ROW_NUMBER() OVER (ORDER BY ItemCode) AS SrNo";
                    }
                    if (chkFields.Items[1].Selected == true)
                    {
                        Strpar += ",ItemCode";
                    }
                    if (chkFields.Items[2].Selected == true)
                    {
                        Strpar += ",Description";
                    }
                    if (chkFields.Items[3].Selected == true)
                    {
                        Strpar += ",UOM";
                    }
                    if (chkFields.Items[4].Selected == true)
                    {
                        Strpar += ",StockQty";
                    }
                    if (chkFields.Items[5].Selected == true)
                    {
                        Strpar += ",PRNo";
                    }
                    if (chkFields.Items[6].Selected == true)
                    {                        
                        Strpar += ",PRDate";
                    }

                    if (chkFields.Items[7].Selected == true)
                    {
                        Strpar += ",PRQty";
                    }

                    if (chkFields.Items[8].Selected == true)
                    {
                        Strpar += ",SPRNo";
                    }
                    if (chkFields.Items[9].Selected == true)
                    {
                       Strpar += ",SPRDate";
                    }

                    if (chkFields.Items[10].Selected == true)
                    {
                        Strpar += ",SPRQty";
                    }

                    if (chkFields.Items[11].Selected == true)
                    {
                        Strpar += ",PONo";
                    }

                    if (chkFields.Items[12].Selected == true)
                    {                        
                        Strpar += ",REPLACE(CONVERT(varchar,CONVERT(datetime, SUBSTRING(Date, CHARINDEX('-', Date) + 1, 2) + '-' + LEFT(Date, CHARINDEX('-', Date) - 1) + '-' + RIGHT(Date, CHARINDEX('-',REVERSE(Date)) - 1)), 103), '/', '-') AS Date";
                    }

                    if (chkFields.Items[13].Selected == true)
                    {
                        Strpar += ",WONo";
                    }

                    if (chkFields.Items[14].Selected == true)
                    {
                        Strpar += ",Qty";
                    }
                    if (chkFields.Items[15].Selected == true)
                    {
                        Strpar += ",Rate";
                    }
                    if (chkFields.Items[16].Selected == true)
                    {
                        Strpar += ",Discount";
                    }
                    if (chkFields.Items[17].Selected == true)
                    {
                        Strpar += ",SupplierName";
                    }

                    if (chkFields.Items[18].Selected == true)
                    {
                        Strpar += ",DelDate";
                    }

                    if (chkFields.Items[19].Selected == true)
                    {
                        Strpar += ",Authorized";
                    }
                    if (chkFields.Items[20].Selected == true)
                    {
                        Strpar += ",AuthorizedBy";
                    }
                    if (chkFields.Items[21].Selected == true)
                    {
                       Strpar += ",AuthorizeDate";
                    }
                    if (chkFields.Items[22].Selected == true)
                    {
                        Strpar += ",AuthorizeTime";
                    }

                    if (chkFields.Items[23].Selected == true)
                    {
                        Strpar += ",GINNo";
                    }

                    if (chkFields.Items[24].Selected == true)
                    {
                        Strpar += ",(CASE WHEN dbo.View_PO_PR_SPR_GIN.GINDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(View_PO_PR_SPR_GIN.GINDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GINDate)+ 1, 2) + '-' + LEFT(View_PO_PR_SPR_GIN.GINDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GINDate) - 1)+ '-' + RIGHT(View_PO_PR_SPR_GIN.GINDate, CHARINDEX('-', REVERSE(View_PO_PR_SPR_GIN.GINDate)) - 1)), 103), '/', '-')) END) AS GINDate";                       
                    }
                    if (chkFields.Items[25].Selected == true)
                    {
                        Strpar += ",ChallanNo";
                    }
                    if (chkFields.Items[26].Selected == true)
                    {
                        Strpar += ",(CASE WHEN dbo.View_PO_PR_SPR_GIN.ChallanDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(View_PO_PR_SPR_GIN.ChallanDate, CHARINDEX('-', View_PO_PR_SPR_GIN.ChallanDate)+ 1, 2) + '-' + LEFT(View_PO_PR_SPR_GIN.ChallanDate, CHARINDEX('-', View_PO_PR_SPR_GIN.ChallanDate) - 1)+ '-' + RIGHT(View_PO_PR_SPR_GIN.ChallanDate, CHARINDEX('-', REVERSE(View_PO_PR_SPR_GIN.ChallanDate)) - 1)), 103), '/', '-')) END) AS ChallanDate";
                       
                    }
                    if (chkFields.Items[27].Selected == true)
                    {
                        Strpar += ",GateEntryNo";
                    }

                    if (chkFields.Items[28].Selected == true)
                    {
                        Strpar += ",ModeofTransport";
                    }
                    if (chkFields.Items[29].Selected == true)
                    {
                        Strpar += ",VehicleNo";
                    }
                    if (chkFields.Items[30].Selected == true)
                    {
                        Strpar += ",ChallanQty";
                    }
                    if (chkFields.Items[31].Selected == true)
                    {
                        Strpar += ",GINQty";
                    }
                    if (chkFields.Items[32].Selected == true)
                    {
                        Strpar += ",GRRNo";
                    }

                    if (chkFields.Items[33].Selected == true)
                    {
                        Strpar += ",(CASE WHEN dbo.View_PO_PR_SPR_GIN.GRRDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(View_PO_PR_SPR_GIN.GRRDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GRRDate)+ 1, 2) + '-' + LEFT(View_PO_PR_SPR_GIN.GRRDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GRRDate) - 1)+ '-' + RIGHT(View_PO_PR_SPR_GIN.GRRDate, CHARINDEX('-', REVERSE(View_PO_PR_SPR_GIN.GRRDate)) - 1)), 103), '/', '-')) END) AS GRRDate";                        
                    }
                    if (chkFields.Items[34].Selected == true)
                    {
                        Strpar += ",GRRQty";
                    }

                    if (chkFields.Items[35].Selected == true)
                    {
                        Strpar += ",GQNNo";
                    }
                    if (chkFields.Items[36].Selected == true)
                    {
                        Strpar += ",(CASE WHEN dbo.View_PO_PR_SPR_GIN.GQNDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(View_PO_PR_SPR_GIN.GQNDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GQNDate)+ 1, 2) + '-' + LEFT(View_PO_PR_SPR_GIN.GQNDate, CHARINDEX('-', View_PO_PR_SPR_GIN.GQNDate) - 1)+ '-' + RIGHT(View_PO_PR_SPR_GIN.GQNDate, CHARINDEX('-', REVERSE(View_PO_PR_SPR_GIN.GQNDate)) - 1)), 103), '/', '-')) END) AS GQNDate";
                    }
                    if (chkFields.Items[37].Selected == true)
                    {
                        Strpar += ",AcceptedQty";
                    }
                    if (chkFields.Items[38].Selected == true)
                    {
                        Strpar += ",RejectedQty";
                    }
                    if (chkFields.Items[39].Selected == true)
                    {

                        Strpar += ",ACHead";
                    }

                    if (!string.IsNullOrEmpty(Request.QueryString["type"]) && !string.IsNullOrEmpty(Request.QueryString["No"]) && Request.QueryString["type"] == "5" && count == 0 && flag >= 0 && StrDate == "")
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_Item where CompId='" + CompId + "'" + FirstCond + "" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + "";

                    }
                    else if (!string.IsNullOrEmpty(Request.QueryString["type"]) && !string.IsNullOrEmpty(Request.QueryString["No"]) && Request.QueryString["type"] != "5" && Request.QueryString["type"] != "0" && count == 0 && flag >= 0 && StrDate == "")
                    {                       
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_GIN where CompId='" + CompId + "'" + FirstCond + "" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + " ";
                    }                    
                    else if (count == 0 && flag >= 0 && StrDate == "")
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_Item where CompId='" + CompId + "'" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + "";

                    }
                    else
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_GIN where CompId='" + CompId + "'" + FirstCond + "" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + "";
                    }

                }
                else
                {

                    for (int i = 23; i < chkFields.Items.Count; i++)
                    {
                        if (chkFields.Items[i].Selected == true)
                        {
                            count++;
                        }
                    }

                    if (chkFields.Items[0].Selected == true)
                    {
                        Strpar = "ROW_NUMBER() OVER (ORDER BY ItemCode) AS SrNo";
                    }
                    if (chkFields.Items[1].Selected == true)
                    {
                        Strpar += ",ItemCode";
                    }
                    if (chkFields.Items[2].Selected == true)
                    {
                        Strpar += ",Description";
                    }
                    if (chkFields.Items[3].Selected == true)
                    {
                        Strpar += ",UOM";
                    }
                    if (chkFields.Items[4].Selected == true)
                    {
                        Strpar += ",StockQty";
                    }
                    if (chkFields.Items[5].Selected == true)
                    {
                        Strpar += ",PRNo";
                    }
                    if (chkFields.Items[6].Selected == true)
                    {
                       
                        Strpar += ",PRDate";
                    }

                    if (chkFields.Items[7].Selected == true)
                    {
                        Strpar += ",PRQty";
                    }

                    if (chkFields.Items[8].Selected == true)
                    {
                        Strpar += ",SPRNo";
                    }
                    if (chkFields.Items[9].Selected == true)
                    {
                        Strpar += ",SPRDate";
                    }

                    if (chkFields.Items[10].Selected == true)
                    {
                        Strpar += ",SPRQty";
                    }

                    if (chkFields.Items[11].Selected == true)
                    {
                        Strpar += ",PONo";
                    }

                    if (chkFields.Items[12].Selected == true)
                    {                       
                        Strpar += ",REPLACE(CONVERT(varchar,CONVERT(datetime, SUBSTRING(Date, CHARINDEX('-', Date) + 1, 2) + '-' + LEFT(Date, CHARINDEX('-', Date) - 1) + '-' + RIGHT(Date, CHARINDEX('-',REVERSE(Date)) - 1)), 103), '/', '-') AS Date";
                    }

                    if (chkFields.Items[13].Selected == true)
                    {
                        Strpar += ",WONo";
                    }

                    if (chkFields.Items[14].Selected == true)
                    {
                        Strpar += ",Qty";
                    }
                    if (chkFields.Items[15].Selected == true)
                    {
                        Strpar += ",Rate";
                    }
                    if (chkFields.Items[16].Selected == true)
                    {
                        Strpar += ",Discount";
                    }
                    if (chkFields.Items[17].Selected == true)
                    {
                        Strpar += ",SupplierName";
                    }

                    if (chkFields.Items[18].Selected == true)
                    {
                       
                        Strpar += ",DelDate";
                    }

                    if (chkFields.Items[19].Selected == true)
                    {
                        Strpar += ",Authorized";
                    }
                    if (chkFields.Items[20].Selected == true)
                    {
                        Strpar += ",AuthorizedBy";
                    }
                    if (chkFields.Items[21].Selected == true)
                    {                        
                        Strpar += ",AuthorizeDate";
                    }
                    if (chkFields.Items[22].Selected == true)
                    {
                        Strpar += ",AuthorizeTime";
                    }

                    if (chkFields.Items[23].Selected == true)
                    {
                        Strpar += ",GINNo";
                    }

                    if (chkFields.Items[24].Selected == true)
                    {
                        Strpar += ",(CASE WHEN GINDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(GINDate, CHARINDEX('-',GINDate)+ 1, 2) + '-' + LEFT(GINDate, CHARINDEX('-',GINDate) - 1)+ '-' + RIGHT(GINDate, CHARINDEX('-', REVERSE(GINDate)) - 1)), 103), '/', '-')) END) AS GINDate";
                    }
                    if (chkFields.Items[25].Selected == true)
                    {
                        Strpar += ",ChallanNo";
                    }
                    if (chkFields.Items[26].Selected == true)
                    {
                        Strpar += ",(CASE WHEN ChallanDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(ChallanDate, CHARINDEX('-',ChallanDate)+ 1, 2) + '-' + LEFT(ChallanDate, CHARINDEX('-',ChallanDate) - 1)+ '-' + RIGHT(ChallanDate, CHARINDEX('-', REVERSE(ChallanDate)) - 1)), 103), '/', '-')) END) AS ChallanDate";
                    }
                    if (chkFields.Items[27].Selected == true)
                    {
                        Strpar += ",GateEntryNo";
                    }

                    if (chkFields.Items[28].Selected == true)
                    {
                        Strpar += ",ModeofTransport";
                    }
                    if (chkFields.Items[29].Selected == true)
                    {
                        Strpar += ",VehicleNo";
                    }
                    if (chkFields.Items[30].Selected == true)
                    {
                        Strpar += ",ChallanQty";
                    }
                    if (chkFields.Items[31].Selected == true)
                    {
                        Strpar += ",GINQty";
                    }
                    if (chkFields.Items[32].Selected == true)
                    {
                        Strpar += ",ACHead";
                    }
                   
                    if(count!=0)
                    {
                    if (chkFields.Items[33].Selected == true)
                    {
                        Strpar += ",GSNNo";
                    }

                    if (chkFields.Items[34].Selected == true)
                    {
                        Strpar += ",(CASE WHEN GSNDate IS NULL THEN '' ELSE(REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(GSNDate, CHARINDEX('-',GSNDate)+ 1, 2) + '-' + LEFT(GSNDate, CHARINDEX('-',GSNDate) - 1)+ '-' + RIGHT(GSNDate, CHARINDEX('-', REVERSE(GSNDate)) - 1)), 103), '/', '-')) END) AS GSNDate";
                    }
                    if (chkFields.Items[35].Selected == true)
                    {
                        Strpar += ",GSNQty";
                    } 
                    }
                    if (!string.IsNullOrEmpty(Request.QueryString["type"]) && !string.IsNullOrEmpty(Request.QueryString["No"]) && Request.QueryString["type"] == "4" &&  count == 0 && flag == 4 && StrDate == "")
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_GSN where CompId='" + CompId + "'" + FirstCond + "" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + " ";
                    }
                    else if (count == 0 && flag == 4 && StrDate == "")
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_Item where CompId='" + CompId + "'" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + "";
                    }
                    else
                    {
                        sql = "SELECT " + Strpar + " FROM View_PO_PR_SPR_GSN where CompId='" + CompId + "'" + FirstCond + "" + Supcode + "" + ACHead + "" + WONo + "" + Itemcode + "" + StrDate + "";
                    }

                }                
                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    using (SqlDataAdapter ad = new SqlDataAdapter(cmd))
                    {
                        ad.Fill(table);
                    }
                }
            }
            if (table.Rows.Count > 0)
            {
                GridView1.DataSource = table;
                GridView1.DataBind();               
                ViewState["dtList"] = table;
            }
            else
            {
                string mystring = string.Empty;
                mystring = "No Records to Dispaly.";
                ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);
            }
        }
        catch(Exception xe)
        {
        }

    }
    protected void checkAll_CheckedChanged(object sender, EventArgs e)
    {
        try
        {
            
                if (checkAll.Checked == true)
                {
                    foreach (ListItem li in chkFields.Items)
                    {
                        if (li.Value != "CompId" && li.Value != "AHId" && li.Value != "Code")
                        {
                            li.Selected = true;
                        }
                    }

                }
                else
                {
                    foreach (ListItem li in chkFields.Items)
                    {
                        if (li.Value != "SrNo" && li.Value != "ItemCode" && li.Value != "Description" && li.Value != "UOM" && li.Value != "StockQty")
                        {
                            li.Selected = false;
                        }
                        
                    }                    
                }
            
            
        }
        catch(Exception ex)
        {
        }
    }
    protected void btnExport_Click(object sender, EventArgs e)
    {
       
        try
        {
            DataTable dt1 = (DataTable)ViewState["dtList"];
            if (dt1 == null)
            {
                throw new Exception("No Records to Export");
            }
            else
            {
                if (flag != 4)
                {

                    if (chkFields.Items[0].Selected == true)
                    {
                        dt1.Columns["SrNo"].ColumnName = "Sr No";
                    }
                    if (chkFields.Items[1].Selected == true)
                    {
                        dt1.Columns["ItemCode"].ColumnName = "Item Code";
                    }
                    if (chkFields.Items[4].Selected == true)
                    {
                        dt1.Columns["StockQty"].ColumnName = "Stock Qty";
                    }
                    if (chkFields.Items[5].Selected == true)
                    {
                        dt1.Columns["PRNo"].ColumnName = "PR No";
                    }

                    if (chkFields.Items[6].Selected == true)
                    {
                        dt1.Columns["PRDate"].ColumnName = "PR Date";
                    }
                    if (chkFields.Items[7].Selected == true)
                    {
                        dt1.Columns["PRQty"].ColumnName = "PR Qty";
                    }
                    if (chkFields.Items[8].Selected == true)
                    {
                        dt1.Columns["SPRNo"].ColumnName = "SPR No";
                    }

                    if (chkFields.Items[9].Selected == true)
                    {
                        dt1.Columns["SPRDate"].ColumnName = "SPR Date";
                    }
                    if (chkFields.Items[10].Selected == true)
                    {
                        dt1.Columns["SPRQty"].ColumnName = "SPR Qty";
                    }
                    if (chkFields.Items[11].Selected == true)
                    {
                        dt1.Columns["PONO"].ColumnName = "PO NO";
                    }
                    if (chkFields.Items[12].Selected == true)
                    {
                        dt1.Columns["Date"].ColumnName = "PO Date";
                    }

                    if (chkFields.Items[13].Selected == true)
                    {
                        dt1.Columns["WONo"].ColumnName = "WO No";
                    }
                    if (chkFields.Items[14].Selected == true)
                    {
                        dt1.Columns["Qty"].ColumnName = "PO Qty";
                    }
                    if (chkFields.Items[17].Selected == true)
                    {
                        dt1.Columns["SupplierName"].ColumnName = "Supplier Name";
                    }

                    if (chkFields.Items[18].Selected == true)
                    {
                        dt1.Columns["DelDate"].ColumnName = "Del. Date";
                    }
                    if (chkFields.Items[20].Selected == true)
                    {
                        dt1.Columns["AuthorizedBy"].ColumnName = "Authorized By";
                    }
                    if (chkFields.Items[21].Selected == true)
                    {
                        dt1.Columns["AuthorizeDate"].ColumnName = "Authorized Date";
                    }

                    if (chkFields.Items[22].Selected == true)
                    {
                        dt1.Columns["AuthorizeTime"].ColumnName = "Authorized Time";
                    }
                    if (chkFields.Items[23].Selected == true)
                    {
                        dt1.Columns["GINNo"].ColumnName = "GIN No";
                    }
                    if (chkFields.Items[24].Selected == true)
                    {
                        dt1.Columns["GINDate"].ColumnName = "GIN. Date";
                    }

                    if (chkFields.Items[25].Selected == true)
                    {
                        dt1.Columns["ChallanNo"].ColumnName = "Challan No";
                    }
                    if (chkFields.Items[26].Selected == true)
                    {
                        dt1.Columns["ChallanDate"].ColumnName = "Challan Date";
                    }
                    if (chkFields.Items[27].Selected == true)
                    {
                        dt1.Columns["GateEntryNo"].ColumnName = "Gate Entry No";
                    }


                    if (chkFields.Items[28].Selected == true)
                    {
                        dt1.Columns["ModeofTransport"].ColumnName = "Mode of Transport";
                    }

                    if (chkFields.Items[29].Selected == true)
                    {
                        dt1.Columns["VehicleNo"].ColumnName = "Vehicle No";
                    }

                    if (chkFields.Items[30].Selected == true)
                    {
                        dt1.Columns["ChallanQty"].ColumnName = "Challan Qty";
                    }


                    if (chkFields.Items[31].Selected == true)
                    {
                        dt1.Columns["GINQty"].ColumnName = "GIN Qty";
                    }

                    if (chkFields.Items[32].Selected == true)
                    {
                        dt1.Columns["GRRNo"].ColumnName = "GRR No";
                    }
                    if (chkFields.Items[33].Selected == true)
                    {
                        dt1.Columns["GRRDate"].ColumnName = "GRR Date";
                    }

                    if (chkFields.Items[34].Selected == true)
                    {
                        dt1.Columns["GRRQty"].ColumnName = "GRR Qty";
                    }

                    if (chkFields.Items[35].Selected == true)
                    {
                        dt1.Columns["GQNNo"].ColumnName = "GQN No";
                    }
                    if (chkFields.Items[36].Selected == true)
                    {
                        dt1.Columns["GQNDate"].ColumnName = "GQN Date";
                    }

                    if (chkFields.Items[37].Selected == true)
                    {
                        dt1.Columns["AcceptedQty"].ColumnName = "Accepted Qty";
                    }

                    if (chkFields.Items[38].Selected == true)
                    {
                        dt1.Columns["RejectedQty"].ColumnName = "Rejected Qty";
                    }
                    if (chkFields.Items[39].Selected == true)
                    {
                        dt1.Columns["AcHead"].ColumnName = "Ac Head";
                    }
                }
                else
                {

                    if (chkFields.Items[0].Selected == true)
                    {
                        dt1.Columns["SrNo"].ColumnName = "Sr No";
                    }
                    if (chkFields.Items[1].Selected == true)
                    {
                        dt1.Columns["ItemCode"].ColumnName = "Item Code";
                    }
                    if (chkFields.Items[4].Selected == true)
                    {
                        dt1.Columns["StockQty"].ColumnName = "Stock Qty";
                    }
                    if (chkFields.Items[5].Selected == true)
                    {
                        dt1.Columns["PRNo"].ColumnName = "PR No";
                    }

                    if (chkFields.Items[6].Selected == true)
                    {
                        dt1.Columns["PRDate"].ColumnName = "PR Date";
                    }
                    if (chkFields.Items[7].Selected == true)
                    {
                        dt1.Columns["PRQty"].ColumnName = "PR Qty";
                    }
                    if (chkFields.Items[8].Selected == true)
                    {
                        dt1.Columns["SPRNo"].ColumnName = "SPR No";
                    }

                    if (chkFields.Items[9].Selected == true)
                    {
                        dt1.Columns["SPRDate"].ColumnName = "SPR Date";
                    }
                    if (chkFields.Items[10].Selected == true)
                    {
                        dt1.Columns["SPRQty"].ColumnName = "SPR Qty";
                    }
                    if (chkFields.Items[11].Selected == true)
                    {
                        dt1.Columns["PONO"].ColumnName = "PO NO";
                    }
                    if (chkFields.Items[12].Selected == true)
                    {
                        dt1.Columns["Date"].ColumnName = "PO Date";
                    }

                    if (chkFields.Items[13].Selected == true)
                    {
                        dt1.Columns["WONo"].ColumnName = "WO No";
                    }
                    if (chkFields.Items[14].Selected == true)
                    {
                        dt1.Columns["Qty"].ColumnName = "PO Qty";
                    }
                    if (chkFields.Items[17].Selected == true)
                    {
                        dt1.Columns["SupplierName"].ColumnName = "Supplier Name";
                    }

                    if (chkFields.Items[18].Selected == true)
                    {
                        dt1.Columns["DelDate"].ColumnName = "Del. Date";
                    }
                    if (chkFields.Items[20].Selected == true)
                    {
                        dt1.Columns["AuthorizedBy"].ColumnName = "Authorized By";
                    }
                    if (chkFields.Items[21].Selected == true)
                    {
                        dt1.Columns["AuthorizeDate"].ColumnName = "Authorized Date";
                    }

                    if (chkFields.Items[22].Selected == true)
                    {
                        dt1.Columns["AuthorizeTime"].ColumnName = "Authorized Time";
                    }
                    if (chkFields.Items[23].Selected == true)
                    {
                        dt1.Columns["GINNo"].ColumnName = "GIN No";
                    }
                    if (chkFields.Items[24].Selected == true)
                    {
                        dt1.Columns["GINDate"].ColumnName = "GIN. Date";
                    }

                    if (chkFields.Items[25].Selected == true)
                    {
                        dt1.Columns["ChallanNo"].ColumnName = "Challan No";
                    }
                    if (chkFields.Items[26].Selected == true)
                    {
                        dt1.Columns["ChallanDate"].ColumnName = "Challan Date";
                    }
                    if (chkFields.Items[27].Selected == true)
                    {
                        dt1.Columns["GateEntryNo"].ColumnName = "Gate Entry No";
                    }


                    if (chkFields.Items[28].Selected == true)
                    {
                        dt1.Columns["ModeofTransport"].ColumnName = "Mode of Transport";
                    }

                    if (chkFields.Items[29].Selected == true)
                    {
                        dt1.Columns["VehicleNo"].ColumnName = "Vehicle No";
                    }

                    if (chkFields.Items[30].Selected == true)
                    {
                        dt1.Columns["ChallanQty"].ColumnName = "Challan Qty";
                    }


                    if (chkFields.Items[31].Selected == true)
                    {
                        dt1.Columns["GINQty"].ColumnName = "GIN Qty";
                    }

                    if (chkFields.Items[32].Selected == true)
                    {
                        dt1.Columns["AcHead"].ColumnName = "Ac Head";
                    }
                    if (chkFields.Items[33].Selected == true)
                    {
                        dt1.Columns["GSNNo"].ColumnName = "GSN No";
                    }

                    if (chkFields.Items[34].Selected == true)
                    {
                        dt1.Columns["GSNDate"].ColumnName = "GSN Date";
                    }

                    if (chkFields.Items[35].Selected == true)
                    {
                        dt1.Columns["GSNQty"].ColumnName = "GSN Qty";
                    }

                }

                string Path = "D:\\ImportExcelFromDatabase\\myexcelfile_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Month.ToString() + ".xls";
                FileInfo FI = new FileInfo(Path);
                StringWriter stringWriter = new StringWriter();
                HtmlTextWriter htmlWrite = new HtmlTextWriter(stringWriter);
                System.Web.UI.WebControls.DataGrid DataGrd = new System.Web.UI.WebControls.DataGrid();
                DataGrd.DataSource = dt1;
                DataGrd.DataBind();
                DataGrd.RenderControl(htmlWrite);
                string directory = Path.Substring(0, Path.LastIndexOf("\\"));// GetDirectory(Path);
                if (!Directory.Exists(directory))
                {
                    Directory.CreateDirectory(directory);
                }
                System.IO.StreamWriter vw = new System.IO.StreamWriter(Path, true);
                stringWriter.ToString().Normalize();
                vw.Write(stringWriter.ToString());
                vw.Flush();
                vw.Close();
                WriteAttachment(FI.Name, "application/vnd.ms-excel", stringWriter.ToString());
            }

            
        }
        catch (Exception ex)
        {
            string mystring = string.Empty;
            mystring = "No Records to Export.";
            ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);           
        }        
        

    }
    public static void WriteAttachment(string FileName, string FileType, string content)
    {
        try
        {
            HttpResponse Response = System.Web.HttpContext.Current.Response;
            Response.ClearHeaders();
            Response.AppendHeader("Content-Disposition", "attachment; filename=" + FileName);
            Response.ContentType = FileType;
            Response.Write(content);
            Response.End();
        }
        catch(Exception ex)
        {
        }
    }
    protected void btnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Inventory/Reports/Search.aspx");
    }
}







