=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Transactions/Salary_Edit_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Salary_Edit_Details.aspx.cs" Inherits="Module_HR_Transactions_Salary_Edit_Details" Title="ERP" Theme ="Default"  %>
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .style2
        {
            width: 100%;
        }
    </style> 
     <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
    <table class="style2" cellpadding="0" cellspacing="0">
       <tr>
            <td align="left" valign="middle"  
                style="background:url(../../../images/hdbg.JPG)" height="21" 
                class="fontcsswhite">&nbsp;&nbsp; <b>
                Salary Edit</b></td>
        </tr>
        <tr>
            <td align="left">
                <asp:GridView ID="GridView2" runat="server" 
                    AutoGenerateColumns="False" DataKeyNames="Id" 
                     CssClass="yui-datatable-theme" Width="100%" 
                     PageSize="20" 
                    onpageindexchanging="GridView2_PageIndexChanging" 
                    onrowcommand="GridView2_RowCommand" >
                    <PagerSettings PageButtonCount="40" />
                    <Columns>
                        <asp:TemplateField ShowHeader="False">
                            <ItemTemplate>
                                <asp:LinkButton ID="LinkButton1" runat="server" CausesValidation="False" 
                                    CommandName="Sel" Text="Select"></asp:LinkButton>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="2%" />
                        </asp:TemplateField>
                      <asp:TemplateField HeaderText="SN">
                                    <ItemTemplate>
                                    <%# Container.DataItemIndex+1 %>
                                    </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Right" Width="2%" />                                      
                                    </asp:TemplateField>
                                    
                                 <asp:TemplateField HeaderText="Id" Visible="false"  >
                            <ItemTemplate>
                                <asp:Label ID="lblId" runat="server" Text='<%# Bind("Id") %>'></asp:Label>
                            </ItemTemplate>
                           
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>  
                        
                        <asp:TemplateField HeaderText="MId" Visible="false"  >
                            <ItemTemplate>
                                <asp:Label ID="lblMId" runat="server" Text='<%# Bind("MId") %>'></asp:Label>
                            </ItemTemplate>
                           
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField> 
                        
                        
                         <asp:TemplateField HeaderText="Mon" Visible="false"  >
                            <ItemTemplate>
                                <asp:Label ID="lblMon" runat="server" Text='<%# Bind("Mon") %>'></asp:Label>
                            </ItemTemplate>
                           
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>        
                                    
                        <asp:TemplateField HeaderText="Month">
                        <ItemTemplate>
                            <asp:Label ID="lblMonth" runat="server" Text='<%#Eval("Month")%>'></asp:Label>
                        </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="5%" />
                        </asp:TemplateField>
                       
                        <asp:TemplateField HeaderText="DOM">
                        <ItemTemplate>
                            <asp:Label ID="lblDaysOfMonth" runat="server" Text='<%#Eval("DaysOfMonth")%>'></asp:Label>
                        </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="3%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField  HeaderText="HD">
                            <ItemTemplate>
                                <asp:Label ID="lblHolidays" runat="server" Text='<%# Bind("Holidays") %>'></asp:Label>
                            </ItemTemplate>                           
                             <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Sun.">
                            <ItemTemplate>
                                <asp:Label ID="lblMonthSunday" runat="server" Text='<%# Bind("MonthSunday") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="WO Days">
                         <ItemTemplate>
                                <asp:Label ID="lblWorkingDays" runat="server" Text='<%# Bind("WorkingDays") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="5%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="P">
                        <ItemTemplate>
                                <asp:Label ID="lblPresent" runat="server" Text='<%# Bind("Present") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>
                         
                        <asp:TemplateField HeaderText="A">
                        <ItemTemplate>
                                <asp:Label ID="lblAbsent" runat="server" Text='<%# Bind("Absent") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="L">
                        <ItemTemplate>
                                <asp:Label ID="lblLateIn" runat="server" Text='<%# Bind("LateIn") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="H">
                         <ItemTemplate>
                                <asp:Label ID="lblHalfDay" runat="server" Text='<%# Bind("HalfDay") %>'></asp:Label>
                            </ItemTemplate>
                           <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="WO Sun">
                         <ItemTemplate>
                                <asp:Label ID="lblSunday" runat="server" Text='<%# Bind("Sunday") %>'></asp:Label>
                            </ItemTemplate>
                           <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                             
                        <asp:TemplateField HeaderText="Coff">
                         <ItemTemplate>
                                <asp:Label ID="lblCoff" runat="server" Text='<%# Bind("Coff") %>'></asp:Label>
                            </ItemTemplate>
                           <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="PL">
                         <ItemTemplate>
                                <asp:Label ID="lblPL" runat="server" Text='<%# Bind("PL") %>'></asp:Label>
                            </ItemTemplate>
                           <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="OT Hrs">
                         <ItemTemplate>
                                <asp:Label ID="lblOverTimeHrs" runat="server" Text='<%# Bind("OverTimeHrs") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="OT Rate">
                         <ItemTemplate>
                                <asp:Label ID="lblOverTimeRate" runat="server" Text='<%# Bind("OverTimeRate") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="Bank Loan">
                         <ItemTemplate>
                                <asp:Label ID="lblBankLoan" runat="server" Text='<%# Bind("BankLoan") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="8%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="Inst.">
                         <ItemTemplate>
                                <asp:Label ID="lblInstallment" runat="server" Text='<%# Bind("Installment") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="Mob Amt">
                         <ItemTemplate>
                                <asp:Label ID="lblMobileExeAmt" runat="server" Text='<%# Bind("MobileExeAmt") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="Add">
                         <ItemTemplate>
                                <asp:Label ID="lblAddition" runat="server" Text='<%# Bind("Addition") %>'></asp:Label>
                            </ItemTemplate>
                             <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                                                
                        <asp:TemplateField HeaderText="Deduct">
                         <ItemTemplate>
                                <asp:Label ID="lblDeduction" runat="server" Text='<%# Bind("Deduction") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                    
                        
                    </Columns>
                    
                       <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>                      
                             
                </asp:GridView>
             
                
            </td>
        </tr>
        
                <tr>
        <td align="center" height="30" valign="middle">
            <asp:Button ID="btnCancel" runat="server" Text="Cancel" CssClass="redbox" 
                onclick="btnCancel_Click"  />
        </td>
        </tr>
        </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Transactions/Salary_Edit_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using System.Globalization;

public partial class Module_HR_Transactions_Salary_Edit_Details : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    int FinYearId = 0;
    string EmpId = "";

    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            EmpId = Request.QueryString["EmpId"].ToString();
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
           
            if (!IsPostBack)
            {
                this.binddata();
            }
        }
        catch (Exception ex) { }
    }

    public void binddata()
    {
       try
        {
            string connStr = fun.Connection();
            SqlConnection con = new SqlConnection(connStr);
            con.Open();

            DataTable dt = new DataTable();
            DataRow dr;

            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("Month", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("DaysOfMonth", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Holidays", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("MonthSunday", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WorkingDays", typeof(string)));

            dt.Columns.Add(new System.Data.DataColumn("Present", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Absent", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("LateIn", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("HalfDay", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Sunday", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Coff", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("PL", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("OverTimeHrs", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("OverTimeRate", typeof(string)));

            dt.Columns.Add(new System.Data.DataColumn("BankLoan", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Installment", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("MobileExeAmt", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Addition", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Deduction", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("MId", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("Mon", typeof(int)));

            string StrLeave = fun.select("tblHR_Salary_Master.EmpId,tblHR_Salary_Details.Id,tblHR_Salary_Details.MId,tblHR_Salary_Details.Present,tblHR_Salary_Details.Absent,tblHR_Salary_Details.LateIn,tblHR_Salary_Details.HalfDay,tblHR_Salary_Details.Sunday,tblHR_Salary_Details.Coff,tblHR_Salary_Details.PL,tblHR_Salary_Details.OverTimeHrs,tblHR_Salary_Details.OverTimeRate,tblHR_Salary_Details.Installment,tblHR_Salary_Details.MobileExeAmt,tblHR_Salary_Details.Addition,tblHR_Salary_Details.Deduction,tblHR_Salary_Master.FMonth", "tblHR_Salary_Details,tblHR_Salary_Master", "tblHR_Salary_Details.MId=tblHR_Salary_Master.Id AND tblHR_Salary_Master.CompId='" + CompId + "' AND tblHR_Salary_Master.FinYearId='" + FinYearId + "' AND tblHR_Salary_Master.EmpId='" + EmpId + "'");

            SqlCommand cmdLeave = new SqlCommand(StrLeave, con);
            SqlDataAdapter DALeave = new SqlDataAdapter(cmdLeave);
            DataSet DSLeave = new DataSet();
            DALeave.Fill(DSLeave);

            for (int i = 0; i < DSLeave.Tables[0].Rows.Count; i++)
            {

                string StrOfferM = fun.select("tblHR_Offer_Master.salary,tblHR_Offer_Master.DutyHrs,tblHR_Offer_Master.OTHrs", "tblHR_Offer_Master,tblHR_OfficeStaff", "tblHR_Offer_Master.OfferId=tblHR_OfficeStaff.OfferId AND tblHR_OfficeStaff.EmpId='" + DSLeave.Tables[0].Rows[i]["EmpId"].ToString() + "'");
                SqlCommand cmdOfferM = new SqlCommand(StrOfferM, con);
                SqlDataReader dsOfferM = cmdOfferM.ExecuteReader();
                //DataSet dsOfferM = new DataSet();
                //daOfferM.Fill(dsOfferM, "tblHR_Offer_Master");
                dsOfferM.Read();

                int g = Convert.ToInt32(DSLeave.Tables[0].Rows[i]["FMonth"]);
                int g1 = fun.SalYrs(FinYearId, g, CompId);

                dr = dt.NewRow();

                dr[0] = DSLeave.Tables[0].Rows[i]["Id"].ToString();

                dr[1] = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(Convert.ToInt32(DSLeave.Tables[0].Rows[i]["FMonth"]));
                dr[2] = DateTime.DaysInMonth(g1, g);
                dr[3] = fun.GetHoliday(g, CompId, FinYearId).ToString();
                dr[4] = fun.CountSundays(g1, g);
                dr[5] = fun.WorkingDays(FinYearId, g).ToString();
                dr[6] = DSLeave.Tables[0].Rows[i]["Present"].ToString();
                dr[7] = DSLeave.Tables[0].Rows[i]["Absent"].ToString();
                dr[8] = DSLeave.Tables[0].Rows[i]["LateIn"].ToString();
                dr[9] = DSLeave.Tables[0].Rows[i]["HalfDay"].ToString();
                dr[10] = DSLeave.Tables[0].Rows[i]["Sunday"].ToString();
                dr[11] = DSLeave.Tables[0].Rows[i]["Coff"].ToString();
                dr[12] = DSLeave.Tables[0].Rows[i]["PL"].ToString();
                dr[13] = DSLeave.Tables[0].Rows[i]["OverTimeHrs"].ToString();

                //double OTRate = 0;

                //// over Time
                //if (Convert.ToDouble(DSLeave.Tables[0].Rows[i]["OverTimeHrs"])>0)
                //{
                //    string SqlOTHrs = fun.select("Hours", "tblHR_OTHour", "Id='" + dsOfferM["OTHrs"].ToString() + "'");
                //    SqlCommand cmdOTHrs = new SqlCommand(SqlOTHrs, con);
                //    SqlDataReader dsOTHrs = cmdOTHrs.ExecuteReader();
                //    dsOTHrs.Read();

                //    string SqlDutyHrs = fun.select("Hours", "tblHR_DutyHour", "Id='" + dsOfferM["DutyHrs"].ToString() + "'");
                //    SqlCommand cmdDutyHrs = new SqlCommand(SqlDutyHrs, con);
                //    SqlDataReader dsDutyHrs = cmdDutyHrs.ExecuteReader();
                //    dsDutyHrs.Read();

                //    OTRate = Math.Round(fun.OTRate(Convert.ToDouble(dsOfferM["salary"]), Convert.ToDouble(dsOTHrs["Hours"]), Convert.ToDouble(dsDutyHrs["Hours"]), DateTime.DaysInMonth(g1, g)),2);
                  
                //    //OTAmt = fun.OTAmt(OTRate, Convert.ToDouble(DSLeave.Tables[0].Rows[0]["OverTimeHrs"]));
                //}

                dr[14] = DSLeave.Tables[0].Rows[i]["OverTimeRate"].ToString(); 

                double LoanAmt = 0;
                string StrBankLoan = fun.select("Sum(Amount) as LoanAmt", "tblHR_BankLoan", "CompId='" + CompId + "' And FinYearId<='" + FinYearId + "' And EmpId='" + EmpId + "'");
                SqlCommand cmdBankLoan = new SqlCommand(StrBankLoan, con);
                SqlDataAdapter daBankLoan = new SqlDataAdapter(cmdBankLoan);
                DataSet dsBankLoan = new DataSet();
                daBankLoan.Fill(dsBankLoan);

                if (dsBankLoan.Tables[0].Rows.Count > 0 && (dsBankLoan.Tables[0].Rows[0]["LoanAmt"]) != DBNull.Value)
                {
                    LoanAmt = Convert.ToDouble(dsBankLoan.Tables[0].Rows[0]["LoanAmt"]);

                }
                dr[15] = LoanAmt;
                dr[16] = DSLeave.Tables[0].Rows[i]["Installment"].ToString();
                dr[17] = DSLeave.Tables[0].Rows[i]["MobileExeAmt"].ToString();
                dr[18] = DSLeave.Tables[0].Rows[i]["Addition"].ToString();
                dr[19] = DSLeave.Tables[0].Rows[i]["Deduction"].ToString();
                dr[20] = DSLeave.Tables[0].Rows[i]["MId"].ToString();
                dr[21] = DSLeave.Tables[0].Rows[i]["FMonth"].ToString();
                dt.Rows.Add(dr);
                dt.AcceptChanges();
            }

            GridView2.DataSource = dt;
            GridView2.DataBind();
        }
        catch (Exception ex) { }
    }

   
    protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        try
        {
            GridView2.PageIndex = e.NewPageIndex;
            this.binddata();
        }
        catch (Exception st)
        {

        }
    }

    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {

        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        con.Open();

        try
        {
            if (e.CommandName == "Sel")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                string DId = "";
                string MId = "";
                string Mon = "";
                DId = ((Label)row.FindControl("lblId")).Text;
                MId = ((Label)row.FindControl("lblMId")).Text;
                Mon = ((Label)row.FindControl("lblMon")).Text;
                if (DId != "" && MId != "" && Mon != "" && EmpId != "")
                {
                    Response.Redirect("Salary_Edit_Details_Emp.aspx?DId=" + DId + "&MId=" + MId + "&Mon=" + Mon + "&EmpId=" + EmpId + "&ModId=12&SubModId=133");
                }
               
            }
        }
        catch (Exception st)
        {
        }

        con.Close();
    }
    protected void btnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("Salary_Edit.aspx?ModId=12&SubModId=133");
    }

}
