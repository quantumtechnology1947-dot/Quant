=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/ECNUnlock.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="ECNUnlock.aspx.cs" Inherits="Module_Design_Transactions_ECNUnlock" Title="ERP" Theme="Default"  %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

 <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />    
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

<table class="fontcss" cellpadding="0" cellspacing="0" width="100%">
              <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)" colspan="2">
        &nbsp;<b>ECN</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>WONo:&nbsp; </strong>
                <asp:Label ID="lblWono" runat="server" Font-Bold="True"></asp:Label></td>
        </tr>
            <tr>
                <td colspan="4">
                    <asp:Panel ID="Panel1" ScrollBars="Auto" Height="430Px" runat="server">
                   
                     <asp:GridView ID="GridView1"  runat="server"
                    AutoGenerateColumns="False"  PageSize="15" Width="100%" DataKeyNames="ItemId" 
                    CssClass="yui-datatable-theme"  >
                
                         <PagerSettings PageButtonCount="40" />
                
                <Columns>
                        <asp:TemplateField HeaderText="SN" SortExpression="ItemId">
                       <ItemTemplate>
                    <%# Container.DataItemIndex+1 %>
                </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                        </asp:TemplateField>
                                               
             
                                               
                       <asp:TemplateField >
                       <HeaderTemplate>
                         <asp:CheckBox ID="CheckBox2" runat="server" AutoPostBack="true" 
                                OnCheckedChanged="CheckBox2_CheckedChanged" />
                       </HeaderTemplate>
                        <ItemTemplate>
                            <asp:CheckBox ID="CheckBox1" runat="server" AutoPostBack="false" 
                                OnCheckedChanged="CheckBox1_CheckedChanged" />
                        </ItemTemplate>
                       
                            <ItemStyle HorizontalAlign="Center" Width="2%" />
        </asp:TemplateField>
                                               
                        <asp:TemplateField HeaderText="ItemId" SortExpression="ItemId" Visible="false">
                        <ItemTemplate>
                        <asp:Label ID="lblItemId" runat="server" Text='<%#Eval("ItemId") %>'>    </asp:Label>                                  </ItemTemplate>
                          <ItemStyle HorizontalAlign="Center" />
                        </asp:TemplateField>
                        
                    <%-- <asp:TemplateField HeaderText="ECN Date" SortExpression="SysDate" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lblSysDate" runat="server" Text='<%#Eval("SysDate") %>'>    </asp:Label>                                  </ItemTemplate>
                          <ItemStyle HorizontalAlign="Center" Width="4%" />
                        </asp:TemplateField>--%>
                                               
                         <asp:TemplateField HeaderText="ItemCode" >
                        <ItemTemplate>
                        <asp:Label ID="lblItemCode" runat="server" Text='<%#Eval("ItemCode") %>'>    </asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="center" Width="7%" />  
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Description" >
                        <ItemTemplate>
                        <asp:Label ID="lblManfDesc" runat="server" Text='<%#Eval("ManfDesc") %>'>    </asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="Left" Width="35%" />                                                               
                        </asp:TemplateField>
                        
                     <asp:TemplateField HeaderText="UOM" >
                        <ItemTemplate>
                        <asp:Label ID="lblUOM" runat="server" Text='<%#Eval("UOM") %>'></asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="center" Width="5%" />
                        </asp:TemplateField>
                         <asp:TemplateField HeaderText="BOM Qty" >
                        <ItemTemplate>
                        <asp:Label ID="lblBOMQty" runat="server" Text='<%#Eval("BOMQty") %>'></asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="center" Width="5%" />
                        </asp:TemplateField>
                        <asp:TemplateField HeaderText="Reason" >
                        <ItemTemplate>
                        <asp:Label ID="lblReason" runat="server" Text='<%#Eval("Reason") %>'></asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="Left" Width="20%" />                      
                        </asp:TemplateField>                     
                        
                        
                        
                        <asp:TemplateField HeaderText="Remarks" >                
                        
                        <ItemTemplate>
                        <asp:Label ID="lblRemarks" runat="server" Text='<%#Eval("Remarks") %>'></asp:Label>
                        </ItemTemplate>                                            
                             <ItemStyle HorizontalAlign="Left" Width="25%" />                      
                        </asp:TemplateField>
                       
                        
                     
                                
                        
                        
                </Columns>
                
                <EmptyDataTemplate>
                                    <table width="100%" class="fontcss"><tr><td align="center" >
                                    <asp:Label ID="Label1" runat="server"  Text="No  data found to display" Font-Bold="true"
    Font-Names="Calibri" ForeColor="red"></asp:Label></td></tr>
    </table>
                                    </EmptyDataTemplate>
                                            <FooterStyle Wrap="True">
                                            </FooterStyle>
                    
                </asp:GridView>
                </asp:Panel>
                
                
                </td>
            </tr>
            <tr>
             <td style="height:30px" align="center" colspan="4" valign="bottom">
                 <asp:Button ID="Button1" runat="server" CssClass="redbox" 
                     onclick="Button1_Click" Text="Unlock ECN" />
&nbsp;
                 <asp:Button ID="BtnCancel" runat="server" CssClass="redbox" 
                     onclick="BtnCancel_Click" Text="Cancel" />
                </td>
            </tr>
            </table>
   

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/ECNUnlock.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

using System.Web.Mail;

public partial class Module_Design_Transactions_ECNUnlock : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    SqlConnection con;

    int CompId = 0;
    int FinYearId = 0;
    string sId = "";
    string connStr = "";
    string WONo = "";    
    protected void Page_Load(object sender, EventArgs e)
    {

       try
        {
            WONo = Request.QueryString["WONo"].ToString();
            connStr = fun.Connection();
            con = new SqlConnection(connStr);
            CompId = Convert.ToInt32(Session["compid"]);
            sId = Session["username"].ToString();
            FinYearId = Convert.ToInt32(Session["finyear"]);
            lblWono.Text = WONo;
            if (!IsPostBack)
            {
                this.loaddata();
            }
        }
        catch (Exception ex)
        {

        }

    }

    public void loaddata()
    {
        try
        {
            string StrSql = "SELECT Distinct(tblDG_ECN_Master.ItemId),Unit_Master.Symbol,tblDG_Item_Master.ItemCode, tblDG_Item_Master.ManfDesc, tblDG_ECN_Master.WONo FROM tblDG_ECN_Master INNER JOIN tblDG_Item_Master ON tblDG_ECN_Master.ItemId = tblDG_Item_Master.Id INNER JOIN Unit_Master ON tblDG_Item_Master.UOMBasic = Unit_Master.Id And tblDG_ECN_Master.WONo='" + WONo + "' And Flag=0 order by tblDG_ECN_Master.ItemId Desc";
            SqlCommand cmdsupId = new SqlCommand(StrSql, con);
            SqlDataAdapter dasupId = new SqlDataAdapter(cmdsupId);
            DataSet DSSql = new DataSet();
            dasupId.Fill(DSSql);
            DataTable dt = new DataTable();
            dt.Columns.Add(new System.Data.DataColumn("ItemId", typeof(Int32)));
            dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("UOM", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Reason", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Remarks", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));
            DataRow dr;
            for (int i = 0; i < DSSql.Tables[0].Rows.Count; i++)
            {
                dr = dt.NewRow();

                string Reason = string.Empty;
                string Remarks = string.Empty;
                double BOMQty = 0;

                BOMQty = fun.AllComponentBOMQty(CompId, WONo, (DSSql.Tables[0].Rows[i]["ItemId"].ToString()), FinYearId);
                dr[6] = BOMQty;

                string StrSql3 = "SELECT Id  FROM tblDG_ECN_Master Where WONo='" + WONo + "' And ItemId='" + Convert.ToInt32(DSSql.Tables[0].Rows[i]["ItemId"]) + "'";
                SqlCommand cmdsupId3 = new SqlCommand(StrSql3, con);
                SqlDataAdapter dasupId3 = new SqlDataAdapter(cmdsupId3);
                DataSet DSSql3 = new DataSet();
                dasupId3.Fill(DSSql3);



                for (int i3 = 0; i3 < DSSql3.Tables[0].Rows.Count; i3++)
                {
                    string StrSql2 = "SELECT  Remarks,Types FROM tblDG_ECN_Master INNER JOIN tblDG_ECN_Details ON tblDG_ECN_Master.Id = tblDG_ECN_Details.MId INNER JOIN tblDG_ECN_Reason ON tblDG_ECN_Reason.Id = tblDG_ECN_Details.ECNReason And tblDG_ECN_Details.MId='" + Convert.ToInt32(DSSql3.Tables[0].Rows[i3]["Id"]) + "'";
                    SqlCommand cmdsup = new SqlCommand(StrSql2, con);
                    SqlDataAdapter dasup = new SqlDataAdapter(cmdsup);
                    DataSet DSSql2 = new DataSet();
                    dasup.Fill(DSSql2);
                    for (int i2 = 0; i2 < DSSql2.Tables[0].Rows.Count; i2++)
                    {
                       string a = string.Empty;
                       if (Reason!="")
                       {
                           a = ", ";
                       }
                       string b = string.Empty;
                       if (Remarks != "")
                       {
                           b = ", ";
                       }
                        Reason = Reason + a + DSSql2.Tables[0].Rows[i2]["Types"].ToString();
                        Remarks = Remarks + b + DSSql2.Tables[0].Rows[i2]["Remarks"].ToString();
                    }
                }
                dr[0] = Convert.ToInt32(DSSql.Tables[0].Rows[i]["ItemId"]);
                dr[1] = DSSql.Tables[0].Rows[i]["ItemCode"].ToString();
                dr[2] = DSSql.Tables[0].Rows[i]["ManfDesc"].ToString();
                dr[3] = DSSql.Tables[0].Rows[i]["Symbol"].ToString();
                dr[4] = Reason;
                dr[5] = Remarks;
                dt.Rows.Add(dr);
                dt.AcceptChanges();
            }
            GridView1.DataSource = dt;
            GridView1.DataBind();
        }
       catch (Exception ex)
        {
        }


    } 

    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {        

    }

    protected void CheckBox2_CheckedChanged(object sender, EventArgs e)
    {
       try
        {
            CheckBox x = (CheckBox)sender;
            GridViewRow grv = (GridViewRow)x.NamingContainer;
            if (x.Checked == true)
            {
                foreach (GridViewRow grv2 in GridView1.Rows)
                {
                    ((CheckBox)grv2.FindControl("CheckBox1")).Checked = true;
                }
            }
            else
            {
                foreach (GridViewRow grv2 in GridView1.Rows)
                {
                    ((CheckBox)grv2.FindControl("CheckBox1")).Checked = false;
                }
            }
        }
       catch (Exception ex)
        {
        }
    }
    protected void BtnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Design/Transactions/ECN_WO.aspx");
    }
    protected void Button1_Click(object sender, EventArgs e)
    {
        try
        {
            con.Open();
            int srNo = 0;
            string ItemCode = string.Empty;
            string Desc = string.Empty;
            string UOM = string.Empty;
            string bomQty = string.Empty;
            string reason = string.Empty;
            string remarks = string.Empty;
            DataTable dtRow = new DataTable();
            DataRow drRow;
            dtRow.Columns.Add(new System.Data.DataColumn("SRNo", typeof(int)));
            dtRow.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
            dtRow.Columns.Add(new System.Data.DataColumn("Description", typeof(string)));
            dtRow.Columns.Add(new System.Data.DataColumn("UOM", typeof(string)));
            dtRow.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(string)));
            dtRow.Columns.Add(new System.Data.DataColumn("Reason", typeof(string)));
            dtRow.Columns.Add(new System.Data.DataColumn("Remarks", typeof(string)));
            foreach (GridViewRow grv2 in GridView1.Rows)
            {
                if (((CheckBox)grv2.FindControl("CheckBox1")).Checked == true)
                {
                    drRow = dtRow.NewRow();
                    srNo++;
                    int ItemId = Convert.ToInt32(((Label)grv2.FindControl("lblItemId")).Text);
                    string updateStr = fun.update("tblDG_BOM_Master", "ECNFlag=0", "ItemId='" + ItemId + "' And WONo='" + WONo + "' And CompId='" + CompId + "'");
                    SqlCommand cmd = new SqlCommand(updateStr, con);
                    cmd.ExecuteNonQuery();

                    string updateStr2 = fun.update("tblDG_ECN_Master", "Flag=1", "ItemId='" + ItemId + "'And WONo='" + WONo + "' And CompId='" + CompId + "'");
                    SqlCommand cmd2 = new SqlCommand(updateStr2, con);
                    cmd2.ExecuteNonQuery();

                    ItemCode = ((Label)grv2.FindControl("lblItemCode")).Text;
                    Desc = ((Label)grv2.FindControl("lblManfDesc")).Text;
                    UOM = ((Label)grv2.FindControl("lblUOM")).Text;
                    bomQty = ((Label)grv2.FindControl("lblBOMQty")).Text;
                    reason = ((Label)grv2.FindControl("lblReason")).Text;
                    remarks = ((Label)grv2.FindControl("lblRemarks")).Text;

                    drRow[0] = srNo;
                    drRow[1] = ItemCode;
                    drRow[2] = Desc;
                    drRow[3] = UOM;
                    drRow[4] = bomQty;
                    drRow[5] = reason;
                    drRow[6] = remarks;
                    dtRow.Rows.Add(drRow);
                    dtRow.AcceptChanges();
                }

            }

            if (dtRow.Rows.Count > 0)
            {
                MailMessage msg = new MailMessage();
                string html = "<table width='100%' border='1' style='font-size:10pt'>";
                //add header row          

                html += "<tr>";
                for (int i = 0; i < dtRow.Columns.Count; i++)
                {
                    string tdwidth = string.Empty;
                    if (dtRow.Columns[i].ColumnName == "ItemCode")
                    {
                        tdwidth = "width='10%'";
                    }
                    html += "<td align='center'" + tdwidth + ">" + dtRow.Columns[i].ColumnName + "</td>";
                }
                html += "</tr>";
                //add rows
                for (int i = 0; i < dtRow.Rows.Count; i++)
                {
                    html += "<tr>";
                    for (int j = 0; j < dtRow.Columns.Count; j++)
                        html += "<td>" + dtRow.Rows[i][j].ToString() + "</td>";
                    html += "</tr>";
                }
                html += "</table>";
                string ErpMail = "";
                string sqlmailserverip = fun.select("MailServerIp,ErpSysmail", "tblCompany_master", "CompId = '" + CompId + "'");
                SqlCommand cmd4 = new SqlCommand(sqlmailserverip, con);
                SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
                DataSet ds4 = new DataSet();
                da4.Fill(ds4);
                if (ds4.Tables[0].Rows.Count > 0)
                {
                    SmtpMail.SmtpServer = ds4.Tables[0].Rows[0]["MailServerIp"].ToString();
                    ErpMail = ds4.Tables[0].Rows[0]["ErpSysmail"].ToString();
                }
                msg.From = ErpMail;
                // msg.To = "sdshinde@sapl.com,monali@sapl.com,suhas@sapl.com";
                msg.Bcc = "shridhar@sapl.com,kumar@sapl.com,shrikrishna@sapl.com";
                msg.Subject = "ECN Unlock";
                msg.Body = "Work Order No :  " + WONo + "<br><br>" + html + "<br><br><br>This is Auto generated mail by ERP system, please do not reply.<br><br> Thank you.";
                msg.BodyFormat = MailFormat.Html;
                SmtpMail.Send(msg);
               
            } 
            Page.Response.Redirect(Page.Request.Url.ToString(), true);          
            con.Close();
        }
        catch (Exception ex)
        {
        }      

    }
}
