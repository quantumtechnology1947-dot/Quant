=== FILE: /Users/shiv/workspace/syncortext/NewERP/DBConnectionTest.aspx.txt ===

<%@ Page Language="C#" %>
<%@ Import Namespace="System.Data" %>
<%@ Import Namespace="System.Data.SqlClient" %>
<%@ Import Namespace="System.Configuration" %>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>ERP Database Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #003366; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <form id="form1" runat="server">
        <div>
            <h1>ERP Database Connection Test</h1>
            
            <asp:Panel ID="pnlStatus" runat="server"></asp:Panel>
            
            <asp:Panel ID="pnlTables" runat="server" Visible="false">
                <h2>Database Tables</h2>
                <asp:GridView ID="gvTables" runat="server" AutoGenerateColumns="true" CellPadding="4" 
                    ForeColor="#333333" GridLines="None">
                    <AlternatingRowStyle BackColor="White" ForeColor="#284775" />
                    <HeaderStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
                    <RowStyle BackColor="#F7F6F3" ForeColor="#333333" />
                </asp:GridView>
                
                <h2>Sample Data</h2>
                <h3>Users</h3>
                <asp:GridView ID="gvUsers" runat="server" AutoGenerateColumns="true" CellPadding="4"
                    ForeColor="#333333" GridLines="None">
                    <AlternatingRowStyle BackColor="White" ForeColor="#284775" />
                    <HeaderStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
                    <RowStyle BackColor="#F7F6F3" ForeColor="#333333" />
                </asp:GridView>
                
                <h3>Products</h3>
                <asp:GridView ID="gvProducts" runat="server" AutoGenerateColumns="true" CellPadding="4"
                    ForeColor="#333333" GridLines="None">
                    <AlternatingRowStyle BackColor="White" ForeColor="#284775" />
                    <HeaderStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
                    <RowStyle BackColor="#F7F6F3" ForeColor="#333333" />
                </asp:GridView>
                
                <h3>Customers</h3>
                <asp:GridView ID="gvCustomers" runat="server" AutoGenerateColumns="true" CellPadding="4"
                    ForeColor="#333333" GridLines="None">
                    <AlternatingRowStyle BackColor="White" ForeColor="#284775" />
                    <HeaderStyle BackColor="#5D7B9D" Font-Bold="True" ForeColor="White" />
                    <RowStyle BackColor="#F7F6F3" ForeColor="#333333" />
                </asp:GridView>
            </asp:Panel>
        </div>
    </form>
    
    <script runat="server">
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                TestDatabaseConnection();
            }
        }
        
        private void TestDatabaseConnection()
        {
            try
            {
                string connectionString = ConfigurationManager.ConnectionStrings["LocalSqlServer"].ConnectionString;
                
                using (SqlConnection conn = new SqlConnection(connectionString))
                {
                    conn.Open();
                    
                    // Display success message
                    pnlStatus.Controls.Add(new LiteralControl("<p class='success'>Successfully connected to the database!</p>"));
                    pnlStatus.Controls.Add(new LiteralControl("<p>Connection String: " + connectionString + "</p>"));
                    
                    // Get table information
                    DataTable tables = GetDatabaseTables(conn);
                    if (tables.Rows.Count > 0)
                    {
                        gvTables.DataSource = tables;
                        gvTables.DataBind();
                        pnlTables.Visible = true;
                        
                        // Get sample data
                        gvUsers.DataSource = GetTableData(conn, "Users");
                        gvUsers.DataBind();
                        
                        gvProducts.DataSource = GetTableData(conn, "Products");
                        gvProducts.DataBind();
                        
                        gvCustomers.DataSource = GetTableData(conn, "Customers");
                        gvCustomers.DataBind();
                    }
                    
                    conn.Close();
                }
            }
            catch (Exception ex)
            {
                pnlStatus.Controls.Add(new LiteralControl("<p class='error'>Error connecting to the database:</p>"));
                pnlStatus.Controls.Add(new LiteralControl("<p class='error'>" + ex.Message + "</p>"));
                
                if (ex.InnerException != null)
                {
                    pnlStatus.Controls.Add(new LiteralControl("<p class='error'>Inner Exception: " + ex.InnerException.Message + "</p>"));
                }
            }
        }
        
        private DataTable GetDatabaseTables(SqlConnection conn)
        {
            DataTable tables = new DataTable();
            
            string sql = @"SELECT 
                            t.name AS TableName,
                            (SELECT COUNT(*) FROM sys.columns c WHERE c.object_id = t.object_id) AS ColumnCount,
                            (SELECT COUNT(*) FROM sys.indexes i WHERE i.object_id = t.object_id) AS IndexCount,
                            (SELECT COUNT(*) FROM sys.foreign_keys fk WHERE fk.parent_object_id = t.object_id) AS ForeignKeyCount,
                            (SELECT COUNT(*) FROM sys.objects o WHERE o.parent_object_id = t.object_id AND o.type = 'TR') AS TriggerCount
                          FROM 
                            sys.tables t
                          ORDER BY 
                            t.name";
            
            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                using (SqlDataAdapter adapter = new SqlDataAdapter(cmd))
                {
                    adapter.Fill(tables);
                }
            }
            
            return tables;
        }
        
        private DataTable GetTableData(SqlConnection conn, string tableName)
        {
            DataTable data = new DataTable();
            
            string sql = "SELECT * FROM " + tableName;
            
            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                using (SqlDataAdapter adapter = new SqlDataAdapter(cmd))
                {
                    adapter.Fill(data);
                }
            }
            
            return data;
        }
    </script>
</body>
</html> 