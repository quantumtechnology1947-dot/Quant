=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SysSupport/SystemCredentialsPrint.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="SystemCredentialsPrint.aspx.cs" Inherits="Module_SysSupport_SystemCredentialsPrint" %>
<%@ Register Assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304"
    Namespace="CrystalDecisions.Web" TagPrefix="CR" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>ERP</title>
    <link href="../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../Css/styles.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <form id="form1" runat="server">
    <div>
    <table width="100%">
    <tr>
    <td align="center"> <asp:Panel ID="Panel4" ScrollBars="Auto" Height="390px" runat="server">
     <CR:CrystalReportViewer ID="CrystalReportViewer1"  
            EnableDatabaseLogonPrompt="False" DisplayGroupTree="False"
      ReportSourceID="CrystalReportSource1"  runat="server" AutoDataBind="True" 
            HasCrystalLogo="False" />
 <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
<Report FileName="~\Module\SysSupport\AuthorityAuthorizationForm.rpt"></Report> 

</CR:CrystalReportSource>
    </asp:Panel> 
    </td>
    </tr>
     
    </table>    
    </div>
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SysSupport/SystemCredentialsPrint.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_SysSupport_SystemCredentialsPrint : System.Web.UI.Page
{

    clsFunctions fun = new clsFunctions();
    private ReportDocument report = new ReportDocument();
    string Key = string.Empty;
    string connStr = "";
    SqlConnection con;
    int CompId = 0;
    int FinYearId = 0;
    int Id = 0;
    string sId = "";

    protected void Page_Init(object sender, EventArgs e)
    {

        connStr = fun.Connection();
        con = new SqlConnection(connStr);
        CompId = Convert.ToInt32(Session["compid"]);
        FinYearId = Convert.ToInt32(Session["finyear"]);
        Key = Request.QueryString["Key"].ToString();
        Id = Convert.ToInt32(Request.QueryString["Id"]);
        con.Open();

        try
        {
        if (!IsPostBack)
        {          
           
            string selectQuery = "SELECT tblSystemCredentials.Id, tblSystemCredentials.CompId, REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING(tblSystemCredentials.SysDate, CHARINDEX('-',tblSystemCredentials.SysDate) + 1, 2) + '-' + LEFT(tblSystemCredentials.SysDate, CHARINDEX('-', tblSystemCredentials.SysDate) - 1)+ '-' + RIGHT(tblSystemCredentials.SysDate, CHARINDEX('-', REVERSE(tblSystemCredentials.SysDate)) - 1)), 103), '/', '-') AS SysDate, tblSystemCredentials.SysPwd,tblSystemCredentials.ERPPwd, tblSystemCredentials.EmailId, tblSystemCredentials.EmailPwd, tblHR_OfficeStaff.EmpId,tblHR_OfficeStaff.Title + '. ' + tblHR_OfficeStaff.EmployeeName AS EmployeeName, tblHR_Designation.Type AS Designation,tblHR_Departments.Description AS Department, vw_tblHR_OfficeStaff.Title + '. ' + vw_tblHR_OfficeStaff.EmployeeName AS HOD FROM tblSystemCredentials INNER JOIN tblHR_OfficeStaff ON tblSystemCredentials.MId = tblHR_OfficeStaff.UserID INNER JOIN tblHR_Designation ON tblHR_OfficeStaff.Designation = tblHR_Designation.Id INNER JOIN tblHR_Departments ON tblHR_OfficeStaff.Department = tblHR_Departments.Id  INNER JOIN vw_tblHR_OfficeStaff ON tblHR_OfficeStaff.DeptHead = vw_tblHR_OfficeStaff.UserID where tblSystemCredentials.Id = '" + Id + "'";

            SqlCommand myCommand = new SqlCommand(selectQuery, con);
            SqlDataAdapter ad = new SqlDataAdapter(myCommand);
            DataSet ds = new DataSet();
            ad.Fill(ds);
            DataSet xsdds = new AuthorityAuthorization();
            xsdds.Tables[0].Merge(ds.Tables[0]);
            xsdds.AcceptChanges();
            report = new ReportDocument();
            report.Load(Server.MapPath("~/Module/SysSupport/AuthorityAuthorizationForm.rpt"));
            report.SetDataSource(xsdds);
            // For Address
            string Address = fun.CompAdd(CompId);
            report.SetParameterValue("Address", Address);
            CrystalReportViewer1.ReportSource = report;
            Session[Key] = report;

        }
        else
        {
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
        }
        catch (Exception ex)
        {

        }
        finally
        {
            con.Close();
        }
    }
    
    protected void Page_Load(object sender, EventArgs e)
    {
        //report
        report = new ReportDocument();
    }

   
    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }
}
