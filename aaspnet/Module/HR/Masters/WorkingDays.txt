=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Masters/WorkingDays.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="WorkingDays.aspx.cs" Inherits="Module_HR_Masters_WorkingDays" Title="ERP" Theme="Default" %>
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
     <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>

    
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

<table cellpadding="0" cellspacing="0" width="35%" align="center" >
        <tr>
            <td>
    <table cellpadding="0" cellspacing="0" width="100%" align="center">
       
        <tr>
            <td align="left" valign="middle" style="background:url(../../../images/hdbg.JPG)" height="21" class="fontcsswhite"><b>
                &nbsp;Working Days</b></td>
        </tr>
        <tr>
            <td align="left" valign="top">
                <asp:GridView ID="GridView1" 
                runat="server" 
                AllowPaging="True"
                ShowFooter="True" 
                AutoGenerateColumns="False" 
                DataKeyNames="Id" 
                FooterStyle-Wrap="True"
                OnRowDeleted="GridView1_RowDeleted" 
               
                OnRowUpdated="GridView1_RowUpdated" 
                OnRowCommand="GridView1_RowCommand"
                CssClass="yui-datatable-theme" Width="100%" 
                    onrowdatabound="GridView1_RowDataBound" PageSize="17" 
                    onrowupdating="GridView1_RowUpdating" onrowediting="GridView1_RowEditing" 
                    onrowdeleting="GridView1_RowDeleting" 
                    onrowcancelingedit="GridView1_RowCancelingEdit">
                    
                <FooterStyle Wrap="True"></FooterStyle>
                    <Columns>
                        <asp:CommandField  ButtonType="Link" ValidationGroup="edit" 
                            ShowEditButton="True" >
                            <ItemStyle Width="3%" />
                        </asp:CommandField>
                        
                         <asp:CommandField ShowDeleteButton="True" ButtonType="Link" 
                            ValidationGroup="edit"   >
                             <ItemStyle Width="3%" />
                        </asp:CommandField>
                        
                        <asp:TemplateField HeaderText="SN">
                        <ItemTemplate>  <%# Container.DataItemIndex+1 %>  </ItemTemplate>
                           <FooterTemplate>
                            <asp:Button ID="btnInsert" runat="server" ValidationGroup="abc" 
                                OnClientClick=" return confirmationAdd()" CommandName="Add" CssClass="redbox" Text="Insert" Width ="42px" />
                            </FooterTemplate>                            
                            <ItemStyle HorizontalAlign="Right" Width="4%" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="False">
                            <ItemTemplate>
                                <asp:Label ID="lblID" runat="server" Text='<%#Eval("Id") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="2%" />
                        </asp:TemplateField>                      
                         
                        
                        <asp:TemplateField HeaderText="Fin Year">

                        <ItemTemplate>  
                        <asp:Label ID="lblFinYearId" runat="server" Text='<%#Eval("FinYear") %>'>    </asp:Label>
                        </ItemTemplate>
                        
                       <%-- <EditItemTemplate>
                         <asp:Label ID="lblFinYearId1" Visible="false" runat="server" Text='<%#Eval("FinYearId") %>'>    </asp:Label>
                          <asp:DropDownList ID="DptYear1"  runat="server" CssClass="box3" 
                    DataSourceID="SqlDataSource2" DataTextField="FinYear" 
                    DataValueField="FinYearId">
                          </asp:DropDownList>   
                        </EditItemTemplate>--%>
                        
                        <FooterTemplate>                 
                          <asp:DropDownList ID="DptYear"  runat="server" CssClass="box3" 
                    DataSourceID="SqlDataSource2" DataTextField="FinYear" 
                    DataValueField="FinYearId">
                          </asp:DropDownList> 
                        </FooterTemplate>
                            <ItemStyle Width="10%"  HorizontalAlign="Center" />
                            <FooterStyle Width="10%"  HorizontalAlign="Center" />
                        </asp:TemplateField> 
                        <asp:TemplateField HeaderText="Month" SortExpression="Title">
                        <ItemTemplate>
                        <asp:Label ID="lblMonthId" runat="server" Text='<%#Eval("MonthId") %>'>    </asp:Label>
                        </ItemTemplate>
                        
                      <%--  <EditItemTemplate>
                           <asp:DropDownList ID="ddlMonth1" runat="server" CssClass="box3" DataSourceID="SqlDataSource3"
                             DataTextField="Month" DataValueField="Id">
                            </asp:DropDownList>
                             <asp:Label ID="lblMonthId1" Visible="false" runat="server" Text='<%#Eval("MonthId") %>'>    </asp:Label>
                        </EditItemTemplate>
                        --%>
                        <FooterTemplate>
                            <asp:DropDownList ID="ddlMonth" runat="server" CssClass="box3" ><%--DataSourceID="SqlDataSource3"
                             DataTextField="Month" DataValueField="Id"--%>
                            </asp:DropDownList>
                        </FooterTemplate>
                        <ItemStyle Width="20%"  HorizontalAlign="Center" />
                        <FooterStyle Width="20%"  HorizontalAlign="Center" />
                        </asp:TemplateField>
                        
                        
                         <asp:TemplateField HeaderText="Days" SortExpression="Title">
                        <ItemTemplate>
                        <asp:Label ID="lblDays" runat="server" Text='<%#Eval("Days") %>'>    </asp:Label>
                        </ItemTemplate>
                        
                        <EditItemTemplate>
                         <asp:TextBox ID="txtDays1" CssClass="box3" Width="60%" runat="server">
                        </asp:TextBox>
                            <asp:RequiredFieldValidator ID="ReqtxtDays1" runat="server" ControlToValidate="txtDays1"
                             ValidationGroup="edit" ErrorMessage="*">
                             </asp:RequiredFieldValidator>
                                <asp:RegularExpressionValidator ID="RegtxtDays1" runat="server" 
                                ControlToValidate="txtDays1" ErrorMessage="*" 
                                ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="edit" >
                                </asp:RegularExpressionValidator>
                                
                                 <asp:Label ID="lblDays1" runat="server" Visible="false" Text='<%#Eval("Days") %>'>    </asp:Label>
                        </EditItemTemplate>
                        
                        <FooterTemplate>
                        <asp:TextBox ID="txtDays" CssClass="box3" Width="70%" runat="server">
                        </asp:TextBox>
                            <asp:RequiredFieldValidator ID="ReqtxtDays" runat="server" ControlToValidate="txtDays"
                             ValidationGroup="abc" ErrorMessage="*">
                             </asp:RequiredFieldValidator>
                                <asp:RegularExpressionValidator ID="RegtxtDays" runat="server" 
                                ControlToValidate="txtDays" ErrorMessage="*" 
                                ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="abc">
                                </asp:RegularExpressionValidator>
                        </FooterTemplate>
                         <ItemStyle Width="10%"  HorizontalAlign="Right" />
                         <FooterStyle Width="10%"  HorizontalAlign="Left" />
                         
                        </asp:TemplateField>                       
                        
                        
                    </Columns>
                    
                    
                    
                     <EmptyDataTemplate>
                <table  width="100%" border="1" style=" border-color:Gray">
                    <tr>
                    <td></td>
                     <td align="center" style="width:30%">
                        <asp:Label ID="lblFinYearId2" Font-Bold="true" Font-Size="Medium" Font-Names="Times New Roman" runat="server" Text="Fin Year">
                        </asp:Label>
                        </td>
                        
                    <td align="center" style="width:30%" >
                        <asp:Label ID="lblMonthId2" Font-Bold="true" Font-Size="Medium" Font-Names="Times New Roman" runat="server" Text="Month">
                        </asp:Label>
                        </td>
                        
                         <td align="center" style="width:20%" >
                        <asp:Label ID="lblDays2" Font-Bold="true" Font-Size="Medium" Font-Names="Times New Roman" runat="server" Text="Days">
                        </asp:Label>
                        </td>
                    </tr>
                    <tr>
                 <td style="width:10%">
                <asp:Button ID="btnInsert" runat="server" ValidationGroup="pqr" CommandName="Add1"
                OnClientClick=" return confirmationAdd()"  CssClass="redbox" Text="Insert" />
                </td>
                
                   <td  align="center">
                &nbsp
                   <asp:DropDownList ID="DptYear2" DataSourceID="SqlDataSource2" DataTextField="FinYear" 
                    DataValueField="FinYearId" runat="server" CssClass="box3">
                          </asp:DropDownList> 
                </td>
                
                 <td  align="center">
                &nbsp
             <asp:DropDownList ID="ddlMonth2" runat="server" CssClass="box3" ><%--DataSourceID="SqlDataSource3"
            
              DataTextField="Month" DataValueField="Id"--%>
                         
                            </asp:DropDownList>
                        
                </td>
           <td>
                &nbsp
              <asp:TextBox ID="txtDays2" CssClass="box3" Width="60%" runat="server">
                        </asp:TextBox>
                            <asp:RequiredFieldValidator ID="ReqtxtDays2" runat="server" ControlToValidate="txtDays2"
                             ValidationGroup="abc" ErrorMessage="*">
                             </asp:RequiredFieldValidator>
                                <asp:RegularExpressionValidator ID="RegtxtDays2" runat="server" 
                                ControlToValidate="txtDays2" ErrorMessage="*" 
                                ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="pqr">
                                </asp:RegularExpressionValidator>
                        
                </td>
           </tr>
           </table>
        </EmptyDataTemplate>
                    
              </asp:GridView>
                
        
                
             
                
               </td>
        </tr>
        <tr>
            <td align="center" valign="top">
                <asp:SqlDataSource ID="SqlDataSource2" runat="server" 
                    ConnectionString="<%$ ConnectionStrings:LocalSqlServer %>" 
                    ProviderName="System.Data.SqlClient" 
                    SelectCommand="SELECT [FinYear], [FinYearId] FROM [tblFinancial_master] WHERE ([CompId] = @CompId) ORDER BY [FinYearId] DESC">
                    <SelectParameters>
                        <asp:SessionParameter Name="CompId" SessionField="compid" Type="Int32" />
                    </SelectParameters>
                </asp:SqlDataSource>
                
                
                  <asp:SqlDataSource ID="SqlDataSource3" runat="server" 
                    ConnectionString="<%$ ConnectionStrings:LocalSqlServer %>" 
                    ProviderName="System.Data.SqlClient" 
                    SelectCommand="SELECT [Id],[Month] FROM [tblHR_Months]">
                  
                </asp:SqlDataSource>
            </td>
        </tr>
        <tr>
            <td align="center" valign="top">
                <asp:Label ID="lblMessage" runat="server" ForeColor="Red"></asp:Label></td>
        </tr>
        <tr>
            <td align="center" valign="top">
                &nbsp;</td>
        </tr>
    </table>
    
    
            </td>
        </tr>
    </table>
    
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Masters/WorkingDays.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using System.Globalization;

public partial class Module_HR_Masters_WorkingDays : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    string connStr = "";
    SqlConnection con;
    int CompId = 0;
    int FinYearId = 0;

    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            connStr = fun.Connection();
            con = new SqlConnection(connStr);
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            lblMessage.Text = "";           
            
            if (!Page.IsPostBack)
            {
                this.FillGrid();
            }
        }
        catch (Exception er) { }
    }

    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {

        try
        {
            if (e.CommandName == "Add")
            {
                int FinYearId = Convert.ToInt32(((DropDownList)GridView1.FooterRow.FindControl("DptYear")).SelectedValue);
                int MonthId = Convert.ToInt32(((DropDownList)GridView1.FooterRow.FindControl("ddlMonth")).SelectedValue);
                double Days = Convert.ToDouble(((TextBox)GridView1.FooterRow.FindControl("txtDays")).Text);

                if (((TextBox)GridView1.FooterRow.FindControl("txtDays")).Text != "" && fun.NumberValidationQty(((TextBox)GridView1.FooterRow.FindControl("txtDays")).Text) == true)
                {

                    string cmdStr1 = fun.select("CompId,FinYearId,MonthId", "tblHR_WorkingDays", "CompId='" + CompId + "' AND FinYearId='" + FinYearId + "' AND MonthId='" + MonthId + "' ");
                    SqlDataAdapter da1 = new SqlDataAdapter(cmdStr1, con);
                    DataSet ds1 = new DataSet();
                    da1.Fill(ds1, "tblHR_WorkingDays");
                    if (ds1.Tables[0].Rows.Count == 0)
                    {
                        string StrAdd = fun.insert("tblHR_WorkingDays", "CompId,FinYearId,MonthId,Days", "'" + CompId + "','" + FinYearId + "','" + MonthId + "','" + Days + "'");
                        SqlCommand cmdAdd = new SqlCommand(StrAdd, con);
                        con.Open();
                        cmdAdd.ExecuteNonQuery();
                        con.Close();
                        this.FillGrid();
                        lblMessage.Text = "Record Inserted";

                    }
                    else
                    {
                        string myStringVariable = string.Empty;
                        myStringVariable = "Month is allrady exist.";
                        ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);
                    }
                }
            }
            else if (e.CommandName == "Add1")
            {


                int FinYearId2 = Convert.ToInt32(((DropDownList)GridView1.Controls[0].Controls[0].FindControl("DptYear2")).SelectedValue);
                int MonthId2 = Convert.ToInt32(((DropDownList)GridView1.Controls[0].Controls[0].FindControl("ddlMonth2")).SelectedValue);
                double Days2 = Convert.ToDouble(((TextBox)GridView1.Controls[0].Controls[0].FindControl("txtDays2")).Text);


                if (((TextBox)GridView1.Controls[0].Controls[0].FindControl("txtDays2")).Text != "" && fun.NumberValidationQty(((TextBox)GridView1.Controls[0].Controls[0].FindControl("txtDays2")).Text) == true)
                {
                    string StrAdd1 = fun.insert("tblHR_WorkingDays", "CompId,FinYearId,MonthId,Days", "'" + CompId + "','" + FinYearId2 + "','" + MonthId2 + "','" + Days2 + "'");
                    SqlCommand cmdAdd1 = new SqlCommand(StrAdd1, con);
                    con.Open();
                    cmdAdd1.ExecuteNonQuery();
                    con.Close();
                    this.FillGrid();
                    lblMessage.Text = "Record Inserted";
                }

            }
        }

        catch (Exception ex) { }
    }

    protected void GridView1_RowDeleted(object sender, GridViewDeletedEventArgs e)
    {
        lblMessage.Text = "Record Deleted";
    }

    protected void GridView1_RowUpdated(object sender, GridViewUpdatedEventArgs e)
    {
        lblMessage.Text = "Record Updated";
    }

    protected void GridView1_RowDataBound(object sender, GridViewRowEventArgs e)
    {
        try
        {
            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                LinkButton del = (LinkButton)e.Row.Cells[0].Controls[0];
                del.Attributes.Add("onclick", "return confirmationUpdate();");
            }

            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                LinkButton del1 = (LinkButton)e.Row.Cells[1].Controls[0];
                del1.Attributes.Add("onclick", "return confirmationDelete();");
            }
        }
        catch (Exception ex) { }
    }

    protected void GridView1_RowUpdating(object sender, GridViewUpdateEventArgs e)
    {
        try
        {
            int rowIndex = GridView1.EditIndex;
            GridViewRow row = GridView1.Rows[rowIndex];
            int id = Convert.ToInt32(GridView1.DataKeys[e.RowIndex].Value);

            //int FinYearId1 = Convert.ToInt32(((DropDownList)row.FindControl("DptYear1")).SelectedValue);
            //int MonthId1 = Convert.ToInt32(((DropDownList)row.FindControl("ddlMonth1")).SelectedValue);
            double Days1 = Convert.ToDouble(((TextBox)row.FindControl("txtDays1")).Text);

            if (((TextBox)row.FindControl("txtDays1")).Text != "" && fun.NumberValidationQty(((TextBox)row.FindControl("txtDays1")).Text) == true)
            {

                ////string cmdStr1 = fun.select("CompId,FinYearId,MonthId,Days", "tblHR_WorkingDays", "CompId='" + CompId + "' AND FinYearId='" + FinYearId1 + "' AND MonthId='" + MonthId1 + "' ");
                //SqlDataAdapter da1 = new SqlDataAdapter(cmdStr1, con);
                //DataSet ds1 = new DataSet();
                //da1.Fill(ds1, "tblHR_WorkingDays");
                //if (ds1.Tables[0].Rows.Count == 0)
                {

                    //string StrEdit = "UPDATE [tblHR_WorkingDays] SET [FinYearId] = '" + FinYearId1 + "', [MonthId] = '" + MonthId1 + "', [Days] ='" + Days1 + "' WHERE [Id] = '" + id + "'";
                     string StrEdit = "UPDATE [tblHR_WorkingDays] SET [Days] ='" + Days1 + "' WHERE [Id] = '" + id + "'";
                    SqlCommand cmdEdit = new SqlCommand(StrEdit, con);
                    con.Open();
                    cmdEdit.ExecuteNonQuery();
                    con.Close();
                    GridView1.EditIndex = -1;
                    this.FillGrid();
                    lblMessage.Text = "Record Updated";


                }
                //else
                //{
                //    //string StrEdit = "UPDATE [tblHR_WorkingDays] SET [Days] ='" + Days1 + "' WHERE [Id] = '" + id + "'";
                //    //SqlCommand cmdEdit = new SqlCommand(StrEdit, con);
                //    //con.Open();
                //    //cmdEdit.ExecuteNonQuery();
                //    //con.Close();
                //    //GridView1.EditIndex = -1;
                //    //this.FillGrid();

                //    string myStringVariable = string.Empty;
                //    myStringVariable = "Month is already .";
                //    ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);
                //}


            }
        }
        catch (Exception ex) { }
    }

    protected void GridView1_RowEditing(object sender, GridViewEditEventArgs e)
    {
        try
        {
            GridView1.EditIndex = e.NewEditIndex;
            this.FillGrid();
            int index = GridView1.EditIndex;
            GridViewRow grv = GridView1.Rows[index];

            //string finid = ((Label)grv.FindControl("lblFinYearId1")).Text;
            //string monthid = ((Label)grv.FindControl("lblMonthId1")).Text;
            string mdays = ((Label)grv.FindControl("lblDays1")).Text;
            //((DropDownList)grv.FindControl("DptYear1")).SelectedValue = finid;
            //((DropDownList)grv.FindControl("ddlMonth1")).SelectedValue = monthid;
            ((TextBox)grv.FindControl("txtDays1")).Text = mdays;

        }
        catch (Exception er) { }
    }

    public void FillGrid()
    {
       try
        {
            //string StrMonth = fun.select("[tblHR_WorkingDays].[MonthId] as [MonthId] ,[tblHR_WorkingDays].[Id],[tblFinancial_master].[FinYearId] as [FinYearId] ,[tblFinancial_master].[FinYear] as [FinYear] ,[tblHR_Months].[Month] AS [Month] ,[tblHR_WorkingDays].[Days]", "[tblHR_WorkingDays],[tblFinancial_master],[tblHR_Months]", " [tblHR_WorkingDays].[FinYearId]=[tblFinancial_master].[FinYearId] AND [tblHR_WorkingDays].[MonthId]=[tblHR_Months].[Id] And [tblHR_WorkingDays].[CompId]='" + CompId + "' AND [tblHR_WorkingDays].[FinYearId]<='" + FinYearId + "' ORDER BY [tblHR_WorkingDays].[Id] DESC");

            string StrMonth = fun.select("[tblHR_WorkingDays].[MonthId] as [MonthId] ,[tblHR_WorkingDays].[Id],[tblFinancial_master].[FinYearId] as [FinYearId] ,[tblFinancial_master].[FinYear] as [FinYear] ,[tblHR_WorkingDays].[Days]", "[tblHR_WorkingDays],[tblFinancial_master]", " [tblHR_WorkingDays].[FinYearId]=[tblFinancial_master].[FinYearId] And [tblHR_WorkingDays].[CompId]='" + CompId + "' AND [tblHR_WorkingDays].[FinYearId]<='" + FinYearId + "' ORDER BY [tblHR_WorkingDays].[Id] DESC");
            
            SqlCommand cmdMonth = new SqlCommand(StrMonth, con);
            SqlDataAdapter daMonth = new SqlDataAdapter(cmdMonth);
            DataSet DSMonth = new DataSet();
            daMonth.Fill(DSMonth);
            GridView1.DataSource = DSMonth;
            GridView1.DataBind();

            if (GridView1.Rows.Count == 0)
            {
                fun.GetMonth((DropDownList)GridView1.Controls[0].Controls[0].FindControl("ddlMonth2"), CompId, FinYearId);
            }
            else
            {
                fun.GetMonth((DropDownList)GridView1.FooterRow.FindControl("ddlMonth"), CompId, FinYearId);
            }

            foreach(GridViewRow grv in GridView1.Rows)
            {
                int x = Convert.ToInt32(((Label)grv.FindControl("lblMonthId")).Text);
                ((Label)grv.FindControl("lblMonthId")).Text = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(x);
                
            }
                
        }
        catch (Exception er) { }
    }

    protected void GridView1_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        try
        {
            int id = Convert.ToInt32(GridView1.DataKeys[e.RowIndex].Value);
            SqlCommand cmd3 = new SqlCommand("DELETE FROM tblHR_WorkingDays WHERE Id=" + id + "", con);
            con.Open();
            cmd3.ExecuteNonQuery();
            con.Close();

            this.FillGrid();

        }
        catch (Exception er) { }
    }

    protected void GridView1_RowCancelingEdit(object sender, GridViewCancelEditEventArgs e)
    {
        try
        {
            GridView1.EditIndex = -1;
            this.FillGrid();
        }
        catch (Exception er) { }
    }

    

}
