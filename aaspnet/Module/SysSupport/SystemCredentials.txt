=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SysSupport/SystemCredentials.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="SystemCredentials.aspx.cs" Inherits="Module_SysSupport_SystemCredentials" Title="ERP" %>


<%@ Register Assembly="AjaxControlToolkit" Namespace="AjaxControlToolkit" TagPrefix="cc1" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../Css/styles.css" rel="stylesheet" type="text/css" />

    <script src="../../Javascript/PopUpMsg.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

    <table width ="100%" cellpadding=0 cellspacing=0 >
        <tr>
       <td  align="left" valign="middle" style="background:url(../../images/hdbg.JPG)" height="21" class="fontcsswhite"><b>&nbsp;System Credentials - New</b></td>
        </tr>
       <tr>
       <td>
       
<cc1:TabContainer ID="TabContainer1" runat="server" Height="434px" ActiveTabIndex="0" 
               AutoPostBack="true" Width="100%" 
               onactivetabchanged="TabContainer1_ActiveTabChanged" >
<cc1:TabPanel runat="server" HeaderText="New" ID="TabPanel1"> 
    
<ContentTemplate>

<table width="100%">
<tr>
<td height="29" valign="middle">
<b>Employee Name:</b> <asp:TextBox ID="txtName" Width="300px" runat="server" 
        CssClass="box3"></asp:TextBox><cc1:AutoCompleteExtender ID="TxtEmpName_AutoCompleteExtender" runat="server" 
                                DelimiterCharacters="" Enabled="True" ServiceMethod="GetCompletionList" 
                                ServicePath="" TargetControlID="txtName" UseContextKey="True"
                                 CompletionInterval="100" CompletionSetCount="2" FirstRowSelected="True" MinimumPrefixLength="1" ShowOnlyCurrentWordInCompletionListItem="True" CompletionListItemCssClass="bg" CompletionListHighlightedItemCssClass="bgtext" CompletionListCssClass="almt"></cc1:AutoCompleteExtender>                                 
                                 &nbsp;
                                 <asp:Button ID="btnSearch" runat="server" CssClass="redbox" 
        onclick="Button1_Click" Text="Search" />
</td>
</tr>
<tr>

<td width="60%" valign="top">
    <asp:GridView ID="GridView1" Width="100%" CssClass="yui-datatable-theme" 
            PageSize="15"  runat="server" AllowPaging="True" 
        AutoGenerateColumns="False" DataKeyNames="UserID" 
        DataSourceID="SqlDataSource1" onrowcommand="GridView1_RowCommand"><Columns>
        
        <asp:TemplateField HeaderText="SN" SortExpression="Id"><ItemTemplate><%#Container.DataItemIndex+1  %></ItemTemplate><ItemStyle HorizontalAlign="Right" Width="5%" /></asp:TemplateField>
        
        
        <asp:TemplateField HeaderText="UserID" Visible="False" InsertVisible="False" 
                SortExpression="UserID"><ItemTemplate><asp:Label ID="lblUID" runat="server" Text='<%# Bind("UserID") %>'></asp:Label></ItemTemplate><ItemStyle Width="5%" /></asp:TemplateField><asp:TemplateField HeaderText="EmpId" SortExpression="EmpId"><ItemTemplate><asp:LinkButton ID="lnkId" CommandName="sel" runat="server" Text='<%# Bind("EmpId") %>'></asp:LinkButton></ItemTemplate>
            <ItemStyle Width="10%" HorizontalAlign="Center" /></asp:TemplateField><asp:BoundField DataField="Employee" HeaderText="Employee Name" ReadOnly="True" 
                SortExpression="Employee" ><ItemStyle Width="30%" /></asp:BoundField><asp:BoundField DataField="CompanyEmail" HeaderText="Email Id" 
                SortExpression="CompanyEmail" ><ItemStyle Width="20%" /></asp:BoundField><asp:BoundField DataField="Department" HeaderText="Department" 
                SortExpression="Department" ><ItemStyle Width="14%" 
                HorizontalAlign="Center" /></asp:BoundField><asp:BoundField DataField="Designation" HeaderText="Designation" 
                SortExpression="Designation" >
            <ItemStyle Width="16px" 
                    HorizontalAlign="Center" /></asp:BoundField></Columns><EmptyDataTemplate><table width="100%" class="fontcss"><tr><td align="center"><asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon"> </asp:Label></td></tr></table></EmptyDataTemplate>
    </asp:GridView><asp:SqlDataSource ID="SqlDataSource1" runat="server" 
        ConnectionString="<%$ ConnectionStrings:LocalSqlServer %>"
        ProviderName="System.Data.SqlClient" 
        SelectCommand="SELECT tblHR_OfficeStaff.UserID, tblHR_OfficeStaff.EmpId, tblHR_OfficeStaff.Title + '.' + tblHR_OfficeStaff.EmployeeName AS Employee, tblHR_OfficeStaff.CompanyEmail, tblHR_Departments.Symbol AS Department, tblHR_Designation.Type AS Designation FROM tblHR_OfficeStaff INNER JOIN tblHR_Designation ON tblHR_OfficeStaff.Designation = tblHR_Designation.Id INNER JOIN tblHR_Departments ON tblHR_OfficeStaff.Department = tblHR_Departments.Id WHERE (tblHR_OfficeStaff.ResignationDate = '') AND (tblHR_OfficeStaff.UserID NOT IN(Select MId from tblSystemCredentials)) order By EmpId Desc" FilterExpression="EmpId = '{0}'"><FilterParameters><asp:Parameter Name="EmpId" Type="String" /></FilterParameters></asp:SqlDataSource></td>
 
 <td Width="40%" valign="Top">
     <asp:Panel ID="Panel1" runat="server" 
         BackColor="#CCFFFF" BorderStyle="Solid" 
                        BorderWidth="1px" Height="310px" >
             <table width="100%">             
            <tr>
            <td  colspan="2" height="20px">
            </td>
            </tr> 
             <tr>
            <td colspan="2">&nbsp;&nbsp;
                <asp:Label ID="Label4" runat="server" style="font-weight: 700" Text="Name :"></asp:Label>
                <asp:Label ID="lblempId" runat="server" style="font-weight: 700"></asp:Label>
            </td>
            </tr> 
                 <tr>
                
                     <td colspan="2"> &nbsp;&nbsp;
                         <asp:Label ID="lblDate" runat="server" style="font-weight: 700" Text="Date :"></asp:Label>
                         <asp:Label ID="lbl_Date" runat="server" style="font-weight: 700"></asp:Label>
                     </td>
                 </tr>
                 <tr>
                     <td colspan="2" height="3px">
                         &nbsp;</td>
                 </tr>
                 <tr>
                     <td>
                         <table bgcolor="#99FFCC" border="1" frame="box" style="width:100%;"><tr><td align="center" colspan="2"><b>
                             System Login</b></td></tr><tr><td class="style4"><asp:Label ID="sysUserName" 
                                     runat="server" Font-Bold="True" Text="User Id"></asp:Label></td><td class="style4">
                                     <asp:Label ID="txtSysName" runat="server" Font-Bold="True" ForeColor="#9900CC" 
                                         style="font-weight: 700" Width="135px"></asp:Label>
                                 </td></tr><tr><td><asp:Label ID="SysPass" runat="server" Font-Bold="True" 
                                     Text="PassWord"></asp:Label></td><td><asp:TextBox ID="txtSysPassword" 
                                         runat="server" Width="140px" CssClass="box3" Height="15px" 
                                         ForeColor="#9900CC"></asp:TextBox><asp:RequiredFieldValidator ID="ReqSysPass" runat="server" 
                                         ControlToValidate="txtSysPassword" ErrorMessage="*" ValidationGroup="A"></asp:RequiredFieldValidator></td></tr><tr><td colspan="2">
                                 &nbsp;</td></tr></table></td>
                     <td><table bgcolor="#99FF99" border="1" frame="box" style="width:100%;"><tr>
                         <td align="center" colspan="2" height="22px"><b>
                         ERP</b><b> Login</b></td></tr><tr><td><asp:Label ID="erpUserName" runat="server" 
                                 Font-Bold="True" Text="User Id"></asp:Label></td><td>
                                 <asp:Label ID="txterpName" runat="server" ForeColor="#9900CC" 
                                     style="font-weight: 700" Width="140px"></asp:Label>
                             </td></tr><tr><td><asp:Label ID="erpPass" runat="server" Font-Bold="True" 
                                 Text="PassWord"></asp:Label></td><td>
                                 <asp:Label ID="txterpPassword" runat="server" ForeColor="#9900CC" 
                                     style="font-weight: 700" Width="140px"></asp:Label>
                             </td></tr><tr><td colspan="2">
                             &nbsp;</td></tr></table></td>
                 </tr>
                 <tr>
                     <td colspan="2" height="3px">
                         &nbsp;</td>
                 </tr>
                 <tr>
                     <td colspan="2" align="center">
                         <table bgcolor="#FFFFCC" border="1" frame="box" width="65%">
                             <tr>
                                 <td align="center"  colspan="2">
                                     <b> Email</b><b> Login</b></td>
                             </tr>
                             <tr>
                                 <td align="left">
                                     <asp:Label ID="erpUserName0" runat="server" Font-Bold="True" Text="User Id"></asp:Label>
                                 </td>
                                 <td align="left">
                                          <asp:TextBox ID="txtemailName" runat="server"  Width="275px" ForeColor="#9900CC"
                                         CssClass="box3"></asp:TextBox><asp:RequiredFieldValidator ID="ReqemailName" runat="server" 
                                         ControlToValidate="txtemailName" ErrorMessage="*" ValidationGroup="A"></asp:RequiredFieldValidator>
                                          <asp:RegularExpressionValidator ID="RegularExpressionValidator1" runat="server" 
                                              ControlToValidate="txtemailName" ErrorMessage="*" 
                                              ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*" 
                                              ValidationGroup="A"></asp:RegularExpressionValidator>
                                 </td>
                             </tr>
                             <tr>
                                 <td align="left">
                                     <asp:Label ID="erpPass0" runat="server" Font-Bold="True" Text="PassWord"></asp:Label>
                                 </td>
                                 <td align="left">
                                     <asp:Label ID="txtemailPassword" runat="server" ForeColor="#9900CC" 
                                         style="font-weight: 700" Width="300px"></asp:Label>
                                 </td>
                             </tr>
                             <tr>
                                 <td colspan="2">
                                     &nbsp;</td>
                             </tr>
                         </table>
                     </td>
                 </tr>
                 <tr>
                     <td align="center" colspan="2" height="27px">
                         <asp:Button ID="btn_Save" runat="server" CssClass="redbox" 
                             OnClick="btn_Save_Click" Text="Save" ValidationGroup="A" Width="56px" />
                     </td>
                 </tr>
             </table>           
                        
                        
                        
                        
                        
                        </asp:Panel></td></tr></table>
 

    </ContentTemplate>
                    
</cc1:TabPanel>
<cc1:TabPanel ID="TabPanel2" runat="server" HeaderText="View">                        
<ContentTemplate>
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="29" valign="middle">
<b>Employee Name:</b> <asp:TextBox ID="txtName1" Width="300px" runat="server" 
        CssClass="box3"></asp:TextBox>
    <cc1:AutoCompleteExtender ID="TxtEmpName1_AutoCompleteExtender" runat="server" 
                                DelimiterCharacters="" Enabled="True" ServiceMethod="GetCompletionList" 
                                ServicePath="" TargetControlID="txtName1" UseContextKey="True"
                                 CompletionInterval="100" CompletionSetCount="2" FirstRowSelected="True" MinimumPrefixLength="1" ShowOnlyCurrentWordInCompletionListItem="True" CompletionListItemCssClass="bg" CompletionListHighlightedItemCssClass="bgtext" CompletionListCssClass="almt">
                            </cc1:AutoCompleteExtender>
    <asp:Button ID="btnSearch1" runat="server" CssClass="redbox" 
        onclick="btnSearch1_Click" Text="Search" />
    <asp:Button ID="btnExport" runat="server" CssClass="redbox" Text="Export" 
        OnClick="btnPrint_Click" />
</td>
</tr>
        <tr>
            <td align="center" valign="top">
                <asp:GridView ID="GridView2" 
                runat="server" 
                AllowPaging="True" 
                AutoGenerateColumns="False" 
                DataKeyNames="Id"
                OnRowDeleted="GridView2_RowDeleted" 
                DataSourceID="LocalSqlServer"
                OnRowUpdated="GridView2_RowUpdated" 
                CssClass="yui-datatable-theme" onrowdatabound="GridView2_RowDataBound" 
                    Width="100%" PageSize="15" onrowupdating="GridView2_RowUpdating" 
                    onrowcommand="GridView2_RowCommand">

                    <Columns>

                        <asp:TemplateField HeaderText="SN">
                  
                        <ItemTemplate>
                        <%# Container.DataItemIndex+1 %> 
                        </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" Width="2%" />
                        </asp:TemplateField>
                        <asp:TemplateField ShowHeader="False">
                            <ItemTemplate>
                                <asp:LinkButton ID="LinkButton3" runat="server" CausesValidation="False" 
                                    CommandName="Edit" Text="Edit"></asp:LinkButton>
                            </ItemTemplate>
                            <EditItemTemplate>
                                <asp:LinkButton ID="LinkButton5" OnClientClick="return confirmationUpdate();" runat="server" CausesValidation="True" 
                                    CommandName="Update" Text="Update">
                                </asp:LinkButton>
                                &nbsp;<asp:LinkButton ID="LinkButton4" runat="server" CausesValidation="False" 
                                    CommandName="Cancel" Text="Cancel"></asp:LinkButton>
                            </EditItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="5%" />
                        </asp:TemplateField>


                        <asp:TemplateField ShowHeader="False">
                          <ItemTemplate>
                              <asp:LinkButton ID="LinkButton2" OnClientClick="return confirmationDelete();" CommandName="Delete" Text="Delete" 
                                  runat="server" CausesValidation="False"></asp:LinkButton>            
                          </ItemTemplate>
                          <ItemStyle HorizontalAlign="Center" Width="4%" />
                        </asp:TemplateField>

                        <asp:TemplateField>
                            <ItemTemplate>
                                <asp:LinkButton ID="LinkButton1" runat="server" CommandName="print" 
                                    Text="Print"></asp:LinkButton>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="4%" />
                        </asp:TemplateField>
                        
                         <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="False" >
                            <ItemTemplate>
                                <asp:Label ID="lblID" runat="server" Text='<%#Eval("Id") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" />
                        </asp:TemplateField>
                        
                         <asp:TemplateField HeaderText="Date" SortExpression="SysDate" >
                            <ItemTemplate>
                                <asp:Label ID="lblSysDate" runat="server" Text='<%#Eval("SysDate") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="5%" />
                        </asp:TemplateField>
                        
                        
                                              
                         <asp:TemplateField HeaderText="EmpId" SortExpression="EmpId" >
                            <ItemTemplate>
                                <asp:Label ID="lblEmpId" runat="server" Text='<%#Eval("EmpId") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="6%" />
                        </asp:TemplateField>
                        
                        
                                              
                        <asp:TemplateField HeaderText="Employee Name" SortExpression="Employee">
                                           
                        <ItemTemplate>
                        <asp:Label ID="lblEmployee" runat="server" Text='<%#Eval("Employee") %>'></asp:Label>
                        </ItemTemplate>
                                           
                            <ItemStyle HorizontalAlign="Left" />
                                           
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Sys Passwd" SortExpression="SysPwd">
                           
                        <ItemTemplate>
                        <asp:Label ID="lblSysPwd" runat="server" Text='<%#Eval("SysPwd") %>'>    </asp:Label>
                        </ItemTemplate>
                           
                        <EditItemTemplate>
                        <asp:TextBox ID="lblSysPwd0" Width="85%" CssClass="box3" runat="server" 
                                Text='<%#Bind("SysPwd") %>'> </asp:TextBox>
                         <asp:RequiredFieldValidator ID="ReqSysPwd" runat="server" 
                                ControlToValidate="lblSysPwd0" ValidationGroup="up" ErrorMessage="*"></asp:RequiredFieldValidator>
                        </EditItemTemplate>
                           <ItemStyle HorizontalAlign="Center" Width="8%" />
                        </asp:TemplateField>
                        
                         <asp:TemplateField HeaderText="ERP Passwd" SortExpression="ERPPwd">
                          
                          
                        <ItemTemplate>
                        <asp:Label ID="lblERPPwd" runat="server" Text='<%#Eval("ERPPwd") %>'>    </asp:Label>
                        </ItemTemplate>
                        <EditItemTemplate>
                        <asp:TextBox ID="lblERPPwd0" Width="85%" CssClass="box3" runat="server" 
                                Text='<%#Bind("ERPPwd") %>'></asp:TextBox>
                         <asp:RequiredFieldValidator ID="ReqERPPwd" runat="server" 
                                ControlToValidate="lblERPPwd0" ValidationGroup="up" ErrorMessage="*"></asp:RequiredFieldValidator>
                         
                         
                        </EditItemTemplate>
                          
                          
                             <ItemStyle HorizontalAlign="Center" Width="8%" />
                          
                          
                        </asp:TemplateField>
                        
                         <asp:TemplateField HeaderText="Email Id" SortExpression="EmailId">
                           
                        <ItemTemplate>
                        <asp:Label ID="lblEmailId" runat="server" Text='<%#Eval("EmailId") %>'>    </asp:Label>
                        </ItemTemplate>
                           
                        <EditItemTemplate>
                        <asp:TextBox ID="lblEmailId0" Width="85%" CssClass="box3" runat="server" 
                                Text='<%#Bind("EmailId") %>'></asp:TextBox>
                         <asp:RequiredFieldValidator ID="ReqEmailId" runat="server" 
                                ControlToValidate="lblEmailId0" ValidationGroup="up" ErrorMessage="*"></asp:RequiredFieldValidator>
                            <asp:RegularExpressionValidator ID="Reg1" runat="server" 
                                ControlToValidate="lblEmailId0" ErrorMessage="*" 
                                ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*" 
                                ValidationGroup="up"></asp:RegularExpressionValidator>
                        </EditItemTemplate>
                           
                             <ItemStyle Width="18%" />
                           
                        </asp:TemplateField>
                    
                        <asp:TemplateField HeaderText="Email Passwd" SortExpression="EmailPwd">
                            <ItemTemplate>
                                <asp:Label ID="lblEmailPwd" runat="server" Text='<%#Eval("EmailPwd") %>'>
                                </asp:Label>
                            </ItemTemplate>
                            <EditItemTemplate>
                                <asp:TextBox ID="lblEmailPwd0" runat="server" CssClass="box3" 
                                    Text='<%#Bind("EmailPwd") %>' Width="85%"></asp:TextBox>
                                <asp:RequiredFieldValidator ID="ReqEmailPwd" runat="server" 
                                    ControlToValidate="lblEmailPwd0" ErrorMessage="*" ValidationGroup="up"></asp:RequiredFieldValidator>
                            </EditItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="9%" />
                        </asp:TemplateField>
                    
                    </Columns>

             <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>                    

<FooterStyle Wrap="True"></FooterStyle>
                </asp:GridView>               
                <asp:Label ID="lblMessage" runat="server" Font-Bold="True" ForeColor="Red"></asp:Label>               
                <asp:SqlDataSource ID="LocalSqlServer" runat="server" 
                    ConnectionString="<%$ ConnectionStrings:LocalSqlServer %>" 
                    DeleteCommand="DELETE FROM [tblSystemCredentials] WHERE [Id] = @Id" 
                   
                    ProviderName="System.Data.SqlClient" 
                    SelectCommand="SELECT  ROW_NUMBER() Over (Order by Id) As SN, tblSystemCredentials.Id,REPLACE(CONVERT(varchar, CONVERT(datetime, SUBSTRING( tblSystemCredentials.SysDate , CHARINDEX('-',tblSystemCredentials.SysDate ) + 1, 2) + '-' + LEFT(tblSystemCredentials.SysDate,CHARINDEX('-',tblSystemCredentials.SysDate) - 1) + '-' + RIGHT(tblSystemCredentials.SysDate, CHARINDEX('-', REVERSE(tblSystemCredentials.SysDate)) - 1)), 103), '/', '-') AS  SysDate,tblHR_OfficeStaff.Title+'. '+tblHR_OfficeStaff.EmployeeName AS Employee,tblHR_OfficeStaff.EmpId,tblSystemCredentials.SysPwd, tblSystemCredentials.ERPPwd, tblSystemCredentials.EmailId, tblSystemCredentials.EmailPwd FROM tblSystemCredentials INNER JOIN tblHR_OfficeStaff ON tblSystemCredentials.MId = tblHR_OfficeStaff.UserID  ORDER BY tblSystemCredentials.Id Desc" FilterExpression="EmpId='{0}'"
                    UpdateCommand="UPDATE [tblSystemCredentials] SET [SysPwd] = @SysPwd, [ERPPwd] = @ERPPwd,[EmailId]=@EmailId,[EmailPwd]=@EmailPwd WHERE [Id] = @Id">
      
                    <FilterParameters>
                    <asp:Parameter Name="EmpId" Type="String" />
                    </FilterParameters>
      
                    <DeleteParameters>
                    
                        <asp:Parameter Name="Id" Type="Int32" />
                    </DeleteParameters>
      
                    <UpdateParameters>
                        <asp:Parameter Name="SysPwd" Type="String" />
                        <asp:Parameter Name="ERPPwd" Type="String" />
                        <asp:Parameter Name="EmailId" Type="String" /> 
                        <asp:Parameter Name="EmailPwd" Type="String" />
                        <asp:Parameter Name="Id" Type="Int32" />
                    </UpdateParameters>
                </asp:SqlDataSource>
               </td>
        </tr>
    </table>
    </ContentTemplate>
                    
</cc1:TabPanel>

<cc1:TabPanel ID="TabPanel3" runat="server" HeaderText="Print">                        
<ContentTemplate>
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td>     
                   
 <iframe id="Iframe1"  runat ="server" width="100%" height="420px" frameborder="0" 
                   scrolling="auto" ></iframe>
</td>
</tr>
<tr>
<td valign="top" align="center"  >
     <asp:Button ID="BtnCancel1"  runat="server"  CssClass="redbox" 
                            onclick="BtnCancel1_Click"  Text="Cancel"   /></td></tr> 
    </table>
    </ContentTemplate>
                    
</cc1:TabPanel>
                    
</cc1:TabContainer>
       
       </td>      
       
       </tr>
     
    </table>

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SysSupport/SystemCredentials.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_SysSupport_SystemCredentials : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    private ReportDocument report = new ReportDocument();    
    string Key = string.Empty;
    string connStr = "";
    SqlConnection con;
    int CompId = 0;
    int FinYearId = 0;
    string sId = "";
    string CDate = string.Empty;
    string CTime = string.Empty;

    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            CDate = fun.getCurrDate();
            CTime = fun.getCurrTime();
            connStr = fun.Connection();
            con = new SqlConnection(connStr);
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            sId = Session["username"].ToString();
            lblMessage.Text = "";
            TabPanel3.Visible = false;
        }
        catch(Exception ex){}
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        try
        {
        string CustId = fun.getCode(txtName.Text);
        SqlDataSource1.FilterParameters[0].DefaultValue = CustId;
        }
        catch (Exception ex) { }
    }
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        try
        {
            GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
            if (e.CommandName == "sel")
            {
                int UserID = Convert.ToInt32(((Label)row.FindControl("lblUID")).Text);
                ViewState["MId"] = UserID;
                string EmpName = row.Cells[3].Text;
                string EmpId = ((LinkButton)row.FindControl("lnkId")).Text;
                string Email = row.Cells[4].Text;
                lblempId.Text = EmpName + ' ' + '[' + EmpId + ']';
                lbl_Date.Text = fun.FromDateDMY(CDate);
                txterpName.Text = EmpId;
                txtSysName.Text = EmpId;
                txtemailName.Text = Email;
                txterpPassword.Text = clsFunctions.GetRandomAlphanumericString(9);
                txtemailPassword.Text = txterpPassword.Text;
            }
        }
        catch (Exception es)
        {

        }
    }
    protected void btn_Save_Click(object sender, EventArgs e)
    {
        try
        {
            if (lblempId.Text != "" && !string.IsNullOrEmpty(lblempId.Text))
            {

                string StrIns2 = fun.insert("tblSystemCredentials", "MId, SysDate,SysTime,SessionId,CompId,FinYearId,SysPwd,ERPPwd,EmailId,EmailPwd", "'" + Convert.ToInt32(ViewState["MId"].ToString()) + "','" + CDate + "','" + CTime + "','" + sId + "','" + CompId + "','" + FinYearId + "','" + txtSysPassword.Text + "','" + txterpPassword.Text + "','" + txtemailName.Text + "','" + txtemailPassword.Text + "'");
                SqlCommand cmdIns2 = new SqlCommand(StrIns2, con);

                string Strup = fun.update("tblHR_OfficeStaff", "CompanyEmail='" + txtemailName.Text + "'", "UserId='" + Convert.ToInt32(ViewState["MId"].ToString()) + "'");
                SqlCommand cmdup = new SqlCommand(Strup, con);

                con.Open();
                cmdIns2.ExecuteNonQuery();
                cmdup.ExecuteNonQuery();
                con.Close();
                Page.Response.Redirect(Page.Request.Url.ToString(), true);
            }
            else
            {
                string mystring = string.Empty;
                mystring = "Please Select EmpId.";
                ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);
            }
        }
        catch (Exception ex) { }

    }
    protected void GridView2_RowUpdated(object sender, GridViewUpdatedEventArgs e)
    {
        lblMessage.Text = "Record Updated.";
    }
    protected void GridView2_RowDeleted(object sender, GridViewDeletedEventArgs e)
    {
        lblMessage.Text = "Record Deleted.";
    }
    protected void GridView2_RowDataBound(object sender, GridViewRowEventArgs e)
    {
        try
        {
            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                LinkButton edit = (LinkButton)e.Row.Cells[1].Controls[0];
                edit.Attributes.Add("onclick", "return confirmationUpdate();");
            }

            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                LinkButton del = (LinkButton)e.Row.Cells[2].Controls[0];
                del.Attributes.Add("onclick", "return confirmationDelete();");
            }
        }
        catch (Exception ex) { }
    }
    protected void GridView2_RowUpdating(object sender, GridViewUpdateEventArgs e)
    {
        try
        {
            int rowIndex = GridView2.EditIndex;
            GridViewRow row = GridView2.Rows[rowIndex];
            int id = Convert.ToInt32(GridView2.DataKeys[e.RowIndex].Value);
            string cmdStr = fun.select("MId", "tblSystemCredentials", "Id='" + id + "'");
            SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
            DataSet ds = new DataSet();
            da.Fill(ds, "tblHR_OfficeStaff");
            

            string SysPwd = ((TextBox)row.FindControl("lblSysPwd0")).Text;
            string ERPPwd = ((TextBox)row.FindControl("lblERPPwd0")).Text;
            string EmailId = ((TextBox)row.FindControl("lblEmailId0")).Text;
            string EmailPwd = ((TextBox)row.FindControl("lblEmailPwd0")).Text;

            if (SysPwd != "" && ERPPwd != "" && EmailId != "" && EmailPwd != "")
            {
                LocalSqlServer.UpdateParameters["SysPwd"].DefaultValue = SysPwd;
                LocalSqlServer.UpdateParameters["ERPPwd"].DefaultValue = ERPPwd;
                LocalSqlServer.UpdateParameters["EmailId"].DefaultValue = EmailId;
                LocalSqlServer.UpdateParameters["EmailPwd"].DefaultValue = EmailPwd;
                LocalSqlServer.Update();

                if (ds.Tables[0].Rows.Count > 0)
                {
                    string Strup = fun.update("tblHR_OfficeStaff", "CompanyEmail='" + EmailId + "'", "UserId='" + Convert.ToInt32(ds.Tables[0].Rows[0]["MId"].ToString()) + "'");
                    SqlCommand cmdup = new SqlCommand(Strup, con);
                    con.Open();
                    cmdup.ExecuteNonQuery();
                    con.Close();
                }
            }
        }
        catch (Exception ex) { }
    }
    protected void btnSearch1_Click(object sender, EventArgs e)
    {
        string CustId = fun.getCode(txtName1.Text);
        LocalSqlServer.FilterParameters[0].DefaultValue = CustId;
    }
    protected void btnPrint_Click(object sender, EventArgs e)
    {
        try
        {
            DataView view = (DataView)LocalSqlServer.Select(DataSourceSelectArguments.Empty);
            DataTable dt1 = view.ToTable();
            dt1.Columns["SysDate"].ColumnName = "Date";
            dt1.Columns["Employee"].ColumnName = "Employee Name";
            //dt1.Columns["EmpId"].ColumnName = "Emp/Login Id";
            dt1.Columns["SysPwd"].ColumnName = "System Password";
            dt1.Columns["ERPPwd"].ColumnName = "ERP Password";
            dt1.Columns["EmailId"].ColumnName = "Email Id";
            dt1.Columns["EmailPwd"].ColumnName = "Email Password";
            dt1.Columns.Remove("Id");

            if (dt1.Rows.Count == 0)
            {
                throw new Exception("No Records to Export");
            }
            else
            {
                DataView dv = dt1.DefaultView;
                dv.Sort = "EmpId ASC ";
                dt1 = dv.ToTable();
                ExportToExcel ete = new ExportToExcel();
                ete.ExportDataToExcel(dt1, "Staff_Details");
            }
        }
        catch (Exception ex)
        {
            string mystring = string.Empty;
            mystring = "No Records to Export.";
            ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);
        }
    }

    [System.Web.Services.WebMethodAttribute(), System.Web.Script.Services.ScriptMethodAttribute()]
    public static string[] GetCompletionList(string prefixText, int count, string contextKey)
    {
        clsFunctions fun = new clsFunctions();
        string connStr = fun.Connection();
        DataSet ds = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        con.Open();
        int CompId = Convert.ToInt32(HttpContext.Current.Session["compid"]);
        string cmdStr = fun.select("EmpId,EmployeeName", "tblHR_OfficeStaff", "CompId='" + CompId + "'");
        SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
        da.Fill(ds, "tblHR_OfficeStaff");
        con.Close();
        string[] main = new string[0];
        for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        {
            if (ds.Tables[0].Rows[i].ItemArray[1].ToString().ToLower().StartsWith(prefixText.ToLower()))
            {
                Array.Resize(ref main, main.Length + 1);
                main[main.Length - 1] = ds.Tables[0].Rows[i].ItemArray[1].ToString() + " [" + ds.Tables[0].Rows[i].ItemArray[0].ToString() + "]";
                //if (main.Length == 10)
                //    break;
            }
        }
        Array.Sort(main);
        return main;
    }

    protected void TabContainer1_ActiveTabChanged(object sender, EventArgs e)
    {
        try
        {
            if (TabContainer1.ActiveTabIndex == 0)
            {
                Page.Response.Redirect(Page.Request.Url.ToString(), true);
                TabPanel3.Visible = false;
            }
            if (TabContainer1.ActiveTabIndex == 1)
            {
                TabPanel3.Visible = false;
            }
            if (TabContainer1.ActiveTabIndex == 2)
            {
                TabPanel1.Visible = true;
                TabPanel2.Visible = true;
                TabPanel3.Visible = true;
            }
        }
        catch (Exception ex) { }
    }
    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        try
        {
            if (e.CommandName == "print")
            {
                GridViewRow row1 = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                TabPanel3.Visible = true;
                TabPanel1.Visible = true;
                TabPanel2.Visible = true;
                TabContainer1.ActiveTabIndex = 2;
                int Id = 0;
                Id = Convert.ToInt32(((Label)row1.FindControl("lblID")).Text);
                string getRandomKey = fun.GetRandomAlphaNumeric();
                Iframe1.Attributes.Add("src", "SystemCredentialsPrint.aspx?Id=" + Id + "&Key=" + getRandomKey + "");
            }
        }
        catch(Exception ex){}
    }

    protected void BtnCancel1_Click(object sender, EventArgs e)
    {
        TabContainer1.ActiveTabIndex = 1;
        TabPanel3.Visible = false;
    }
}
