=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Transactions/MobileBills_New.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="MobileBills_New.aspx.cs" Inherits="Module_HR_Transactions_MobileBills_New" Title="ERP" Theme ="Default"  %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
   
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script> 
    <style type="text/css">
        .style2
        {
            height: 25px;
        }
        .style3
        {
            height: 30px;
        }
    </style>
   <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script> 
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

    <table width="100%" cellpadding="0" cellspacing="0">
        <tr>
           
            <td align="left" valign="middle" style="background:url(../../../images/hdbg.JPG)" height="21" class="fontcsswhite"><b>&nbsp;Mobile Bill - New</b></td>
           
        </tr>
        <tr>
           
            <td align="left" class="style3">
                &nbsp;Month Of Bill&nbsp;<asp:DropDownList ID="DropDownList1" runat="server" AutoPostBack="True" 
                    onselectedindexchanged="DropDownList1_SelectedIndexChanged" 
                    CssClass="box3" Width="100px">
                  
                </asp:DropDownList>  
            </td>
           
        </tr>
        <tr>
            <td align="left">
               <asp:GridView ID="GridView1" 
                runat="server" 
                AllowPaging="True"
                ShowFooter="True" 
                AutoGenerateColumns="False" 
                DataKeyNames="UserID" 
                FooterStyle-Wrap="True"
                OnRowDeleted="GridView1_RowDeleted"
                OnRowUpdated="GridView1_RowUpdated" 
                OnRowCommand="GridView1_RowCommand"
                CssClass="yui-datatable-theme" Width="100%" 
                    onpageindexchanging="GridView1_PageIndexChanging" PageSize="20">
                   
                <FooterStyle Wrap="True"></FooterStyle>
                
                    <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>

                    <PagerSettings PageButtonCount="40" />

                    <Columns>
                        
                        <asp:TemplateField HeaderText="SN">
                        <ItemTemplate>
                        <%# Container.DataItemIndex+1 %> 
                        </ItemTemplate>
                     
                            <ItemStyle HorizontalAlign="Right" Width="3%" />
                     
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="UserID" SortExpression="UserID" Visible="False">
                            
                            <ItemTemplate>
                                <asp:Label ID="lblId" runat="server" Text='<%#Eval("UserID") %>'></asp:Label>
                            </ItemTemplate>
                            <ItemStyle HorizontalAlign="Right" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="CK">
        <ItemTemplate>
        <asp:CheckBox ID="CheckBox1" OnCheckedChanged="CheckBox1_CheckedChanged" AutoPostBack="true"  runat="server"/>
        </ItemTemplate>
                            <ItemStyle HorizontalAlign="Center" Width="2%" />
        </asp:TemplateField>
                        
                        
                        <asp:TemplateField HeaderText="Emp Id" SortExpression="EmpId">
                        <ItemTemplate>
                        <asp:Label ID="lblEmpId" runat="server" Text='<%#Eval("EmpId") %>'>    </asp:Label>
                        </ItemTemplate>
                    
                            <ItemStyle HorizontalAlign="Center" />
                    
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Emp Name" SortExpression="EmployeeName">
                       <ItemTemplate>
                        <asp:Label ID="lblEmpName" runat="server" Text='<%#Eval("EmployeeName") %>'>    </asp:Label>
                        </ItemTemplate>
                     
                            <ItemStyle HorizontalAlign="Left" Width="25%" />
                     
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="Mobile No" SortExpression="MobileNo">
                       <ItemTemplate>
                        <asp:Label ID="lblMobileNo" runat="server" Text='<%#Eval("MobileNo") %>'>    </asp:Label>
                        </ItemTemplate>
                       
                            <ItemStyle HorizontalAlign="Center" />
                       
                        </asp:TemplateField>
                        
                        
                        
                        <asp:TemplateField HeaderText="Limit Amt" SortExpression="LimitAmt">
                       <ItemTemplate>
                        <asp:Label ID="lblLimitAmt" runat="server" Text='<%#Eval("LimitAmt") %>'>    </asp:Label>
                        </ItemTemplate>
                    
                            <ItemStyle HorizontalAlign="Right" />
                    
                        </asp:TemplateField>
                        
                        
                        
                         <asp:TemplateField HeaderText="Bill Amt" SortExpression="BillAmt">
                        <ItemTemplate>
                        <asp:Label ID="lblBillAmt" runat="server" > </asp:Label>
                        <asp:TextBox ID="TxtBillAmt" runat="server"  Visible="false">                       
                        </asp:TextBox><asp:RegularExpressionValidator ID="RegularExpressionValidator1" runat="server"  ValidationGroup="A" ControlToValidate="TxtBillAmt" ErrorMessage="*" ValidationExpression="^\d{1,15}(\.\d{0,3})?$">
</asp:RegularExpressionValidator>
    <asp:RequiredFieldValidator ID="Req1" runat="server" ControlToValidate="TxtBillAmt" ValidationGroup="A" ErrorMessage="*"></asp:RequiredFieldValidator>
                        </ItemTemplate>
                    
                       
                         <FooterTemplate> 
                  <asp:Button ID="BtnInsert" runat="server" CssClass="redbox" ValidationGroup="A"   Text="Insert" OnClientClick="return confirmationAdd()" CommandName="Insert" />
                  </FooterTemplate>
                        
                       
                             <ItemStyle HorizontalAlign="Right" />
                        
                       
                          </asp:TemplateField>

                         
                         <asp:TemplateField HeaderText="Taxes" SortExpression="Taxes">
                        <ItemTemplate>
                        <asp:Label ID="lblTaxes" runat="server" >  </asp:Label>
                        <asp:DropDownList ID="DDLTaxes" runat="server" DataSourceID="SqlDataSource1" Visible="false"
                        DataTextField="Value"  DataValueField="Id"> 
                        </asp:DropDownList>
                        <asp:SqlDataSource ID="SqlDataSource1" runat="server" 
                    ConnectionString="<%$ ConnectionStrings:LocalSqlServer %>" 
                    SelectCommand="SELECT [Id], [Value] FROM [tblExciseser_Master] Where LiveSerTax='1'">
                  </asp:SqlDataSource>
                        </ItemTemplate>
                        
                             <ItemStyle HorizontalAlign="Right" />
                        
                         </asp:TemplateField>
                         
                         <asp:TemplateField HeaderText="Excess Amount" SortExpression="ExcessAmount">
                        <ItemTemplate>
                        <asp:Label ID="lblExcessAmount" runat="server" Visible="false" >    </asp:Label>
                        </ItemTemplate>
                        
                             <ItemStyle HorizontalAlign="Right" />
                        
                         </asp:TemplateField>
                        
                        
                    </Columns>
     
              </asp:GridView>
          
             
             </td>
           
        </tr>
        <tr>
           
            <td align="center" class="style2">
              
                
                <asp:Label ID="lblMessage" runat="server" Font-Bold="True" ForeColor="Red"></asp:Label>
                
                
            </td>
           
        </tr>
               
        </table>

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/HR/Transactions/MobileBills_New.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using System.IO;
using System.Collections.Generic;
using iTextSharp.text;
using iTextSharp.text.html.simpleparser;
using iTextSharp.text.pdf;

public partial class Module_HR_Transactions_MobileBills_New : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
   
    protected void Page_Load(object sender, EventArgs e)
    {
       
        lblMessage.Text = "";
        this.getValData();
        if (!IsPostBack)
        {
            string connStr = fun.Connection();
            SqlConnection con = new SqlConnection(connStr);
            
            try
            {
                DataSet DS = new DataSet();
                int CompId = Convert.ToInt32(Session["compid"]);
                int FinYearId = Convert.ToInt32(Session["finyear"]);

               
                fun.GetMonth(DropDownList1, CompId, FinYearId);
            }
            catch (Exception ex)
            { }

            lblMessage.Text = "";
            if (Request.QueryString["m"] != null)
            {
                string v = Request.QueryString["m"].ToString();
                DropDownList1.SelectedValue = v;
                lblMessage.Text = Request.QueryString["n"].ToString();
                this.DDLMonth();
            }
        }
        
    }
    protected void GridView1_RowUpdated(object sender, GridViewUpdatedEventArgs e)
    {
        lblMessage.Text = "Record Updated";
    }
    protected void GridView1_RowDeleted(object sender, GridViewDeletedEventArgs e)
    {

    }
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
       
        if (e.CommandName == "Insert")
        {
            con.Open();
           try
            {
                string CDate = fun.getCurrDate();
                string CTime = fun.getCurrTime();
                string sId = Session["username"].ToString();
                int CompId = Convert.ToInt32(Session["compid"]);
                int FinYearId = Convert.ToInt32(Session["finyear"]);
                int i = 0;
                foreach (GridViewRow grv in GridView1.Rows)
                {
                    if (((TextBox)grv.FindControl("TxtBillAmt")).Text!="")
                    {
                    string BillAmt = decimal.Parse((((TextBox)grv.FindControl("TxtBillAmt")).Text).ToString()).ToString("N2");
                    int id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                    string Tax = ((DropDownList)grv.FindControl("DDLTaxes")).SelectedValue;
                    string empid = ((Label)grv.FindControl("lblEmpId")).Text;
                    string billLimit =decimal.Parse(( ((Label)grv.FindControl("lblLimitAmt")).Text).ToString()).ToString("N2");
                        if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                        {
                            if (Tax != "" && BillAmt != "" && billLimit!="0")
                            {                                
                                string insert = fun.insert("tblHR_MobileBill","SysDate,SysTime,CompId,FinYearId,SessionId,EmpId,BillMonth,BillAmt,Taxes ","'" + CDate + "','" + CTime + "','" + CompId + "','" + FinYearId + "','" + sId + "','" + empid + "','" + DropDownList1.SelectedValue + "','" + Convert.ToDouble(BillAmt) + "','" + Convert.ToDouble(Tax) + "'");

                                SqlCommand cmd = new SqlCommand(insert, con);
                                cmd.ExecuteNonQuery();
                                i++;
                            }
                        }
                    }
                                        
                }

                if(i>0)
                {
                    string s = DropDownList1.SelectedValue;
                    string g = "Record is Inserted";
                    Response.Redirect("MobileBills_New.aspx?m=" + s + "&n=" + g + "&ModId=12&SubModId=50");
                }
            }
            catch (Exception ex) { }
            finally
            {
               con.Close();
            
            }
        }

    }
    protected void GridView1_SelectedIndexChanged(object sender, EventArgs e)
    {

    }
    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {
        this.getValData();      

    }
    public void getValData()
    {
        foreach (GridViewRow grv1 in GridView1.Rows)
        {

            if (((CheckBox)grv1.FindControl("CheckBox1")).Checked == true)
            {
                ((TextBox)grv1.FindControl("TxtBillAmt")).Visible = true;
                ((DropDownList)grv1.FindControl("DDLTaxes")).Visible = true;
                ((RegularExpressionValidator)grv1.FindControl("RegularExpressionValidator1")).Visible = true;
                ((RequiredFieldValidator)grv1.FindControl("Req1")).Visible = true;
            }
            else
            {

                ((TextBox)grv1.FindControl("TxtBillAmt")).Visible = false;
                ((DropDownList)grv1.FindControl("DDLTaxes")).Visible = false;
                ((RegularExpressionValidator)grv1.FindControl("RegularExpressionValidator1")).Visible = false;
                ((RequiredFieldValidator)grv1.FindControl("Req1")).Visible = false;
            }
        }
    }
    protected void DropDownList1_SelectedIndexChanged(object sender, EventArgs e)
    {        
            this.DDLMonth();
    }

    public void DDLMonth()
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        try
        {
            int CompId = Convert.ToInt32(Session["compid"]);
            int FinYearId = Convert.ToInt32(Session["finyear"]);
            if (DropDownList1.SelectedItem.Text != "Select")
            {
                GridView1.Visible = true;

                string SelectComd = fun.select("tblHR_OfficeStaff.UserID,tblHR_OfficeStaff.EmpId,tblHR_OfficeStaff.EmployeeName,tblHR_CoporateMobileNo.Id ,tblHR_CoporateMobileNo.MobileNo, tblHR_CoporateMobileNo.LimitAmt", "tblHR_OfficeStaff,tblHR_CoporateMobileNo", "tblHR_OfficeStaff.MobileNo = tblHR_CoporateMobileNo.Id And tblHR_OfficeStaff.MobileNo!=1 And tblHR_OfficeStaff.CompId='" + CompId + "' AND tblHR_CoporateMobileNo.LimitAmt>0"); 
                
                
                SqlCommand cmd2 = new SqlCommand(SelectComd, con);
                DataSet DS2 = new DataSet();
                SqlDataAdapter DA2 = new SqlDataAdapter(cmd2);                
                DA2.Fill(DS2);
                GridView1.DataSource = DS2;
                GridView1.DataBind();                
                int mth = Convert.ToInt32(DropDownList1.SelectedValue);

                foreach (GridViewRow grv in GridView1.Rows)
                {
                    string empid = ((Label)grv.FindControl("lblEmpId")).Text;
                    string q =fun.select("BillAmt","tblHR_MobileBill","BillMonth='" + mth + "' AND CompId='" + CompId + "' AND EmpId='" + empid + "' And FinYearId='"+FinYearId+"'");
                    SqlCommand cmd = new SqlCommand(q, con);
                    DataSet DS1 = new DataSet();
                    SqlDataAdapter DA1 = new SqlDataAdapter(cmd);

                    DA1.Fill(DS1, "tblHR_MobileBill");
                   
                    if (DS1.Tables[0].Rows.Count > 0)
                    {
                        ((Label)grv.FindControl("lblBillAmt")).Text = DS1.Tables[0].Rows[0][0].ToString();
                        ((TextBox)grv.FindControl("TxtBillAmt")).Visible = false;
                        ((CheckBox)grv.FindControl("CheckBox1")).Visible = false;
                        ((Label)grv.FindControl("lblExcessAmount")).Visible = true;
                       
                        string SelectBillID = fun.select("Id","tblHR_MobileBill","CompId='" + CompId + "' AND FinYearId='" + FinYearId + "' AND EmpId='" + empid + "'And BillMonth='" + DropDownList1.SelectedValue + "'");
                        SqlCommand cmdBillID = new SqlCommand(SelectBillID, con);
                        DataSet DSBillID = new DataSet();
                        SqlDataAdapter DABillID = new SqlDataAdapter(cmdBillID);
                        DABillID.Fill(DSBillID, "tblHR_MobileBill");

                        int MobBillId = Convert.ToInt32(DSBillID.Tables[0].Rows[0][0].ToString());

                        string CmdTaxlbl = fun.select("tblExciseser_Master.Value","tblExciseser_Master,tblHR_MobileBill"," tblExciseser_Master.Id=tblHR_MobileBill.Taxes AND tblHR_MobileBill.Id='" + MobBillId + "'");
                        SqlCommand Cmdtaxlbl = new SqlCommand(CmdTaxlbl, con);
                        DataSet DSTaxlbl = new DataSet();
                        SqlDataAdapter DATaxlbl = new SqlDataAdapter(Cmdtaxlbl);
                        DATaxlbl.Fill(DSTaxlbl, "tblExciseser_Master");
                        double Taxes = 0;
                        if (DSTaxlbl.Tables[0].Rows.Count>0)
                       {
                        ((Label)grv.FindControl("lblTaxes")).Text = DSTaxlbl.Tables[0].Rows[0][0].ToString();
                         Taxes = Convert.ToDouble(((Label)grv.FindControl("lblTaxes")).Text = DSTaxlbl.Tables[0].Rows[0][0].ToString());
                       }
                        double LimitAmt = Convert.ToDouble(((Label)grv.FindControl("lblLimitAmt")).Text);
                        double BillAmt = Convert.ToDouble(((Label)grv.FindControl("lblBillAmt")).Text = DS1.Tables[0].Rows[0][0].ToString());
                        double CalAmt = BillAmt-((BillAmt * Taxes) / (Taxes + 100));
                        
                        if ((CalAmt - LimitAmt) > 0)
                        {
                            ((Label)grv.FindControl("lblExcessAmount")).Text = Convert.ToString(Math.Round((CalAmt - LimitAmt), 2));
                        }
                        else
                        {
                            ((Label)grv.FindControl("lblExcessAmount")).Text = "0";
                        }
                    }
                    else
                    {
                        ((CheckBox)grv.FindControl("CheckBox1")).Visible = true;
                    }
                    string CmdTax = fun.select("Id","tblExciseser_Master","Live = 1");
                    SqlCommand Cmdtax = new SqlCommand(CmdTax, con);
                    DataSet DSTax = new DataSet();
                    SqlDataAdapter DATax = new SqlDataAdapter(Cmdtax);
                    DATax.Fill(DSTax, "tblExciseser_Master");
                    if (DSTax.Tables[0].Rows.Count>0)
                    {
                    ((DropDownList)grv.FindControl("DDLTaxes")).SelectedValue = DSTax.Tables[0].Rows[0][0].ToString();

                    }

                }
            }
            else
            {
                GridView1.Visible = false;
            }
        }
       catch(Exception ex){}
              
    }
    protected void GridView1_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        GridView1.PageIndex = e.NewPageIndex;
        this.DDLMonth();
    }

    
}
