=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_Print_Details.aspx.txt ===

<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="SupplierChallan_Print_Details.aspx.cs" Inherits="Module_Inventory_Transactions_SupplierChallan_Print_Details" Theme="Default" Title="ERP" %>

<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    </asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">

</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">

</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">

</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

    <script type="text/javascript">
        function OnChanged(sender, args)
        {
            ServerUtilities.SetTabIndex(sender.get_activeTabIndex());
        }
    </script>
    
      <cc1:TabContainer ID="TabContainer1" runat="server" ActiveTabIndex="0" 
                    AutoPostBack="true"
                    Width="100%" 
       >
                    <cc1:TabPanel runat="server" HeaderText="Supplier Challan" ID="Add">                    
<ContentTemplate>


<asp:Panel ID="Panel2" ScrollBars="Auto" runat="server"><table align="left" cellpadding="0" cellspacing="0" width="100%"><tr><td height="5px" ></td></tr><tr><td align="left"  valign="top"><table align="left" cellpadding="0" cellspacing="0" width="100%" ><tr><td valign="top" align="center"  ><asp:Panel ID="Panel1" ScrollBars="Auto" Height="430px" runat="server"><CR:CrystalReportViewer 
        ID="CrystalReportViewer1" runat="server" 
                    AutoDataBind="True" EnableDatabaseLogonPrompt="False" HasCrystalLogo="False"
                    EnableParameterPrompt="False" ReportSourceID="CrystalReportSource1" 
                    DisplayGroupTree="False" /><CR:CrystalReportSource ID="CrystalReportSource1" runat="server"><Report FileName="Module\Inventory\Transactions\Reports\SupplierChallan.rpt"></Report></CR:CrystalReportSource></asp:Panel></td></tr><tr><td valign="top" align="center"  ><asp:Button ID="Btncancel"  runat="server"  CssClass="redbox" 
                                            Text="Cancel" onclick="Btncancel_Click"  /></td></tr></table></td></tr></table></asp:Panel></ContentTemplate></cc1:TabPanel>
    
       <cc1:TabPanel ID="View" runat="server" HeaderText="Clear Challan">
                    <ContentTemplate><asp:Panel ID="Panel3" ScrollBars="Auto" runat="server"><table align="left" width="100%" cellpadding="0" cellspacing="0" ><tr><td height="5px" ></td></tr><tr><td align="left"  valign="top"><table align="left" cellpadding="0" width="100%" cellspacing="0" ><tr><td valign="top" align="center"  ><asp:Panel ID="Panel4" ScrollBars="Auto" Height="430px" runat="server"><CR:CrystalReportViewer ID="CrystalReportViewer2" runat="server" 
                    AutoDataBind="True" EnableDatabaseLogonPrompt="False" HasCrystalLogo="False"
                    EnableParameterPrompt="False" ReportSourceID="CrystalReportSource2" 
                    DisplayGroupTree="False"  /><CR:CrystalReportSource ID="CrystalReportSource2" runat="server"><Report FileName="Module\Inventory\Transactions\Reports\Challan_Clear.rpt"></Report></CR:CrystalReportSource></asp:Panel></td></tr><tr><td valign="top" align="center"  >&#160;<asp:Button ID="BtnCancel1"  runat="server"  CssClass="redbox" 
                                            Text="Cancel" onclick="BtnCancel1_Click"  /></td></tr></table></td></tr></table></asp:Panel>
                    </ContentTemplate>
                    </cc1:TabPanel>
    </cc1:TabContainer>
  
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>




=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_Print_Details.aspx.cs ===

ï»¿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;
using System.Threading;
using System.Globalization;

public partial class Module_Inventory_Transactions_SupplierChallan_Print_Details : System.Web.UI.Page
{

    clsFunctions fun = new clsFunctions();
    string sId = "";
    int CompId = 0;
    int fyid = 0;
    string supid = "";
    string str = "";
    SqlConnection con;    
    int id = 0;
    int PType = 0;
    string DelivTo = "";
    string DelAdd = "";
    string Person = "";
    string ContactNo = "";
    string VehicleNo = "";
    string Transporter = "";
    string GenBy1 = "";
    string DelivTo1 = "";
    string DelAdd1 = "";
    string Person1 = "";
    string ContactNo1 = "";
    ReportDocument cryRpt = new ReportDocument();
    ReportDocument cryRpt2 = new ReportDocument();

    string Key = string.Empty;
    string Key1 = string.Empty;

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {


            Key = Request.QueryString["Key"].ToString();
            Key1 = Request.QueryString["Key1"].ToString();
            PType = Convert.ToInt32(Request.QueryString["T"]);
            str = fun.Connection();
            con = new SqlConnection(str);
            try
            {
                CompId = Convert.ToInt32(Session["compid"]);
                fyid = Convert.ToInt32(Session["finyear"]);
                sId = Session["username"].ToString();
                id = Convert.ToInt32(Request.QueryString["Id"]);
                this.fillGrid();
                this.LoadGrid();

            }
            catch (Exception ex)
            {
            }
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;


            Key1 = Request.QueryString["Key1"].ToString();
            ReportDocument doc2 = (ReportDocument)Session[Key1];
            CrystalReportViewer2.ReportSource = doc2;
        }
    }

    protected void Page_Load(object sender, EventArgs e)
    {
        cryRpt = new ReportDocument();
        cryRpt2 = new ReportDocument();
    }

    public void fillGrid()
    {
         try
        {

            SqlDataAdapter da = new SqlDataAdapter("GetChallan_Details", con);
            da.SelectCommand.CommandType = CommandType.StoredProcedure;
            da.SelectCommand.Parameters.Add(new SqlParameter("@Id", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.SelectCommand.Parameters["@Id"].Value = id;
            da.SelectCommand.Parameters["@CompId"].Value = CompId;           
            DataSet DSitem = new DataSet();
            da.Fill(DSitem);
            DataColumn Rate = new DataColumn("Rate", typeof(double));
            DSitem.Tables[0].Columns.Add(Rate);           
            foreach(DataRow row in DSitem.Tables[0].Rows)
            {
                
                double Rate1 = 0;
                string dept = fun.select("max(Rate-(Rate*(Discount/100))) As rate", "tblMM_Rate_Register", "CompId='" + CompId + "'And ItemId='" + row.ItemArray[19] + "'");
                SqlCommand cmddpt = new SqlCommand(dept, con);
                DataSet DSRate = new DataSet();
                SqlDataAdapter dadpt = new SqlDataAdapter(cmddpt);
                dadpt.Fill(DSRate);
                if (DSRate.Tables[0].Rows.Count > 0 && DSRate.Tables[0].Rows[0]["rate"] != DBNull.Value)
                {
                    Rate1 = Convert.ToDouble(DSRate.Tables[0].Rows[0]["rate"]);
                }               
                row["Rate"] = Rate1;                
                
            }

            DataSet xsd = new SupplierChallan();
            xsd.Tables[0].Merge(DSitem.Tables[0]);
            xsd.AcceptChanges();
            cryRpt = new ReportDocument();
            cryRpt.Load(Server.MapPath("~/Module/Inventory/Transactions/Reports/SupplierChallan.rpt"));
            cryRpt.SetDataSource(xsd);

            string cmdStr = fun.select("SupplierName+'['+SupplierId+']' As SupName,MaterialDelAddress,ContactPerson,ContactNo", "tblMM_Supplier_master", "CompId='" + CompId + "' And SupplierId='" + DSitem.Tables[0].Rows[0]["SupplierId"] + "' ");
            SqlDataAdapter da3 = new SqlDataAdapter(cmdStr, con);
            DataSet ds = new DataSet();
            da3.Fill(ds, "tblMM_Supplier_master");
            if (ds.Tables[0].Rows.Count > 0)
            {
                DelivTo = ds.Tables[0].Rows[0]["SupName"].ToString();
                DelAdd = ds.Tables[0].Rows[0]["MaterialDelAddress"].ToString();
                Person = ds.Tables[0].Rows[0]["ContactPerson"].ToString();
                ContactNo = ds.Tables[0].Rows[0]["ContactNo"].ToString();
            }
            string PtintType = string.Empty;
            switch (PType)
            {
                case 0:
                    PtintType = "ORIGINAL";
                    break;
                case 1:
                    PtintType = "DUPLICATE";
                    break;
                case 2:
                    PtintType = "TRIPLICATE";
                    break;
                case 3:
                    PtintType = "ACKNOWLEDGEMENT";
                    break;
            }

            //   Company Address     
            string CompAdd = fun.select("*", "tblCompany_master", "CompId='" + CompId + "'");
            SqlCommand cmdCompAdd = new SqlCommand(CompAdd, con);
            SqlDataAdapter daCompAdd = new SqlDataAdapter(cmdCompAdd);
            DataSet dsCompAdd = new DataSet();
            daCompAdd.Fill(dsCompAdd, "tblCompany_master");
            string Address = dsCompAdd.Tables[0].Rows[0]["RegdAddress"].ToString() + ",\n" + fun.getCity(Convert.ToInt32(dsCompAdd.Tables[0].Rows[0]["RegdCity"]), 1) + ", " + fun.getState(Convert.ToInt32(dsCompAdd.Tables[0].Rows[0]["RegdState"]), 1) + ", " + fun.getCountry(Convert.ToInt32(dsCompAdd.Tables[0].Rows[0]["RegdCountry"]), 1) + " PIN No.-" + dsCompAdd.Tables[0].Rows[0]["RegdPinCode"].ToString() + ".\n" + "Ph No.-" + dsCompAdd.Tables[0].Rows[0]["RegdContactNo"].ToString() + ", " + " Fax No.-" + dsCompAdd.Tables[0].Rows[0]["RegdFaxNo"].ToString() + "\n" + "Email No.-" + dsCompAdd.Tables[0].Rows[0]["RegdEmail"].ToString();

            cryRpt.SetParameterValue("Address", Address);
            cryRpt.SetParameterValue("DelivTo", DelivTo);
            cryRpt.SetParameterValue("DelAdd", DelAdd);
            cryRpt.SetParameterValue("Person", Person);
            cryRpt.SetParameterValue("ContactNo", ContactNo);
            cryRpt.SetParameterValue("PtintType", PtintType);
            CrystalReportViewer1.ReportSource = cryRpt;
            Session[Key] = cryRpt;


        }
        catch (Exception ex)
        {
        }

    }

    public void LoadGrid()
    {
        try
        {
            SqlDataAdapter da = new SqlDataAdapter("GetSup_Challan_Clear_Edit", con);
            da.SelectCommand.CommandType = CommandType.StoredProcedure;
            da.SelectCommand.Parameters.Add(new SqlParameter("@Id", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@FinYearId", SqlDbType.VarChar));
            da.SelectCommand.Parameters["@Id"].Value = id;           
            da.SelectCommand.Parameters["@CompId"].Value = CompId;
            da.SelectCommand.Parameters["@FinYearId"].Value = fyid;
            DataSet DSitem = new DataSet();
            da.Fill(DSitem);
            DataSet xsd = new Challan_Clear();
            xsd.Tables[0].Merge(DSitem.Tables[0]);
            xsd.AcceptChanges();
            cryRpt2 = new ReportDocument();
            cryRpt2.Load(Server.MapPath("~/Module/Inventory/Transactions/Reports/Challan_Clear.rpt"));
            cryRpt2.SetDataSource(xsd);

            if (DSitem.Tables[0].Rows.Count > 0)
            {
                string sql2 = fun.select("Title+'. '+EmployeeName As EmpName", "tblHR_OfficeStaff", "CompId='" + CompId + "' AND EmpId='" + DSitem.Tables[0].Rows[0]["SessionId"] + "'");

                SqlCommand cmd2 = new SqlCommand(sql2, con);
                SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                DataSet DS2 = new DataSet();
                da2.Fill(DS2);

                if (DS2.Tables[0].Rows.Count > 0)
                {
                    GenBy1 = DS2.Tables[0].Rows[0]["EmpName"].ToString();
                }


                string cmdStr = fun.select("SupplierName+'['+SupplierId+']' As SupName,MaterialDelAddress,ContactPerson,ContactNo", "tblMM_Supplier_master", "CompId='" + CompId + "' And SupplierId='" + DSitem.Tables[0].Rows[0]["SupplierId"] + "' ");
                SqlDataAdapter da3 = new SqlDataAdapter(cmdStr, con);
                DataSet ds = new DataSet();
                da3.Fill(ds, "tblMM_Supplier_master");
                if (ds.Tables[0].Rows.Count > 0)
                {
                    DelivTo1 = ds.Tables[0].Rows[0]["SupName"].ToString();
                    DelAdd1 = ds.Tables[0].Rows[0]["MaterialDelAddress"].ToString();
                    Person1 = ds.Tables[0].Rows[0]["ContactPerson"].ToString();
                    ContactNo1 = ds.Tables[0].Rows[0]["ContactNo"].ToString();
                }
            }
            

            string Address = fun.CompAdd(CompId);
            cryRpt2.SetParameterValue("Address", Address);
            cryRpt2.SetParameterValue("GenBy", GenBy1);
            cryRpt2.SetParameterValue("DelivTo", DelivTo1);
            cryRpt2.SetParameterValue("DelAdd", DelAdd1);
            cryRpt2.SetParameterValue("Person", Person1);
            cryRpt2.SetParameterValue("ContactNo", ContactNo1);
            CrystalReportViewer2.ReportSource = cryRpt2;
            Session[Key1] = cryRpt2;
            
        }
        catch (Exception ex)
        {
        }
    }
    protected void BtnCancel1_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Inventory/Transactions/SupplierChallan_Print.aspx?ModId=9&SubModId=118");
    }
    protected void Btncancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Inventory/Transactions/SupplierChallan_Print.aspx?ModId=9&SubModId=118");
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        cryRpt.Close();
        cryRpt.Dispose();

        this.CrystalReportViewer2.Dispose();
        this.CrystalReportViewer2 = null;
        cryRpt2.Close();
        cryRpt2.Dispose();
        GC.Collect();
    }

    
}
