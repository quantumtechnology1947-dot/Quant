=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MIS/Reports/BOMCosting_Report.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="BOMCosting_Report.aspx.cs" Inherits="Module_MIS_Reports_BOMCosting_Report" Title="ERP" Theme="Default"  %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <style type="text/css">
        .style2
        {
            width: 914px;
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
    <p><br /></p><p></p>
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
    <table align="center" cellpadding="0" cellspacing="0" width="100%">
    
    <tr>
        <td align="left" valign="middle"  scope="col" 
                style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite" height="21">
        &nbsp;<b>BOM - Print</b></td>            
    </tr>
    
    <tr>
        <td align="center">
        <asp:Panel ID="Panel1" runat="server" Height="450px" ScrollBars="Auto">
            <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server" HasCrystalLogo="False"
                AutoDataBind="true" ReportSourceID="CrystalReportSource1" 
                DisplayGroupTree="False" EnableDatabaseLogonPrompt="False" 
                EnableParameterPrompt="False" ReuseParameterValuesOnRefresh="True" />
            <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
                <Report FileName="~\Module\Design\Transactions\Reports\BOM_Print_ALL.rpt">
                </Report>
            </CR:CrystalReportSource>
            </asp:Panel>
        </td>
    </tr>
     <tr>
     <td align="center" valign="top">
            <asp:Button ID="Button2" runat="server" CssClass="redbox" onclick="Button1_Click" Text="Cancel" />
        </td>
    </tr>
</table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MIS/Reports/BOMCosting_Report.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using CrystalDecisions.CrystalReports.Engine;
using System.Data.SqlClient;

public partial class Module_MIS_Reports_BOMCosting_Report : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    private ReportDocument report = new ReportDocument();
    DataTable DT = new DataTable();
    DataRow DR;
    string WONo = "";
    int CompId = 0;
    string sId = "";
    int FinYearId = 0;
    string StartDate = "";
    string UpToDate = "";
    string Key = string.Empty;
    int RadVal = 0;

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
                string connStr = fun.Connection();
                SqlConnection con = new SqlConnection(connStr);
                con.Open();

                if (Request.QueryString["wono"] != "")
                {
                    WONo = Request.QueryString["wono"].ToString();
                }
               
                RadVal = Convert.ToInt32(Request.QueryString["RadVal"].ToString());

           try
            {
                sId = Session["username"].ToString();
                CompId = Convert.ToInt32(Session["compid"]);
                FinYearId = Convert.ToInt32(Session["finyear"]);
                Key = Request.QueryString["Key"].ToString();
               
                if (Request.QueryString["wono"] != "")
                {
                    WONo = Request.QueryString["wono"].ToString();

                    string sql = "";
                    if (Request.QueryString["PId"] != "" && Request.QueryString["CId"] != "")
                    {
                        int PId = Convert.ToInt32(Request.QueryString["PId"].ToString());
                        int CId = Convert.ToInt32(Request.QueryString["CId"].ToString());
                        sql = fun.select("CId", "tblDG_BOM_Master", "WONo='" + WONo + "' AND CId='" + CId + "' AND PId='" + PId + "' AND FinYearId<='" + FinYearId + "'And CompId='" + CompId + "'");                       
                    }
                    else
                    {
                        sql = fun.select("CId", "tblDG_BOM_Master", "WONo='" + WONo + "' AND PId='0'AND FinYearId<='" + FinYearId + "'And CompId='" + CompId + "'");
                    }


                    SqlCommand cmd = new SqlCommand(sql, con);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    DataSet DS9 = new DataSet();
                    da.Fill(DS9, "tblDG_BOM_Master");

                    DT.Columns.Add("ItemCode", typeof(string));
                    DT.Columns.Add("ManfDesc", typeof(string));
                    DT.Columns.Add("UOM", typeof(string));
                    DT.Columns.Add("Qty", typeof(double));
                    DT.Columns.Add("BOMQty", typeof(double));
                    DT.Columns.Add("WONo", typeof(string));
                    DT.Columns.Add("CompId", typeof(int));
                    DT.Columns.Add("AC", typeof(string));
                    DT.Columns.Add("StartDate", typeof(string));
                    DT.Columns.Add("Rate", typeof(double));
                    DT.Columns.Add("Amount", typeof(double));

                    for (int i = 0; i < DS9.Tables[0].Rows.Count; i++)
                    {
                        this.getPrintnode(Convert.ToInt32(DS9.Tables[0].Rows[i]["CId"]), WONo, CompId);
                    }

                    DataTable DT2 = (DataTable)ViewState["myDT"];
                    // Get Company Name
                    string Company = fun.getCompany(CompId);
                    // Get Address
                    string Address = fun.CompAdd(CompId);
                    // Get Project Title
                    string Title = fun.getProjectTitle(WONo);

                    string reportPath = Server.MapPath("~/Module/MIS/Reports/BOM_Print_ALL.rpt");
                    report.Load(reportPath);
                    report.SetDataSource(DT2);
                    report.SetParameterValue("Company", Company);
                    report.SetParameterValue("Address", Address);
                    report.SetParameterValue("Title", Title);
                    CrystalReportViewer1.ReportSource = report;
                    CrystalReportViewer1.EnableViewState = true;
                    Session[Key] = report;

                }
            }
            catch (Exception ex)
            {

            }
        }
        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            if (Request.QueryString["wono"] != "")
            {
                WONo = Request.QueryString["wono"].ToString();
            }
            report = new ReportDocument();
            RadVal = Convert.ToInt32(Request.QueryString["RadVal"].ToString());
        }
        catch (Exception ex)
        {
        }
    }
    public void getPrintnode(int node, string wono, int compid)
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);

        try
        {
            DataSet DS = new DataSet();
            int CompId = compid;
            int FinYearId = Convert.ToInt32(Session["finyear"]);
            con.Open();

            string getparent2 = fun.select("tblDG_Item_Master.ItemCode,tblDG_Item_Master.Id,tblDG_BOM_Master.SysDate,tblDG_BOM_Master.Qty,tblDG_BOM_Master.PId,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_BOM_Master,tblDG_Item_Master,Unit_Master", "tblDG_BOM_Master.CId='" + node + "' And tblDG_BOM_Master.WONo='" + wono + "'  And tblDG_BOM_Master.CompId='" + CompId + "' AND tblDG_BOM_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id;");



            SqlCommand checkparent2 = new SqlCommand(getparent2, con);
            SqlDataAdapter daparent2 = new SqlDataAdapter(checkparent2);
            DataSet dsparent2 = new DataSet();
            daparent2.Fill(dsparent2);

            DR = DT.NewRow();
            //] = dsparent2.Tables[0].Rows[0]["ItemCode"].ToString();
            DR[0] = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(dsparent2.Tables[0].Rows[0]["Id"].ToString()));
            DR[1] = dsparent2.Tables[0].Rows[0]["ManfDesc"].ToString();
            DR[2] = dsparent2.Tables[0].Rows[0]["Symbol"].ToString();
            DR[3] = Convert.ToDouble(dsparent2.Tables[0].Rows[0]["Qty"]);
            DR[4] = Convert.ToDouble(fun.BOMRecurQty(wono, Convert.ToInt32(dsparent2.Tables[0].Rows[0]["PId"]), node, 1, CompId, FinYearId));

            //DR[5] = Convert.ToInt32(dsparent2.Tables[0].Rows[0]["Weldments"]);
            //DR[6] = Convert.ToInt32(dsparent2.Tables[0].Rows[0]["LH"]);
            //
            DR[5] = wono;
            DR[6] = Convert.ToInt32(CompId);
            DR[7] = "A";
            DR[8] = fun.FromDateDMY(dsparent2.Tables[0].Rows[0]["SysDate"].ToString());

            // to Get Rate 
            double Rate = 0;
            string x1 = "";
            string y1 = "";

            switch (RadVal)
            {
                case 0: // MAX
                    x1 = " max(Rate-(Rate*(Discount/100))) As rate ";
                    break;

                case 1: //MIN
                    x1 = " min(Rate-(Rate*(Discount/100))) As rate ";
                    break;

                case 2: //Average
                    x1 = " avg(Rate-(Rate*(Discount/100))) As rate ";
                    break;

                case 3: //Latest
                    x1 = " Rate-(Rate*(Discount/100)) As rate ";
                    y1 = " Order by Id Desc ";
                    break;
            }

            string SqlStr = fun.select(x1, "tblMM_Rate_Register", "CompId='" + CompId + "'And ItemId='" + dsparent2.Tables[0].Rows[0]["Id"].ToString() + "'" + y1);

            SqlCommand CmdRateReg = new SqlCommand(SqlStr, con);
            SqlDataAdapter DARateStr = new SqlDataAdapter(CmdRateReg);
            DataSet DSRateStr = new DataSet();
            DARateStr.Fill(DSRateStr, "tblMM_Rate_Register");

            if (DSRateStr.Tables[0].Rows.Count > 0 && DSRateStr.Tables[0].Rows[0][0] != DBNull.Value)
            {
                Rate = Convert.ToDouble(decimal.Parse((DSRateStr.Tables[0].Rows[0][0]).ToString()).ToString("N2"));
            }

            DR[9] = Rate;
            DR[10] = (Convert.ToDouble(fun.BOMRecurQty(wono, Convert.ToInt32(dsparent2.Tables[0].Rows[0]["PId"]), node, 1, CompId, FinYearId)) * Rate);
            DT.Rows.Add(DR);

            string getparent = fun.select("tblDG_Item_Master.Id,tblDG_BOM_Master.CId,tblDG_Item_Master.ItemCode,tblDG_BOM_Master.SysDate,tblDG_BOM_Master.PId,tblDG_BOM_Master.Qty,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_BOM_Master,tblDG_Item_Master,Unit_Master", "tblDG_BOM_Master.PId='" + node + "' And tblDG_BOM_Master.WONo='" + wono + "' And tblDG_BOM_Master.CompId='" + CompId + "'AND tblDG_BOM_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id");
            SqlCommand checkparent = new SqlCommand(getparent, con);
            SqlDataAdapter daparent = new SqlDataAdapter(checkparent);
            DataSet dsparent = new DataSet();
            daparent.Fill(dsparent);

            for (int h = 0; h < dsparent.Tables[0].Rows.Count; h++)
            {
                DR = DT.NewRow();
                DR[0] = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(dsparent.Tables[0].Rows[h]["Id"].ToString()));
                DR[1] = dsparent.Tables[0].Rows[h]["ManfDesc"].ToString();
                DR[2] = dsparent.Tables[0].Rows[h]["Symbol"].ToString();
                DR[3] = Convert.ToDouble(dsparent.Tables[0].Rows[h]["Qty"]);
                DR[4] = Convert.ToDouble(fun.BOMRecurQty(wono, Convert.ToInt32(dsparent.Tables[0].Rows[h]["PId"]), Convert.ToInt32(dsparent.Tables[0].Rows[h]["CId"]), 1, CompId, FinYearId));
                //DR[5] = Convert.ToInt32(dsparent.Tables[0].Rows[h]["Weldments"]);
                //DR[6] = Convert.ToInt32(dsparent.Tables[0].Rows[h]["LH"]);
                //DR[7] = Convert.ToInt32(dsparent.Tables[0].Rows[h]["RH"]);
                DR[5] = wono;
                DR[6] = Convert.ToInt32(CompId);
                DR[7] = "C";
                DR[8] = fun.FromDateDMY(dsparent.Tables[0].Rows[h]["SysDate"].ToString());


                // to Get Rate 
                double Rate2 = 0;
                string x2 = "";
                string y2 = "";

                switch (RadVal)
                {
                    case 0: // MAX
                        x2 = " max(Rate-(Rate*(Discount/100))) As rate ";
                        break;

                    case 1: //MIN
                        x2 = " min(Rate-(Rate*(Discount/100))) As rate ";
                        break;

                    case 2: //Average
                        x2 = " avg(Rate-(Rate*(Discount/100))) As rate ";
                        break;

                    case 3: //Latest
                        x2 = " Rate-(Rate*(Discount/100)) As rate ";
                        y2 = " Order by Id Desc ";
                        break;
                }


                string SqlStr1 = fun.select(x2, "tblMM_Rate_Register", "CompId='" + CompId + "'And ItemId='" + dsparent.Tables[0].Rows[h]["Id"].ToString() + "'" + y2);
                SqlCommand CmdRateReg1 = new SqlCommand(SqlStr1, con);
                SqlDataAdapter DARateStr1 = new SqlDataAdapter(CmdRateReg1);
                DataSet DSRateStr1 = new DataSet();
                DARateStr1.Fill(DSRateStr1, "tblMM_Rate_Register");

                if (DSRateStr1.Tables[0].Rows.Count > 0 && DSRateStr1.Tables[0].Rows[0][0] != DBNull.Value)
                {
                    Rate2 = Convert.ToDouble(decimal.Parse((DSRateStr1.Tables[0].Rows[0][0]).ToString()).ToString("N2"));
                }

                DR[9] = Rate2;
                DR[10] = (Convert.ToDouble(fun.BOMRecurQty(wono, Convert.ToInt32(dsparent.Tables[0].Rows[h]["PId"]), Convert.ToInt32(dsparent.Tables[0].Rows[h]["CId"]), 1, CompId, FinYearId)) * Rate2);

                DT.Rows.Add(DR);

                DataSet DS2 = new DataSet();

                string cmdStr2 = fun.select("tblDG_Item_Master.Id,tblDG_Item_Master.ItemCode,tblDG_BOM_Master.Qty,tblDG_BOM_Master.SysDate,tblDG_BOM_Master.CId,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_BOM_Master,tblDG_Item_Master,Unit_Master", "tblDG_BOM_Master.PId=" + dsparent.Tables[0].Rows[h]["CId"] + "And tblDG_BOM_Master.WONo='" + wono + "'  And tblDG_BOM_Master.CompId='" + CompId + "'AND tblDG_BOM_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id AND tblDG_BOM_Master.ItemId=tblDG_Item_Master.Id");
                SqlCommand cmd2 = new SqlCommand(cmdStr2, con);
                SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                da2.Fill(DS2);

                if (DS2.Tables[0].Rows.Count > 0)
                {
                    for (int j = 0; j < DS2.Tables[0].Rows.Count; j++)
                    {
                        this.getPrintnode(Convert.ToInt32(DS2.Tables[0].Rows[j]["CId"]), wono, compid);
                    }
                }
            }

            DT.AcceptChanges();
            ViewState["myDT"] = DT;

        }
        catch (Exception x)
        {
        }
        finally
        {
            con.Close();
            con.Dispose();

        }
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        Response.Redirect("BOMCosting.aspx?ModId=14&SubModId=");
    }
    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }

}
