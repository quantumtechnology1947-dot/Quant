=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/Dashboard.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Dashboard.aspx.cs" Inherits="Module_Design_Transactions_Dashboard" Title="ERP" Theme ="Default" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <style type="text/css">
        .style2
        {
            height: 35px;
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
    
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
   <%-- <table align="center" cellpadding="0" width="100%">
        <tr>
            <td align="left" valign="middle" style="background:url(../../../images/hdbg.JPG)" height="21" class="fontcsswhite"><b>
                &nbsp;Convert TPL Items into BOM</b></td>
        </tr>
        <tr>
            <td valign="top" align="center">
                <asp:GridView ID="GridView2" runat="server" CssClass="yui-datatable-theme" 
                    onrowdatabound="GridView2_RowDataBound" PageSize="13" Width="100%" 
                    AllowPaging="True" onpageindexchanging="GridView2_PageIndexChanging">
                    <Columns>
                        <asp:TemplateField HeaderText="SN">
                        <ItemTemplate>
                        <%# Container.DataItemIndex+1 %>
                        </ItemTemplate>
                        </asp:TemplateField>
                        <asp:TemplateField>
                        <HeaderTemplate>
                        <asp:CheckBox ID="chkSelectAll" runat="server"  AutoPostBack="true" OnCheckedChanged="chkSelectAll_CheckedChanged"/>
                        </HeaderTemplate>
                        <ItemTemplate>
                            <asp:CheckBox runat="server" ID="chkSelect" AutoPostBack="true"></asp:CheckBox>
                         </ItemTemplate>
                        </asp:TemplateField>
                        
                    </Columns>
                   
                </asp:GridView>
            </td>
        </tr>
        <tr>
            <td valign="middle" align="left" class="style2">
                &nbsp;
                <asp:Button ID="btncnv" runat="server" CssClass="redbox" Text="Add To BOM"  OnClientClick=" return confirmationAdd()" 
                    onclick="btncnv_Click" />
            &nbsp;&nbsp;&nbsp;&nbsp;
                <asp:Label ID="lblmsg" runat="server" ForeColor="Red" style="font-weight: 700"></asp:Label>
            </td>
        </tr>
    </table>--%>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/Dashboard.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_Design_Transactions_Dashboard : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    string connStr = "";
    SqlConnection con;
    int CompId=0;
    string SId="";
    int FinYear = 0;

    


    protected void Page_Load(object sender, EventArgs e)
    {
       // CompId = Convert.ToInt32(Session["compid"]);
       // SId = Session["username"].ToString();
       // FinYear = Convert.ToInt32(Session["finyear"]);
       //if (!IsPostBack)
       //{
       //    DataTable dt = (DataTable)ViewState["dtable"];
       //    this.makeGrid();
       // }
    }
//public void makeGrid()
    //{
    //   try
    //    {
    //        connStr = fun.Connection();
    //        con = new SqlConnection(connStr);
            
    //        DataTable dt = new DataTable();

    //        dt.Columns.Add("WO No", typeof(string));
    //        dt.Columns.Add("Assly No", typeof(string));
    //        dt.Columns.Add("ItemCode", typeof(string));
    //        dt.Columns.Add("Description", typeof(string));
    //        dt.Columns.Add("UOM", typeof(string));
    //        dt.Columns.Add("Unit Qty", typeof(string));
    //        dt.Columns.Add("TPL Qty", typeof(string));
    //        dt.Columns.Add("Weld", typeof(int));
    //        dt.Columns.Add("LH", typeof(int));
    //        dt.Columns.Add("RH", typeof(int));
    //        dt.Columns.Add("PId", typeof(MappingType));
    //        dt.Columns.Add("CId", typeof(MappingType));
    //        dt.Columns.Add("ItemId", typeof(MappingType));

    //        DataRow dr;
    //        string StrSql = fun.select(" *", "tblDG_TPL_Master", "CompId='" + CompId + "'AND FinYearId<='" + FinYear + "'AND ConvertToBOM='0' Order by WONo");
    //        SqlCommand cmd = new SqlCommand(StrSql, con);
    //        SqlDataAdapter da = new SqlDataAdapter(cmd);
    //        DataSet ds = new DataSet();
    //        da.Fill(ds);

    //        for (int k = 0; k < ds.Tables[0].Rows.Count; k++)
    //        {
    //            dr = dt.NewRow();

    //            dr[0] = ds.Tables[0].Rows[0]["WONo"].ToString();
    //            string StrWO = fun.select("ItemId", "tblDG_TPL_Master", "WONo='" + ds.Tables[0].Rows[k]["WONo"].ToString() + "' AND CompId='" + CompId + "'AND FinYearId<='" + FinYear + "' AND CId='" + Convert.ToInt32(ds.Tables[0].Rows[k]["PId"]) + "'");
    //            SqlCommand cmd4 = new SqlCommand(StrWO, con);
    //            SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
    //            DataSet ds4 = new DataSet();
    //            da4.Fill(ds4);

    //            string StrgetData = fun.select("*", "tblDG_Item_Master", "CompId='" + CompId + "'AND FinYearId<='" + FinYear + "' AND Id='" + Convert.ToInt32(ds.Tables[0].Rows[k]["ItemId"]) + "'");
    //            SqlCommand cmd2 = new SqlCommand(StrgetData, con);
    //            SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
    //            DataSet ds2 = new DataSet();
    //            da2.Fill(ds2);

    //            double AsslyNewqty = fun.RecurQty(ds.Tables[0].Rows[0]["WONo"].ToString(), Convert.ToInt32(ds.Tables[0].Rows[k]["PId"]), Convert.ToInt32(ds.Tables[0].Rows[k]["CId"]), 1,CompId,FinYear);

    //            if (ds4.Tables[0].Rows.Count > 0)
    //            {
    //                string q = fun.select("ItemCode as AsslyNo", "tblDG_Item_Master", "Id='" + ds4.Tables[0].Rows[0]["ItemId"] + "'AND CompId='" + CompId + "'AND FinYearId<='" + FinYear + "'");
    //                SqlCommand cmd5 = new SqlCommand(q, con);
    //                SqlDataAdapter da5 = new SqlDataAdapter(cmd5);
    //                DataSet ds5 = new DataSet();
    //                da5.Fill(ds5);

    //                dr[1] = ds5.Tables[0].Rows[0]["AsslyNo"].ToString();
    //                dr[2] = ds2.Tables[0].Rows[0]["ItemCode"].ToString();
    //            }
    //            else
    //            {
    //                dr[1] = ds2.Tables[0].Rows[0]["ItemCode"].ToString();
    //                dr[2] = "";
    //            }


    //            dr[3] = ds2.Tables[0].Rows[0]["ManfDesc"].ToString();

    //            string StrUom = fun.select("Symbol", "Unit_Master","Id='" + ds2.Tables[0].Rows[0]["UOMBasic"] + "'");
    //            SqlCommand cmd3 = new SqlCommand(StrUom, con);
    //            SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
    //            DataSet ds3 = new DataSet();
    //            da3.Fill(ds3);
    //            dr[4] = ds3.Tables[0].Rows[0]["Symbol"].ToString();
    //            dr[5] = ds.Tables[0].Rows[k]["Qty"].ToString();
    //            dr[6] = AsslyNewqty;
    //            dr[7] = ds.Tables[0].Rows[k]["Weldments"];
    //            dr[8] = ds.Tables[0].Rows[k]["LH"];
    //            dr[9] = ds.Tables[0].Rows[k]["RH"];
    //            dr[10] = ds.Tables[0].Rows[k]["PId"];
    //            dr[11] = ds.Tables[0].Rows[k]["CId"];
    //            dr[12] = ds.Tables[0].Rows[k]["ItemId"];

    //            dt.Rows.Add(dr);
    //        }
            
    //        GridView2.DataSource = dt;
    //        GridView2.DataBind();

    //        fun.EmptyGridFix(GridView2);

    //        if (GridView2.Rows.Count > 0)
    //        {
    //            btncnv.Visible = true;
    //        }
    //        else
    //        {
    //            btncnv.Visible = false;
    //        }

    //        ViewState["dtable"] = dt;
    //    }
    //    catch (Exception ex) {}
        
       
    //    finally
    //    {
    //        con.Close();
    //    }
    //}
    //protected void chkSelectAll_CheckedChanged(object sender, EventArgs e)
    //{
    //    try
    //    {
    //        CheckBox chkAll = (CheckBox)GridView2.HeaderRow.FindControl("chkSelectAll");

    //        if (chkAll.Checked == true)
    //        {
    //            foreach (GridViewRow gvRow in GridView2.Rows)
    //            {
    //                CheckBox chkSel = (CheckBox)gvRow.FindControl("chkSelect");
    //                chkSel.Checked = true;
    //            }
    //        }
    //        else
    //        {
    //            foreach (GridViewRow gvRow in GridView2.Rows)
    //            {
    //                CheckBox chkSel = (CheckBox)gvRow.FindControl("chkSelect");
    //                chkSel.Checked = false;
    //            }
    //        }
    //    }
    //    catch (Exception ee)
    //    { }
        
    //}


    //protected void GridView2_RowDataBound(object sender, GridViewRowEventArgs e)
    //{
    //    if (e.Row.RowType == DataControlRowType.DataRow)
    //    {
    //        e.Row.Cells[0].Width = 10;
    //        e.Row.Cells[0].HorizontalAlign = HorizontalAlign.Right;
    //        e.Row.Cells[1].Width = 7;
    //        e.Row.Cells[1].HorizontalAlign = HorizontalAlign.Center;
    //        e.Row.Cells[2].Width = 60;
    //        e.Row.Cells[2].HorizontalAlign = HorizontalAlign.Center;
    //        e.Row.Cells[3].Width = 100;
    //        e.Row.Cells[3].HorizontalAlign = HorizontalAlign.Left;
    //        e.Row.Cells[4].Width = 140;
    //        e.Row.Cells[4].HorizontalAlign = HorizontalAlign.Left;
    //        e.Row.Cells[5].Width = 270;
    //        e.Row.Cells[5].HorizontalAlign = HorizontalAlign.Left;
    //        e.Row.Cells[6].Width = 50;
    //        e.Row.Cells[6].HorizontalAlign = HorizontalAlign.Left;
    //        e.Row.Cells[7].HorizontalAlign = HorizontalAlign.Right;
    //        e.Row.Cells[8].HorizontalAlign = HorizontalAlign.Right;
    //        e.Row.Cells[9].HorizontalAlign = HorizontalAlign.Center;
    //    }
    //}

    //protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    //{
    //    GridView2.PageIndex = e.NewPageIndex;
    //    this.makeGrid();
    //}

    //protected void btncnv_Click(object sender, EventArgs e)
    //{
    //    connStr = fun.Connection();
    //    con = new SqlConnection(connStr);
    //    con.Open();
    //    DataTable mytb = (DataTable)ViewState["dtable"];
    //    try
    //    {
    //        foreach (GridViewRow gvRow in GridView2.Rows)
    //        {
    //            CheckBox chkSel = (CheckBox)gvRow.FindControl("chkSelect");

    //            if (chkSel.Checked == true)
    //            {
    //                int rowIndex = gvRow.RowIndex;
    //                string wono = mytb.Rows[rowIndex][0].ToString();
    //                int PId = Convert.ToInt32(mytb.Rows[rowIndex][10]);
    //                int CId = Convert.ToInt32(mytb.Rows[rowIndex][11]);
    //                int ItemId = Convert.ToInt32(mytb.Rows[rowIndex][12]);
    //                double Qty = Convert.ToDouble(mytb.Rows[rowIndex][5]);
    //                string sysdate = fun.getCurrDate();
    //                string CTime = fun.getCurrTime();

    //                if (PId == 0)
    //                {
    //                    string cmdBOM = fun.insert("tblDG_BOM_Master", "SysDate,SysTime,CompId,FinYearId,SessionId,WONo,PId,CId,ItemId,Qty", "'" + sysdate.ToString() + "','" + CTime.ToString() + "','" + CompId + "','" + FinYear + "','" + SId + "','" + wono + "','" + PId + "','" + CId + "','" + ItemId.ToString() + "','" + Qty + "'");

    //                    SqlCommand sqlBOM = new SqlCommand(cmdBOM, con);
    //                    sqlBOM.ExecuteNonQuery();

    //                    ///Updating UpdateWO Field 
    //                    string sqlwo = fun.update("SD_Cust_WorkOrder_Master", "UpdateWO='1'", "WONo='" + wono + "' And  CompId='" + CompId + "' ");
    //                    SqlCommand cmdwo = new SqlCommand(sqlwo, con);
    //                    cmdwo.ExecuteNonQuery();
    //                    string cmdupdate = fun.update("tblDG_TPL_Master", "ConvertToBOM=1", "WONo='" + wono + "' AND CompId='" + CompId + "' AND PId='" + PId + "' AND CId='" + CId + "' AND ItemId='" + ItemId + "'");

    //                    SqlCommand sqlupdate = new SqlCommand(cmdupdate, con);
    //                    sqlupdate.ExecuteNonQuery();
    //                }
    //                else
    //                {
    //                    string cmdcheck = fun.select("*", "tblDG_TPL_Master", "WONo='" + wono + "' AND CompId='" + CompId + "'AND FinYearId<='"+FinYear+"' AND CId='" + PId + "'");
    //                    SqlCommand sqlCheck = new SqlCommand(cmdcheck, con);
    //                    SqlDataAdapter daCheck = new SqlDataAdapter(sqlCheck);
    //                    DataSet dsCheck = new DataSet();
    //                    daCheck.Fill(dsCheck, "tblDG_TPL_Master");

    //                    if (Convert.ToInt32(dsCheck.Tables[0].Rows[0]["ConvertToBOM"]) == 1)
    //                    {
    //                        string cmdBOM = fun.insert("tblDG_BOM_Master", "SysDate,SysTime,CompId,FinYearId,SessionId,WONo,PId,CId,ItemId,Qty", "'" + sysdate.ToString() + "','" + CTime.ToString() + "','" + CompId + "','" + FinYear + "','" + SId + "','" + wono + "','" + PId + "','" + CId + "','" + ItemId.ToString() + "','" + Qty + "'");

    //                        SqlCommand sqlBOM = new SqlCommand(cmdBOM, con);
    //                        sqlBOM.ExecuteNonQuery();

    //                        ///Updating UpdateWO Field 
    //                        string sqlwo = fun.update("SD_Cust_WorkOrder_Master", "UpdateWO='1'", "WONo='" + wono + "' And  CompId='" + CompId + "' ");
    //                        SqlCommand cmdwo = new SqlCommand(sqlwo, con);
    //                        cmdwo.ExecuteNonQuery();

    //                        string cmdupdate = fun.update("tblDG_TPL_Master", "ConvertToBOM=1", "WONo='" + wono + "' AND CompId='" + CompId + "' AND PId='" + PId + "' AND CId='" + CId + "' AND ItemId='" + ItemId + "'");

    //                        SqlCommand sqlupdate = new SqlCommand(cmdupdate, con);
    //                        sqlupdate.ExecuteNonQuery();
    //                    }
    //                }

    //            }
    //        }
    //    }
    //    catch (Exception ee) {}
       
    //   finally
    //    {
    //        Page.Response.Redirect(Page.Request.Url.ToString(), true);
    //    }
    //}

}
