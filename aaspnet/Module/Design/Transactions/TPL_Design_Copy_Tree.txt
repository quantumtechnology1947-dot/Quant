=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/TPL_Design_Copy_Tree.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="TPL_Design_Copy_Tree.aspx.cs" Inherits="Module_Design_Transactions_TPL_Design_Copy_Tree"  Theme ="Default"%>
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<%@ Register TagPrefix="telerik" Namespace="Telerik.Web.UI" Assembly="Telerik.Web.UI" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>ERP</title>
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
</head>
<body  topmargin="0" bottommargin="0" leftmargin="0" rightmargin="0">
    <form id="form1" runat="server">    
    <table Width="100%" cellpadding="0" cellspacing="0" >                             
    <tr>
<td align="left" class="fontcss">&nbsp;<b>Wo No: </b>
    <asp:Label ID="Label2" runat="server"></asp:Label>
    &nbsp;&nbsp; <asp:CheckBox  runat="server" ID="CheckBox1"
AutoPostBack="True"  Visible="true" oncheckedchanged="CheckBox1_CheckedChanged" /><b>Expand Tree&nbsp;&nbsp;&nbsp;&nbsp;                 <asp:Label ID="lblasslymsg" runat="server" 
        style="color: #FF3300; font-weight: 700"></asp:Label>
                        </b></td>
    </tr>
    
    <tr>
<td>

<telerik:RadAjaxLoadingPanel ID="RadAjaxLoadingPanel1" runat="server" 
        Height="16px" >
       
      </telerik:RadAjaxLoadingPanel>
   
    
    <telerik:RadAjaxPanel ID="RadAjaxPanel1" LoadingPanelID="RadAjaxLoadingPanel1" 
        runat="server" Width="100%" HorizontalAlign="NotSet">
       
        <telerik:RadTreeList runat="server" ID="RadTreeList1" AllowPaging="True" PageSize="8"
            DataKeyNames="CId" OnItemCommand="RadTreeList1_ItemCommand"           
            OnPageSizeChanged="RadTreeList1_PageSizeChanged" OnPageIndexChanged="RadTreeList1_PageIndexChanged"
            ParentDataKeyNames="PId"
            onautogeneratedcolumncreated="RadTreeList1_AutoGeneratedColumnCreated" 
             CssClass="yui-datatable-theme">        
             
            <Columns>            
           <telerik:TreeListSelectColumn UniqueName="ck" >
          
               <HeaderStyle Width="60px" />
          
            </telerik:TreeListSelectColumn>
                        <telerik:TreeListBoundColumn DataField="CId" HeaderText="Assembly" 
                            UniqueName="CId"  Visible="False
                            "/>
                         <telerik:TreeListBoundColumn DataField="WONo" HeaderText="WorkOrder" 
                            UniqueName="WONo"  Visible="False"/>
                          <telerik:TreeListBoundColumn DataField="PId" HeaderText="Parent Node" 
                            UniqueName="PId" Visible="False"/>
                            <telerik:TreeListBoundColumn DataField="ItemId" HeaderText="ItemId" 
                            UniqueName="ItemId"  Visible="False"/>                            
                            <telerik:TreeListBoundColumn DataField="Unit Qty" HeaderText="Quantity" 
                            UniqueName="Unit Qty"  Visible="False"/>
                         <telerik:TreeListBoundColumn DataField="Weld" HeaderText="Weldments" 
                            UniqueName="Weld"  Visible="False"/>
                             <telerik:TreeListBoundColumn DataField="LH" HeaderText="LH" 
                            UniqueName="LH" Visible="False"/>
                            <telerik:TreeListBoundColumn DataField="RH" HeaderText="RH" 
                            UniqueName="RH"  Visible="False"/>
                                                                  
            </Columns>
            <PagerStyle CssClass="fontcss" />
            
            <HeaderStyle Font-Bold="True" CssClass="fontcss" />
            
            <SelectedItemStyle CssClass="fontcss" />
            
            <PagerTemplate>
                <table width="100%">
                    <tr>
                        <td align="center" width="7%">
<asp:Button ID="btnPageFirst" runat="server" Text=" " CssClass="rtlPageFirst" CommandName="Page"
CommandArgument="First" />
<asp:Button ID="btnPagePrev" runat="server" Text=" " CssClass="rtlPagePrev" CommandName="Page"
CommandArgument="Prev" /> 
                        </td>
                        <td align="center" width="4%">
                        <%# (int)DataBinder.Eval(Container, "Paging.CurrentPageIndex") + 1 %>
                        </td>
                        <td align="center" width="6%">
                        <asp:Panel runat="server" ID="TreeListPagerPlaceHolder" />
<asp:Button ID="btnPageNext" runat="server" Text=" " CssClass="rtlPageNext" CommandName="Page"
CommandArgument="Next" />
<asp:Button ID="btnPageLast" runat="server" Text=" " CssClass="rtlPageLast" CommandName="Page"
CommandArgument="Last" />
<td>
<asp:Button ID="btnCopy" runat="server" CssClass="redbox"  OnClientClick=" return confirmationCopy()" 
            onclick="btnCopy_Click" Text="Copy" />
            <asp:Button ID="BtnCancel" runat="server" CssClass="redbox" 
            onclick="BtnCancel_Click" Text="Cancel" />
</td>

                        </td>
                        <td align="right">
                                Displaying page
                                <%# (int)DataBinder.Eval(Container, "Paging.CurrentPageIndex") + 1 %>
                                of
                                <%# (int)DataBinder.Eval(Container, "Paging.PageCount") %>
                                / Items
                                <%# (int)DataBinder.Eval(Container, "Paging.FirstIndexInPage") + 1 %>
                                to
                                <%# (int)DataBinder.Eval(Container, "Paging.LastIndexInPage") + 1 %>
                                of
                                <%# DataBinder.Eval(Container, "Paging.DataSourceCount")%>
                        </td>
                    </tr>
                </table>
            </PagerTemplate>
          
            
        </telerik:RadTreeList>  
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <br />
        
     </telerik:RadAjaxPanel>
    <asp:ScriptManager ID="ScriptManager1" runat="server">
    </asp:ScriptManager>
    </td>
</tr>  
    </table>
    
   
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/TPL_Design_Copy_Tree.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using Telerik.Web.UI;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Security.Cryptography;
public partial class Module_Design_Transactions_TPL_Design_Copy_Tree : System.Web.UI.Page
{

    clsFunctions fun = new clsFunctions();
    public int pid = 0;
    public int cid = 0;
    string sId = "";
    int CompId = 0;
    int FinYearId = 0;
    public string wonosrc = "";
    public string wonodest = "";
    
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            wonosrc = (Request.QueryString["WONoSrc"].ToString());
            wonodest = (Request.QueryString["WONoDest"].ToString());
            pid = Convert.ToInt32((Request.QueryString["DestPId"]));
            cid = Convert.ToInt32((Request.QueryString["DestCId"]));
            sId = Session["username"].ToString();
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            if (!Page.IsPostBack)
            {
                RadTreeList1.DataSource = GetDataTable();
                RadTreeList1.DataBind();
                RadTreeList1.ExpandAllItems();
                CheckBox1.Checked = true;
                this.DataBind();
            }

        }
        catch (Exception ex)
        {

        }
    }

    public DataTable GetDataTable()
    {
        String ConnString = ConfigurationManager.ConnectionStrings["LocalSqlServer"].ConnectionString;
        SqlConnection conn = new SqlConnection(ConnString);
        SqlDataAdapter adapter = new SqlDataAdapter();
        DataTable myDataTable = new DataTable();
        DataSet DS = new DataSet();        
        Label2.Text = wonosrc;
       

        try
        {

            conn.Open();
            string StrSql = fun.select("ItemId,WONo,PId,CId,Qty,Weldments,LH,RH ", "tblDG_TPL_Master", "WONo='" + wonosrc + "' AND CompId=" + CompId + " AND FinYearId<='" + FinYearId + "' Order By PId ASC");
            adapter.SelectCommand = new SqlCommand(StrSql, conn);

            adapter.Fill(DS, "tblDG_TPL_Master");
            myDataTable.Columns.Add(new System.Data.DataColumn("ItemId", typeof(int)));
            myDataTable.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("PId", typeof(int)));
            myDataTable.Columns.Add(new System.Data.DataColumn("CId", typeof(int)));
            myDataTable.Columns.Add(new System.Data.DataColumn("Item Code", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("Manf Desc", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("UOM", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("Unit Qty", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("TPL Qty", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("Weld", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("LH", typeof(string)));
            myDataTable.Columns.Add(new System.Data.DataColumn("RH", typeof(string)));
            DataRow dr;

            for (int p = 0; p < DS.Tables[0].Rows.Count; p++)
            {

                dr = myDataTable.NewRow();
                dr[0] = DS.Tables[0].Rows[p][0];
                dr[1] = DS.Tables[0].Rows[p][1].ToString();
                dr[2] = DS.Tables[0].Rows[p][2];
                dr[3] = DS.Tables[0].Rows[p][3];
                dr[7] = decimal.Parse(DS.Tables[0].Rows[p][4].ToString()).ToString("N3");
                string icSql = fun.select("*", "tblDG_Item_Master", "Id='" + dr[0] + "'AND CompId=" + CompId + " AND FinYearId<='" + FinYearId + "'");
                SqlCommand cmditemCode = new SqlCommand(icSql, conn);
                SqlDataAdapter Dr = new SqlDataAdapter(cmditemCode);
                DataSet DsIt = new DataSet();
                Dr.Fill(DsIt, "tblDG_Item_Master");
                dr[4] = DsIt.Tables[0].Rows[0]["ItemCode"].ToString();
                dr[5] = DsIt.Tables[0].Rows[0]["ManfDesc"].ToString();

                string utSql = fun.select("*", "Unit_Master", "Id='" + Convert.ToInt32(DsIt.Tables[0].Rows[0]["UOMBasic"]) + "'");
                SqlCommand cmdut = new SqlCommand(utSql, conn);
                SqlDataAdapter Drut = new SqlDataAdapter(cmdut);
                DataSet Dsut = new DataSet();
                Drut.Fill(Dsut, "tblDG_Item_Master");
                dr[6] = Dsut.Tables[0].Rows[0]["Symbol"].ToString();

                List<double> g = new List<double>();
                g = fun.TreeQty(wonosrc, Convert.ToInt32(dr[2]), Convert.ToInt32(dr[3]));

                double h = 1;

                for (int j = 0; j < g.Count; j++)
                {
                    h = h * g[j];
                }

                dr[8] = decimal.Parse(h.ToString()).ToString("N3");
                dr[9] = DS.Tables[0].Rows[p]["Weldments"].ToString();
                dr[10] = DS.Tables[0].Rows[p]["LH"].ToString();
                dr[11] = DS.Tables[0].Rows[p]["RH"].ToString();
                g.Clear();
                myDataTable.Rows.Add(dr);
            }


        }
        catch (Exception ex)
        {
        }
        finally
        {
            conn.Close();
        }
        return myDataTable;
    }

    protected void RadTreeList1_ItemCommand(object sender, TreeListCommandEventArgs e)
    {
        try
        {
        if (e.CommandName == RadTreeList.ExpandCollapseCommandName)
        {

            RadTreeList1.DataSource = GetDataTable();
            RadTreeList1.DataBind();
        }
        }

        catch (Exception ex) { }

    }

    protected void RadTreeList1_PageIndexChanged(object source, Telerik.Web.UI.TreeListPageChangedEventArgs e)
    {
        RadTreeList1.CurrentPageIndex = e.NewPageIndex;
        RadTreeList1.DataSource = GetDataTable();
        RadTreeList1.DataBind();
    }
    protected void RadTreeList1_PageSizeChanged(object source, Telerik.Web.UI.TreeListPageSizeChangedEventArgs e)
    {
        RadTreeList1.DataSource = GetDataTable();
        RadTreeList1.DataBind();
    }


    protected void RadTreeList1_AutoGeneratedColumnCreated(object sender, TreeListAutoGeneratedColumnCreatedEventArgs e)
    {
        
        if (e.Column.HeaderText == "ItemId")
        {
            e.Column.Visible = false;
        }

        if (e.Column.HeaderText == "PId")
        {
            e.Column.Visible = false;
        }
        if (e.Column.HeaderText == "CId")
        {
            e.Column.Visible = false;
        }
        if (e.Column.HeaderText == "ECN")
        {
            e.Column.Visible = false;
        }
        if (e.Column.HeaderText == "WONo")
        {
            e.Column.Visible = false;
        }

        if (e.Column.HeaderText == "Item Code")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(150);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
        }

        if (e.Column.HeaderText == "Manf Desc")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(340);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            
        }

        if (e.Column.HeaderText == "Unit Qty")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(100);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
        }
        if (e.Column.HeaderText == "TPL Qty")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(100);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
        }

        if (e.Column.HeaderText == "UOM")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(60);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
        }
        if (e.Column.HeaderText == "Weld")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(40);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
        }

        if (e.Column.HeaderText == "LH")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(40);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
        }

        if (e.Column.HeaderText == "RH")
        {
            e.Column.HeaderStyle.Width = Unit.Pixel(40);
            e.Column.HeaderStyle.HorizontalAlign = HorizontalAlign.Center;
            e.Column.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
        }
    }


    protected void btnCopy_Click(object sender, EventArgs e)
    {
        try
        {           
            int SrcCid = 0;            
            SrcCid = Convert.ToInt32(RadTreeList1.SelectedItems[0]["CId"].Text);             
            // Copy Assembly           
            if (cid == SrcCid)
            {                
                Response.Redirect("TPL_Design_CopyWo.aspx?WONoSrc=" + wonosrc + "&WONoDest=" + wonodest + "&DestPId=" + pid + "&DestCId=" + cid + "&ModId=3&SubModId=23&msg=Selection of Assly/Item is incorrect.");
                
            }
            else
            {
                fun.getnode(SrcCid, wonosrc, wonodest, CompId, sId, FinYearId, pid, cid);
                Response.Redirect("TPL_Design_CopyWo.aspx?WONoSrc=" +wonosrc + "&WONoDest=" +wonodest + "&DestPId=" + pid+ "&DestCId=" + cid + "&ModId=3&SubModId=23&msg=TPL is Copied sucessfuly in WONo:"+wonodest+" from WONo:"+wonosrc+".");
            }           
        
        }
        catch (Exception ex)
        {

        }
        finally
        {
            
        }

    }

    
    protected void BtnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("TPL_Design_CopyWo.aspx?WONoSrc=" + wonosrc+ "&WONoDest=" + wonodest + "&DestPId=" +pid + "&DestCId=" + cid + "");
    }

    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {
        if (CheckBox1.Checked == true)
        {
            RadTreeList1.DataSource = GetDataTable();
            RadTreeList1.DataBind();
            RadTreeList1.ExpandAllItems();
        }
        else
        {
            RadTreeList1.DataSource = GetDataTable();
            RadTreeList1.DataBind();
            RadTreeList1.CollapseAllItems();
        }
    }
   
}
 