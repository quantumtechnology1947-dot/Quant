=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/WISWONO_Print_.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="WISWONO_Print_.aspx.cs" Inherits="Module_Inventory_Transactions_WISWONO_Print_" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<%@ Register Assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304"
    Namespace="CrystalDecisions.Web" TagPrefix="CR" %>
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
    <title></title>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</head>
<body>
    <form id="form1" runat="server">
    <div style="width:auto;">  
    <table width="100%">
    <tr>
    <td align="Left">
     <CR:CrystalReportViewer ID="CrystalReportViewer1"  EnableDatabaseLogonPrompt="false" DisplayGroupTree="False"
      ReportSourceID="CrystalReportSource1"  runat="server" AutoDataBind="true" HasCrystalLogo="False" />
 <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
<Report FileName="~\Module\Inventory\Transactions\Reports\WONOWISe.rpt"></Report> 

</CR:CrystalReportSource>
    
    </td>
    </tr>
    </table>

          
    </div>
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/WISWONO_Print_.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_Inventory_Transactions_WISWONO_Print_ : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();   
    int CompId = 0;
    int FinYearId = 0;  
    string x = "";
    string z = "";
    string FDate = "";
    string TDate = "";
    string Key = string.Empty;
    double OverHeads = 0;
    private ReportDocument report = new ReportDocument();
    //public void prints()
    //{
    //    string connStr = fun.Connection();           
    //    SqlConnection con = new SqlConnection(connStr);
    //    DataTable dt = new DataTable();
      
    //   // try
    //    {
    //        con.Open();
    //        x = (Request.QueryString["x"].ToString());
    //        z = (Request.QueryString["z"].ToString());
    //        OverHeads = Convert.ToDouble(Request.QueryString["OverHeads"].ToString());          
    //        FDate = (Request.QueryString["FDate"].ToString());
    //        TDate = (Request.QueryString["TDate"].ToString());
    //        CompId = Convert.ToInt32(Session["compid"]);
    //        FinYearId = Convert.ToInt32(Session["finyear"]);
            
    //        dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("UOMBasic", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("WISNo", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));
    //        dt.Columns.Add(new System.Data.DataColumn("IssuedQty", typeof(double)));
    //        dt.Columns.Add(new System.Data.DataColumn("GenBy", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_FDate", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_TDate", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_FDate", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_TDate", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskProjectTitle", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("TaskProjectLeader", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("SysDate", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
    //        dt.Columns.Add(new System.Data.DataColumn("StockQty", typeof(double)));
    //        dt.Columns.Add(new System.Data.DataColumn("Rate", typeof(double)));
         
    //        DataRow dr;
    //        string ItemCode = "";
    //        string ManfDesc = "";
    //        string UomBasic = "";
    //        string wono = "";

    //        string sql = fun.select("Distinct tblInv_WIS_Details.ItemId,tblInv_WIS_Master.WISNo,tblInv_WIS_Master.WONo,tblInv_WIS_Master.Id,tblInv_WIS_Master.SessionId,tblInv_WIS_Master.SysDate", "tblInv_WIS_Master,tblInv_WIS_Details", "tblInv_WIS_Master.Id=tblInv_WIS_Details.MId " + x + z + " order by tblInv_WIS_Master.WISNo Desc");


           
    //        SqlCommand Cmdgrid = new SqlCommand(sql, con);
    //        SqlDataReader rdr = Cmdgrid.ExecuteReader();
                     
    //        while (rdr.Read())          
    //        {
    //            string sqlWoNo = string.Empty;
               
    //            sqlWoNo = fun.select("Id", "SD_Cust_WorkOrder_Master", "WONo='" + rdr["WONo"].ToString() + "'");
    //            SqlCommand cmdWoNo = new SqlCommand(sqlWoNo, con);
    //            SqlDataReader rdrWoNo = cmdWoNo.ExecuteReader();
    //            rdrWoNo.Read();

    //            string sqlInvWoNo = string.Empty;

    //            sqlInvWoNo = fun.select("Id", "tblACC_SalesInvoice_Master", "WONo like '" + rdrWoNo["Id"].ToString() + ",'");
    //            SqlCommand cmdInvWoNo = new SqlCommand(sqlInvWoNo, con);
    //            SqlDataReader rdrInvWoNo = cmdInvWoNo.ExecuteReader();
    //            rdrInvWoNo.Read();
               
    //            if (rdrInvWoNo.HasRows == false)
    //            {
                   
    //                double qty = 0; 
    //                double Issuedqty = 0;
    //                dr = dt.NewRow();
    //                wono = rdr["WONo"].ToString();
    //                string sql3 = fun.select("PId,CId,IssuedQty", "tblInv_WIS_Details", "MId='" + rdr["Id"].ToString() + "' AND ItemId='" + rdr["ItemId"].ToString() + "'");
    //                SqlCommand Cmdgrid3 = new SqlCommand(sql3, con);
    //                SqlDataAdapter dagrid3 = new SqlDataAdapter(Cmdgrid3);
    //                DataSet DS3 = new DataSet();
    //                dagrid3.Fill(DS3);
    //                double rate = 0;
                
    //                for (int j = 0; j < DS3.Tables[0].Rows.Count; j++)
    //                {
    //                    Issuedqty += Convert.ToDouble(DS3.Tables[0].Rows[j]["IssuedQty"]);
    //                }

    //                qty = fun.AllComponentBOMQty(CompId, wono, rdr["ItemId"].ToString(), FinYearId);
    //                string StrIcode = fun.select("ItemCode,ManfDesc,UOMBasic,StockQty", "tblDG_Item_Master", "Id='" + rdr["ItemId"].ToString() + "'");
    //                SqlCommand cmdIcode = new SqlCommand(StrIcode, con);
    //                SqlDataAdapter daIcode = new SqlDataAdapter(cmdIcode);
    //                DataSet DSIcode = new DataSet();
    //                daIcode.Fill(DSIcode);
    //                // For ItemCode
    //                if (DSIcode.Tables[0].Rows.Count > 0)
    //                {
    //                    ItemCode = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(rdr["ItemId"].ToString()));
    //                    // For Purch Desc
    //                    ManfDesc = DSIcode.Tables[0].Rows[0]["ManfDesc"].ToString();
    //                    // For Manf. Desc                      
    //                    string sqlPurch = fun.select("Symbol", "Unit_Master", "Id='" + DSIcode.Tables[0].Rows[0]["UOMBasic"].ToString() + "'");
    //                    SqlCommand cmdPurch = new SqlCommand(sqlPurch, con);
    //                    SqlDataAdapter daPurch = new SqlDataAdapter(cmdPurch);
    //                    DataSet DSPurch = new DataSet();
    //                    daPurch.Fill(DSPurch);
    //                    if (DSPurch.Tables[0].Rows.Count > 0)
    //                    {
    //                        UomBasic = DSPurch.Tables[0].Rows[0]["Symbol"].ToString();
    //                    }

    //                    string SqlStr = fun.select("max(Rate-(Rate*(Discount/100))) As rate", "tblMM_Rate_Register", "CompId='" + CompId + "'And ItemId='" + rdr["ItemId"].ToString() + "'");
    //                    SqlCommand CmdRateReg = new SqlCommand(SqlStr, con);
    //                    SqlDataAdapter Darate = new SqlDataAdapter(CmdRateReg);
    //                    DataSet DsRate = new DataSet();
    //                    Darate.Fill(DsRate);
    //                    if (DsRate.Tables[0].Rows[0][0] != DBNull.Value)
    //                    {
    //                        rate = Convert.ToDouble(DsRate.Tables[0].Rows[0][0]) + (Convert.ToDouble(DsRate.Tables[0].Rows[0][0]) * (OverHeads / 100));
    //                    }
    //                }
    //                dr[0] = ItemCode;
    //                dr[1] = ManfDesc;
    //                dr[2] = UomBasic;
    //                dr[3] = rdr["WISNo"].ToString();
    //                dr[4] = qty;
    //                dr[5] = Convert.ToDouble(decimal.Parse(Issuedqty.ToString()).ToString("N3"));
    //                dr[7] = CompId;
    //                dr[14] = fun.FromDate(rdr["SysDate"].ToString());
    //                dr[15] = wono;
    //                dr[16] = DSIcode.Tables[0].Rows[0]["StockQty"].ToString();
    //                dr[17] = rate;
    //                dt.Rows.Add(dr);
    //                dt.AcceptChanges();

    //            }
    //        }             

    //        string reportPath = Server.MapPath("~/Module/Inventory/Transactions/Reports/WONOWISe.rpt");
    //        report.Load(reportPath);
    //        report.SetDataSource(dt);
    //        string Company = fun.getCompany(CompId);
    //        report.SetParameterValue("Company", Company);
    //        string Address = fun.CompAdd(CompId);
    //        report.SetParameterValue("Address", Address);
    //        CrystalReportViewer1.ReportSource = report;
    //        Session[Key] = report;

    //    }
    //  // catch (Exception ex)
    //    {

    //    }
    //  // finally
    //    {
    //        //dt.Clear();
    //        //dt.Dispose();
    //        //con.Close();
    //        //con.Dispose();
    //    }
    //}

    public void prints()
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        DataTable dt = new DataTable();

        try
        {
            con.Open();
            x = (Request.QueryString["x"].ToString());
            z = (Request.QueryString["z"].ToString());
            OverHeads = Convert.ToDouble(Request.QueryString["OverHeads"].ToString());
            FDate = (Request.QueryString["FDate"].ToString());
            TDate = (Request.QueryString["TDate"].ToString());
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("UOMBasic", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WISNo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("IssuedQty", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("GenBy", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_FDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_TDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_FDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_TDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("TaskProjectTitle", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("TaskProjectLeader", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("SysDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("StockQty", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("Rate", typeof(double)));
            DataRow dr;
            string sql = fun.select("ItemCode,Description,UOM,StockQty,Sum(WISQty) AS WISQty,ItemId,SysDate,WISNo,WONo,WOId", "View_WIP_Final", " FinYearId<=" + FinYearId + "" + x + z + " group by ItemCode,Description,UOM,StockQty,ItemId,SysDate,WISNo,WONo,WOId order by WISNo Desc");
            SqlCommand Cmdgrid = new SqlCommand(sql, con);
            SqlDataReader rdr = Cmdgrid.ExecuteReader();           
            while (rdr.Read())
            {
                string ItemCode = "";
                string ManfDesc = "";
                string UomBasic = "";
                string wono = "";
                double qty = 0;
                double Issuedqty = 0;
                double rate = 0;
                string sqlInvWoNo = string.Empty;
                sqlInvWoNo = fun.select("Id", "tblACC_SalesInvoice_Master", "WONo like '" + rdr["WoId"].ToString() + ",'");
                SqlCommand cmdInvWoNo = new SqlCommand(sqlInvWoNo, con);
                SqlDataReader rdrInvWoNo = cmdInvWoNo.ExecuteReader();
                rdrInvWoNo.Read();
                //if (rdrInvWoNo.HasRows == false)
                {
                    dr = dt.NewRow();
                    wono = rdr["WONo"].ToString();
                    Issuedqty = Convert.ToDouble(rdr["WISQty"]);
                    qty = fun.AllComponentBOMQty(CompId, wono, rdr["ItemId"].ToString(), FinYearId);
                    ItemCode = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(rdr["ItemId"].ToString()));
                    ManfDesc = rdr["Description"].ToString();
                    UomBasic = rdr["UOM"].ToString();
                    SqlCommand cmdrate = new SqlCommand("Select MAX(dbo.tblMM_Rate_Register.Rate - dbo.tblMM_Rate_Register.Rate * (dbo.tblMM_Rate_Register.Discount / 100)) AS rate from tblMM_Rate_Register where ItemId='" + rdr["ItemId"]+ "'", con);
                    SqlDataReader rdrRate = cmdrate.ExecuteReader();
                    rdrRate.Read();
                    if (rdrRate["rate"] != DBNull.Value)
                    {
                        rate = Convert.ToDouble(rdrRate["rate"]) + (Convert.ToDouble(rdrRate["rate"]) * (OverHeads / 100));
                    }
                    dr[0] = ItemCode;
                    dr[1] = ManfDesc;
                    dr[2] = UomBasic;
                    dr[3] = rdr["WISNo"].ToString();
                    dr[4] = qty;
                    dr[5] = Convert.ToDouble(decimal.Parse(Issuedqty.ToString()).ToString("N3"));
                    dr[7] = CompId;
                    dr[14] = fun.FromDate(rdr["SysDate"].ToString());
                    dr[15] = wono;
                    dr[16] = rdr["StockQty"].ToString();
                    dr[17] = rate;
                    dt.Rows.Add(dr);
                    dt.AcceptChanges();
                }
            }
            string reportPath = Server.MapPath("~/Module/Inventory/Transactions/Reports/WONOWISe.rpt");
            report.Load(reportPath);
            report.SetDataSource(dt);
            string Company = fun.getCompany(CompId);
            report.SetParameterValue("Company", Company);
            string Address = fun.CompAdd(CompId);
            report.SetParameterValue("Address", Address);
            CrystalReportViewer1.ReportSource = report;
            Session[Key] = report;

        }
        catch (Exception ex)
        {

        }
        finally
        {
            dt.Clear();
            dt.Dispose();
            con.Close();
            con.Dispose();
        }
    }
    protected void Page_Init(object sender, EventArgs e)
    {
        Key = Request.QueryString["Key"].ToString();
        if (!IsPostBack)
        {
           this.prints();
        }
        else
        {
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }
    protected void Page_Load(object sender, EventArgs e)
    {
        report = new ReportDocument();
    }
    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }
}
