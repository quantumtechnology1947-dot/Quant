=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/ProjectManagement/Transactions/MaterialCreditNote_MCN_Print_Report.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="MaterialCreditNote_MCN_Print_Report.aspx.cs" Inherits="Module_ProjectManagement_Transactions_MaterialCreditNote_MCN_Print_Report" Title="ERP" Theme="Default" %>

<%@ Register Assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304"
    Namespace="CrystalDecisions.Web" TagPrefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server"> 
      
    
    <table align="center" cellpadding="0" cellspacing="0" width="100%">
        <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)" colspan="2">
        &nbsp;<b>Material Credit Note [MCN] - Print</b>
            </td>
        </tr>
        <tr>
            <td align="center">
                <asp:Panel ID="Panel1" runat="server" Height="430px" ScrollBars="Auto" 
                    Width="100%">
                    <CR:CrystalReportSource ID="CrystalReportSource1"   runat="server">
        <Report FileName="Module\ProjectManagement\Transactions\Reports\MaterialCreditNote.rpt">
        </Report>
    </CR:CrystalReportSource>
<CR:CrystalReportViewer ID="CrystalReportViewer1" DisplayGroupTree="False"  EnableDatabaseLogonPrompt="false" EnableParameterPrompt="false"  ReportSourceID="CrystalReportSource1" runat="server" HasCrystalLogo="False"
    AutoDataBind="true" />
                </asp:Panel>
                    
                    </td>
            <td align="center" valign="top">
                &nbsp;</td>
        </tr>
        <tr>
            <td align="center" class="style4" colspan="2">
                <asp:Button ID="Cancel" runat="server" Text="Cancel" CssClass="redbox" 
                    valign="top" onclick="Cancel_Click"/>
                    
                    </td>
        </tr>
    </table>
    
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/ProjectManagement/Transactions/MaterialCreditNote_MCN_Print_Report.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using CrystalDecisions.CrystalReports.Engine;
using System.Data.SqlClient;

public partial class Module_ProjectManagement_Transactions_MaterialCreditNote_MCN_Print_Report : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    int FinYearId = 0;
    string SId = "";
    string Id = "";
    int WOId = 0;
    string WONo = "";
    private ReportDocument report = new ReportDocument();
    string Key = string.Empty;

    protected void Page_Init(object sender, EventArgs e)
    {

        string str = fun.Connection();
        SqlConnection con = new SqlConnection(str);
        DataSet MainDS = new DataSet();
        DataTable dt = new DataTable();

        try
        {
            if (!string.IsNullOrEmpty(Request.QueryString["WONo"]))
            {
                WONo = Request.QueryString["WONo"].ToString();
            }
            if (!string.IsNullOrEmpty(Request.QueryString["WOId"]))
            {
                WOId = Convert.ToInt32(Request.QueryString["WOId"].ToString());
            }
            SId = Session["username"].ToString();
            Key = Request.QueryString["Key"].ToString();
            CompId = Convert.ToInt32(Session["compid"]);
            Id = (Request.QueryString["Id"].ToString());
            FinYearId = Convert.ToInt32(Session["finyear"]);

            if (!IsPostBack)
            {
                string cmdStr3 = fun.select("tblPM_MaterialCreditNote_Master.SessionId, tblPM_MaterialCreditNote_Master.CompId,tblPM_MaterialCreditNote_Master.Id ,tblPM_MaterialCreditNote_Master.SysDate,tblPM_MaterialCreditNote_Master.MCNNo,tblPM_MaterialCreditNote_Details.PId,tblPM_MaterialCreditNote_Details.CId,tblPM_MaterialCreditNote_Details.MCNQty,tblPM_MaterialCreditNote_Details.Id As DId", "tblPM_MaterialCreditNote_Master,tblPM_MaterialCreditNote_Details", "tblPM_MaterialCreditNote_Master.Id=tblPM_MaterialCreditNote_Details.MId AND tblPM_MaterialCreditNote_Master.WONo='" + WONo + "' AND tblPM_MaterialCreditNote_Master.FinYearId<='" + FinYearId + "' AND tblPM_MaterialCreditNote_Master.CompId='" + CompId + "'   AND tblPM_MaterialCreditNote_Master.Id='" + Id + "' ");

                SqlCommand cmd3 = new SqlCommand(cmdStr3, con);
                SqlDataAdapter DA3 = new SqlDataAdapter(cmd3);
                DataSet DS3 = new DataSet();
                DA3.Fill(DS3);


                string EmpName = "";
                dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));//0           
                dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));//1
                dt.Columns.Add(new System.Data.DataColumn("Description", typeof(string)));//2
                dt.Columns.Add(new System.Data.DataColumn("UOM", typeof(string)));//3
                dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));//4
                dt.Columns.Add(new System.Data.DataColumn("MCNQty", typeof(double)));//5
                dt.Columns.Add(new System.Data.DataColumn("MCNNo", typeof(string)));//6
                dt.Columns.Add(new System.Data.DataColumn("MCNDate", typeof(string)));//7         
                dt.Columns.Add(new System.Data.DataColumn("QAQty", typeof(double)));//8
                dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));//8

                DataRow dr;
                for (int i = 0; i < DS3.Tables[0].Rows.Count; i++)
                {
                    dr = dt.NewRow();
                    int Pid = 0;
                    int Cid = 0;
                    double QAqty = 0;
                    dr[0] = Convert.ToInt32(DS3.Tables[0].Rows[i]["Id"]);
                    Pid = Convert.ToInt32(DS3.Tables[0].Rows[i]["PId"]);
                    Cid = Convert.ToInt32(DS3.Tables[0].Rows[i]["CId"]);


                    string StrDA = fun.select("QAQty", "tblQc_AuthorizedMCN", " FinYearId<='" + FinYearId + "'And CompId='" + CompId + "' And  MCNId='" + DS3.Tables[0].Rows[i]["Id"].ToString() + "' AND MCNDId='" + DS3.Tables[0].Rows[i]["DId"].ToString() + "'");

                    SqlCommand cmdDA = new SqlCommand(StrDA, con);
                    SqlDataAdapter DADA = new SqlDataAdapter(cmdDA);
                    DataSet DSDA = new DataSet();
                    DADA.Fill(DSDA);
                    if (DSDA.Tables[0].Rows.Count > 0)
                    {
                        QAqty = Convert.ToDouble(decimal.Parse(DSDA.Tables[0].Rows[0]["QAQty"].ToString()).ToString("N3"));
                    }


                    string StrSql = fun.select("*", "tblDG_BOM_Master", "WONo='" + WONo + "' AND FinYearId<='" + FinYearId + "'And CompId='" + CompId + "' And  PId='" + DS3.Tables[0].Rows[i]["PId"].ToString() + "' AND CId='" + DS3.Tables[0].Rows[i]["CId"].ToString() + "'");

                    SqlCommand cmdwono = new SqlCommand(StrSql, con);
                    SqlDataAdapter DAwono = new SqlDataAdapter(cmdwono);
                    DataSet DSwono = new DataSet();
                    DAwono.Fill(DSwono);

                    dr[4] = Convert.ToDouble(decimal.Parse(DSwono.Tables[0].Rows[0]["Qty"].ToString()).ToString("N3"));

                    string icSql = fun.select("*", "tblDG_Item_Master", "Id='" + Convert.ToInt32(DSwono.Tables[0].Rows[0]["ItemId"]) + "'");
                    SqlCommand cmditemCode = new SqlCommand(icSql, con);
                    SqlDataAdapter Dr = new SqlDataAdapter(cmditemCode);
                    DataSet DsIt = new DataSet();
                    Dr.Fill(DsIt, "tblDG_Item_Master");

                    if (DsIt.Tables[0].Rows.Count > 0)
                    {
                        if (DsIt.Tables[0].Rows[0]["CId"] != DBNull.Value)
                        {
                            dr[1] = DsIt.Tables[0].Rows[0]["ItemCode"].ToString();
                        }
                        else
                        {
                            dr[1] = DsIt.Tables[0].Rows[0]["PartNo"].ToString();
                        }

                        dr[2] = DsIt.Tables[0].Rows[0]["ManfDesc"].ToString();

                        string utSql = fun.select("*", "Unit_Master", "Id='" + Convert.ToInt32(DsIt.Tables[0].Rows[0]["UOMBasic"]) + "'");
                        SqlCommand cmdut = new SqlCommand(utSql, con);
                        SqlDataAdapter Drut = new SqlDataAdapter(cmdut);
                        DataSet Dsut = new DataSet();
                        Drut.Fill(Dsut, "Unit_Master");

                        if (Dsut.Tables[0].Rows.Count > 0)
                        {
                            dr[3] = Dsut.Tables[0].Rows[0]["Symbol"].ToString();
                        }


                    }


                    dr[5] = Convert.ToDouble(DS3.Tables[0].Rows[i]["MCNQty"]);
                    dr[6] = DS3.Tables[0].Rows[i]["MCNNo"].ToString();
                    dr[7] = fun.FromDateDMY(DS3.Tables[0].Rows[i]["SysDate"].ToString());
                    dr[8] = QAqty;
                    dr[9] = Convert.ToDouble(DS3.Tables[0].Rows[i]["CompId"]);

                    string StrCheckedBy = fun.select(" Title,EmployeeName ", " tblHR_OfficeStaff ", " EmpId='" + DS3.Tables[0].Rows[i]["SessionId"].ToString() + "'And CompId='" + CompId + "'");
                    SqlCommand CmdCheckedBy = new SqlCommand(StrCheckedBy, con);
                    SqlDataAdapter DACKBy = new SqlDataAdapter(CmdCheckedBy);
                    DataSet DSCKBy = new DataSet();
                    DACKBy.Fill(DSCKBy, "tblHR_OfficeStaff");

                    EmpName = DSCKBy.Tables[0].Rows[0]["Title"].ToString() + ". " + DSCKBy.Tables[0].Rows[0]["EmployeeName"].ToString();
                    dt.Rows.Add(dr);
                    dt.AcceptChanges();
                }


                MainDS.Tables.Add(dt);

                DataSet xsdds = new MCN();
                xsdds.Tables[0].Merge(MainDS.Tables[0]);

                xsdds.AcceptChanges();

                string reportPath = Server.MapPath("~/Module/ProjectManagement/Transactions/Reports/MaterialCreditNote.rpt");
                report.Load(reportPath);
                report.SetDataSource(xsdds);

                string Address = fun.CompAdd(CompId);
                report.SetParameterValue("Address", Address);

                report.SetParameterValue("WONo", WONo);
                string Customer = "";
                string Project = "";
                string StrSql1 = fun.select("TaskProjectTitle,CustomerId", "SD_Cust_WorkOrder_Master", "CompId='" + CompId + "' AND FinYearId<='" + FinYearId + "' AND WONo='" + WONo + "'");

                SqlCommand cmdwono1 = new SqlCommand(StrSql1, con);
                SqlDataAdapter DAwono1 = new SqlDataAdapter(cmdwono1);
                DataSet DSwono1 = new DataSet();
                DAwono1.Fill(DSwono1);
                if (DSwono1.Tables[0].Rows.Count > 0)
                {
                    Project = DSwono1.Tables[0].Rows[0]["TaskProjectTitle"].ToString();
                    string StrCust = fun.select("CustomerName,CustomerId", "SD_Cust_Master", "CompId='" + CompId + "'  AND  CustomerId='" + DSwono1.Tables[0].Rows[0]["CustomerId"].ToString() + "'");

                    SqlCommand cmdCust = new SqlCommand(StrCust, con);
                    SqlDataAdapter daCust = new SqlDataAdapter(cmdCust);
                    DataSet DSCust = new DataSet();
                    daCust.Fill(DSCust);
                    if (DSCust.Tables[0].Rows.Count > 0)
                    {
                        Customer = DSCust.Tables[0].Rows[0]["CustomerName"].ToString() + " [ " + DSCust.Tables[0].Rows[0]["CustomerId"].ToString() + " ]";

                    }
                    report.SetParameterValue("Customer", Customer);
                    report.SetParameterValue("Project", Project);
                    report.SetParameterValue("EMPName", EmpName);
                    CrystalReportViewer1.ReportSource = report;
                    Session[Key] = report;

                }
            }
            else
            {
                Key = Request.QueryString["Key"].ToString();
                ReportDocument doc = (ReportDocument)Session[Key];
                CrystalReportViewer1.ReportSource = doc;
            }


        }

        catch (Exception ex)
        {
        }
        finally
        {
            MainDS.Clear();
            MainDS.Dispose();
            dt.Clear();
            dt.Dispose();
            con.Close();
            con.Dispose();

        }
    }

    protected void Page_Load(object sender, EventArgs e)
    {
        report = new ReportDocument();
    }

    protected void Cancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/ProjectManagement/Transactions/MaterialCreditNote_MCN_Print_Details.aspx?WONo=" + WONo + "&WOId=" + WOId + "&ModId=7&SubModId=127");
    }
    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }
}
