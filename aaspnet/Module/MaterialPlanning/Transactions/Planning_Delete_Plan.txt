=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialPlanning/Transactions/Planning_Delete_Plan.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Planning_Delete_Plan.aspx.cs" Inherits="Module_MaterialPlanning_Transactions_Planning_Delete_Plan" Title="ERP" Theme="Default" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
 <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <style type="text/css">
        .style2
        {
            font-size: 14px;
            font-weight: bold;
        }
    </style>
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

 <table width="100%" align="center" cellpadding="0" cellspacing="0" border="0" Class="fontcss">
        <tr>
            <td>
                <table width="100%" align="center" cellpadding="0" cellspacing="0">
                    <tr >                   
                        <td height="21px" style="background:url(../../../images/hdbg.JPG)"  class="fontcsswhite" >&nbsp;<strong> Material Planning - Delete&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="style2">WONo : </span>
            <asp:Label ID="lblWono" runat="server" style="font-size: 14px"></asp:Label>
                            </strong></td>
                    </tr>   
              </table>
              
              </td>
              
             </tr>
             
             <tr>
                <td>
                <table width="100%" align="center" cellpadding="0" cellspacing="0" class="box3">
                    <tr>
        <td align="justify" height="25" >
        
          
            &nbsp;<span class="style2"> </span>
&nbsp;&nbsp; <b style="font-size: small">PL No:</b>
        
          
            
         
            <asp:TextBox ID="Txtsearch" runat="server" Width="150px" CssClass="box3"></asp:TextBox>
           
        
              &nbsp;<asp:Button ID="Button1" runat="server" CssClass="redbox" 
                onclick="Button1_Click" Text="Search" />
            
        
        
              &nbsp;<asp:Button ID="btnCancel" runat="server" CssClass="redbox" 
                onclick="btnCancel_Click" Text="Cancel" />
            
        
        
              </td>
        </tr>

             <tr>
            <td width="48%" align="left" valign="top">                     
  
                     <asp:GridView ID="GridView1"  runat="server" 
                    AllowPaging="True"  CssClass="yui-datatable-theme"
                    AllowSorting="True" AutoGenerateColumns="False"
                    DataKeyNames="Id" RowStyle-HorizontalAlign ="Center"
     
                     Width="96%" 
                    ShowFooter="false" onpageindexchanged="GridView1_PageIndexChanged" 
                         onrowcommand="GridView1_RowCommand" 
                         onpageindexchanging="GridView1_PageIndexChanging" PageSize="20" >
           
<RowStyle HorizontalAlign="Center"></RowStyle>
           
            <Columns>
              <asp:TemplateField HeaderText="SN">
                                    <ItemTemplate><%#Container.DataItemIndex+1  %></ItemTemplate>
                                    <HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Right" Width="5%" VerticalAlign="Top" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="False">                           <ItemTemplate>
              <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>'> </asp:Label>
              </ItemTemplate>
              
                                    </asp:TemplateField>                                       
                                    
              <asp:TemplateField HeaderText="FinYear">
                         <ItemTemplate>
                        <asp:Label ID="lblFinYear" runat="server" Text='<%#Eval("FinYear") %>'></asp:Label>
                        </ItemTemplate>
                                        <ItemStyle Width="10%" HorizontalAlign="Center" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="FinYearId" Visible="false">
                         <ItemTemplate>
                        <asp:Label ID="lblFinYearId" runat="server" Text='<%#Eval("FinYearId") %>'></asp:Label>
                        </ItemTemplate>
                                         <ItemStyle HorizontalAlign="Center" />
                        </asp:TemplateField>
                        
                        <asp:TemplateField HeaderText="PL No">
                                    <ItemTemplate>
                                 <%-- <asp:Label ID="lblPLNo" Visible="false"  runat="server" Text='<%# Eval("PLNo") %>'></asp:Label>--%>
                                    <asp:LinkButton  runat="server"    CommandName="Sel" Text='<%# Eval("PLNo") %>' ID="btnSel"  />
                                                </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="10%" HorizontalAlign="Center" />
                                    </asp:TemplateField>            
                        
                           <asp:TemplateField HeaderText="Plan Date"  >
                                    <ItemTemplate>
                                    <asp:Label ID="lblplnDate"   runat="server" Text='<%# Eval("PlanDate") %>'></asp:Label>         
                                                </ItemTemplate>
                                                 <ItemStyle Width="10%" HorizontalAlign="Center" />
                                    <HeaderStyle HorizontalAlign="Center" />                              
                                    
                                    </asp:TemplateField>                        
                       
                       <asp:TemplateField HeaderText="Gen.By">
                                    <ItemTemplate>
                                    <asp:Label ID="lblgenBy" runat="server" Text='<%# Eval("GenBy") %>'></asp:Label> 
                                    </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="40%" HorizontalAlign="Left" />
                                  
                                    
                                    </asp:TemplateField>              
            
 
            </Columns> 
            <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>
           
      </asp:GridView>
                    </td>
                    
                    <td width="52%" valign="top">
                    
                   <%-- <asp:Label ID="lblPLNo" Visible="false"  runat="server" Text='<%# Eval("PLNo") %>'></asp:Label>--%>
<asp:Panel ID="Up" runat="server">
                       
                     <asp:GridView ID="GridView2"  runat="server" 
                    AllowPaging="True"  CssClass="yui-datatable-theme"
                    AllowSorting="True" AutoGenerateColumns="False"
                    DataKeyNames="Id" RowStyle-HorizontalAlign ="Center"     
                     Width="100%" 
                    ShowFooter="false" onpageindexchanged="GridView2_PageIndexChanged" 
                         onrowcommand="GridView2_RowCommand" 
                         onpageindexchanging="GridView2_PageIndexChanging" PageSize="20" >
           
<RowStyle HorizontalAlign="Center"></RowStyle>
           
            <Columns>
              <asp:TemplateField HeaderText="SN">
                                    <ItemTemplate><%#Container.DataItemIndex+1  %></ItemTemplate>
                                    <HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Right" Width="5%" VerticalAlign="Top" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="False">                           <ItemTemplate>
              <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>'> </asp:Label>
              </ItemTemplate>
              
                                    </asp:TemplateField> 
                                    
                                    <asp:TemplateField HeaderText=" "  >
                                   <ItemTemplate>
                                   <asp:LinkButton ID="btndelete" Text="Delete" OnClientClick="return confirmationDelete();" CommandName="Del" runat="server"></asp:LinkButton>
             
              </ItemTemplate>
               <ItemStyle HorizontalAlign="center" Width="4%" VerticalAlign="Top" />
                                    </asp:TemplateField>                                       
                                    
              <asp:TemplateField HeaderText="Item Code">
                         <ItemTemplate>
                        <asp:Label ID="lblitemcode" runat="server" Text='<%#Eval("ItemCode") %>'></asp:Label>
                        </ItemTemplate>
                                        <ItemStyle Width="10%" HorizontalAlign="Center" />
                        </asp:TemplateField>                       
                        
                        
                        <asp:TemplateField HeaderText="Description">
                                    <ItemTemplate>
                                 <asp:Label ID="lbldesc" runat="server" Text='<%# Eval("ManfDesc") %>'></asp:Label>
                                    
                                                </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="20%" HorizontalAlign="left" />
                                    </asp:TemplateField>            
                        
                           <asp:TemplateField HeaderText="UOM"  >
                                    <ItemTemplate>
                                    <asp:Label ID="lbluom"   runat="server" Text='<%# Eval("Symbol") %>'></asp:Label>         
                                                </ItemTemplate>
                                                 <ItemStyle Width="8%" HorizontalAlign="Center" />
                                    <HeaderStyle HorizontalAlign="Center" />                              
                                    
                                    </asp:TemplateField>                        
                       
                       <asp:TemplateField HeaderText="BOM Qty">
                                    <ItemTemplate>
                                    <asp:Label ID="lblbomQty" runat="server" Text='<%# Eval("BOMQty") %>'></asp:Label> 
                                    </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="10%" HorizontalAlign="right" />
                                  
                                    
                                    </asp:TemplateField>    
                                    
                                    <asp:TemplateField HeaderText="Plan Type">
                                    <ItemTemplate>
                                    <asp:Label ID="lblplantype" runat="server" Text='<%# Eval("TypeOfPlan") %>'></asp:Label> 
                                    </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="8%" HorizontalAlign="Center" />
                                  
                                    
                                    </asp:TemplateField>  
                                    
                                    <asp:TemplateField HeaderText="Item Code After Plan">
                                    <ItemTemplate>
                                    <asp:Label ID="lblItemAfter" runat="server" Text='<%# Eval("ItemCode1") %>'></asp:Label> 
                                    </ItemTemplate>
                                    <HeaderStyle HorizontalAlign="Center" />
                                    <ItemStyle Width="10%" HorizontalAlign="Center" />
                                  
                                    
                                    </asp:TemplateField>    
                                    
                                    <asp:TemplateField HeaderText="MId" SortExpression="MId" Visible="False">                           <ItemTemplate>
              <asp:Label ID="lblMId" runat="server" Text='<%#Eval("MId") %>'> </asp:Label>
              </ItemTemplate>
              
                                    </asp:TemplateField>              
            
 
            </Columns> 
            <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>
           
      </asp:GridView>
                    <%--</fieldset>
                    
                    </ContentTemplate>
                    
                    </asp:UpdatePanel>--%>
                     </asp:Panel>
                    
                    </td>
             </tr>
              </table>
            </td>
        </tr>
        
        </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialPlanning/Transactions/Planning_Delete_Plan.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_MaterialPlanning_Transactions_Planning_Delete_Plan : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    int FinYearId = 0;
    string No = "";
    string Wono = "";
    string str = "";
    SqlConnection con ;
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            Wono = Request.QueryString["WONo"].ToString();
            lblWono.Text = Wono;
            str = fun.Connection();
            con = new SqlConnection(str);
            if (!IsPostBack)
            {
                this.fillgrid(No);              
                Up.Visible = true;
            }
            
        }
        catch (Exception ex)
        {

        }

    }
    public void fillgrid(string no)
    {
        
        try
        {

            con.Open();

            string x = "";
            //if (DrpField.SelectedValue == "1")
            {
                if (Txtsearch.Text != "")
                {
                    x = " AND PLNo='" + Txtsearch.Text + "'";
                }
            }
            
            string sql = fun.select("Id,SysDate,SessionId,WONo,PLNo,FinYearId", "tblMP_Material_Master", "CompId='" + CompId + "' and FinYearId<='" + FinYearId + "'" + x + " And WONo='"+Wono+"' Order By Id Desc");
            SqlCommand cmd = new SqlCommand(sql, con);
            SqlDataAdapter da = new SqlDataAdapter(cmd);
            DataSet DS = new DataSet();
            da.Fill(DS);
            DataTable dt = new DataTable();
            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("FinYear", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("PlanDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("GenBy", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("PLNo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("ProjectTitle", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("FinYearId", typeof(string)));


            DataRow dr;
            for (int i = 0; i < DS.Tables[0].Rows.Count; i++)
            {
                dr = dt.NewRow();

                string sqlGenBy = fun.select("Title+'. '+EmployeeName AS GenBy", "tblHR_OfficeStaff", "EmpId='" + DS.Tables[0].Rows[i]["SessionId"].ToString() + "'");
                SqlCommand cmdGenBy = new SqlCommand(sqlGenBy, con);
                SqlDataAdapter daGenBy = new SqlDataAdapter(cmdGenBy);
                DataSet DSGenBy = new DataSet();
                daGenBy.Fill(DSGenBy);

                if (DSGenBy.Tables[0].Rows.Count > 0)
                {

                    dr[3] = DSGenBy.Tables[0].Rows[0]["GenBy"].ToString();
                }
                dr[2] = fun.FromDateDMY(DS.Tables[0].Rows[i]["SysDate"].ToString());
                dr[6] = fun.getProjectTitle(DS.Tables[0].Rows[i]["WONo"].ToString());

                string sqlFin = fun.select("FinYear", "tblFinancial_master", "FinYearId='" + DS.Tables[0].Rows[i]["FinYearId"] + "'");
                SqlCommand cmdFinYr = new SqlCommand(sqlFin, con);
                SqlDataAdapter daFin = new SqlDataAdapter(cmdFinYr);
                DataSet DSFin = new DataSet();
                daFin.Fill(DSFin);

                dr[0] = DS.Tables[0].Rows[i]["Id"].ToString();

                ViewState["Id"] = DS.Tables[0].Rows[i]["Id"].ToString();
                dr[1] = DSFin.Tables[0].Rows[0]["FinYear"].ToString();
                dr[4] = DS.Tables[0].Rows[i]["PLNo"].ToString();
                ViewState["Plan"] = DS.Tables[0].Rows[i]["PLNo"].ToString();
                dr[5] = DS.Tables[0].Rows[i]["WONo"].ToString();
                dr[7] = DS.Tables[0].Rows[i]["FinYearId"].ToString();
                dt.Rows.Add(dr);
                dt.AcceptChanges();

            }

            GridView1.DataSource = dt;
            GridView1.DataBind();

        }
        catch (Exception ex)
        {

        }
        finally
        {
            con.Close();
        }
    }
    public void fillgrid2()
    {
        try
        {
            string PLNo = "";
            int PlnId = 0;
            if (!string.IsNullOrEmpty(ViewState["Id"].ToString()))
            {
                PlnId = Convert.ToInt32(ViewState["Id"]);
            }
            if (!string.IsNullOrEmpty(ViewState["Plan"].ToString()))
            {
                PLNo = ViewState["Plan"].ToString();
            }
            DataTable dt = new DataTable();
            dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Symbol", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(Int32)));
            dt.Columns.Add(new System.Data.DataColumn("TypeOfPlan", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("MId", typeof(Int32)));
            dt.Columns.Add(new System.Data.DataColumn("ItemCode1", typeof(string)));

            string sqlgetPlDate = "SELECT tblMP_Material_Master.SysDate,tblMP_Material_Master.Id As MId,tblMP_Material_Detail.ItemId,tblMP_Material_Detail.Id,tblMP_Material_Detail.RM,tblMP_Material_Detail.PRO,tblMP_Material_Detail.FIN FROM tblMP_Material_Master,tblMP_Material_Detail where tblMP_Material_Master.Id=tblMP_Material_Detail.Mid And  tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_Master.CompId=" + CompId + " And  tblMP_Material_Master.Id='" + PlnId + "'  and tblMP_Material_Master.PLNo='" + PLNo + "'";

            SqlCommand cmdgetPlDate = new SqlCommand(sqlgetPlDate, con);
            SqlDataAdapter dagetPlDate = new SqlDataAdapter(cmdgetPlDate);
            DataSet DSgetPlDate = new DataSet();
            dagetPlDate.Fill(DSgetPlDate);
            DataRow dr;
            for (int i2 = 0; i2 < DSgetPlDate.Tables[0].Rows.Count; i2++)
            {
                dr = dt.NewRow();
                string sqlItem99 = fun.select("ItemCode,UOMBasic,ManfDesc", "tblDG_Item_Master", "Id='" + DSgetPlDate.Tables[0].Rows[i2]["ItemId"].ToString() + "' ");
                SqlCommand cmdItem99 = new SqlCommand(sqlItem99, con);
                SqlDataAdapter daItem99 = new SqlDataAdapter(cmdItem99);
                DataSet DSItem99 = new DataSet();
                daItem99.Fill(DSItem99);
                if (DSItem99.Tables[0].Rows.Count > 0)
                {
                    string sqlUnit = fun.select("Id,Symbol ", "Unit_Master", "Id='" + DSItem99.Tables[0].Rows[0]["UOMBasic"].ToString() + "' ");
                    SqlCommand cmdUnit = new SqlCommand(sqlUnit, con);
                    SqlDataAdapter daUnit = new SqlDataAdapter(cmdUnit);
                    DataSet DSUnit = new DataSet();
                    daUnit.Fill(DSUnit);
                    if (DSUnit.Tables[0].Rows.Count > 0)
                    {
                        dr[1] = DSUnit.Tables[0].Rows[0]["Symbol"].ToString();
                    }
                    dr[0] = DSItem99.Tables[0].Rows[0]["ItemCode"].ToString();
                    dr[2] = DSItem99.Tables[0].Rows[0]["ManfDesc"].ToString();
                    double liQty = fun.AllComponentBOMQty(CompId, Wono, DSgetPlDate.Tables[0].Rows[i2]["ItemId"].ToString(), FinYearId);
                    dr[3] = Convert.ToDouble(decimal.Parse(liQty.ToString()).ToString("N3"));
                    dr[4] = DSgetPlDate.Tables[0].Rows[i2]["Id"].ToString();
                    string Plntype = "";
                    string NewItemCode = "";
                    string sql = "";
                    if (DSgetPlDate.Tables[0].Rows[i2]["FIN"].ToString() == "1")
                    {
                        Plntype = "Finish";

                        sql = "SELECT  tblMP_Material_Finish.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_Finish ON tblMP_Material_Detail.Id = tblMP_Material_Finish.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.PLNo='" + PLNo + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_Finish.DMid='" + DSgetPlDate.Tables[0].Rows[i2]["Id"].ToString() + "' ";

                    }
                    if (DSgetPlDate.Tables[0].Rows[i2]["RM"].ToString() == "1")
                    {
                        Plntype = "RM";

                        sql = "SELECT  tblMP_Material_RawMaterial.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_RawMaterial ON tblMP_Material_Detail.Id = tblMP_Material_RawMaterial.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.PLNo='" + PLNo + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_RawMaterial.DMid='" + DSgetPlDate.Tables[0].Rows[i2]["Id"].ToString() + "' ";
                    }
                    if (DSgetPlDate.Tables[0].Rows[i2]["PRO"].ToString() == "1")
                    {
                        Plntype = "Process";

                        sql = "SELECT  tblMP_Material_Process.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_Process ON tblMP_Material_Detail.Id = tblMP_Material_Process.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.PLNo='" + PLNo + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_Process.DMid='" + DSgetPlDate.Tables[0].Rows[i2]["Id"].ToString() + "' ";

                    }
                    SqlCommand cmdSql = new SqlCommand(sql, con);
                    SqlDataAdapter daSql = new SqlDataAdapter(cmdSql);
                    DataSet DSSql = new DataSet();
                    daSql.Fill(DSSql);
                    for (int k = 0; k < DSSql.Tables[0].Rows.Count;k++ )
                    {
                        string sqlItem991 = fun.select("ItemCode", "tblDG_Item_Master", "Id='" + DSSql.Tables[0].Rows[k]["ItemId"].ToString() + "' ");
                        SqlCommand cmdItem991 = new SqlCommand(sqlItem991, con);
                        SqlDataAdapter daItem991 = new SqlDataAdapter(cmdItem991);
                        DataSet DSItem991 = new DataSet();
                        daItem991.Fill(DSItem991);
                        if (DSItem991.Tables[0].Rows.Count>0)
                        {
                            dr[7] = DSItem991.Tables[0].Rows[0]["ItemCode"].ToString();

                        }
                    }


                    dr[5] = Plntype;
                    dr[6] = Convert.ToInt32(DSgetPlDate.Tables[0].Rows[i2]["MId"].ToString());

                    dt.Rows.Add(dr);
                    dt.AcceptChanges();
                }

            }
            GridView2.DataSource = dt;
            GridView2.DataBind();

        }

        catch(Exception ex)
        {

        }


    }
    //protected void DrpField_SelectedIndexChanged(object sender, EventArgs e)
    //{
       
    //}
    protected void Button1_Click(object sender, EventArgs e)
    {
        try
        {
            this.fillgrid(Txtsearch.Text);
        }
        catch (Exception ex)
        {

        }
    }
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        try
        {

            con.Open();

            if (e.CommandName == "Sel")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int PlnId = Convert.ToInt32((((Label)row.FindControl("lblId")).Text));
                string pln = (((LinkButton)row.FindControl("btnSel")).Text);                
                ViewState["Plan"] = pln;
                ViewState["Id"] = PlnId;
                this.fillgrid2();

            }

        }
        catch (Exception ex)
        {

        }
        finally
        {
            con.Close();
        }
    }
    protected void GridView1_PageIndexChanged(object sender, EventArgs e)
    {

    }
    protected void GridView1_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        GridView1.PageIndex = e.NewPageIndex;
        this.fillgrid(No);
    }
    protected void btnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/MaterialPlanning/Transactions/Planning_Delete.aspx?ModId=4&SubModId=33");
    }
    protected void GridView2_PageIndexChanged(object sender, EventArgs e)
    {

    }
    protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        GridView2.PageIndex = e.NewPageIndex;
        this.fillgrid2();

    }
    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {

        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        try
        {

            con.Open();
            if (e.CommandName == "Del")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int Id = Convert.ToInt32((((Label)row.FindControl("lblId")).Text));
                int MId = Convert.ToInt32((((Label)row.FindControl("lblMId")).Text));               
                string typePlan = ((Label)row.FindControl("lblplantype")).Text;               

                if (typePlan == "Finish")
                {

                    string sql = "SELECT  tblMP_Material_Finish.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_Finish ON tblMP_Material_Detail.Id = tblMP_Material_Finish.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.Id='" + MId + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_Finish.DMid='" + Id + "' ";
                    SqlCommand cmdItem = new SqlCommand(sql, con);
                    SqlDataAdapter daItem = new SqlDataAdapter(cmdItem);
                    DataSet DSItem = new DataSet();
                    daItem.Fill(DSItem);
                    for (int y = 0; y < DSItem.Tables[0].Rows.Count; y++)
                    {
                        string sqlItemFm = fun.select("tblMM_PR_Details.ItemId", "tblMM_PR_Master,tblMP_Material_Master,tblMM_PR_Details", "tblMM_PR_Master.PLNId = tblMP_Material_Master.Id And tblMM_PR_Master.PLNId='" + MId + "'And tblMM_PR_Master.Id=tblMM_PR_Details.MId  And tblMM_PR_Master.CompId='" + CompId + "' And tblMP_Material_Master.WONo='" + Wono + "' And tblMM_PR_Details.ItemId='" + DSItem.Tables[0].Rows[y][0].ToString() + "' ");
                        SqlCommand cmdItemFm = new SqlCommand(sqlItemFm, con);
                        SqlDataAdapter daItemFm = new SqlDataAdapter(cmdItemFm);
                        DataSet DSItemFm = new DataSet();
                        daItemFm.Fill(DSItemFm);
                        if (DSItemFm.Tables[0].Rows.Count == 0)
                        {
                            string Finish = fun.delete("tblMP_Material_Finish", "DMid='" + Id + "'");
                            SqlCommand sqlFinish = new SqlCommand(Finish, con);
                            sqlFinish.ExecuteNonQuery();
                        }
                    }                  

                }

                else if (typePlan == "RM")
                {

                    string sql = "SELECT  tblMP_Material_RawMaterial.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_RawMaterial ON tblMP_Material_Detail.Id = tblMP_Material_RawMaterial.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.Id='" + MId + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_RawMaterial.DMid='" + Id + "' ";
                    SqlCommand cmdItem = new SqlCommand(sql, con);
                    SqlDataAdapter daItem = new SqlDataAdapter(cmdItem);
                    DataSet DSItem = new DataSet();
                    daItem.Fill(DSItem);
                   
                    for (int y = 0; y < DSItem.Tables[0].Rows.Count; y++)
                    {
                                               
                        string StrDelItemPro = fun.delete("tblDG_Item_Master", "Id='" + DSItem.Tables[0].Rows[y][0].ToString() + "'");
                        SqlCommand sqlDelItemPro = new SqlCommand(StrDelItemPro, con);
                        sqlDelItemPro.ExecuteNonQuery();
                    }

                    string RawMaterial = fun.delete("tblMP_Material_RawMaterial", "DMid='" + Id + "'");
                    SqlCommand sqlRawMaterial = new SqlCommand(RawMaterial, con);
                    sqlRawMaterial.ExecuteNonQuery();

                    
                }

                else if (typePlan == "Process")
                {
                    

                    string sql = "SELECT  tblMP_Material_Process.ItemId FROM tblMP_Material_Detail INNER JOIN tblMP_Material_Master ON tblMP_Material_Detail.Mid = tblMP_Material_Master.Id INNER JOIN tblMP_Material_Process ON tblMP_Material_Detail.Id = tblMP_Material_Process.DMid AND tblMP_Material_Master.CompId=" + CompId + " AND tblMP_Material_Master.Id='" + MId + "' AND tblMP_Material_Master.WONo='" + Wono + "' And tblMP_Material_Process.DMid='" + Id + "' ";                    
                    SqlCommand cmdItem = new SqlCommand(sql, con);
                    SqlDataAdapter daItem = new SqlDataAdapter(cmdItem);
                    DataSet DSItem = new DataSet();
                    daItem.Fill(DSItem);                   
                    for(int y=0;y<DSItem.Tables[0].Rows.Count;y++)
                    {                      

                        string StrDelItemPro = fun.delete("tblDG_Item_Master", "Id='" + DSItem.Tables[0].Rows[y][0].ToString()+ "'");
                        SqlCommand sqlDelItemPro = new SqlCommand(StrDelItemPro, con);
                        sqlDelItemPro.ExecuteNonQuery();
                                              

                    }

                    string process = fun.delete("tblMP_Material_Process", "DMid='" + Id + "'");
                    SqlCommand sqlprocess = new SqlCommand(process, con);
                    sqlprocess.ExecuteNonQuery();

                }

                string sqlItem88 = fun.select("*", "tblMP_Material_Process", "DMid='" + Id + "' ");
                SqlCommand cmdItem88 = new SqlCommand(sqlItem88, con);
                SqlDataAdapter daItem88 = new SqlDataAdapter(cmdItem88);
                DataSet DSItem88 = new DataSet();
                daItem88.Fill(DSItem88);

                string sqlItem881 = fun.select("*", "tblMP_Material_RawMaterial", "DMid='" + Id + "' ");
                SqlCommand cmdItem881 = new SqlCommand(sqlItem881, con);
                SqlDataAdapter daItem881 = new SqlDataAdapter(cmdItem881);
                DataSet DSItem881 = new DataSet();
                daItem881.Fill(DSItem881);

                string sqlItem882 = fun.select("*", "tblMP_Material_RawMaterial", "DMid='" + Id + "' ");
                SqlCommand cmdItem882 = new SqlCommand(sqlItem882, con);
                SqlDataAdapter daItem882 = new SqlDataAdapter(cmdItem882);
                DataSet DSItem882 = new DataSet();
                daItem882.Fill(DSItem882);

                if (DSItem88.Tables[0].Rows.Count == 0 && DSItem881.Tables[0].Rows.Count == 0 && DSItem882.Tables[0].Rows.Count == 0)
                {
                string MaterialDetail = fun.delete("tblMP_Material_Detail", "Id='" + Id + "'");
                SqlCommand sqlMaterialDetail = new SqlCommand(MaterialDetail, con);
                sqlMaterialDetail.ExecuteNonQuery();
                }

                string sqlItem99 = fun.select("*", "tblMP_Material_Detail", "Mid='" +MId+ "' ");
                SqlCommand cmdItem99 = new SqlCommand(sqlItem99, con);
                SqlDataAdapter daItem99 = new SqlDataAdapter(cmdItem99);
                DataSet DSItem99 = new DataSet();
                daItem99.Fill(DSItem99);
                if (DSItem99.Tables[0].Rows.Count == 0)
                {
                   
                    string MaterialMaster = fun.delete("tblMP_Material_Master", "Id='" + MId + "'");
                    SqlCommand sqlMaterialMaster = new SqlCommand(MaterialMaster, con);
                    sqlMaterialMaster.ExecuteNonQuery();                   

                }

                string sqlItemMM = fun.select1("*", "tblMP_Material_Master");
                SqlCommand cmdItemMM = new SqlCommand(sqlItemMM, con);
                SqlDataAdapter daItemMM = new SqlDataAdapter(cmdItemMM);
                DataSet DSItemMM = new DataSet();
                daItemMM.Fill(DSItemMM);
                if (DSItemMM.Tables[0].Rows.Count == 0)
                {
                    Response.Redirect("~/Module/MaterialPlanning/Transactions/Planning_Delete.aspx?ModId=4&SubModId=33");                    
                }
                this.fillgrid2();
                this.fillgrid(No);
            }
            

        }

        catch (SqlException ex)
        {
            string mystring = string.Empty;
            mystring = "item is being used,you can not delete it.";
            ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);

        }
        catch (Exception ex)
        {

        }
        finally
        {
            con.Close();
        }
    }
}
