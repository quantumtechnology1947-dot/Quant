=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustPO_Print_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="CustPO_Print_Details.aspx.cs" Inherits="Module_SalesDistribution_Transactions_CustPO_Print_Details" Title="ERP"  Theme="Default"  %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>

    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
    .style2
    {
        width: 100%;
        float: left;
    }
</style> 
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

     <table align="left" cellpadding="0" cellspacing="0" class="style2">
    <tr Height="21" >
        <td style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite">&nbsp;<b>Customer PO - Print</b></td>
    </tr>
    <tr>
        <td align="center">
            <asp:Panel ID="Panel1" runat="server" Width="100%" Height="450" ScrollBars="Auto">            
     <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server"  HasCrystalLogo="False"
         ReuseParameterValuesOnRefresh="true" DisplayGroupTree="False"  AutoDataBind="true" />
    <CR:CrystalReportSource ID="CrystalReportSource2" runat="server">
    </CR:CrystalReportSource>
           </asp:Panel>
        </td>
    </tr>
    <tr>
        <td align="center">
            <asp:Button ID="Button1" runat="server" CssClass="redbox" 
                onclick="Button1_Click" Text="Cancel" />
        </td>
    </tr>
</table>

     </asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustPO_Print_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_SalesDistribution_Transactions_CustPO_Print_Details : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    string connStr1 = "";
    SqlConnection myConnection;
    private ReportDocument report = new ReportDocument();

    string regdate = "";
    string PODate = "";
    string prdate = "";
    string PORecDate = "";
    string RegCity = "";
    string RegState = "";
    string RegCountry = "";
    string WorkCity = "";
    string WorkState = "";
    string WorkCountry = "";
    string DelCity = "";
    string DelState = "";
    string DelCountry = "";
    string custId = "";
    string regcity = "";
    string regstate = "";
    string regcountry = "";
    string workcity = "";
    string workstate = "";
    string workcountry = "";
    string delcity = "";
    string delstate = "";
    string delcountry = "";
    string POId = "";
    string Key = string.Empty;

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            connStr1 = fun.Connection();
            myConnection = new SqlConnection(connStr1);
            myConnection.Open();
            try
            {

                string strcustId = "";
                if (!string.IsNullOrEmpty(Request.QueryString["PONo"]))
                {
                    strcustId = Request.QueryString["PONo"].ToString();
                }
                string strenqId = "";
                if (!string.IsNullOrEmpty(Request.QueryString["EnqId"]))
                {
                    strenqId = Request.QueryString["EnqId"].ToString();
                }

                if (!string.IsNullOrEmpty(Request.QueryString["POId"]))
                {
                    POId = Request.QueryString["POId"].ToString();
                }
                Key = Request.QueryString["Key"].ToString();
                CompId = Convert.ToInt32(Session["compid"]);
                
                // To pass values in crystal report from  SD_Cust_PO_Master
                string selectQuery = fun.select("*", " SD_Cust_PO_Master", "PONo='" + strcustId + "' And EnqId='" + strenqId + "' And CompId='" + CompId + "' AND POId='" + POId + "' ");
                SqlCommand myCommand = new SqlCommand(selectQuery, myConnection);
                SqlDataAdapter ad = new SqlDataAdapter(myCommand);
                DataSet ds = new DataSet();
                ad.Fill(ds, "SD_Cust_PO_Master");
                string reportPath = Server.MapPath("~/Module/SalesDistribution/Transactions/Reports/CustPO.rpt");
                report.Load(reportPath);
                report.SetDataSource(ds);

                //Registration Date 
                if (ds.Tables[0].Rows.Count > 0)
                {
                    custId = ds.Tables[0].Rows[0]["CustomerId"].ToString();
                    regdate = ds.Tables[0].Rows[0]["PODate"].ToString();
                    PODate = fun.FromDateDMY(regdate);
                    prdate = ds.Tables[0].Rows[0]["POReceivedDate"].ToString();
                    PORecDate = fun.FromDate(prdate);
                }
                // To get City,State and country from SD_Cust_Master

                string strCsc = fun.select("*", "SD_Cust_master", "CustomerId='" + custId + "' And CompId='" + CompId + "' ");
                SqlCommand cmdcust = new SqlCommand(strCsc, myConnection);
                SqlDataAdapter adcust = new SqlDataAdapter(cmdcust);
                DataSet dscust = new DataSet();
                adcust.Fill(dscust, "SD_Cust_master");
                if (dscust.Tables[0].Rows.Count > 0)
                {
                    RegCity = dscust.Tables[0].Rows[0]["RegdCity"].ToString();
                    RegState = dscust.Tables[0].Rows[0]["RegdState"].ToString();
                    RegCountry = dscust.Tables[0].Rows[0]["RegdCountry"].ToString();
                    WorkCity = dscust.Tables[0].Rows[0]["WorkCity"].ToString();
                    WorkState = dscust.Tables[0].Rows[0]["WorkState"].ToString();
                    WorkCountry = dscust.Tables[0].Rows[0]["WorkCountry"].ToString();
                    DelCity = dscust.Tables[0].Rows[0]["MaterialDelCity"].ToString();
                    DelState = dscust.Tables[0].Rows[0]["MaterialDelState"].ToString();
                    DelCountry = dscust.Tables[0].Rows[0]["MaterialDelCountry"].ToString();
                }
                //Regd
                string selectregCt = fun.select("CityName", "tblCity", "CityId='" + RegCity + "' ");
                SqlCommand myCmdct = new SqlCommand(selectregCt, myConnection);
                SqlDataAdapter adct = new SqlDataAdapter(myCmdct);
                DataSet Dsct = new DataSet();
                adct.Fill(Dsct);

                string selectregSt = fun.select("StateName", "tblState", "SId='" + RegState + "' ");
                SqlCommand myCmdst = new SqlCommand(selectregSt, myConnection);
                SqlDataAdapter adst = new SqlDataAdapter(myCmdst);
                DataSet Dsst = new DataSet();
                adst.Fill(Dsst);

                string selectregCnt = fun.select("CountryName", "tblCountry", "CId='" + RegCountry + "'");
                SqlCommand myCmdcnt = new SqlCommand(selectregCnt, myConnection);
                SqlDataAdapter adcnt = new SqlDataAdapter(myCmdcnt);
                DataSet Dscnt = new DataSet();
                adcnt.Fill(Dscnt);
                if (Dsct.Tables[0].Rows.Count > 0)
                {
                    regcity = Dsct.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst.Tables[0].Rows.Count > 0)
                {
                    regstate = Dsst.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt.Tables[0].Rows.Count > 0)
                {
                    regcountry = Dscnt.Tables[0].Rows[0]["CountryName"].ToString();
                }
                //Work 

                string selectregCt1 = fun.select("CityName", "tblCity", "CityId='" + WorkCity + "'");
                SqlCommand myCmdct1 = new SqlCommand(selectregCt1, myConnection);
                SqlDataAdapter adct1 = new SqlDataAdapter(myCmdct1);
                DataSet Dsct1 = new DataSet();
                adct1.Fill(Dsct1);

                string selectregSt1 = fun.select("StateName", "tblState", "SId='" + WorkState + "'");
                SqlCommand myCmdst1 = new SqlCommand(selectregSt1, myConnection);
                SqlDataAdapter adst1 = new SqlDataAdapter(myCmdst1);
                DataSet Dsst1 = new DataSet();
                adst1.Fill(Dsst1);

                string selectregCnt1 = fun.select("CountryName", "tblCountry", "CId='" + WorkCountry + "'");
                SqlCommand myCmdcnt1 = new SqlCommand(selectregCnt1, myConnection);
                SqlDataAdapter adcnt1 = new SqlDataAdapter(myCmdcnt1);
                DataSet Dscnt1 = new DataSet();
                adcnt1.Fill(Dscnt1);
                if (Dsct1.Tables[0].Rows.Count > 0)
                {
                    workcity = Dsct1.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst1.Tables[0].Rows.Count > 0)
                {
                    workstate = Dsst1.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt1.Tables[0].Rows.Count > 0)
                {
                    workcountry = Dscnt1.Tables[0].Rows[0]["CountryName"].ToString();
                }
                // Del

                string selectregCt2 = fun.select("CityName", "tblCity", "CityId='" + DelCity + "' ");
                SqlCommand myCmdct2 = new SqlCommand(selectregCt2, myConnection);
                SqlDataAdapter adct2 = new SqlDataAdapter(myCmdct2);
                DataSet Dsct2 = new DataSet();
                adct2.Fill(Dsct2);

                string selectregSt2 = fun.select("StateName", "tblState", "SId='" + DelState + "' ");
                SqlCommand myCmdst2 = new SqlCommand(selectregSt2, myConnection);
                SqlDataAdapter adst2 = new SqlDataAdapter(myCmdst2);
                DataSet Dsst2 = new DataSet();
                adst2.Fill(Dsst2);

                string selectregCnt2 = fun.select("CountryName", "tblCountry", "CId='" + DelCountry + "' ");
                SqlCommand myCmdcnt2 = new SqlCommand(selectregCnt2, myConnection);
                SqlDataAdapter adcnt2 = new SqlDataAdapter(myCmdcnt2);
                DataSet Dscnt2 = new DataSet();
                adcnt1.Fill(Dscnt2);
                if (Dsct2.Tables[0].Rows.Count > 0)
                {
                    delcity = Dsct2.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst2.Tables[0].Rows.Count > 0)
                {
                    delstate = Dsst2.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt2.Tables[0].Rows.Count > 0)
                {
                    delcountry = Dscnt2.Tables[0].Rows[0]["CountryName"].ToString();
                }

                //Quotation

                string QuotNo = "";
                string strQuote = fun.select("QuotationNo", " SD_Cust_Quotation_Master", "Id='" + ds.Tables[0].Rows[0]["QuotationNo"].ToString() + "' And CompId='" + CompId + "'");
                SqlCommand cmdQuote = new SqlCommand(strQuote, myConnection);
                SqlDataAdapter daQuote = new SqlDataAdapter(cmdQuote);
                DataSet DSQuote = new DataSet();
                daQuote.Fill(DSQuote, "SD_Cust_Quotation_Master");

                if (DSQuote.Tables[0].Rows.Count > 0)
                {

                    QuotNo = DSQuote.Tables[0].Rows[0]["QuotationNo"].ToString();
                }
                else
                {
                    QuotNo = "NA";
                }

                report.SetParameterValue("QuotNo", QuotNo);
                report.SetParameterValue("RegCity", regcity);
                report.SetParameterValue("RegState", regstate);
                report.SetParameterValue("RegCountry", regcountry);

                report.SetParameterValue("WrkCity", workcity);
                report.SetParameterValue("WrkState", workstate);
                report.SetParameterValue("WrkCountry", workcountry);

                report.SetParameterValue("DelCity", delcity);
                report.SetParameterValue("DelState", delstate);
                report.SetParameterValue("DelCountry", delcountry);

                report.SetParameterValue("PODate", PODate);
                report.SetParameterValue("PORecDate", PORecDate);
                //// To Show Company Name& Company Address on Crystal Report            
                string Address = fun.CompAdd(CompId);
                report.SetParameterValue("Address", Address);

                string Company = fun.getCompany(CompId);
                report.SetParameterValue("Company", Company);

                CrystalReportViewer1.ReportSource = report;
                CrystalReportViewer1.EnableViewState = true;
                Session[Key] = report;

            }
           catch (Exception ex)
            {

            }
            finally
            {
                myConnection.Close();
                myConnection.Dispose();
            }

         
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }

    protected void Page_Load(object sender, EventArgs e)
    {
        report = new ReportDocument();
    }
    protected void Button1_Click(object sender, EventArgs e)
    {
        Response.Redirect("CustPO_Print.aspx?ModId=2&SubModId=11");
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }
}
