=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustEnquiry_Print_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="CustEnquiry_Print_Details.aspx.cs" Inherits="Module_SalesDistribution_Transactions_CustEnquiry_Print_Details" Title="ERP" Theme="Default" %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>

    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .style1
        {
            width: 976px;
        }
        .style2
        {
            width: 100%;
            float: left;
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
    <table cellpadding="0" cellspacing="0" width="100%" align="center">
        <tr>
            <td>
                <table align="center" cellpadding="0" cellspacing="0" width="100%">
                    <tr height="21">
                        <th style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite" >&nbsp; <strong> Customer Enquiry - Print</strong></th>
                    </tr>
                    <tr>
                        <td Height="320" align="center">
                   <asp:Panel ID="Panel1" runat="server" Width="100%" Height="450" ScrollBars="Auto">
                          
                <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server" 
                    AutoDataBind="true" DisplayGroupTree="False" EnableDatabaseLogonPrompt="False" 
HasCrystalLogo="False" EnableParameterPrompt="False" />
                <CR:CrystalReportSource ID="CrystalReportSource1" runat="server" >
                </CR:CrystalReportSource>
                  </asp:Panel>
                        </td>
                    </tr>
                    
                     <tr>
                        <td align="center">
                            <asp:Button ID="Button1" runat="server" Text="Cancel" CssClass="redbox" 
                                onclick="Button1_Click" />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            </td>
                    </tr>
                    
                </table>
            </td>
        </tr>
    </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/CustEnquiry_Print_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using CrystalDecisions.CrystalReports.Engine;
using System.Data.SqlClient;
using CrystalDecisions.Shared;

public partial class Module_SalesDistribution_Transactions_CustEnquiry_Print_Details : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    private ReportDocument report = new ReportDocument();
    int CompId = 0;
    string connStr1 = "";

    SqlConnection myConnection;

    string regdate = "";
    string RegDate = "";
    string RegCity = "";
    string RegState = "";
    string RegCountry = "";
    string WorkCity = "";
    string WorkState = "";
    string WorkCountry = "";
    string DelCity = "";
    string DelState = "";
    string DelCountry = "";
    string regcity = "";
    string regstate = "";
    string regcountry = "";
    string workcity = "";
    string workstate = "";
    string workcountry = "";
    string delcity = "";
    string delstate = "";
    string delcountry = "";
    string Key = string.Empty;

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
           
                connStr1 = fun.Connection();
                myConnection = new SqlConnection(connStr1);
                myConnection.Open();

 try
            {

                CompId = Convert.ToInt32(Session["compid"]);
                Key = Request.QueryString["Key"].ToString();
                string strcustId = Request.QueryString["CustomerId"].ToString();
                string strenqId = Request.QueryString["EnqId"].ToString();

                string selectQuery = fun.select("*", "SD_Cust_Enquiry_Master", "EnqId='" + strenqId + "'And CompId='" + CompId + "' ");

                SqlCommand myCommand = new SqlCommand(selectQuery, myConnection);
                SqlDataAdapter ad = new SqlDataAdapter(myCommand);

                DataSet ds = new DataSet();
                ad.Fill(ds, "SD_Cust_Enquiry_Master");
                string reportPath = Server.MapPath("~/Module/SalesDistribution/Transactions/Reports/CustEnquiry.rpt");

                report.Load(reportPath);
                report.SetDataSource(ds);

                //Registration Date 

                if (ds.Tables[0].Rows.Count > 0)
                {
                    regdate = ds.Tables[0].Rows[0]["SysDate"].ToString();
                    RegDate = fun.FromDateDMY(regdate);
                    RegCity = ds.Tables[0].Rows[0]["RegdCity"].ToString();
                    RegState = ds.Tables[0].Rows[0]["RegdState"].ToString();
                    RegCountry = ds.Tables[0].Rows[0]["RegdCountry"].ToString();
                    WorkCity = ds.Tables[0].Rows[0]["WorkCity"].ToString();
                    WorkState = ds.Tables[0].Rows[0]["WorkState"].ToString();
                    WorkCountry = ds.Tables[0].Rows[0]["WorkCountry"].ToString();
                    DelCity = ds.Tables[0].Rows[0]["MaterialDelCity"].ToString();
                    DelState = ds.Tables[0].Rows[0]["MaterialDelState"].ToString();
                    DelCountry = ds.Tables[0].Rows[0]["MaterialDelCountry"].ToString();

                }
                //Regd
                string selectregCt = fun.select("CityName", "tblCity", "CityId='" + RegCity + "'");
                SqlCommand myCmdct = new SqlCommand(selectregCt, myConnection);
                SqlDataAdapter adct = new SqlDataAdapter(myCmdct);
                DataSet Dsct = new DataSet();
                adct.Fill(Dsct);

                string selectregSt = fun.select("StateName", "tblState", "SId='" + RegState + "' ");
                SqlCommand myCmdst = new SqlCommand(selectregSt, myConnection);
                SqlDataAdapter adst = new SqlDataAdapter(myCmdst);
                DataSet Dsst = new DataSet();
                adst.Fill(Dsst);

                string selectregCnt = fun.select("CountryName", "tblCountry", "CId='" + RegCountry + "' ");
                SqlCommand myCmdcnt = new SqlCommand(selectregCnt, myConnection);
                SqlDataAdapter adcnt = new SqlDataAdapter(myCmdcnt);
                DataSet Dscnt = new DataSet();
                adcnt.Fill(Dscnt);
                if (Dsct.Tables[0].Rows.Count > 0)
                {
                    regcity = Dsct.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst.Tables[0].Rows.Count > 0)
                {
                    regstate = Dsst.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt.Tables[0].Rows.Count > 0)
                {
                    regcountry = Dscnt.Tables[0].Rows[0]["CountryName"].ToString();
                }
                //Work 

                string selectregCt1 = fun.select("CityName", "tblCity", "CityId='" + WorkCity + "' ");
                SqlCommand myCmdct1 = new SqlCommand(selectregCt1, myConnection);
                SqlDataAdapter adct1 = new SqlDataAdapter(myCmdct1);
                DataSet Dsct1 = new DataSet();
                adct1.Fill(Dsct1);

                string selectregSt1 = fun.select("StateName", "tblState", "SId='" + WorkState + "' ");
                SqlCommand myCmdst1 = new SqlCommand(selectregSt1, myConnection);
                SqlDataAdapter adst1 = new SqlDataAdapter(myCmdst1);
                DataSet Dsst1 = new DataSet();
                adst1.Fill(Dsst1);

                string selectregCnt1 = fun.select("CountryName", "tblCountry", "CId='" + WorkCountry + "' ");
                SqlCommand myCmdcnt1 = new SqlCommand(selectregCnt1, myConnection);
                SqlDataAdapter adcnt1 = new SqlDataAdapter(myCmdcnt1);
                DataSet Dscnt1 = new DataSet();
                adcnt1.Fill(Dscnt1);
                if (Dsct1.Tables[0].Rows.Count > 0)
                {
                    workcity = Dsct1.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst1.Tables[0].Rows.Count > 0)
                {
                    workstate = Dsst1.Tables[0].Rows[0]["StateName"].ToString();
                }
                if (Dscnt1.Tables[0].Rows.Count > 0)
                {
                    workcountry = Dscnt1.Tables[0].Rows[0]["CountryName"].ToString();
                }

                // Del

                string selectregCt2 = fun.select("CityName", "tblCity", "CityId='" + DelCity + "' ");
                SqlCommand myCmdct2 = new SqlCommand(selectregCt2, myConnection);
                SqlDataAdapter adct2 = new SqlDataAdapter(myCmdct2);
                DataSet Dsct2 = new DataSet();
                adct2.Fill(Dsct2);

                string selectregSt2 = fun.select("StateName", "tblState", "SId='" + DelState + "' ");
                SqlCommand myCmdst2 = new SqlCommand(selectregSt2, myConnection);
                SqlDataAdapter adst2 = new SqlDataAdapter(myCmdst2);
                DataSet Dsst2 = new DataSet();
                adst2.Fill(Dsst2);

                string selectregCnt2 = fun.select("CountryName", "tblCountry", "CId='" + DelCountry + "' ");
                SqlCommand myCmdcnt2 = new SqlCommand(selectregCnt2, myConnection);
                SqlDataAdapter adcnt2 = new SqlDataAdapter(myCmdcnt2);
                DataSet Dscnt2 = new DataSet();
                adcnt2.Fill(Dscnt2);


                if (Dsct2.Tables[0].Rows.Count > 0)
                {
                    delcity = Dsct2.Tables[0].Rows[0]["CityName"].ToString();
                }
                if (Dsst2.Tables[0].Rows.Count > 0)
                {
                    delstate = Dsst2.Tables[0].Rows[0]["StateName"].ToString();
                }

                if (Dscnt2.Tables[0].Rows.Count > 0)
                {
                    delcountry = Dscnt2.Tables[0].Rows[0]["CountryName"].ToString();

                }
                report.SetParameterValue("RegCity", regcity);
                report.SetParameterValue("RegState", regstate);
                report.SetParameterValue("RegCountry", regcountry);

                report.SetParameterValue("WrkCity", workcity);
                report.SetParameterValue("WrkState", workstate);
                report.SetParameterValue("WrkCountry", workcountry);

                report.SetParameterValue("DelCity", delcity);
                report.SetParameterValue("DelState", delstate);
                report.SetParameterValue("DelCountry", delcountry);

                report.SetParameterValue("RegDate", RegDate);

                string Company = fun.getCompany(CompId);
                report.SetParameterValue("Company", Company);

                string Address = fun.CompAdd(CompId);
                report.SetParameterValue("Address", Address);

                CrystalReportViewer1.ReportSource = report;
                CrystalReportViewer1.DataBind();
                Session[Key] = report;
            }
            catch (Exception ex)
            {

            }
            finally
            {
                myConnection.Close();
                myConnection.Dispose();
            }           
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }


    protected void Page_Load(object sender, EventArgs e)
    {
        report = new ReportDocument();
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        Response.Redirect("CustEnquiry_Print.aspx?ModId=2&SubModId=10");
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }
}
