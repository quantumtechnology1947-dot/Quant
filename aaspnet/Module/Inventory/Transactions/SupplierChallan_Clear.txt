=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_Clear.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="SupplierChallan_Clear.aspx.cs" Inherits="Module_Inventory_Transactions_SupplierChallan_Clear" Theme="Default" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>ERP</title>
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</head>
<body  style="margin:0px 0px 0px 0px" class="fontcss" >
    <form id="form1" runat="server">
    <div>
    <asp:Panel ID="Panel1" ScrollBars="Auto" runat="server">                    
                        
                         <table align="left" width="100%" cellpadding="0" cellspacing="0" >
        <tr>
            <td height="5px" ></td>
        </tr>
        <tr>
            <td align="left"  valign="top">
               
                            <table align="left" cellpadding="0" width="100%" cellspacing="0" >
                               
                                <tr>
                                    <td valign="top" align="center"  >
                                        <asp:Panel ID="Panel3" ScrollBars="Auto" Height="395px" runat="server">
                                       
                                      
                                            <asp:GridView ID="GridView2" runat="server"
                                                AutoGenerateColumns="False" CssClass="yui-datatable-theme" 
                                                OnPageIndexChanging="GridView2_PageIndexChanging" style="position:static" 
                                                Width="100%" onrowcommand="GridView2_RowCommand" 
                                              >
                                                
                                                <PagerSettings PageButtonCount="40" />
                                                
                                                <Columns>
                                                    <asp:TemplateField HeaderText="SN">
                                                        <ItemTemplate>
                                                            <%# Container.DataItemIndex+1 %>
                                                        </ItemTemplate>
                                                        <HeaderStyle Font-Size="10pt" />
                                                        <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" Width="2%" />
                                                    </asp:TemplateField>
                                                    <asp:TemplateField>
                                                        <ItemTemplate>
                                                 <asp:CheckBox ID="CheckBox1" runat="server" AutoPostBack="true" oncheckedchanged="CheckBox1_CheckedChanged"
                                                 />
                                                
                                                        </ItemTemplate>                                                         
                                                        <HeaderStyle Font-Size="10pt" />
                                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="2%" />
                                                    </asp:TemplateField>
                                                    
                                                    <asp:TemplateField  Visible="true" HeaderText="SC No">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblprDId" runat="server" Text='<%# Eval("SCNo") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" Width="6%" />
                                                    </asp:TemplateField> 
                                                    
                                                    <asp:TemplateField  Visible="false" HeaderText="Id">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblId" runat="server" Text='<%# Eval("Id") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" Width="6%" />
                                                    </asp:TemplateField> 
                                                    
                                                    <asp:TemplateField HeaderText="PR NO">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblprNo" runat="server" Text='<%# Eval("PRNo") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" Width="6%" />
                                                    </asp:TemplateField>                                                    
                                                    <asp:TemplateField HeaderText="Date">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblprDt" runat="server" Text='<%# Eval("PRDate") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" Width="6%" />
                                                    </asp:TemplateField> 
                                                   
                                                   <asp:TemplateField HeaderText="WONo">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblWono" runat="server" Text='<%# Eval("WONo") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" Width="6%" />
                                                    </asp:TemplateField> 
                                                     <asp:TemplateField HeaderText="Item Code">
                                                        <ItemTemplate>
                                                            <asp:Label ID="lblit" runat="server" Text='<%# Eval("ItemCode") %>'> </asp:Label>
                                                        </ItemTemplate>
                                                        <ItemStyle HorizontalAlign="Center" Width="8%" VerticalAlign="Top" />
                                                    </asp:TemplateField>
                                                    <asp:TemplateField HeaderText="Description">
                                                        <ItemTemplate>
                                                            <asp:Label ID="lbldesc" runat="server" Text='<%# Eval("Descr") %>'> </asp:Label>
                                                        </ItemTemplate>
                                                        <ItemStyle HorizontalAlign="Left" Width="20%" VerticalAlign="Top" />
                                                    </asp:TemplateField>
                                                    <asp:TemplateField HeaderText="UOM">
                                                        <ItemTemplate>
                                                            <asp:Label ID="lbluom" runat="server" Text='<%# Eval("Symbol") %>'> </asp:Label>
                                                        </ItemTemplate>
                                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="5%" />
                                                    </asp:TemplateField>
                                                    
                                                    <asp:TemplateField HeaderText="Challan Qty">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblprqty" runat="server" Text='<%# Eval("ChallanQty") %>'></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Right" Width="6%" />
                                                    </asp:TemplateField> 
                                                    
                                                    <asp:TemplateField HeaderText="Cleared Qty">
                                                        <ItemTemplate>
                                                           <asp:Label ID="lblqty" runat="server" Text=""></asp:Label>
                                                    </ItemTemplate>
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Right" Width="6%" />
                                                    </asp:TemplateField> 
                                                   
                                                   
                                                     <asp:TemplateField HeaderText=" Clear Qty">
                                                        <ItemTemplate>
                                                            <asp:TextBox ID="txtqty" Width="80%"  CssClass="box3" runat="server"></asp:TextBox>
        <asp:RegularExpressionValidator ID="RegularExpressionValidator2" runat="server" ErrorMessage="*" ControlToValidate="txtqty" ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="A"></asp:RegularExpressionValidator>
                                    <asp:RequiredFieldValidator
                                        ID="ReqChNo" runat="server" ErrorMessage="*"  ValidationGroup="A" ControlToValidate="txtqty"></asp:RequiredFieldValidator>
                                                          
                                                    </ItemTemplate>
                                                    
                                                        <ItemStyle VerticalAlign="Top" HorizontalAlign="Left" Width="10%" />
                                                    </asp:TemplateField> 
                                                
                                                    
                                                </Columns>
                                                <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    
                   
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>
                                                <FooterStyle Font-Bold="False" />
                                                <HeaderStyle Font-Size="9pt" />
                                            </asp:GridView>
                                        </asp:Panel>
                                        
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td valign="top" align="center"  >
                                        <asp:Button ID="BtnAdd" ValidationGroup="A"  runat="server"  CssClass="redbox" 
                                            Text="Submit" onclick="BtnAdd_Click" />                                            
                                        
                                        &nbsp;<asp:Button ID="BtnCancel"  runat="server"  CssClass="redbox" 
                                            Text="Cancel" onclick="BtnCancel_Click"  /> 
                                        
                                    </td>
                                </tr>
                                
                            </table>
                      
                   </td>
        </tr>
        
    </table>
                        </asp:Panel>
    </div>
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_Clear.aspx.cs ===

﻿using System;
using System.Data.SqlClient;
using System.Data;
using System.Web.UI.WebControls;

public partial class Module_Inventory_Transactions_SupplierChallan_Clear : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    string sId = "";
    int CompId = 0;
    int fyid = 0;
    string id = "";
    string str = "";
    SqlConnection con;
    string CDate = "";
    string CTime = "";
    string supid = "";
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            CompId = Convert.ToInt32(Session["compid"]);
            fyid = Convert.ToInt32(Session["finyear"]);
            id = Request.QueryString["Id"].ToString();
            supid = Request.QueryString["SupId"].ToString();
            sId = Session["username"].ToString();
            str = fun.Connection();
            con = new SqlConnection(str);
            CDate = fun.getCurrDate();
            CTime = fun.getCurrTime();          
            if (!IsPostBack)
            {
                this.fillGrid(id);
            } 

        }
        catch (Exception es)
        {

        }

    }
    public void GetValidate()
    {
       try
        {
            foreach (GridViewRow grv in GridView2.Rows)
            {
                int Id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                {
                    ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = true;
                    ((TextBox)grv.FindControl("txtqty")).Enabled = true;

                }
                else
                {
                    ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = false;
                    ((TextBox)grv.FindControl("txtqty")).Enabled = false;
                }

                double TotClearedQty = 0;
                double ChallanQty=0;
                ChallanQty = Convert.ToDouble(decimal.Parse(((Label)grv.FindControl("lblprqty")).Text).ToString("N3")); 
                string StrSql3 = "SELECT  Sum(tblInv_Supplier_Challan_Clear.ClearedQty) As Qty  FROM  tblInv_Supplier_Challan_Clear INNER JOIN tblInv_Supplier_Challan_Details ON tblInv_Supplier_Challan_Clear.DId = tblInv_Supplier_Challan_Details.Id   And tblInv_Supplier_Challan_Clear.DId=" + Id + "";
                SqlCommand cmd3 = new SqlCommand(StrSql3, con);
                SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                DataSet DS3 = new DataSet();
                da3.Fill(DS3);
                if (DS3.Tables[0].Rows.Count > 0 && DS3.Tables[0].Rows[0][0] != DBNull.Value)
                {
                    TotClearedQty = Convert.ToDouble(decimal.Parse(DS3.Tables[0].Rows[0][0].ToString()).ToString("N3"));
                }
                ((Label)grv.FindControl("lblqty")).Text = decimal.Parse((TotClearedQty).ToString()).ToString("N3");

                if ((ChallanQty - TotClearedQty) <= 0)
                {
                    ((CheckBox)grv.FindControl("CheckBox1")).Visible = false;
                }
                else
                {
                    ((CheckBox)grv.FindControl("CheckBox1")).Visible = true;
                }
            }
        }

       catch (Exception ex) { }

    }
    public void fillGrid(string supid)
    {
        try
        {
            SqlDataAdapter da = new SqlDataAdapter("GetSup_Challan_Clear", con);
            da.SelectCommand.CommandType = CommandType.StoredProcedure;
            da.SelectCommand.Parameters.Add(new SqlParameter("@Id", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@FinYearId", SqlDbType.VarChar));
            da.SelectCommand.Parameters["@Id"].Value = id;
            da.SelectCommand.Parameters["@CompId"].Value = CompId;
            da.SelectCommand.Parameters["@FinYearId"].Value = fyid;
            DataSet DSitem = new DataSet();
            da.Fill(DSitem);
            GridView2.DataSource = DSitem;
            GridView2.DataBind();           
            this.GetValidate();
        }
        catch (Exception ex)
        {
        }
    }
    protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
    }
    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {
    }
    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {
        this.GetValidate();
    }
    protected void BtnAdd_Click(object sender, EventArgs e)
    {
        try
        {

            int y = 0;
            int x = 0;
            int k = 0;

            foreach (GridViewRow grv in GridView2.Rows)
            {
                if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                {
                    x++;
                    if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("txtqty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("txtqty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("txtqty")).Text) != 0)
                    {

                        double CleardQty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("txtqty")).Text).ToString("N3"));
                        double ChallanQty = Convert.ToDouble(decimal.Parse(((Label)grv.FindControl("lblprqty")).Text).ToString("N3"));
                        int Id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                        double TotChalnQty = 0;
                        string StrSql3 = "SELECT  Sum(tblInv_Supplier_Challan_Clear.ClearedQty) As Qty  FROM  tblInv_Supplier_Challan_Clear INNER JOIN tblInv_Supplier_Challan_Details ON tblInv_Supplier_Challan_Clear.DId = tblInv_Supplier_Challan_Details.Id   And tblInv_Supplier_Challan_Clear.DId=" + Id + "";
                        SqlCommand cmd3 = new SqlCommand(StrSql3, con);
                        SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                        DataSet DS3 = new DataSet();
                        da3.Fill(DS3);
                        if (DS3.Tables[0].Rows.Count > 0 && DS3.Tables[0].Rows[0][0] != DBNull.Value)
                        {
                            TotChalnQty = Convert.ToDouble(decimal.Parse(DS3.Tables[0].Rows[0][0].ToString()).ToString("N3"));
                        }

                        if (Convert.ToDouble(decimal.Parse((ChallanQty - (CleardQty + TotChalnQty)).ToString()).ToString("N3")) >= 0)
                        {
                            y++;
                        }


                    }
                }

            }

            if (x == y && y > 0)
            {                  

                    foreach (GridViewRow grv in GridView2.Rows)
                    {
                        if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("txtqty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("txtqty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("txtqty")).Text) != 0)
                        {

                            double CleardQty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("txtqty")).Text).ToString("N3"));                            
                            int DId = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                            SqlCommand exeme2 = new SqlCommand(fun.insert("tblInv_Supplier_Challan_Clear", "SysDate,SysTime,CompId,FinYearId,SessionId,DId,ClearedQty", "'" + CDate + "','" + CTime + "'," + CompId + "," + fyid + ",'" + sId+ "'," + DId + ","+ CleardQty + ""), con);
                            
                            con.Open();
                            exeme2.ExecuteNonQuery();
                            con.Close();
                            k++;

                        }
                    }
               
            }

            else
            {
                string myStringVariable = string.Empty;
                myStringVariable = "Invalid input data.";
                ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);

            }
            if(k>0)
            {
                this.fillGrid(id);
            }

        }
        catch (Exception ex) { }
    }
    protected void BtnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Inventory/Transactions/SupplierChallan_Clear_Details.aspx?supid="+supid+"&ModId=9&SubModId=118");

    }
}
