=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialManagement/Reports/VendorRating_Print.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="VendorRating_Print.aspx.cs" Inherits="Module_MaterialManagement_Reports_VendorRating_Print" Title="ERP" Theme ="Default" %>
<%@ Register Assembly="AjaxControlToolkit" Namespace="AjaxControlToolkit" TagPrefix="cc1" %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
    .style2
    {
        width: 100%;
        float: left;
    } 
    
</style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
  <table align="left" cellpadding="0" cellspacing="0" class="style2">
        <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)">
        &nbsp;<b> Supplier Rating</b></td>
        </tr>
        <tr>
            <td>
    <cc1:TabContainer ID="TabContainer1" runat="server" ActiveTabIndex="0">
    <cc1:TabPanel runat="server" ID="ORTab" HeaderText="Overall Rating" >
    <ContentTemplate>
    <asp:Panel runat="server"  ID="plnOR"  Width="100%" 
            Height="410px" ScrollBars="Auto" >
            <table width="100%">
            <tr>
            <td align="center">
    <CR:CrystalReportViewer ID="CrystalReportViewer1"  
        ReportSourceID="VendorRating"  EnableDatabaseLogonPrompt="False" HasCrystalLogo="False"
        ReuseParameterValuesOnRefresh="True" runat="server" 
    AutoDataBind="True" DisplayGroupTree="False" />
    <CR:CrystalReportSource ID="VendorRating"  runat="server">
        <Report FileName="Module\MaterialManagement\Reports\VendorRating.rpt">
        </Report>
    </CR:CrystalReportSource> 
    </td>
    </tr>
    </table>   
    </asp:Panel>    
        </ContentTemplate> 
    </cc1:TabPanel>   
    
    <cc1:TabPanel runat="server" ID="TabPanel2" Visible="false" HeaderText="Quality Rating">
    <ContentTemplate>
    <asp:Panel runat="server" ID="Panel1"  Width="100%" Height="410" ScrollBars="Auto" >
    <table width="100%">
            <tr>
            <td align="center">
    <CR:CrystalReportViewer ID="CrystalReportViewer2"  
        ReportSourceID="VendorRatingQual"  EnableDatabaseLogonPrompt="false" HasCrystalLogo="False"
        ReuseParameterValuesOnRefresh="true" runat="server" 
    AutoDataBind="true" DisplayGroupTree="False" />
    <CR:CrystalReportSource ID="VendorRatingQual"  runat="server">
        <Report FileName="Module\MaterialManagement\Reports\VendorRatingQual.rpt">
        </Report>
    </CR:CrystalReportSource>  
    </td>
    </tr>
    </table> 
    </asp:Panel>    
        </ContentTemplate> 
    </cc1:TabPanel>
    
    <cc1:TabPanel runat="server" ID="TabPanel3" Visible="false" HeaderText="Delivery Rating">
    <ContentTemplate>
    <asp:Panel runat="server" ID="Panel2"  Width="100%" Height="410" ScrollBars="Auto" >
    <table width="100%">
            <tr>
            <td align="center">
    <CR:CrystalReportViewer ID="CrystalReportViewer3"  
        ReportSourceID="VendorRatingDelv"  EnableDatabaseLogonPrompt="false" 
        ReuseParameterValuesOnRefresh="true" runat="server" 
    AutoDataBind="true" DisplayGroupTree="False" />
    <CR:CrystalReportSource ID="VendorRatingDelv"  runat="server">
        <Report FileName="Module\MaterialManagement\Reports\VendorRatingDel.rpt">
        </Report>
    </CR:CrystalReportSource> 
     </td>
    </tr>
    </table>    
    </asp:Panel>    
        </ContentTemplate> 
    </cc1:TabPanel>
    
    </cc1:TabContainer>
      </td>
                </tr> 
        <tr>
            <td align="center" height="25">
            <asp:Button ID="Button1" runat="server" CssClass="redbox" Text="Cancel" onclick="Button1_Click"/>
                            
             </td>
             </tr>
    </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialManagement/Reports/VendorRating_Print.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_MaterialManagement_Reports_VendorRating_Print : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    int FinYearId = 0;
    int Item = 0;
    string SId = "";
    string SupplId = "";
    string Fd = "";
    string Td = "";
    string Category = "";
    string x = "";
    string Key = string.Empty;
    ReportDocument cryRpt = new ReportDocument();

    protected void Page_Init(object sender, EventArgs e)
    {

        CompId = Convert.ToInt32(Session["compid"]);
        FinYearId = Convert.ToInt32(Session["finyear"]);

        SId = Session["username"].ToString();
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);

        SupplId = Request.QueryString["SupCode"];
        Fd = Request.QueryString["FD"]; ;
        Td = Request.QueryString["TD"];
        Key = Request.QueryString["Key"].ToString();

        switch (Request.QueryString["Val"])
        {
            case "Select":
                x = "";
                break;

            case "WOItems":
                x = " And CId is NULL";
                break;
            case "BoughtOut":
                x = " And CId is not NULL";
                break;
        }
       
        if (!IsPostBack)
        {

            DataSet DS = new DataSet();
            DataTable dt = new DataTable();
            DataRow dr;
            con.Open();
            try
            {
                dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("UOMBasic", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("RecedQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("NormalAccQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("DeviatedQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("SegregatedQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("RejectedQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("SupId", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));
                dt.Columns.Add(new System.Data.DataColumn("Delrate", typeof(double)));//10
                dt.Columns.Add(new System.Data.DataColumn("OverallRating", typeof(double)));//11
                dt.Columns.Add(new System.Data.DataColumn("Rating", typeof(double)));//12
                string ItemCode = "";
                string ManfDesc = "";
                string UOMBasic = "";
                double SPRSup = 0;

                //////////////////////
                string sqlflag = "Select tblMM_PO_Master.Id, tblMM_PO_Master.PRSPRFlag, tblMM_PO_Master.SupplierId, tblMM_PO_Details.PONo, tblMM_PO_Details.PRNo, tblMM_PO_Details.PRId,tblMM_PO_Details.SPRNo, tblMM_PO_Details.SPRId from tblMM_PO_Master INNER JOIN tblMM_PO_Details ON tblMM_PO_Master.Id = tblMM_PO_Details.MId And  tblMM_PO_Master.CompId='" + CompId + "' AND tblMM_PO_Master.SupplierId='" + SupplId + "'And tblMM_PO_Master.Authorize=1  And tblMM_PO_Details.DelDate  between '" + fun.FromDate(Fd) + "' And '" + fun.FromDate(Td) + "'";

                SqlCommand cmd = new SqlCommand(sqlflag, con);
                SqlDataAdapter da = new SqlDataAdapter(cmd);

                da.Fill(DS);

                for (int p = 0; p < DS.Tables[0].Rows.Count; p++)
                {
                    double RecQty = 0;
                    double AccQty = 0;
                    double DevQty = 0;
                    double SegQty = 0;
                    double RejQty = 0;
                    double DelRate = 0;
                    double CalDateDiff = 0;
                    DateTime PODelDate = new DateTime();
                    DateTime GQNDelDate = new DateTime();
                    TimeSpan TimeDel = new TimeSpan();
                    DateTime ExtDate = new DateTime();
                    int poid = 0;
                    double rating = 0;
                    double orating = 0;
                    //dr = dt.NewRow();                                      
                    if (DS.Tables[0].Rows[p]["PRSPRFlag"].ToString() == "0")
                    {
                        string StrFlag = fun.select("tblMM_PR_Details.ItemId,tblMM_PR_Master.WONo,tblMM_PR_Details.Id,tblMM_PR_Master.PRNo", "tblMM_PR_Master,tblMM_PR_Details", " tblMM_PR_Details.Id='" + DS.Tables[0].Rows[p]["PRId"] + "' AND tblMM_PR_Master.CompId='" + CompId + "' AND tblMM_PR_Master.Id=tblMM_PR_Details.MId And tblMM_PR_Master.FinYearId='" + FinYearId + "' ");
                        SqlCommand cmdFlag = new SqlCommand(StrFlag, con);
                        SqlDataAdapter daFlag = new SqlDataAdapter(cmdFlag);
                        DataSet DSFlag = new DataSet();
                        daFlag.Fill(DSFlag);
                        for (int i = 0; i < DSFlag.Tables[0].Rows.Count; i++)
                        {
                            dr = dt.NewRow();
                            string StrIcode1 = "";


                            StrIcode1 = fun.select("Id,ItemCode,ManfDesc,UOMBasic", "tblDG_Item_Master", " CompId='" + CompId + "' And Id='" + DSFlag.Tables[0].Rows[i]["ItemId"].ToString() + "' " + x);

                            SqlCommand cmdIcode1 = new SqlCommand(StrIcode1, con);
                            SqlDataAdapter daIcode1 = new SqlDataAdapter(cmdIcode1);
                            DataSet DSIcode1 = new DataSet();
                            daIcode1.Fill(DSIcode1);

                            if (DSIcode1.Tables[0].Rows.Count > 0)
                            {
                                ItemCode = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(DSIcode1.Tables[0].Rows[0]["Id"].ToString()));

                                ManfDesc = DSIcode1.Tables[0].Rows[0]["ManfDesc"].ToString();
                                // for UOM Purchase  from Unit Master table
                                string sqlPurch1 = fun.select("Symbol", "Unit_Master", "Id='" + DSIcode1.Tables[0].Rows[0]["UOMBasic"].ToString() + "' ");
                                SqlCommand cmdPurch1 = new SqlCommand(sqlPurch1, con);
                                SqlDataAdapter daPurch1 = new SqlDataAdapter(cmdPurch1);
                                DataSet DSPurch1 = new DataSet();
                                daPurch1.Fill(DSPurch1);
                                if (DSPurch1.Tables[0].Rows.Count > 0)
                                {
                                    UOMBasic = DSPurch1.Tables[0].Rows[0][0].ToString();
                                }


                                //-----------------------------------------------------------------------------------

                                string StrSql31 = fun.select("tblMM_PO_Master.PONo,tblMM_PO_Master.SupplierId,tblMM_PO_Details.Id,tblMM_PO_Details.DelDate ", "tblMM_PO_Details,tblMM_PO_Master", " tblMM_PO_Master.SupplierId='" + SupplId + "'AND tblMM_PO_Master.CompId='" + CompId + "' AND tblMM_PO_Master.Id=tblMM_PO_Details.MId AND tblMM_PO_Details.PRId='" + Convert.ToInt32(DSFlag.Tables[0].Rows[i]["Id"]) + "'");
                                SqlCommand cmdsupId31 = new SqlCommand(StrSql31, con);
                                SqlDataAdapter dasupId31 = new SqlDataAdapter(cmdsupId31);
                                DataSet DSSql31 = new DataSet();
                                dasupId31.Fill(DSSql31);
                                for (int j = 0; j < DSSql31.Tables[0].Rows.Count; j++)
                                {

                                    poid = Convert.ToInt32(DSSql31.Tables[0].Rows[j]["Id"]);
                                    SupplId = DSSql31.Tables[0].Rows[j]["SupplierId"].ToString();
                                    string StrSql2 = fun.select("tblInv_Inward_Master.GINNo,tblInv_Inward_Master.Id", "tblInv_Inward_Master,tblInv_Inward_Details", "CompId='" + CompId + "' AND tblInv_Inward_Master.Id=tblInv_Inward_Details.GINId AND tblInv_Inward_Details.POId='" + Convert.ToInt32(DSSql31.Tables[0].Rows[j]["Id"]) + "' AND tblInv_Inward_Master.PONo='" + DSSql31.Tables[0].Rows[j]["PONo"].ToString() + "'");
                                    SqlCommand cmdsupId2 = new SqlCommand(StrSql2, con);
                                    SqlDataAdapter dasupId2 = new SqlDataAdapter(cmdsupId2);
                                    DataSet DSSql2 = new DataSet();
                                    dasupId2.Fill(DSSql2);

                                    for (int j1 = 0; j1 < DSSql2.Tables[0].Rows.Count; j1++)
                                    {
                                        string StrSql = fun.select("tblinv_MaterialReceived_Master.GRRNo,tblinv_MaterialReceived_Details.Id,tblinv_MaterialReceived_Details.ReceivedQty", "tblinv_MaterialReceived_Master,tblinv_MaterialReceived_Details", "tblinv_MaterialReceived_Master.CompId='" + CompId + "' AND tblinv_MaterialReceived_Master.GINId='" + DSSql2.Tables[0].Rows[j1]["Id"].ToString() + "' AND tblinv_MaterialReceived_Master.Id=tblinv_MaterialReceived_Details.MId AND tblinv_MaterialReceived_Details.POId='" + poid + "'");
                                        SqlCommand cmdsupId = new SqlCommand(StrSql, con);
                                        SqlDataAdapter dasupId = new SqlDataAdapter(cmdsupId);
                                        DataSet DSSql = new DataSet();
                                        dasupId.Fill(DSSql);

                                        for (int s = 0; s < DSSql.Tables[0].Rows.Count; s++)
                                        {

                                            RecQty = Convert.ToDouble(decimal.Parse((DSSql.Tables[0].Rows[s]["ReceivedQty"]).ToString()).ToString("N3"));
                                            string StrGQN = fun.select("tblQc_MaterialQuality_Details.DeviatedQty,tblQc_MaterialQuality_Details.SegregatedQty,tblQc_MaterialQuality_Details.RejectedQty,tblQc_MaterialQuality_Details.NormalAccQty,tblQc_MaterialQuality_Details.RejectedQty,tblQc_MaterialQuality_Master.SysDate", "tblQc_MaterialQuality_Master,tblQc_MaterialQuality_Details", "tblQc_MaterialQuality_Master.CompId='" + CompId + "'  AND tblQc_MaterialQuality_Master.Id=tblQc_MaterialQuality_Details.MId AND  tblQc_MaterialQuality_Details.GRRId='" + DSSql.Tables[0].Rows[s]["Id"] + "' ");

                                            SqlCommand cmdGQN = new SqlCommand(StrGQN, con);
                                            SqlDataAdapter daGQN = new SqlDataAdapter(cmdGQN);
                                            DataSet DSGQN = new DataSet();
                                            daGQN.Fill(DSGQN);

                                            for (int s1 = 0; s1 < DSGQN.Tables[0].Rows.Count; s1++)
                                            {

                                                AccQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["NormalAccQty"].ToString()).ToString("N3"));
                                                DevQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["DeviatedQty"].ToString()).ToString("N3"));
                                                SegQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["SegregatedQty"].ToString()).ToString("N3"));
                                                RejQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["RejectedQty"].ToString()).ToString("N3"));
                                                dr[4] = AccQty;
                                                dr[5] = DevQty;
                                                dr[6] = SegQty;

                                                rating = Convert.ToDouble(decimal.Parse(((((AccQty * 1) + (DevQty * 0.70) + (SegQty * 0.50)) * 100) / (RecQty)).ToString()).ToString("N3"));

                                                GQNDelDate = Convert.ToDateTime(DSGQN.Tables[0].Rows[s1]["SysDate"].ToString());
                                                dr[7] = RejQty;
                                            }
                                        }

                                    }
                                    dr[8] = SupplId.ToString();
                                    PODelDate = Convert.ToDateTime(DSSql31.Tables[0].Rows[j]["DelDate"].ToString());
                                    TimeDel = (PODelDate - GQNDelDate);
                                    CalDateDiff = Convert.ToDouble(Math.Round((TimeDel.TotalDays * 1.1), 0));
                                    ExtDate = GQNDelDate.AddDays(CalDateDiff);
                                    if (ExtDate >= PODelDate)
                                    {
                                        DelRate = 100;
                                    }
                                    else
                                    {
                                        DelRate = 0;
                                    }
                                    dr[10] = DelRate;
                                }
                                dr[0] = ItemCode;
                                dr[1] = ManfDesc;
                                dr[2] = UOMBasic;
                                dr[3] = RecQty;
                                dr[9] = CompId;
                                orating = Math.Round((rating * 0.6) + (DelRate * 0.4));
                                dr[11] = Math.Round(orating);
                                dr[12] = Math.Round(rating);
                                dt.Rows.Add(dr);
                                dt.AcceptChanges();
                            }
                        }

                    }
                    else if (DS.Tables[0].Rows[p]["PRSPRFlag"].ToString() == "1")
                    {
                        string StrFlag1 = fun.select("tblMM_SPR_Details.ItemId,tblMM_SPR_Details.WONo,tblMM_SPR_Details.Id,tblMM_SPR_Master.SPRNo", "tblMM_SPR_Master,tblMM_SPR_Details", "tblMM_SPR_Master.Id=tblMM_SPR_Details.MId AND tblMM_SPR_Master.CompId='" + CompId + "' And tblMM_SPR_Details.Id='" + DS.Tables[0].Rows[p]["SPRId"] + "'  And tblMM_SPR_Master.FinYearId='" + FinYearId + "' ");

                        SqlCommand cmdFlag1 = new SqlCommand(StrFlag1, con);
                        SqlDataAdapter daFlag1 = new SqlDataAdapter(cmdFlag1);
                        DataSet DSFlag1 = new DataSet();
                        daFlag1.Fill(DSFlag1);

                        for (int i = 0; i < DSFlag1.Tables[0].Rows.Count; i++)
                        {
                            dr = dt.NewRow();

                            string StrIcode1 = "";

                            StrIcode1 = fun.select("Id,ItemCode,ManfDesc,UOMBasic", "tblDG_Item_Master", " CompId='" + CompId + "' And Id='" + DSFlag1.Tables[0].Rows[i]["ItemId"].ToString() + "'    " + x);

                            SqlCommand cmdIcode1 = new SqlCommand(StrIcode1, con);
                            SqlDataAdapter daIcode1 = new SqlDataAdapter(cmdIcode1);
                            DataSet DSIcode1 = new DataSet();
                            daIcode1.Fill(DSIcode1);
                            if (DSIcode1.Tables[0].Rows.Count > 0)
                            {
                                ItemCode = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(DSIcode1.Tables[0].Rows[0]["Id"].ToString()));

                                //Response.Write(ItemCode);
                                ManfDesc = DSIcode1.Tables[0].Rows[0]["ManfDesc"].ToString();
                                // for UOM Purchase  from Unit Master table
                                string sqlPurch1 = fun.select("Symbol", "Unit_Master", "Id='" + DSIcode1.Tables[0].Rows[0]["UOMBasic"].ToString() + "' ");
                                SqlCommand cmdPurch1 = new SqlCommand(sqlPurch1, con);
                                SqlDataAdapter daPurch1 = new SqlDataAdapter(cmdPurch1);
                                DataSet DSPurch1 = new DataSet();
                                daPurch1.Fill(DSPurch1);
                                if (DSPurch1.Tables[0].Rows.Count > 0)
                                {
                                    UOMBasic = DSPurch1.Tables[0].Rows[0][0].ToString();
                                }


                                //-----------------------------------------------------------------------------------

                                string StrSup = fun.select(" count(tblMM_PO_Master.SupplierId)", "tblMM_PO_Master,tblMM_PO_Details", " tblMM_PO_Master.PONo=tblMM_PO_Details.PONo AND tblMM_PO_Master.CompId='" + CompId + "' AND tblMM_PO_Master.Id=tblMM_PO_Details.MId And tblMM_PO_Master.SupplierId='" + SupplId + "'  Group by tblMM_PO_Master.SupplierId ");

                                SqlCommand cmdSup = new SqlCommand(StrSup, con);
                                SqlDataAdapter daSup = new SqlDataAdapter(cmdSup);
                                DataSet dsSup = new DataSet();
                                daSup.Fill(dsSup);
                                if (dsSup.Tables[0].Rows.Count > 0)
                                {
                                    SPRSup = dsSup.Tables[0].Rows.Count;

                                }
                                string StrSql31 = fun.select("tblMM_PO_Master.PONo,tblMM_PO_Master.SupplierId,tblMM_PO_Details.Id ,tblMM_PO_Details.DelDate", "tblMM_PO_Details,tblMM_PO_Master", " tblMM_PO_Master.SupplierId='" + SupplId + "'AND  tblMM_PO_Master.CompId='" + CompId + "' AND tblMM_PO_Master.Id=tblMM_PO_Details.MId AND tblMM_PO_Details.SPRId='" + Convert.ToInt32(DSFlag1.Tables[0].Rows[i]["Id"]) + "' ");
                                SqlCommand cmdsupId31 = new SqlCommand(StrSql31, con);
                                SqlDataAdapter dasupId31 = new SqlDataAdapter(cmdsupId31);
                                DataSet DSSql31 = new DataSet();
                                dasupId31.Fill(DSSql31);

                                for (int j = 0; j < DSSql31.Tables[0].Rows.Count; j++)
                                {
                                    poid = Convert.ToInt32(DSSql31.Tables[0].Rows[j]["Id"]);
                                    SupplId = DSSql31.Tables[0].Rows[j]["SupplierId"].ToString();
                                    string StrSql2 = fun.select("tblInv_Inward_Master.GINNo,tblInv_Inward_Master.Id", "tblInv_Inward_Master,tblInv_Inward_Details", "CompId='" + CompId + "' AND tblInv_Inward_Master.Id=tblInv_Inward_Details.GINId AND tblInv_Inward_Details.POId='" + Convert.ToInt32(DSSql31.Tables[0].Rows[j]["Id"]) + "' AND tblInv_Inward_Master.PONo='" + DSSql31.Tables[0].Rows[j]["PONo"].ToString() + "'");
                                    SqlCommand cmdsupId2 = new SqlCommand(StrSql2, con);
                                    SqlDataAdapter dasupId2 = new SqlDataAdapter(cmdsupId2);
                                    DataSet DSSql2 = new DataSet();
                                    dasupId2.Fill(DSSql2);
                                    for (int j1 = 0; j1 < DSSql2.Tables[0].Rows.Count; j1++)
                                    {

                                        string StrSql = fun.select("tblinv_MaterialReceived_Master.GRRNo,tblinv_MaterialReceived_Details.Id,tblinv_MaterialReceived_Details.ReceivedQty", "tblinv_MaterialReceived_Master,tblinv_MaterialReceived_Details", "tblinv_MaterialReceived_Master.CompId='" + CompId + "' AND tblinv_MaterialReceived_Master.GINId='" + DSSql2.Tables[0].Rows[j1]["Id"].ToString() + "' AND tblinv_MaterialReceived_Master.Id=tblinv_MaterialReceived_Details.MId AND tblinv_MaterialReceived_Details.POId='" + poid + "'");
                                        SqlCommand cmdsupId = new SqlCommand(StrSql, con);
                                        SqlDataAdapter dasupId = new SqlDataAdapter(cmdsupId);
                                        DataSet DSSql = new DataSet();
                                        dasupId.Fill(DSSql);

                                        for (int s = 0; s < DSSql.Tables[0].Rows.Count; s++)
                                        {
                                            RecQty = Convert.ToDouble(decimal.Parse((DSSql.Tables[0].Rows[s]["ReceivedQty"]).ToString()).ToString("N3"));
                                            string StrGQN = fun.select(" tblQc_MaterialQuality_Details.DeviatedQty,tblQc_MaterialQuality_Details.SegregatedQty,tblQc_MaterialQuality_Details.RejectedQty,tblQc_MaterialQuality_Details.NormalAccQty,tblQc_MaterialQuality_Master.SysDate", "tblQc_MaterialQuality_Master,tblQc_MaterialQuality_Details", "tblQc_MaterialQuality_Master.CompId='" + CompId + "'  AND tblQc_MaterialQuality_Master.Id=tblQc_MaterialQuality_Details.MId AND tblQc_MaterialQuality_Details.GRRId='" + DSSql.Tables[0].Rows[s]["Id"] + "'  ");
                                            SqlCommand cmdGQN = new SqlCommand(StrGQN, con);
                                            SqlDataAdapter daGQN = new SqlDataAdapter(cmdGQN);
                                            DataSet DSGQN = new DataSet();
                                            daGQN.Fill(DSGQN);

                                            for (int s1 = 0; s1 < DSGQN.Tables[0].Rows.Count; s1++)
                                            {

                                                AccQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["NormalAccQty"].ToString()).ToString("N3"));
                                                DevQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["DeviatedQty"].ToString()).ToString("N3"));
                                                SegQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["SegregatedQty"].ToString()).ToString("N3"));
                                                RejQty = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[s1]["RejectedQty"].ToString()).ToString("N3"));
                                                dr[4] = AccQty;
                                                dr[5] = DevQty;
                                                dr[6] = SegQty;
                                                dr[7] = RejQty;

                                                rating = Convert.ToDouble(decimal.Parse(((((AccQty * 1) + (DevQty * 0.70) + (SegQty * 0.50)) * 100) / (RecQty)).ToString()).ToString("N3"));

                                                GQNDelDate = Convert.ToDateTime(DSGQN.Tables[0].Rows[s1]["SysDate"].ToString());
                                            }
                                        }

                                    }

                                    dr[8] = SupplId.ToString();
                                    PODelDate = Convert.ToDateTime(DSSql31.Tables[0].Rows[j]["DelDate"].ToString());
                                    TimeDel = (PODelDate - GQNDelDate);

                                    CalDateDiff = Convert.ToDouble(Math.Round((TimeDel.TotalDays * 1.1), 0));
                                    ExtDate = GQNDelDate.AddDays(CalDateDiff);

                                    if (ExtDate >= PODelDate)
                                    {
                                        DelRate = 100;
                                    }
                                    else
                                    {
                                        DelRate = 0;
                                    }

                                    dr[10] = DelRate;
                                }

                                dr[0] = ItemCode;
                                dr[1] = ManfDesc;
                                dr[2] = UOMBasic;
                                dr[3] = RecQty;
                                dr[9] = CompId;

                                orating = Convert.ToDouble(decimal.Parse(((rating * 0.6) + (DelRate * 0.4)).ToString()).ToString("N3"));
                                dr[11] = Convert.ToDouble(decimal.Parse((orating / SPRSup).ToString()).ToString("N3"));

                                dr[12] = Convert.ToDouble(decimal.Parse(rating.ToString()).ToString("N3"));

                                dt.Rows.Add(dr);
                                dt.AcceptChanges();
                            }
                        }
                    }

                }

                ///////////////////
                //var query = from r in dt.AsEnumerable()

                //            group r by new { ID = r.Field<string>("SupplierId"), CompId = r.Field<Int32>("CompId") } into grp
                //            select new
                //            {
                //                ID = grp.Key.ID,
                //                Compid = grp.Key.CompId,
                //                SumQual = grp.Average(r => r.Field<double>("Rating")),
                //                SumDel = grp.Average(r => r.Field<double>("Delrate")),
                //                ABC = ((grp.Average(r => r.Field<double>("Rating")) * 0.6) + (grp.Average(r => r.Field<double>("Delrate")) * 0.4))

                //            };

                //DataTable dt2 = new DataTable();
                //DataRow dr2;
                //dt2.Columns.Add(new System.Data.DataColumn("SupId", typeof(string)));
                //dt2.Columns.Add(new System.Data.DataColumn("QualRating", typeof(double)));
                //dt2.Columns.Add(new System.Data.DataColumn("DelivRating", typeof(double)));
                //dt2.Columns.Add(new System.Data.DataColumn("OverAllRating", typeof(double)));

                //foreach (var str in query)
                //{
                //    dr2 = dt2.NewRow();
                //    dr2[0] = str.ID;
                //    dr2[1] = str.SumQual;
                //    dr2[2] = str.SumDel;
                //    dr2[3] = str.ABC;                   
                //    dt2.Rows.Add(dr2);
                //    dt2.AcceptChanges();
                //}


                DataSet dSXsd = new VendorRating();
                //dSXsd.Tables[0].Merge(dt2);
                dSXsd.Tables[0].Merge(dt);
                dSXsd.AcceptChanges();

                cryRpt.Load(Server.MapPath("~/Module/MaterialManagement/Reports/VendorRating.rpt"));
                cryRpt.SetDataSource(dSXsd);
                // For Address
                string Address = fun.CompAdd(CompId);
                cryRpt.SetParameterValue("Address", Address);
                cryRpt.SetParameterValue("ManfDesc", ManfDesc);
                cryRpt.SetParameterValue("ItemCode", ItemCode);
                cryRpt.SetParameterValue("UOM", UOMBasic);
                CrystalReportViewer1.ReportSource = cryRpt;
                Session[Key] = cryRpt;





                //ReportDocument cryRpt2 = new ReportDocument();
                //cryRpt2.Load(Server.MapPath("~/Module/MaterialManagement/Reports/VendorRatingQual.rpt"));
                //cryRpt2.SetDataSource(dSXsd);
                //cryRpt2.SetParameterValue("Address", Address);
                //cryRpt2.SetParameterValue("ManfDesc", ManfDesc);
                //cryRpt2.SetParameterValue("ItemCode", ItemCode);
                //cryRpt2.SetParameterValue("UOM", UOMBasic);
                //CrystalReportViewer2.ReportSource = cryRpt2;
                //Session["ReportDocument2"] = cryRpt2;


                //ReportDocument cryRpt3 = new ReportDocument();
                //cryRpt3.Load(Server.MapPath("~/Module/MaterialManagement/Reports/VendorRatingDel.rpt"));
                //cryRpt3.SetDataSource(dSXsd);
                //// For Address            
                //cryRpt3.SetParameterValue("Address", Address);
                //cryRpt3.SetParameterValue("ManfDesc", ManfDesc);
                //cryRpt3.SetParameterValue("ItemCode", ItemCode);
                //cryRpt3.SetParameterValue("UOM", UOMBasic);
                //Supplier Address
                string cn = fun.select("SupplierName,RegdAddress,RegdCountry,RegdState,RegdCity,RegdPinNo", "tblMM_Supplier_master", "SupplierId='" + SupplId + "' And CompId='" + CompId + "'");
                DataSet dsAdd = new DataSet();
                SqlCommand cmdSupAdd = new SqlCommand(cn, con);
                SqlDataAdapter daAdd = new SqlDataAdapter(cmdSupAdd);
                daAdd.Fill(dsAdd, "tblMM_Supplier_master");

                string strcmd1 = fun.select("CountryName", "tblcountry", "CId='" + dsAdd.Tables[0].Rows[0]["RegdCountry"] + "'");
                string strcmd2 = fun.select("StateName", "tblState", "SId='" + dsAdd.Tables[0].Rows[0]["RegdState"] + "'");
                string strcmd3 = fun.select("CityName", "tblCity", "CityId='" + dsAdd.Tables[0].Rows[0]["RegdCity"] + "'");
                SqlCommand Cmd1 = new SqlCommand(strcmd1, con);
                SqlCommand Cmd2 = new SqlCommand(strcmd2, con);
                SqlCommand Cmd3 = new SqlCommand(strcmd3, con);

                SqlDataAdapter DA1 = new SqlDataAdapter(Cmd1);
                SqlDataAdapter DA2 = new SqlDataAdapter(Cmd2);
                SqlDataAdapter DA3 = new SqlDataAdapter(Cmd3);

                DataSet ds1 = new DataSet();
                DataSet ds2 = new DataSet();
                DataSet ds3 = new DataSet();

                DA1.Fill(ds1, "tblCountry");
                DA2.Fill(ds2, "tblState");
                DA3.Fill(ds3, "tblcity");

                string SupplierAddress = dsAdd.Tables[0].Rows[0]["RegdAddress"].ToString() + "," + ds3.Tables[0].Rows[0]["CityName"].ToString() + "," + ds2.Tables[0].Rows[0]["StateName"].ToString() + "," + ds1.Tables[0].Rows[0]["CountryName"].ToString() + "." + dsAdd.Tables[0].Rows[0]["RegdPinNo"].ToString() + "." + "";

                cryRpt.SetParameterValue("SupplierAddress", SupplierAddress);
                //CrystalReportViewer3.ReportSource = cryRpt3;
                //Session["ReportDocument3"] = cryRpt3;

            }
            catch (Exception ex) { }
            finally
            {
                DS.Clear();
                DS.Dispose();
                dt.Clear();
                dt.Dispose();
                con.Close();
                con.Dispose();
            }
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;

            //ReportDocument doc2 = (ReportDocument)Session["ReportDocument2"];
            //CrystalReportViewer2.ReportSource = doc2;
            //ReportDocument doc3 = (ReportDocument)Session["ReportDocument3"];
            //CrystalReportViewer3.ReportSource = doc3;
        }
    }





    protected void Page_Load(object sender, EventArgs e)
    {
        cryRpt = new ReportDocument();


        //CompId = Convert.ToInt32(Session["compid"]);
        //FinYearId = Convert.ToInt32(Session["finyear"]);

        //SId = Session["username"].ToString();
        //string connStr = fun.Connection();
        //SqlConnection con = new SqlConnection(connStr);
        //DataTable dt = new DataTable();
        //SupplId = Request.QueryString["SupCode"];
        //Fd = Request.QueryString["FD"]; ;
        //Td = Request.QueryString["TD"];

        //switch (Request.QueryString["Val"])
        //{
        //    case "Select":
        //        x = "1";
        //        break;

        //    case "WOItems":
        //        x = " And CId is NULL";
        //        break;
        //    case "BoughtOut":
        //        x = " And CId is not NULL";
        //        break;
        //}
        ////Response.Write(x);
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        Response.Redirect("VendorRating.aspx");
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        cryRpt.Close();
        cryRpt.Dispose();
        GC.Collect();
    }
}