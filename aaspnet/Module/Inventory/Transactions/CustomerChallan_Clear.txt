=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/CustomerChallan_Clear.aspx.txt ===

﻿<%@ Page Language="C#" AutoEventWireup="true" CodeFile="CustomerChallan_Clear.aspx.cs" Inherits="Module_Inventory_Transactions_CustomerChallan_Clear" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
    <title>ERP</title>
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    
</head>
<body  style="margin:0px 0px 0px 0px" class="fontcss" >
    <form id="form1" runat="server">
    <div>
     
                         <table width="100%" align="center" cellpadding="0" cellspacing="0"   >
        <tr>
            <td>
                <table width="100%"  cellpadding="0" cellspacing="0">

                    <tr >
                       <td valign="top"  align="Left"width="35%"  >
                       
                       <asp:GridView ID="GridView1" runat="server" AllowPaging="True" 
                                    AllowSorting="True" AutoGenerateColumns="False" CssClass="yui-datatable-theme" 
                                    DataKeyNames="Id" onpageindexchanging="GridView1_PageIndexChanging" 
                                    onrowcommand="GridView1_RowCommand" PageSize="17" Width="95%">
                                    <Columns>   
                                       
                                        <asp:TemplateField HeaderText="SN">
                                            <ItemTemplate>
                                                <%# Container.DataItemIndex+1 %>
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Right" Width="15%" />
                                        </asp:TemplateField>
                                        <asp:BoundField DataField="FinYear" HeaderText="Fin Yrs">
                                            <ItemStyle HorizontalAlign="Center" Width="25%" />
                                        </asp:BoundField>
                                        <asp:TemplateField HeaderText="CC No">
                                            <ItemTemplate>
                                                <asp:LinkButton ID="lnkbtnScNo" runat="server" CommandName="Sel" 
                                                    Text='<%#Eval("CCNo") %>'></asp:LinkButton>
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Center" Width="30%" />
                                        </asp:TemplateField>
                                        <asp:TemplateField Visible="False">
                                            <ItemTemplate>
                                                <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>' />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Center" />
                                        </asp:TemplateField>
                                        <asp:BoundField DataField="WONo" HeaderText="WO No" />
                                    </Columns>
                                    <EmptyDataTemplate>
                                        <table class="fontcss" width="100%">
                                            <tr>
                                                <td align="center">
                                                    <asp:Label ID="Label1" runat="server" Font-Size="Larger" ForeColor="maroon" 
                                                        Text="No data to display !"> </asp:Label>
                                                </td>
                                            </tr>
                                        </table>
                                    </EmptyDataTemplate>
                                    <PagerSettings PageButtonCount="40" />
                                    <RowStyle HorizontalAlign="Center" />
                                </asp:GridView>
                        </td>
                       
                        <td align="center">
                        <asp:Panel ID="Panel2"  ScrollBars="Auto"  Height="390px" runat="server">                    
                        
                              <asp:GridView ID="GridView2" runat="server" 
                                    AllowSorting="True" AutoGenerateColumns="False" CssClass="yui-datatable-theme" 
                                    DataKeyNames="Id" onpageindexchanging="GridView2_PageIndexChanging" 
                                    onrowcommand="GridView2_RowCommand" PageSize="17" Width="100%">
                                    <Columns>
                                    
                                     <asp:TemplateField ><ItemTemplate>  <asp:CheckBox ID="CheckBox1" runat="server" AutoPostBack="true" oncheckedchanged="CheckBox1_CheckedChanged"
                                                 />
                                                </ItemTemplate><ItemStyle HorizontalAlign="Center" /></asp:TemplateField>
                                        <asp:TemplateField HeaderText="SN">
                                            <ItemTemplate>
                                                <%# Container.DataItemIndex+1 %>
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Right" Width="6%" />
                                        </asp:TemplateField>
                                        <asp:BoundField DataField="ItemCode" HeaderText="Item Code">
                                            <ItemStyle HorizontalAlign="Center" Width="12%" />
                                        </asp:BoundField>
                                        <asp:TemplateField HeaderText="Description">
                                            <ItemTemplate>
                                              <asp:Label ID="lblDesc" runat="server" Text='<%#Eval("ManfDesc") %>' />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Left" Width="45%" />
                                        </asp:TemplateField>
                                          <asp:TemplateField HeaderText="UOM">
                                            <ItemTemplate>
                                                <asp:Label ID="lblUOM" runat="server" Text='<%#Eval("Symbol") %>' />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Left" />
                                        </asp:TemplateField>
                                        
                                         <asp:TemplateField HeaderText="Challan Qty">
                                            <ItemTemplate>
                                                <asp:Label ID="lblChallanQty" runat="server" Text='<%#Eval("ChallanQty") %>' />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Right" />
                                        </asp:TemplateField>
                                          
                                         <asp:TemplateField HeaderText="Cleared Qty">
                                            <ItemTemplate>
                                                <asp:Label ID="lblClearedQty" runat="server"  />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Right" />
                                        </asp:TemplateField>
                                        
                                        
                                        
                                       <asp:TemplateField  HeaderText=" Clear Qty">
                        <ItemTemplate>
                            <asp:TextBox ID="TxtQty" runat="server" Width="80%"></asp:TextBox>
                            
                            <asp:RegularExpressionValidator ID="RegularExpressionValidator2" runat="server" ErrorMessage="*" ControlToValidate="TxtQty" ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="A"></asp:RegularExpressionValidator>
                                    <asp:RequiredFieldValidator
                                        ID="ReqChNo" runat="server" ErrorMessage="*"  ValidationGroup="A" ControlToValidate="TxtQty"></asp:RequiredFieldValidator>
                            
                            
           </ItemTemplate>
             <ItemStyle HorizontalAlign="Left" Width="13%" />
           <ItemStyle HorizontalAlign="Left" /></asp:TemplateField>
                                        <asp:TemplateField Visible="False">
                                            <ItemTemplate>
                                                <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>' />
                                            </ItemTemplate>
                                            <ItemStyle HorizontalAlign="Center" />
                                        </asp:TemplateField>
                                        
                                    </Columns>
                                    <EmptyDataTemplate>
                                        <table class="fontcss" width="100%">
                                            <tr>
                                                <td align="center">
                                                    <asp:Label ID="Label1" runat="server" Font-Size="Larger" ForeColor="maroon" 
                                                        Text="No data to display !"> </asp:Label>
                                                </td>
                                            </tr>
                                        </table>
                                    </EmptyDataTemplate>
                                    <PagerSettings PageButtonCount="40" />
                                    <RowStyle HorizontalAlign="Center" />
                                </asp:GridView> </asp:Panel></td>
                       
                    </tr>

                     <tr>
                                    <td  >
                                        
                                        
                                    </td>
                                    <td valign="top" align="center" >
                                    <asp:Button ID="BtnAdd" ValidationGroup="A"  runat="server"  CssClass="redbox" 
                                            Text="Submit" onclick="BtnAdd_Click"  Visible="false" />
                                            &nbsp;&nbsp;&nbsp;&nbsp;
                                            
                                             </td>
                                </tr>
              </table>
                <asp:ScriptManager ID="ScriptManager1" runat="server">
                </asp:ScriptManager>
              
            </td>
        </tr>
</table>
                    
    </div>
    </form>
</body>
</html>


=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/CustomerChallan_Clear.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_Inventory_Transactions_CustomerChallan_Clear : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    string sId = "";
    int CompId = 0;
    int fyid = 0;
    string supid = "";
    string str = "";
    string wono = "";
    SqlConnection con;
    string CDate = "";
    string CTime = "";
    protected void Page_Load(object sender, EventArgs e)

    {

        try
        {
            CDate = fun.getCurrDate();
            CTime = fun.getCurrTime();
            CompId = Convert.ToInt32(Session["compid"]);
            fyid = Convert.ToInt32(Session["finyear"]);
            wono = Request.QueryString["WONo"].ToString();
            sId = Session["username"].ToString();
            str = fun.Connection();
            con = new SqlConnection(str);
            this.BindData();
        }
        catch (Exception ex)
        {
        }
       
    }

    protected void GridView1_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        try
        {
        GridView1.PageIndex = e.NewPageIndex;
        this.BindData();
        }
        catch (Exception ex)
        {
        }
    }

    public void BindData()
    {

       try
        {

            SqlDataAdapter da = new SqlDataAdapter("GetCCWO", con);
            da.SelectCommand.CommandType = CommandType.StoredProcedure;
            da.SelectCommand.Parameters.Add(new SqlParameter("@WONo", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@FinId", SqlDbType.VarChar));
            da.SelectCommand.Parameters["@WONo"].Value = wono;
            da.SelectCommand.Parameters["@CompId"].Value = CompId;
            da.SelectCommand.Parameters["@FinId"].Value = fyid;
            DataSet DSitem = new DataSet();
            da.Fill(DSitem);
            GridView1.DataSource = DSitem;
             GridView1.DataBind();
             con.Close();
        }
       catch (Exception ex)
        {
        }

    }

 

   
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        try
        {
        if (e.CommandName == "Sel")
        {
            GridViewRow grv = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
            int Id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
            if (Id.ToString() != string.Empty)
            {
                ViewState["Id"] = Id;
                this.LoadData();
                this.GetValidate();
                BtnAdd.Visible = true;
             
            }

        }

         }
        catch (Exception ex)
        {
        }
    }

    public void LoadData()
    {


       try
        {
            con.Open();
            string Id = "";
            if (!string.IsNullOrEmpty(ViewState["Id"].ToString()))
            {
                Id = (ViewState["Id"].ToString());

            }



            SqlDataAdapter da = new SqlDataAdapter("GetCustChallan_Details", con);
            da.SelectCommand.CommandType = CommandType.StoredProcedure;
            da.SelectCommand.Parameters.Add(new SqlParameter("@Id", SqlDbType.VarChar));
            da.SelectCommand.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.SelectCommand.Parameters["@CompId"].Value = CompId;
            da.SelectCommand.Parameters["@Id"].Value = Id;
            DataSet DSitem = new DataSet();
            da.Fill(DSitem);
            GridView2.DataSource = DSitem;
            GridView2.DataBind();
            this.GetValidate();
            con.Close();

        }

       catch (Exception ex)
        { }








    }



    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {
        this.GetValidate();
    }

    protected void BtnAdd_Click(object sender, EventArgs e)
    {
         try
        {

            int y = 0;
            int x = 0;
            int k = 0;

            foreach (GridViewRow grv in GridView2.Rows)
            {
                if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                {
                    x++;
                    if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("TxtQty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("TxtQty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("TxtQty")).Text) != 0)
                    {
                        double CleardQty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("TxtQty")).Text).ToString("N3"));
                        double ChallanQty = Convert.ToDouble(decimal.Parse(((Label)grv.FindControl("lblChallanQty")).Text).ToString("N3"));
                        int Id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                        double TotClearQty = 0;

                        string StrSql3 = "SELECT  Sum(tblInv_Customer_Challan_Clear.ClearQty) As ClearedQty  FROM  tblInv_Customer_Challan_Clear INNER JOIN tblInv_Customer_Challan_Details ON tblInv_Customer_Challan_Clear.DId = tblInv_Customer_Challan_Details.Id   And tblInv_Customer_Challan_Clear.DId=" + Id + "";
                        SqlCommand cmd3 = new SqlCommand(StrSql3, con);
                        SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                        DataSet DS3 = new DataSet();
                        da3.Fill(DS3);
                        if (DS3.Tables[0].Rows.Count > 0 && DS3.Tables[0].Rows[0][0] != DBNull.Value)
                        {
                            TotClearQty = Convert.ToDouble(decimal.Parse(DS3.Tables[0].Rows[0][0].ToString()).ToString("N3"));
                        }

                        if (Convert.ToDouble(decimal.Parse((ChallanQty - (CleardQty + TotClearQty)).ToString()).ToString("N3")) >= 0)
                        {
                            y++;
                        }

                    }
                }

            }

            if (x == y && y > 0)
            {


                DataSet DS = new DataSet();


             
                {
                   
                    foreach (GridViewRow grv in GridView2.Rows)
                    {


                        if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("TxtQty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("TxtQty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("TxtQty")).Text) != 0)
                        {
                            int dId = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                            double Qty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("TxtQty")).Text).ToString("N3"));


                            SqlCommand exeme2 = new SqlCommand(fun.insert("tblInv_Customer_Challan_Clear", "SysDate,SysTime,SessionId,CompId,FinYearId,DId,ClearQty", "'" + CDate + "','" + CTime + "','" + sId + "','" + CompId + "','" + fyid + "','" + dId + "','" + Qty + "'"), con);
                            con.Open();
                            exeme2.ExecuteNonQuery();
                            con.Close();
                            k++;

                        }
                    }
                }
            }

            else
            {
                string myStringVariable = string.Empty;
                myStringVariable = "Invalid input data.";
                ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);

            }

            if (k > 0)
            {
                this.LoadData();
            }

        }
        catch (Exception ex) { }
    }
    public void GetValidate()
    {

        try
        {
            foreach (GridViewRow grv in GridView2.Rows)
            {
                int Id = Convert.ToInt32(((Label)grv.FindControl("lblId")).Text);
                if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                {
                    ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = true;
                    ((TextBox)grv.FindControl("TxtQty")).Enabled = true;

                }
                else
                {
                    ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = false;
                    ((TextBox)grv.FindControl("TxtQty")).Enabled = false;
                }

                double TotClearedQty = 0;
                double ChallanQty = 0;
                ChallanQty = Convert.ToDouble(decimal.Parse(((Label)grv.FindControl("lblChallanQty")).Text).ToString("N3"));
                string StrSql3 = "SELECT  Sum(tblInv_Customer_Challan_Clear.ClearQty) As ClearedQty  FROM  tblInv_Customer_Challan_Clear INNER JOIN tblInv_Customer_Challan_Details ON tblInv_Customer_Challan_Clear.DId = tblInv_Customer_Challan_Details.Id   And tblInv_Customer_Challan_Clear.DId=" + Id + "";
                SqlCommand cmd3 = new SqlCommand(StrSql3, con);
                SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                DataSet DS3 = new DataSet();
                da3.Fill(DS3);
           
                if (DS3.Tables[0].Rows.Count > 0 && DS3.Tables[0].Rows[0][0] != DBNull.Value)
                {
                    TotClearedQty = Convert.ToDouble(decimal.Parse(DS3.Tables[0].Rows[0][0].ToString()).ToString("N3"));
                }
                ((Label)grv.FindControl("lblClearedQty")).Text = decimal.Parse((TotClearedQty).ToString()).ToString("N3");



              
                if ((ChallanQty - TotClearedQty) > 0)
                {
                    ((CheckBox)grv.FindControl("CheckBox1")).Visible = true;
                }
                else
                {
                    ((CheckBox)grv.FindControl("CheckBox1")).Visible = false;
                }
            }
        }

        catch (Exception ex) { }




    }
  
    protected void Btncancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("CustomerChallan_New.aspx");
    }
    protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {

    }
    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {

    }
}
