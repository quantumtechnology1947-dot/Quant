using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using CrystalDecisions.CrystalReports.Engine;
using System.Data.SqlClient;
using System.Threading;

public partial class Module_MaterialManagement_Reports_RateRegister_Details : System.Web.UI.Page
{
   
    clsFunctions fun = new clsFunctions();
    string connStr = "";
    SqlConnection con;
    string SupCode = "";
    int CId = 0;
    int ItemId = 0;
    int FyId = 0;
    string Key = string.Empty;
    ReportDocument cryRpt = new ReportDocument();

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            try
            {
                connStr = fun.Connection();
                con = new SqlConnection(connStr);
                CId = Convert.ToInt32(Session["compid"]);
                ItemId = Convert.ToInt32(Request.QueryString["ItemId"]);
                FyId = Convert.ToInt32(Session["finyear"]);
                Key = Request.QueryString["Key"].ToString();
                this.loadData(SupCode, ItemId);
            }
            catch (Exception ess)
            {

            }
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }

   protected void Page_Load(object sender, EventArgs e)
    {
        cryRpt = new ReportDocument();
    }

   protected void btnSearch_Click(object sender, EventArgs e)
   {
       try
       {


           if (txtSearchSupplier.Text != "")
           {
               SupCode = fun.getCode(txtSearchSupplier.Text);
               if (SupCode != "")
               {
                   CrystalReportViewer1.Visible = true;
                   this.loadData(SupCode, ItemId);
               }
               else
               {

                   CrystalReportViewer1.Visible = false;

                   string mystring = string.Empty;
                   mystring = "Invalid data input";
                   ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + mystring + "');", true);
               }
           }

           else
           {

               CrystalReportViewer1.Visible = true;
               this.loadData(SupCode, ItemId);
           }

       }
       catch (Exception dtt)
       {

       }
   }

    protected void Btncancel_Click(object sender, EventArgs e)
    {
        try
        {
            Response.Redirect("RateRegister.aspx");          
        }
        catch (Exception dtt)
        {
        }
    }

    public void loadData(string SupCode, int itemid)
    {

        try
        {
            DataTable dt = new DataTable();
            string x = "";
            string y = "";
            if (SupCode != "")
            {
                x = "And tblMM_Supplier_master.SupplierId ='" + SupCode + "'";
            }

            if (itemid != 0)
            {
                y = "And tblMM_Rate_Register.ItemId ='" + itemid + "'";
            }

            string StrGQN = "SELECT  tblMM_Rate_Register.Id,tblMM_Rate_Register.ItemId,tblMM_Rate_Register.POId,tblMM_Rate_Register.Rate,tblMM_Rate_Register.Discount,tblMM_Rate_Register.IndirectCost,tblMM_Rate_Register.DirectCost,tblMM_Rate_Register.CompId,tblDG_Item_Master.ManfDesc, Unit_Master.Symbol, tblFinancial_master.FinYear, tblPacking_Master.Terms,tblExciseser_Master.Terms AS Expr1, tblVAT_Master.Terms AS Expr2 FROM  tblDG_Item_Master INNER JOIN tblMM_Rate_Register ON tblDG_Item_Master.Id = tblMM_Rate_Register.ItemId INNER JOIN Unit_Master ON tblDG_Item_Master.UOMBasic = Unit_Master.Id INNER JOIN tblFinancial_master ON tblMM_Rate_Register.FinYearId = tblFinancial_master.FinYearId INNER JOIN tblPacking_Master ON tblMM_Rate_Register.PF = tblPacking_Master.Id INNER JOIN tblExciseser_Master ON tblMM_Rate_Register.ExST = tblExciseser_Master.Id INNER JOIN tblVAT_Master ON tblMM_Rate_Register.VAT = tblVAT_Master.Id  AND tblMM_Rate_Register.CompId='" + CId + "' AND tblMM_Rate_Register.FinYearId<='" + FyId + "'" + x + "" + y + "";

            SqlCommand cmdGQN = new SqlCommand(StrGQN, con);
            SqlDataAdapter daGQN = new SqlDataAdapter(cmdGQN);
            DataSet DSGQN = new DataSet();
            daGQN.Fill(DSGQN);
            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));//0
            dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));//1
            dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));//2
            dt.Columns.Add(new System.Data.DataColumn("UOMBasic", typeof(string)));//3
            dt.Columns.Add(new System.Data.DataColumn("FinYear", typeof(string)));//4
            dt.Columns.Add(new System.Data.DataColumn("PONo", typeof(string)));//5
            dt.Columns.Add(new System.Data.DataColumn("Rate", typeof(double)));//6
            dt.Columns.Add(new System.Data.DataColumn("Discount", typeof(double)));//7
            dt.Columns.Add(new System.Data.DataColumn("Excise", typeof(string)));//8
            dt.Columns.Add(new System.Data.DataColumn("SupplierName", typeof(string)));//9
            dt.Columns.Add(new System.Data.DataColumn("SupplierId", typeof(string)));//10
            dt.Columns.Add(new System.Data.DataColumn("IndirectCost", typeof(double)));//11
            dt.Columns.Add(new System.Data.DataColumn("DirectCost", typeof(double)));//12
            dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));//13
            dt.Columns.Add(new System.Data.DataColumn("VAT", typeof(string)));//14
            dt.Columns.Add(new System.Data.DataColumn("PF", typeof(string)));//15
            dt.Columns.Add(new System.Data.DataColumn("Amount", typeof(double)));//16
            dt.Columns.Add(new System.Data.DataColumn("Symbol", typeof(string)));//16
            DataSet Gqn = new DataSet();
            DataRow dr;
            if (DSGQN.Tables[0].Rows.Count > 0)
            {

                for (int i = 0; i < DSGQN.Tables[0].Rows.Count; i++)
                {
                    dr = dt.NewRow();
                    dr[0] = Convert.ToInt32(DSGQN.Tables[0].Rows[i]["Id"].ToString());
                    dr[1] = fun.GetItemCode_PartNo(CId, Convert.ToInt32(DSGQN.Tables[0].Rows[i]["ItemId"].ToString()));
                    dr[2] = DSGQN.Tables[0].Rows[i]["ManfDesc"].ToString();
                    dr[3] = DSGQN.Tables[0].Rows[i]["Symbol"].ToString();
                    dr[4] = DSGQN.Tables[0].Rows[i]["FinYear"].ToString();

                    string StrPono = fun.select("PONo,SupplierId", "tblMM_PO_Master", "Id='" + Convert.ToInt32(DSGQN.Tables[0].Rows[i]["POId"]) + "'");
                    SqlCommand cmdPono = new SqlCommand(StrPono, con);
                    SqlDataAdapter DAPono = new SqlDataAdapter(cmdPono);
                    DataSet DSPono = new DataSet();
                    DAPono.Fill(DSPono);
                    string currency = string.Empty;

                    if (DSPono.Tables[0].Rows.Count > 0)
                    {
                        dr[5] = DSPono.Tables[0].Rows[0]["PONo"].ToString();
                        dr[10] = DSPono.Tables[0].Rows[0]["SupplierId"].ToString();

                        string cn = fun.select("SupplierName,RegdCountry", "tblMM_Supplier_master", "SupplierId='" + DSPono.Tables[0].Rows[0]["SupplierId"].ToString() + "' And CompId='" + CId + "'");
                        DataSet ds = new DataSet();
                        SqlCommand cmd4 = new SqlCommand(cn, con);
                        SqlDataAdapter da = new SqlDataAdapter(cmd4);
                        da.Fill(ds, "tblMM_Supplier_master");
                        if (ds.Tables[0].Rows.Count > 0)
                        {
                            dr[9] = ds.Tables[0].Rows[0]["SupplierName"].ToString() + '[' + DSPono.Tables[0].Rows[0]["SupplierId"].ToString() + ']';


                            string Sym = fun.select("Symbol", "tblCountry", "CId='" + ds.Tables[0].Rows[0]["RegdCountry"].ToString() + "' ");
                            DataSet dsSym = new DataSet();
                            SqlCommand cmdSym = new SqlCommand(Sym, con);
                            SqlDataAdapter daSym = new SqlDataAdapter(cmdSym);
                            daSym.Fill(dsSym, "tblCountry");

                            if (Convert.ToInt32(DSGQN.Tables[0].Rows[i]["POId"]) != 0)
                            {
                                currency = dsSym.Tables[0].Rows[0]["Symbol"].ToString();
                            }
                        }
                    }
                    else
                    {
                        string Sym1 = fun.select("Symbol", "tblCountry", "CId='" + CId + "' ");
                        DataSet dsSym1 = new DataSet();
                        SqlCommand cmdSym1 = new SqlCommand(Sym1, con);
                        SqlDataAdapter daSym1 = new SqlDataAdapter(cmdSym1);
                        daSym1.Fill(dsSym1, "tblCountry");
                        currency = dsSym1.Tables[0].Rows[0]["Symbol"].ToString();
                    }

                    dr[17] = currency;

                    dr[6] = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[i]["Rate"].ToString()).ToString("N2"));
                    dr[7] = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[i]["Discount"].ToString()).ToString("N2"));
                    dr[11] = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[i]["IndirectCost"].ToString()).ToString("N2"));
                    dr[12] = Convert.ToDouble(decimal.Parse(DSGQN.Tables[0].Rows[i]["DirectCost"].ToString()).ToString("N2"));
                    dr[8] = DSGQN.Tables[0].Rows[i]["Expr1"].ToString();
                    dr[13] = Convert.ToInt32(DSGQN.Tables[0].Rows[i]["CompId"].ToString());
                    dr[14] = DSGQN.Tables[0].Rows[i]["Expr2"];
                    dr[15] = DSGQN.Tables[0].Rows[i]["Terms"];
                    double amt = 0;
                    amt = Convert.ToDouble((Convert.ToDouble(DSGQN.Tables[0].Rows[i]["Rate"]) - (Convert.ToDouble(DSGQN.Tables[0].Rows[i]["Rate"]) * Convert.ToDouble(DSGQN.Tables[0].Rows[i]["Discount"]) / 100)));
                    dr[16] = Convert.ToDouble(decimal.Parse(amt.ToString()).ToString("N2"));
                    dt.Rows.Add(dr);
                    dt.AcceptChanges();
                }
                DataSet xsdds = new RateRegister();
                xsdds.Tables[0].Merge(dt);
                xsdds.AcceptChanges();

                cryRpt.Load(Server.MapPath("~/Module/MaterialManagement/Reports/RateRegister.rpt"));
                cryRpt.SetDataSource(xsdds);
                // For Address
                string Address = fun.CompAdd(CId);
                cryRpt.SetParameterValue("Address", Address);
                CrystalReportViewer1.ReportSource = cryRpt;
                Session[Key] = cryRpt;
            }
            else
            {
                CrystalReportViewer1.Visible = false;
                string MSG = "1";
                Response.Redirect("RateRegister.aspx?MSG=" + MSG + "");
            }

        }


        catch (Exception ex) { }
        finally
        { con.Close(); }
    }
 
    [System.Web.Services.WebMethodAttribute(), System.Web.Script.Services.ScriptMethodAttribute()]
    public static string[] sql(string prefixText, int count, string contextKey)
    {
        clsFunctions fun = new clsFunctions();
        string connStr = fun.Connection();
        DataSet ds = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        int CompId = Convert.ToInt32(HttpContext.Current.Session["compid"]);
        con.Open();
        string cmdStr = fun.select("SupplierId,SupplierName", "tblMM_Supplier_master", "CompId='" + CompId + "'");
        SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
        da.Fill(ds, "tblMM_Supplier_master");
        con.Close();
        string[] main = new string[0];
        for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        {
            if (ds.Tables[0].Rows[i].ItemArray[1].ToString().ToLower().StartsWith(prefixText.ToLower()))
            {
                Array.Resize(ref main, main.Length + 1);
                main[main.Length - 1] = ds.Tables[0].Rows[i].ItemArray[1].ToString() + " [" + ds.Tables[0].Rows[i].ItemArray[0].ToString() + "]";
                //if (main.Length == 10)
                //    break;
            }
        }
        Array.Sort(main);
        return main;
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        cryRpt.Close();
        cryRpt.Dispose();
        GC.Collect();
    }

}
