=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/Quotation_Print_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="Quotation_Print_Details.aspx.cs" Inherits="Module_SalesDistribution_Transactions_Quotation_Print_Details" Title="ERP"  Theme="Default"   %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>

    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
    .style2
    {
        width: 100%;
        float: left;
    }
</style> 
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

     <table align="Center" cellpadding="0" cellspacing="0" class="style2">
    <tr Height="21" >
        <td style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite">&nbsp;<b>Quotation- Print</b></td>
    </tr>
    <tr>
        <td align=Center >
            <asp:Panel ID="Panel1" runat="server" Width="100%" Height="450" ScrollBars="Auto">            
     <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server" HasCrystalLogo="False"
         ReuseParameterValuesOnRefresh="true" DisplayGroupTree="False"  AutoDataBind="true" />
    <CR:CrystalReportSource ID="CrystalReportSource2" runat="server">
    </CR:CrystalReportSource>
           </asp:Panel>
        </td>
    </tr>
    <tr>
        <td align="center">
            <asp:Button ID="Button1" runat="server" CssClass="redbox" 
                onclick="Button1_Click" Text="Cancel" />
        </td>
    </tr>
</table>

     </asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/SalesDistribution/Transactions/Quotation_Print_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using CrystalDecisions.CrystalReports.Engine;
using System.Data.SqlClient;

public partial class Module_SalesDistribution_Transactions_Quotation_Print_Details : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    int CompId = 0;
    string connStr1 = "";
    SqlConnection myConnection;
    private ReportDocument report = new ReportDocument();

  
    string QuotationDate = "";
    string ParentPage = "";
    string RegCity = "";
    string RegState = "";
    string RegCountry = "";
    string custId = "";
     int Id = 0;
    string QuoteNo = "";
    int FYId = 0;
    string RegAddress = "";
    string Key = string.Empty;

    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            connStr1 = fun.Connection();
            myConnection = new SqlConnection(connStr1);
            try
            {
                FYId = Convert.ToInt32(Session["finyear"]);

                if (!string.IsNullOrEmpty(Request.QueryString["QuotationNo"]))
                {
                    QuoteNo = Request.QueryString["QuotationNo"].ToString();
                }

                Key = Request.QueryString["Key"].ToString();

                string strenqId = "";
                if (!string.IsNullOrEmpty(Request.QueryString["EnqId"]))
                {
                    strenqId = (Request.QueryString["EnqId"].ToString());
                }

                Id = Convert.ToInt32(Request.QueryString["Id"].ToString());

                CompId = Convert.ToInt32(Session["compid"]);
                myConnection.Open();
                // To pass values in crystal report from  SD_Cust_PO_Master
                string selectQuery = fun.select("*", " SD_Cust_Quotation_Master", "QuotationNo='" + QuoteNo + "' And EnqId='" + strenqId + "' And CompId='" + CompId + "' AND Id='" + Id + "'   ");
                SqlCommand myCommand = new SqlCommand(selectQuery, myConnection);
                SqlDataAdapter ad = new SqlDataAdapter(myCommand);
                DataSet ds = new DataSet();
                ad.Fill(ds, "SD_Cust_Quotation_Master");
                string reportPath = Server.MapPath("~/Module/SalesDistribution/Transactions/Reports/Quotation.rpt");
                report.Load(reportPath);
                report.SetDataSource(ds);

                //Registration Date 
                if (ds.Tables[0].Rows.Count > 0)
                {
                    custId = ds.Tables[0].Rows[0]["CustomerId"].ToString();
                    QuotationDate = fun.FromDateDMY(ds.Tables[0].Rows[0]["SysDate"].ToString());

                }

                string strCsc = fun.select("*", "SD_Cust_master", "CustomerId='" + custId + "' And CompId='" + CompId + "' ");
                SqlCommand cmdcust = new SqlCommand(strCsc, myConnection);
                SqlDataAdapter adcust = new SqlDataAdapter(cmdcust);
                DataSet dscust = new DataSet();
                adcust.Fill(dscust, "SD_Cust_master");
                if (dscust.Tables[0].Rows.Count > 0)
                {
                    RegCity = dscust.Tables[0].Rows[0]["RegdCity"].ToString();
                    RegState = dscust.Tables[0].Rows[0]["RegdState"].ToString();
                    RegCountry = dscust.Tables[0].Rows[0]["RegdCountry"].ToString();

                }
                //Regd
                string selectregCt = fun.select("CityName", "tblCity", "CityId='" + RegCity + "' ");
                SqlCommand myCmdct = new SqlCommand(selectregCt, myConnection);
                SqlDataAdapter adct = new SqlDataAdapter(myCmdct);
                DataSet Dsct = new DataSet();
                adct.Fill(Dsct);

                string selectregSt = fun.select("StateName", "tblState", "SId='" + RegState + "' ");
                SqlCommand myCmdst = new SqlCommand(selectregSt, myConnection);
                SqlDataAdapter adst = new SqlDataAdapter(myCmdst);
                DataSet Dsst = new DataSet();
                adst.Fill(Dsst);

                string selectregCnt = fun.select("CountryName", "tblCountry", "CId='" + RegCountry + "'");
                SqlCommand myCmdcnt = new SqlCommand(selectregCnt, myConnection);
                SqlDataAdapter adcnt = new SqlDataAdapter(myCmdcnt);
                DataSet Dscnt = new DataSet();
                adcnt.Fill(Dscnt);
                report.SetParameterValue("QuotationDate", QuotationDate);
                string Company = fun.getCompany(CompId);
                report.SetParameterValue("Company", Company);
                string DueDate = fun.FromDateDMY(ds.Tables[0].Rows[0]["DueDate"].ToString());
                report.SetParameterValue("DueDate", DueDate);
                string CheckBy = "";
                string ApproveBy = "";
                string AuthorizeBy = "";

                string sqlChekBy = fun.select("Title+'. '+EmployeeName As EmpName", "tblHR_OfficeStaff", "CompId='" + CompId + "'AND EmpId='" + ds.Tables[0].Rows[0]["CheckedBy"] + "'");
                SqlCommand cmdChekBy = new SqlCommand(sqlChekBy, myConnection);
                SqlDataAdapter daChekBy = new SqlDataAdapter(cmdChekBy);
                DataSet DSChekBy = new DataSet();
                daChekBy.Fill(DSChekBy);
                if (DSChekBy.Tables[0].Rows.Count > 0)
                {
                    CheckBy = DSChekBy.Tables[0].Rows[0][0].ToString();
                }

                string sqlApproveBy = fun.select("Title+'. '+EmployeeName As EmpName", "tblHR_OfficeStaff", "CompId='" + CompId + "'AND EmpId='" + ds.Tables[0].Rows[0]["ApprovedBy"] + "'");
                SqlCommand cmdApproveBy = new SqlCommand(sqlApproveBy, myConnection);
                SqlDataAdapter daApproveBy = new SqlDataAdapter(cmdApproveBy);
                DataSet DSApproveBy = new DataSet();
                daApproveBy.Fill(DSApproveBy);
                if (DSApproveBy.Tables[0].Rows.Count > 0)
                {
                    ApproveBy = DSApproveBy.Tables[0].Rows[0][0].ToString();
                }

                string sqlAuthBy = fun.select("Title+'. '+EmployeeName As EmpName", "tblHR_OfficeStaff", "CompId='" + CompId + "'AND EmpId='" + ds.Tables[0].Rows[0]["AuthorizedBy"] + "'");
                SqlCommand cmdAuthBy = new SqlCommand(sqlAuthBy, myConnection);
                SqlDataAdapter daAuthBy = new SqlDataAdapter(cmdAuthBy);
                DataSet DSAuthBy = new DataSet();
                daAuthBy.Fill(DSAuthBy);
                if (DSAuthBy.Tables[0].Rows.Count > 0)
                {
                    AuthorizeBy = DSAuthBy.Tables[0].Rows[0][0].ToString();
                }

                RegAddress = dscust.Tables[0].Rows[0]["RegdAddress"].ToString() + ",\n" + Dsct.Tables[0].Rows[0]["CityName"].ToString() + "," + Dsst.Tables[0].Rows[0]["StateName"].ToString() + ",\n" + Dscnt.Tables[0].Rows[0]["CountryName"].ToString() + ".\n" + dscust.Tables[0].Rows[0]["RegdPinNo"].ToString() + "\n";
                report.SetParameterValue("RegAddress", RegAddress);
                report.SetParameterValue("QuatCheck", CheckBy);
                report.SetParameterValue("QuatApprove", ApproveBy);
                report.SetParameterValue("QuatAuth", AuthorizeBy);
                string Address = fun.CompAdd(CompId);
                report.SetParameterValue("Address", Address);
                CrystalReportViewer1.ReportSource = report;
                CrystalReportViewer1.EnableViewState = true;
                Session[Key] = report;

            }
           catch (Exception ex)
            {

            }
           
            finally
            {
                myConnection.Close();
                myConnection.Dispose();
            }


           
        }

        else
        {
            Key = Request.QueryString["Key"].ToString();
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }



    protected void Page_Load(object sender, EventArgs e)
    {

        report = new ReportDocument();

        if (!string.IsNullOrEmpty(Request.QueryString["parentpage"]))
        {
            ParentPage = Request.QueryString["parentpage"].ToString();
        }
    }
    protected void Button1_Click(object sender, EventArgs e)
    {
        
        if (ParentPage == "1")
        {
            Response.Redirect("Quotation_Check.aspx?ModId=2&SubModId=64");
        }

        else if (ParentPage == "2")
        {
            Response.Redirect("Quotation_Print.aspx?ModId=2&SubModId=63");
        }

        else if (ParentPage == "3")
        {
            Response.Redirect("Quotation_Approve.aspx?ModId=2&SubModId=65");
        }
        else if (ParentPage == "4")
        {
            Response.Redirect("Quotation_Authorize.aspx?ModId=2&SubModId=66");
        }
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }


}
