=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/WIS_View_TransWise_print.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="WIS_View_TransWise_print.aspx.cs" Inherits="Module_Inventory_Transactions_WIS_View_TransWise_print" Title="ERP" Theme="Default" %>

<%@ Register Assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304"
    Namespace="CrystalDecisions.Web" TagPrefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
 
 <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
    <table cellspacing="0" width="100%">
    <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)" colspan="2">
        &nbsp;<b> Transaction wise WIS- Print</b>
            </td>
            </tr>
<tr>
<td align="center">
<asp:Panel ID ="Panel1" runat= "server" Height="438px" ScrollBars="Auto" Width="100%">
    <CR:CrystalReportViewer ID="CrystalReportViewer1" EnableDatabaseLogonPrompt="false"  HasCrystalLogo="False"
    EnableParameterPrompt="false" runat="server" ReportSourceID="CrystalReportSource1" DisplayGroupTree="False"  AutoDataBind="true" />
    <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
        <Report FileName="Module\Inventory\Transactions\Reports\TransactionwiseWIS.rpt">
        </Report>
    </CR:CrystalReportSource>
    </asp:Panel>
</td>
</tr>
<tr>
<td align="center" class="style4" colspan="2">
                <asp:Button ID="Cancel" runat="server" Text="Cancel" CssClass="redbox" 
                    valign="top" onclick="Cancel_Click"/>
                    
                    </td>
</tr>
    
    </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/WIS_View_TransWise_print.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;

public partial class Module_Inventory_Transactions_WIS_View_TransWise_print : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    DataSet DS = new DataSet();
    string connStr = "";
    SqlConnection con;
    string WISNO = "";
    string WISId = "";
    string wono = "";
    int CompId = 0;
    private ReportDocument report = new ReportDocument();
    int FinYearId = 0;
    int Status = 0;
    string Key = string.Empty;
    protected void Page_Init(object sender, EventArgs e)
    {
        Key = Request.QueryString["Key"].ToString();
        DataTable dt = new DataTable();
        if (!IsPostBack)
        {

           try
            {
                connStr = fun.Connection();
                con = new SqlConnection(connStr);
                con.Open();
                WISNO = Request.QueryString["WISNo"].ToString();
                WISId = Request.QueryString["WISId"].ToString();
                wono = Request.QueryString["wn"].ToString();
                CompId = Convert.ToInt32(Session["compid"]);
                FinYearId = Convert.ToInt32(Session["finyear"]);
                Status = Convert.ToInt32(Request.QueryString["status"]); 
                string sql = fun.select("Distinct tblInv_WIS_Details.ItemId,tblInv_WIS_Master.SessionId,tblInv_WIS_Master.SysDate", "tblInv_WIS_Master,tblInv_WIS_Details", "tblInv_WIS_Master.Id='" + WISId + "' AND tblInv_WIS_Master.Id=tblInv_WIS_Details.MId");               
                SqlCommand Cmdgrid = new SqlCommand(sql, con);               
                SqlDataReader rdr = Cmdgrid.ExecuteReader();                
                dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("ManfDesc", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("UOMBasic", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("WISNo", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("BOMQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("IssuedQty", typeof(double)));
                dt.Columns.Add(new System.Data.DataColumn("GenBy", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("CompId", typeof(int)));
                dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_FDate", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("TaskTargetTryOut_TDate", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_FDate", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("TaskTargetDespach_TDate", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("TaskProjectTitle", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("TaskProjectLeader", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("SysDate", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
                dt.Columns.Add(new System.Data.DataColumn("StockQty", typeof(double)));

                DataRow dr;
                string ItemCode = "";
                string ManfDesc = "";
                string UomBasic = "";

                while (rdr.Read())               
                {
                    double qty = 0;
                    double Issuedqty = 0;

                    dr = dt.NewRow();

                    string sql3 = fun.select("PId,CId,IssuedQty", "tblInv_WIS_Details", "MId='" + WISId + "' AND ItemId='" + rdr["ItemId"].ToString() + "'");

                    SqlCommand Cmdgrid3 = new SqlCommand(sql3, con);
                    SqlDataAdapter dagrid3 = new SqlDataAdapter(Cmdgrid3);
                    DataSet DS3 = new DataSet();
                    dagrid3.Fill(DS3);

                    for (int j = 0; j < DS3.Tables[0].Rows.Count; j++)
                    {                        
                        Issuedqty += Convert.ToDouble(DS3.Tables[0].Rows[j]["IssuedQty"]);
                    }
                    qty = fun.AllComponentBOMQty(CompId, wono, rdr["ItemId"].ToString(), FinYearId);
                    string StrIcode = fun.select("ItemCode,ManfDesc,UOMBasic,StockQty", "tblDG_Item_Master", "Id='" + rdr["ItemId"].ToString() + "'");
                    SqlCommand cmdIcode = new SqlCommand(StrIcode, con);
                    SqlDataAdapter daIcode = new SqlDataAdapter(cmdIcode);
                    DataSet DSIcode = new DataSet();
                    daIcode.Fill(DSIcode);

                    // For ItemCode
                    if (DSIcode.Tables[0].Rows.Count > 0)
                    {
                        ItemCode = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(rdr["ItemId"].ToString()));
                        // For Purch Desc
                        ManfDesc = DSIcode.Tables[0].Rows[0]["ManfDesc"].ToString();
                        // For Manf. Desc                      
                        string sqlPurch = fun.select("Symbol", "Unit_Master", "Id='" + DSIcode.Tables[0].Rows[0]["UOMBasic"].ToString() + "'");
                        SqlCommand cmdPurch = new SqlCommand(sqlPurch, con);
                        SqlDataAdapter daPurch = new SqlDataAdapter(cmdPurch);
                        DataSet DSPurch = new DataSet();
                        daPurch.Fill(DSPurch);
                        if (DSPurch.Tables[0].Rows.Count > 0)
                        {
                            UomBasic = DSPurch.Tables[0].Rows[0]["Symbol"].ToString();
                        }
                    }

                    string sql2 = fun.select("Title+'. '+EmployeeName As GenBy", "tblHR_OfficeStaff", "CompId='" + CompId + "' AND EmpId='" + rdr["SessionId"] + "'");
                    SqlCommand cmd2 = new SqlCommand(sql2, con);
                    SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                    DataSet DS2 = new DataSet();
                    da2.Fill(DS2);

                    string cmdStr = fun.select("TaskTargetTryOut_FDate,TaskTargetTryOut_TDate,TaskTargetDespach_FDate,TaskTargetDespach_TDate,TaskProjectTitle,TaskProjectLeader", "SD_Cust_WorkOrder_Master", "WONo='" + wono + "' And CompId='" + CompId + "'");
                    SqlCommand cmdwo = new SqlCommand(cmdStr, con);
                    SqlDataAdapter DAwo = new SqlDataAdapter(cmdwo);
                    DataSet DSWo = new DataSet();
                    DAwo.Fill(DSWo, "SD_Cust_WorkOrder_Master");

                    dr[0] = ItemCode;
                    dr[1] = ManfDesc;
                    dr[2] = UomBasic;
                    dr[3] = WISNO;
                    dr[4] = qty;

                    dr[5] = Convert.ToDouble(decimal.Parse(Issuedqty.ToString()).ToString("N3"));

                    if (DS2.Tables[0].Rows.Count > 0)
                    {
                        dr[6] = DS2.Tables[0].Rows[0]["GenBy"].ToString();
                    }
                    dr[7] = CompId;
                    dr[8] = fun.FromDateDMY(DSWo.Tables[0].Rows[0]["TaskTargetTryOut_FDate"].ToString());
                    dr[9] = fun.FromDateDMY(DSWo.Tables[0].Rows[0]["TaskTargetTryOut_TDate"].ToString());
                    dr[10] = fun.FromDateDMY(DSWo.Tables[0].Rows[0]["TaskTargetDespach_FDate"].ToString());
                    dr[11] = fun.FromDateDMY(DSWo.Tables[0].Rows[0]["TaskTargetDespach_TDate"].ToString());
                    dr[12] = DSWo.Tables[0].Rows[0]["TaskProjectTitle"].ToString();
                    dr[13] = DSWo.Tables[0].Rows[0]["TaskProjectLeader"].ToString();
                    dr[14] = fun.FromDate(rdr["SysDate"].ToString());
                    dr[15] = wono;
                    dr[16] = DSIcode.Tables[0].Rows[0]["StockQty"].ToString();

                    dt.Rows.Add(dr);
                    dt.AcceptChanges();
                }

                DataView dv = dt.DefaultView;
                dv.Sort = "ItemCode";                
                string reportPath = Server.MapPath("~/Module/Inventory/Transactions/Reports/TransactionwiseWIS.rpt");
                report.Load(reportPath);
                report.SetDataSource(dv);
                string Company = fun.getCompany(CompId);
                report.SetParameterValue("Company", Company);
                string Address = fun.CompAdd(CompId);
                report.SetParameterValue("Address", Address);
                CrystalReportViewer1.ReportSource = report; 
                Session[Key] = report;

            }
            catch (Exception ex)
            {

            }
            finally
            {
                dt.Clear();
                dt.Dispose();
                con.Close();
                con.Dispose();
            }

        }

        else
        {
            ReportDocument doc = (ReportDocument)Session[Key];
            CrystalReportViewer1.ReportSource = doc;
        }
    }
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            WISNO = Request.QueryString["WISNo"].ToString();
            WISId = Request.QueryString["WISId"].ToString();
            wono = Request.QueryString["wn"].ToString();
            CompId = Convert.ToInt32(Session["compid"]);
            FinYearId = Convert.ToInt32(Session["finyear"]);
            Status = Convert.ToInt32(Request.QueryString["status"]);
            report = new ReportDocument();
        }
        catch (Exception et)
        {

        }
    }

    protected void Page_UnLoad(object sender, EventArgs e)
    {
        this.CrystalReportViewer1.Dispose();
        this.CrystalReportViewer1 = null;
        report.Close();
        report.Dispose();
        GC.Collect();
    }

    protected void Cancel_Click(object sender, EventArgs e)
    {        
        Response.Redirect("~/Module/Inventory/Transactions/WIS_View_TransWise.aspx?WONo=" + wono + "&ModId=9&SubModId=53&status=" + Status + "");

    }

}
