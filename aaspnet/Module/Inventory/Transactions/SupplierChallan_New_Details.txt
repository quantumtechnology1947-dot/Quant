=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_New_Details.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="SupplierChallan_New_Details.aspx.cs" Inherits="Module_Inventory_Transactions_SupplierChallan_New_Details" Title="ERP"  Theme="Default"%>

<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <style type="text/css">
        .style2
        {
            width: 100%;
        }
    
        .style3
        {
            height: 37px;
        }
    
        .style4
        {
            width: 100%;
            float: left;
        }
            
        .style5
        {
            width: 30%;
        }
            
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

    <script type="text/javascript">
        function OnChanged(sender, args)
        {
            ServerUtilities.SetTabIndex(sender.get_activeTabIndex());
        }
    </script>
   
    <table width="100%" align="center" cellpadding="0" cellspacing="0">
                    <tr height="21">
                        <td style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite" 
                            >&nbsp;<strong> 
                            Supplier Challan- New</strong></td>
                    </tr>
                    </table>
    
     <cc1:TabContainer ID="TabContainer1" runat="server" ActiveTabIndex="0" 
                    AutoPostBack="true"
                    Width="100%" 
        onactivetabchanged="TabContainer1_ActiveTabChanged">
                    <cc1:TabPanel runat="server" HeaderText="Generate" ID="Add">                    
                        <HeaderTemplate>Generate
                        </HeaderTemplate><ContentTemplate><asp:Panel ID="Panel1" ScrollBars="Auto" runat="server"><table align="left" cellpadding="0" cellspacing="0" class="style2"><tr><td 
                            height="5px" colspan="4" >&#160;</td></tr><tr><td colspan="4" height="5px"><asp:Panel 
                                ID="Panel3" runat="server" Height="329px" ScrollBars="Auto"><asp:GridView 
                                ID="GridView2" runat="server" AutoGenerateColumns="False" 
                                CssClass="yui-datatable-theme" style="position:static" Width="100%"><Columns><asp:TemplateField 
                                        HeaderText="SN"><ItemTemplate><%# Container.DataItemIndex+1 %>
                                    </ItemTemplate>
                                    <HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" Width="2%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField>
                                        <ItemTemplate>
                                            <asp:CheckBox ID="CheckBox1" runat="server" AutoPostBack="true" 
                                                oncheckedchanged="CheckBox1_CheckedChanged" />
                                        </ItemTemplate>
                                        <HeaderStyle Font-Size="10pt" />
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="2%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="PR NO">
                                        <ItemTemplate>
                                            <asp:Label ID="lblprNo" runat="server" Text='<%# Eval("PRNo") %>'></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="6%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField Visible="False">
                                        <ItemTemplate>
                                            <asp:Label ID="lblprDId" runat="server" Text='<%# Eval("PRId") %>'></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="3%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Date">
                                        <ItemTemplate>
                                            <asp:Label ID="lblprDt" runat="server" Text='<%# Eval("PRDate") %>'></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="6%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="WONo">
                                        <ItemTemplate>
                                            <asp:Label ID="lblWono" runat="server" Text='<%# Eval("WONo") %>'></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="6%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Item Code">
                                        <ItemTemplate>
                                            <asp:Label ID="lblit" runat="server" Text='<%# Eval("ItemCode") %>'> </asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="8%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Description">
                                        <ItemTemplate>
                                            <asp:Label ID="lbldesc" runat="server" Text='<%# Eval("Descr") %>'> </asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Left" VerticalAlign="Top" Width="20%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="UOM">
                                        <ItemTemplate>
                                            <asp:Label ID="lbluom" runat="server" Text='<%# Eval("Symbol") %>'> </asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="5%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="PR Qty">
                                        <ItemTemplate>
                                            <asp:Label ID="lblprqty" runat="server" Text='<%# Eval("Qty") %>'></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" Width="6%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Remain Qty">
                                        <ItemTemplate>
                                            <asp:Label ID="lblqty" runat="server" Text=""></asp:Label>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" Width="6%" />
                                    </asp:TemplateField>
                                    <asp:TemplateField HeaderText="Qty">
                                        <ItemTemplate>
                                            <asp:TextBox ID="txtqty" runat="server" CssClass="box3" Enabled="false" 
                                                Width="78%">
                                             </asp:TextBox><asp:RequiredFieldValidator ID="ReqChNo" runat="server" 
                                                ControlToValidate="txtqty" ErrorMessage="*" ValidationGroup="A" Visible="false"> </asp:RequiredFieldValidator><asp:RegularExpressionValidator 
                                                ID="Reg2" runat="server" ControlToValidate="txtqty" ErrorMessage="*" 
                                                ValidationExpression="^\d{1,15}(\.\d{0,3})?$" ValidationGroup="A" 
                                                Visible="false"> </asp:RegularExpressionValidator>
                                        </ItemTemplate>
                                        <ItemStyle HorizontalAlign="Left" VerticalAlign="Top" Width="8%" />
                                    </asp:TemplateField>
                                </Columns>
                                <EmptyDataTemplate>
                                    <table class="fontcss" width="100%">
                                        <tr>
                                            <td align="center">
                                                <asp:Label ID="Label1" runat="server" Font-Size="Larger" ForeColor="maroon" 
                                                    Text="No data to display !"> </asp:Label></td></tr></table>
                                </EmptyDataTemplate>
                                <FooterStyle Font-Bold="False" />
                                <HeaderStyle Font-Size="9pt" />
                                <PagerSettings PageButtonCount="40" />
                            </asp:GridView>
                            </asp:Panel>
                            </td>
                        </tr>
                        <tr>
                        <td colspan="4" height="5px" 
                                style="border-bottom-style: solid; border-width: thin; border-color: #808080">
                            &#160;</td>
                         </tr>
                         <tr>
                         <td height="23px" 
                                style="border-right-style: none; border-width: medium; border-color: #808080; border-left-style: solid; border-top-style: none;" 
                                width="1%">&#160;</td><td class="style5" height="5px" valign="middle">Vehicle No. : <asp:TextBox 
                                    ID="txtVehicleNo" runat="server" CssClass="box3" Width="200px"></asp:TextBox></td><td 
                                align="right" height="5px" valign="middle" width="5%">Remarks :</td><td 
                                height="5px" rowspan="2" 
                                style="border-width: thin; border-color: #808080; height: 10px; border-right-style: solid;" 
                                valign="middle"><asp:TextBox ID="txtRemarks" runat="server" CssClass="box3" 
                                    Height="36px" TextMode="MultiLine" Width="98%"></asp:TextBox></td></tr>
                          <tr>
                          <td 
                                height="23px" 
                                style="border-left-style: solid; border-width: medium; border-color: #808080; border-right-style: none;" 
                                width="1%">&#160;</td><td height="5px" valign="middle">Transpoter : <asp:TextBox 
                                    ID="txtTranspoter" runat="server" CssClass="box3" Width="200px"></asp:TextBox></td><td 
                                height="5px" width="10%">&#160;</td></tr>
                           <tr>
                           <td align="left" valign="top" 
                                colspan="4" height="5px"><table align="left" cellpadding="0" cellspacing="0" class="style4"><tr><td 
                                    valign="bottom" align="center" height="23px" 
                                    style="border-top-style: solid; border-width: thin; border-color: #808080"  ><asp:Button 
                                    ID="BtnAdd" runat="server" CssClass="redbox" OnClick="BtnAdd_Click" 
                                    Text="Submit" ValidationGroup="A" />
                                &#160; <asp:Button ID="btnCancel" runat="server" CssClass="redbox" 
                                    OnClick="btnCancel_Click" Text="Cancel" />
                                </td></tr></table></td></tr>
                                
                                </table></asp:Panel></ContentTemplate></cc1:TabPanel>
                        
                        
                        
                        
                    <cc1:TabPanel ID="View" runat="server" HeaderText="Clear">
                    <ContentTemplate><asp:Panel ID="Panel2"  ScrollBars="Auto" runat="server"><table width="100%" align="center" cellpadding="0" cellspacing="0" 
                             style="height: 454px"><tr><td><table width="100%" align="center" cellpadding="0" cellspacing="0"><tr><td colspan="2"><iframe src="" id="myframe"  runat="server"  width="100%" height="430Px" frameborder="0" ></iframe></td></tr></table></td></tr></table></asp:Panel>
                    </ContentTemplate>
                    </cc1:TabPanel>
                </cc1:TabContainer>

</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Inventory/Transactions/SupplierChallan_New_Details.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_Inventory_Transactions_SupplierChallan_New_Details : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();   
    string sId = "";
    int CompId = 0;   
    int fyid = 0;
    string supid = "";   
    string str = "";
    SqlConnection con;
    string CDate = "";
    string CTime = "";
    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            CompId = Convert.ToInt32(Session["compid"]);
            fyid = Convert.ToInt32(Session["finyear"]);
            supid = Request.QueryString["SupplierId"].ToString();
            sId = Session["username"].ToString();
            str = fun.Connection();
            con = new SqlConnection(str);          
            if (!IsPostBack)
            {
                this.fillGrid(supid);
                txtRemarks.Text = "";
            }
        }
        catch (Exception es)
        {

        }
    }
    public void disableCheck()
    {
        con.Open();
        foreach (GridViewRow grv in GridView2.Rows)
        {
            int Id = Convert.ToInt32(((Label)grv.FindControl("lblprDId")).Text);            
            double TotDiffQty = 0;
            SqlCommand sqlCmd;                               
            sqlCmd = new SqlCommand("GetSupplier_PR_ChQty", con);
            sqlCmd.CommandType = CommandType.StoredProcedure;
            sqlCmd.Parameters.Add(new SqlParameter("@SupId", SqlDbType.VarChar));         
            sqlCmd.Parameters.Add(new SqlParameter("@Id", SqlDbType.VarChar));
            sqlCmd.Parameters["@SupId"].Value = supid;           
            sqlCmd.Parameters["@Id"].Value = Id;
            SqlDataReader rdr = sqlCmd.ExecuteReader(CommandBehavior.CloseConnection);
            rdr.Read();
            if(rdr.HasRows)
            {
                TotDiffQty = Convert.ToDouble(decimal.Parse(rdr[0].ToString()).ToString("N3"));
            } 
            ((Label)grv.FindControl("lblqty")).Text = decimal.Parse((TotDiffQty).ToString()).ToString("N3");           
            if (TotDiffQty <=0)
            {
                ((CheckBox)grv.FindControl("CheckBox1")).Visible = false;
            }
            else
            {
                ((CheckBox)grv.FindControl("CheckBox1")).Visible = true;
            }
        }

    }   
   
    public void fillGrid(string supid)
    {
        try
        {            
            con.Open();           
            SqlCommand da = new SqlCommand("GetSup_Challan", con);
            da.CommandType = CommandType.StoredProcedure;
            da.Parameters.Add(new SqlParameter("@SupId", SqlDbType.VarChar));
            da.Parameters.Add(new SqlParameter("@CompId", SqlDbType.VarChar));
            da.Parameters["@SupId"].Value = supid;
            da.Parameters["@CompId"].Value = CompId; 
            SqlDataReader rdr = da.ExecuteReader(CommandBehavior.CloseConnection);            
            DataTable dt = new DataTable();
            dt.Load(rdr);            
            GridView2.DataSource = dt;
            GridView2.DataBind();
            this.disableCheck();
        }
        catch (Exception ex)
        {
        }
        
    }

    protected void CheckBox1_CheckedChanged(object sender, EventArgs e)
    {
        CheckBox x = (CheckBox)sender;
        GridViewRow grv = (GridViewRow)x.NamingContainer;
        if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
        {
            ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = true;
            ((RegularExpressionValidator)grv.FindControl("Reg2")).Visible = true;
            ((TextBox)grv.FindControl("txtqty")).Enabled = true;

        }
        else
        {
            ((RequiredFieldValidator)grv.FindControl("ReqChNo")).Visible = false;
            ((RegularExpressionValidator)grv.FindControl("Reg2")).Visible = false;
            ((TextBox)grv.FindControl("txtqty")).Enabled = false;
        }
       
        
    }
    protected void BtnAdd_Click(object sender, EventArgs e)
    {
       try
        {
            
                int y = 0;
                int x = 0;
                int k = 0;

                foreach (GridViewRow grv in GridView2.Rows)
                {
                    if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true)
                    {
                        x++;
                        if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("txtqty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("txtqty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("txtqty")).Text) != 0)
                        {

                            double Qty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("txtqty")).Text).ToString("N3"));
                            double PrQty = Convert.ToDouble(decimal.Parse(((Label)grv.FindControl("lblprqty")).Text).ToString("N3"));
                            int Id = Convert.ToInt32(((Label)grv.FindControl("lblprDId")).Text);
                            double TotChalnQty = 0;
                            string StrSql3 = "SELECT  Sum(tblInv_Supplier_Challan_Details.ChallanQty) As Qty  FROM  tblInv_Supplier_Challan_Master INNER JOIN tblInv_Supplier_Challan_Details ON tblInv_Supplier_Challan_Master.Id = tblInv_Supplier_Challan_Details.MId  AND tblInv_Supplier_Challan_Master.CompId='" + CompId + "' AND tblInv_Supplier_Challan_Master.SupplierId='" + supid + "' And tblInv_Supplier_Challan_Details.PRDId=" + Id + "";
                            SqlCommand cmd3 = new SqlCommand(StrSql3, con);
                            SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                            DataSet DS3 = new DataSet();
                            da3.Fill(DS3);
                            if (DS3.Tables[0].Rows.Count > 0&& DS3.Tables[0].Rows[0][0]!=DBNull.Value)
                            {
                                TotChalnQty = Convert.ToDouble(decimal.Parse(DS3.Tables[0].Rows[0][0].ToString()).ToString("N3"));
                            }
                            
                            if (Convert.ToDouble(decimal.Parse((PrQty - (Qty + TotChalnQty)).ToString()).ToString("N3")) >= 0)
                            {
                                y++;
                            }


                        }
                    }

                }

                if (x == y && y > 0)
                {


                    DataSet DS = new DataSet();
                    CDate = fun.getCurrDate();
                    CTime = fun.getCurrTime();

                    string cmdStr = fun.select("SCNo", "tblInv_Supplier_Challan_Master", "CompId='" + CompId + "' AND FinYearId='" + fyid + "' order by Id desc");
                    SqlCommand cmd1 = new SqlCommand(cmdStr, con);
                    SqlDataAdapter da = new SqlDataAdapter(cmd1);
                    da.Fill(DS, "tblInv_Supplier_Challan_Master");
                    string SCNo;
                    if (DS.Tables[0].Rows.Count > 0)
                    {
                        int scno = Convert.ToInt32(DS.Tables[0].Rows[0][0].ToString()) + 1;
                        SCNo = scno.ToString("D4");
                    }
                    else
                    {
                        SCNo = "0001";
                    }
                    int EmpSupId = fun.chkEmpCustSupplierCode(supid, 3, CompId);

                    if (EmpSupId == 1)
                    {
                        string StrSCMaster = fun.insert("tblInv_Supplier_Challan_Master", "SysDate,SysTime,SessionId,CompId,FinYearId,SCNo,SupplierId,Remarks,VehicleNo,Transpoter", "'" + CDate + "','" + CTime + "','" + sId + "','" + CompId + "','" + fyid + "','" + SCNo + "','" + supid + "','" + txtRemarks.Text + "','"+txtVehicleNo.Text+"','"+txtTranspoter.Text+"'");
                        SqlCommand cmd11 = new SqlCommand(StrSCMaster, con);
                        con.Open();
                        cmd11.ExecuteNonQuery();
                        con.Close();

                        string sqlMId = fun.select("Id", "tblInv_Supplier_Challan_Master", "CompId='" + CompId + "' AND SCNo='" + SCNo + "' Order By Id Desc");
                        SqlCommand cmdMId = new SqlCommand(sqlMId, con);
                        SqlDataAdapter DAMId = new SqlDataAdapter(cmdMId);
                        DataSet DSMId = new DataSet();
                        DAMId.Fill(DSMId);
                        int MId = Convert.ToInt32(DSMId.Tables[0].Rows[0]["Id"].ToString());

                        foreach (GridViewRow grv in GridView2.Rows)
                        {
                            if (((CheckBox)grv.FindControl("CheckBox1")).Checked == true && ((TextBox)grv.FindControl("txtqty")).Text != "" && fun.NumberValidationQty(((TextBox)grv.FindControl("txtqty")).Text) == true && Convert.ToDouble(((TextBox)grv.FindControl("txtqty")).Text) != 0)
                            {

                                double Qty = Convert.ToDouble(decimal.Parse(((TextBox)grv.FindControl("txtqty")).Text).ToString("N3"));
                                int Prid = Convert.ToInt32(((Label)grv.FindControl("lblprDId")).Text);

                                SqlCommand exeme2 = new SqlCommand(fun.insert("tblInv_Supplier_Challan_Details", "MId,PRDId,ChallanQty", "" + MId + "," + Prid + ",'" + Qty + "'"), con);
                                con.Open();
                                exeme2.ExecuteNonQuery();
                                con.Close();
                                k++;

                            }
                        }
                    }
                }

                else
                {
                    string myStringVariable = string.Empty;
                    myStringVariable = "Invalid input data.";
                    ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);

                }

                if (k > 0)
                {
                    this.fillGrid(supid);
                    txtRemarks.Text = "";
                    txtVehicleNo.Text = "";
                    txtTranspoter.Text = "";
                    string myStringVariable = string.Empty;
                    myStringVariable = "Data inserted successfully.";
                    ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);
                } 

        }
       catch (Exception ex) { }
    }
    protected void btnCancel_Click(object sender, EventArgs e)
    {
        Response.Redirect("~/Module/Inventory/Transactions/SupplierChallan_New.aspx?ModId=9&SubModId=118");
    }
    protected void TabContainer1_ActiveTabChanged(object sender, EventArgs e)
    {
        if (TabContainer1.ActiveTabIndex == 1)
        {
            myframe.Attributes.Add("Src", "SupplierChallan_Clear_Details.aspx?supid=" + supid + "&ModId=9&SubModId=118");
        }
    }

    
}
