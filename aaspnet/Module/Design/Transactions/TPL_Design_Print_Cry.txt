=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/TPL_Design_Print_Cry.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="TPL_Design_Print_Cry.aspx.cs" Inherits="Module_Design_Transactions_TPL_Design_Print_Cry" Title="ERP" Theme ="Default" %>

<%@ Register assembly="CrystalDecisions.Web, Version=10.5.3700.0, Culture=neutral, PublicKeyToken=692fbea5521e1304" namespace="CrystalDecisions.Web" tagprefix="CR" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
<script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">   
    <table align="center" cellpadding="0" cellspacing="0" width="100%">   
    <tr>
        <td align="left" valign="middle"  scope="col" 
                style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite" height="21">
        &nbsp;<b>TPL - Print</b></td>            
    </tr>
        
    <tr>
        <td align="center"> 
        <asp:Panel ID="Panel1" runat="server" Height="450px" ScrollBars="Auto">
            <CR:CrystalReportViewer ID="CrystalReportViewer1" runat="server" 
                AutoDataBind="true" ReportSourceID="CrystalReportSource1" 
                DisplayGroupTree="False" EnableDatabaseLogonPrompt="False" 
                EnableParameterPrompt="False" ReuseParameterValuesOnRefresh="True"  />
            <CR:CrystalReportSource ID="CrystalReportSource1" runat="server">
                <Report FileName="~\Module\Design\Transactions\Reports\TPL_Print_ALL.rpt">
                </Report>
            </CR:CrystalReportSource>
            </asp:Panel>
        </td>            
    </tr>
    <tr>
     <td align="center" valign="top">
            <asp:Button ID="Button1" runat="server" CssClass="redbox" 
                onclick="Button1_Click" Text="Cancel" />
        </td>
    </tr>
</table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>

=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Design/Transactions/TPL_Design_Print_Cry.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using CrystalDecisions.CrystalReports.Engine;
using System.Collections.Generic;
using System.Security.Cryptography;
public partial class Module_Design_Transactions_TPL_Design_Print_Cry : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    private ReportDocument report = new ReportDocument();
    
    DataRow DR;
    DataTable DT = new DataTable();

    public string WONo = "";
    int CompId = 0;
    int FinYearId = 0; 
    string sql = "";
    string StartDate = "";
    string UpToDate = "";



    protected void Page_Init(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {

            try
            {

                CompId = Convert.ToInt32(Session["compid"]);
                FinYearId = Convert.ToInt32(Session["finyear"]);
                if (!string.IsNullOrEmpty(Request.QueryString["SD"]))
                {
                    StartDate = Request.QueryString["SD"].ToString();
                }
                if (!string.IsNullOrEmpty(Request.QueryString["TD"]))
                {
                    UpToDate = Request.QueryString["TD"].ToString();
                }
                string connStr = fun.Connection();
                SqlConnection con = new SqlConnection(connStr);
                con.Open();
                if ((Request.QueryString["wono"]) != "")
                {
                    WONo = (Request.QueryString["wono"].ToString());

                    if ((Request.QueryString["PId"]) != "" && (Request.QueryString["CId"]) != "")
                    {
                        int PId = Convert.ToInt32((Request.QueryString["PId"].ToString()));
                        int CId = Convert.ToInt32((Request.QueryString["CId"].ToString()));
                        sql = fun.select("CId", "tblDG_TPL_Master", "WONo='" + WONo + "' AND PId='" + PId + "' AND CId='" + CId + "' AND FinYearId<='" + FinYearId + "'And CompId='" + CompId + "' ");
                    }
                    else
                    {
                        sql = fun.select("CId", "tblDG_TPL_Master", "WONo='" + WONo + "' AND PId='0' AND FinYearId<='" + FinYearId + "'And CompId='" + CompId + "'");
                    }
                    SqlCommand cmd = new SqlCommand(sql, con);
                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    DataSet DS9 = new DataSet();
                    da.Fill(DS9, "tblDG_TPL_Master");
                    DT.Columns.Add("ItemCode", typeof(string));
                    DT.Columns.Add("ManfDesc", typeof(string));
                    DT.Columns.Add("UOM", typeof(string));
                    DT.Columns.Add("Qty", typeof(double));
                    DT.Columns.Add("TPLQty", typeof(double));
                    DT.Columns.Add("WONo", typeof(string));
                    DT.Columns.Add("CompId", typeof(int));
                    DT.Columns.Add("AC", typeof(string));
                    DT.Columns.Add("StartDate", typeof(string));
                    for (int i = 0; i < DS9.Tables[0].Rows.Count; i++)
                    {
                        this.getPrintnode(Convert.ToInt32(DS9.Tables[0].Rows[i]["CId"]), WONo, CompId, FinYearId);
                    }

                    DataTable DT2 = (DataTable)ViewState["myDT"];
                    // Get Company Name
                    string Company = fun.getCompany(CompId);
                    // Get Address
                    string Address = fun.CompAdd(CompId);
                    // Get Project Title
                    string Title = fun.getProjectTitle(WONo);

                    string reportPath = Server.MapPath("~/Module/Design/Transactions/Reports/TPL_Print_ALL.rpt");
                    report.Load(reportPath);
                    report.SetDataSource(DT2);
                    report.SetParameterValue("Company", Company);
                    report.SetParameterValue("Address", Address);
                    report.SetParameterValue("Title", Title);
                    CrystalReportViewer1.ReportSource = report;
                    CrystalReportViewer1.EnableViewState = true;
                    Session["ReportDocument"] = report;

                }
            }
            catch (Exception ex)
            {

            }

           
        }

        else
        {
            ReportDocument doc = (ReportDocument)Session["ReportDocument"];
            CrystalReportViewer1.ReportSource = doc;
        }
    }



    protected void Page_Load(object sender, EventArgs e)
    {
     
       
    }
    
    public void getPrintnode(int node, string wono, int compid,int FinId)
    {
        string connStr = fun.Connection();
        SqlConnection con = new SqlConnection(connStr);
        try
        {
            DataSet DS = new DataSet();          
            con.Open();
            string getparent2 = fun.select("tblDG_Item_Master.ItemCode,tblDG_Item_Master.PartNo,tblDG_Item_Master.CId,tblDG_TPL_Master.SysDate,tblDG_TPL_Master.Qty,tblDG_TPL_Master.PId,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_TPL_Master,tblDG_Item_Master,Unit_Master", "tblDG_TPL_Master.CId='" + node + "' And tblDG_TPL_Master.WONo='" + wono + "'And tblDG_TPL_Master.SysDate between '" + fun.FromDate(StartDate) + "' and '" + fun.FromDate(UpToDate) + "'  And tblDG_TPL_Master.CompId='" + CompId + "' AND tblDG_TPL_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id"); 
            SqlCommand checkparent2 = new SqlCommand(getparent2, con);
            SqlDataAdapter daparent2 = new SqlDataAdapter(checkparent2);
            DataSet dsparent2 = new DataSet();
            daparent2.Fill(dsparent2);
            DR = DT.NewRow();

            if (dsparent2.Tables[0].Rows.Count>0)
            {


            if (dsparent2.Tables[0].Rows[0]["CId"] != DBNull.Value)
            {
                DR[0] = dsparent2.Tables[0].Rows[0]["ItemCode"].ToString();
            }

            else
            {
                DR[0] = dsparent2.Tables[0].Rows[0]["PartNo"].ToString();
            }

            DR[1] = dsparent2.Tables[0].Rows[0]["ManfDesc"].ToString();
            DR[2] = dsparent2.Tables[0].Rows[0]["Symbol"].ToString();
            DR[3] = Convert.ToDouble(dsparent2.Tables[0].Rows[0]["Qty"]);
            DR[4] = Convert.ToDouble(fun.RecurQty(wono, Convert.ToInt32(dsparent2.Tables[0].Rows[0]["PId"]), node, 1,CompId,FinId));            
            DR[5] = wono;
            DR[6] = Convert.ToInt32(CompId);
            DR[7] = "A";
            DR[8] = fun.FromDateDMY(dsparent2.Tables[0].Rows[0]["SysDate"].ToString());
            }
            DT.Rows.Add(DR);

            string getparent = fun.select("tblDG_TPL_Master.CId,tblDG_Item_Master.ItemCode,tblDG_Item_Master.PartNo,tblDG_Item_Master.CId As CatId,tblDG_TPL_Master.SysDate,tblDG_TPL_Master.PId,tblDG_TPL_Master.Qty,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_TPL_Master,tblDG_Item_Master,Unit_Master", "tblDG_TPL_Master.PId='" + node + "' And tblDG_TPL_Master.WONo='" + wono + "'And tblDG_TPL_Master.SysDate between '" + fun.FromDate(StartDate) + "'and '" + fun.FromDate(UpToDate) + "' And tblDG_TPL_Master.CompId='" + CompId + "'AND tblDG_TPL_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id");

            SqlCommand checkparent = new SqlCommand(getparent, con);
            SqlDataAdapter daparent = new SqlDataAdapter(checkparent);
            DataSet dsparent = new DataSet();
            daparent.Fill(dsparent);
            
            for (int h = 0; h < dsparent.Tables[0].Rows.Count; h++)
            {
                DR = DT.NewRow();
                if (dsparent.Tables[0].Rows[h]["CId"] != DBNull.Value)
                {
                    DR[0] = dsparent.Tables[0].Rows[h]["ItemCode"].ToString();
                }

                else
                {
                    DR[0] = dsparent.Tables[0].Rows[h]["PartNo"].ToString();
                }
                DR[1] = dsparent.Tables[0].Rows[h]["ManfDesc"].ToString();
                DR[2] = dsparent.Tables[0].Rows[h]["Symbol"].ToString();
                DR[3] = Convert.ToDouble(dsparent.Tables[0].Rows[h]["Qty"]);
                DR[4] = Convert.ToDouble(fun.RecurQty(wono, Convert.ToInt32(dsparent.Tables[0].Rows[h]["PId"]), Convert.ToInt32(dsparent.Tables[0].Rows[h]["CId"]), 1,CompId,FinId));                
                DR[5] = wono;
                DR[6] = Convert.ToInt32(CompId);
                DR[7] = "C";
                DR[8] = fun.FromDateDMY(dsparent.Tables[0].Rows[h]["SysDate"].ToString());
                DT.Rows.Add(DR);

                DataSet DS2 = new DataSet();

                string cmdStr2 = fun.select("tblDG_Item_Master.ItemCode,tblDG_Item_Master.PartNo,tblDG_Item_Master.CId As CatId,tblDG_TPL_Master.Qty,tblDG_TPL_Master.SysDate,tblDG_TPL_Master.CId,Unit_Master.Symbol,tblDG_Item_Master.ManfDesc", "tblDG_TPL_Master,tblDG_Item_Master,Unit_Master", "tblDG_TPL_Master.PId=" + dsparent.Tables[0].Rows[h]["CId"] + "And tblDG_TPL_Master.WONo='" + wono + "' And tblDG_TPL_Master.SysDate between '" + fun.FromDate(StartDate) + "' and '" + fun.FromDate(UpToDate) + "' And tblDG_TPL_Master.CompId='" + CompId + "'AND tblDG_TPL_Master.FinYearId<='" + FinYearId + "' AND Unit_Master.Id=tblDG_Item_Master.UOMBasic AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id AND tblDG_TPL_Master.ItemId=tblDG_Item_Master.Id");
                SqlCommand cmd2 = new SqlCommand(cmdStr2, con);
                SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                da2.Fill(DS2);

                if (DS2.Tables[0].Rows.Count > 0)
                {
                    for (int j = 0; j < DS2.Tables[0].Rows.Count; j++)
                    {
                        this.getPrintnode(Convert.ToInt32(DS2.Tables[0].Rows[j]["CId"]), wono, compid,FinId);
                        
                    }
                }
                
            }
            DT.AcceptChanges();
            
            ViewState["myDT"] = DT;

        }
       catch (Exception x)
        {
        }
       finally
        {
            con.Close();
        }

    }
    
    protected void Button1_Click(object sender, EventArgs e)
    {
        Response.Redirect("TPL_Design_Print_Tree.aspx?WONo=" + WONo + "&SD=" + StartDate + "&TD=" + UpToDate + "&ModId=3&SubModId=23");
    }

}
