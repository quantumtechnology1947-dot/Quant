=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/ProjectManagement/Transactions/ForCustomers.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="ForCustomers.aspx.cs" Inherits="Module_ProjectManagement_Transactions_ForCustomers" Title="ERP" Theme ="Default" %>

<%@ Register assembly="AjaxControlToolkit" namespace="AjaxControlToolkit" tagprefix="cc1" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link type="text/css" href="../../../css/yui-datatable.css" rel="stylesheet" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <style type="text/css">
        .style3
        {
            height: 13px;
        }
        .style4
        {
            height: 13px;
            width: 119px;
        }
        .style5
        {
            height: 12px;
            width: 119px;
        }
        .style6
        {
            width: 119px;
        }
        .style7
        {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 11px;
            font-style: normal;
            line-height: normal;
            font-weight: normal;
            font-variant: normal;
            text-transform: none;
            color: #FFFFFF;
            text-decoration: none;
        }
        .style8
        {
            height: 13px;
            width: 27px;
        }
        .style9
        {
            height: 12px;
            width: 27px;
        }
        .style10
        {
        }
        .style11
        {
            font-weight: bold;
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">
    <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr height="21">
            <td style="background:url(../../../images/hdbg.JPG)" class="style7" colspan="3">
                &nbsp;<strong> For Customer</strong></td>
        </tr>
        <tr height="21">
            <td  height="25" class="style8">
                            &nbsp;</td>
            <td  height="25" class="style4">
                            &nbsp;
                            
                            <asp:Label ID="Label2" runat="server" Text="Customer Name" CssClass="style11"></asp:Label>
                &nbsp;</td>
            <td  height="25" class="style3">
                            :
                <asp:TextBox ID="TxtSearchValue" runat="server" CssClass="box3" Width="350px"></asp:TextBox>
                <cc1:AutoCompleteExtender ID="TxtSearchValue_AutoCompleteExtender" 
                    runat="server" CompletionInterval="100" CompletionSetCount="1" 
                                            DelimiterCharacters="" Enabled="True" FirstRowSelected="True" 
                                            MinimumPrefixLength="1" ServiceMethod="sql" ServicePath="" 
                                            ShowOnlyCurrentWordInCompletionListItem="True" 
                                            TargetControlID="TxtSearchValue" UseContextKey="True" CompletionListItemCssClass="bg" CompletionListHighlightedItemCssClass="bgtext" CompletionListCssClass="almt">
                </cc1:AutoCompleteExtender>
                &nbsp;<asp:Button ID="Search" runat="server" onclick="Search_Click" Text="Search" 
                                CssClass="redbox" />
            </td>
        </tr>
        <tr height="21">
            <td  height="25" class="style9">
                            &nbsp;</td>
            <td  height="25" class="style5">
                            &nbsp;
                            
                            <asp:Label ID="Label3" runat="server" Text="Select User" CssClass="style11"></asp:Label>
            </td>
            <td  height="25" style="height: 12px">
                            : <asp:TextBox ID="TxtEmpName" runat="server" Width="350px" CssClass="box3"></asp:TextBox>
                  
        <cc1:AutoCompleteExtender ID="TxtEmpName_AutoCompleteExtender" runat="server" 
                                DelimiterCharacters="" Enabled="True" ServiceMethod="GetCompletionList" 
                                ServicePath="" TargetControlID="TxtEmpName" UseContextKey="True"
                                 CompletionInterval="100" CompletionSetCount="2" FirstRowSelected="True" MinimumPrefixLength="1" ShowOnlyCurrentWordInCompletionListItem="True" CompletionListItemCssClass="bg" CompletionListHighlightedItemCssClass="bgtext" CompletionListCssClass="almt">
                            </cc1:AutoCompleteExtender>
        
                            <asp:Label ID="lblUser" runat="server"></asp:Label>
        
            </td>
        </tr>
        <tr height="21">
            <td  height="25" class="style9">
                            &nbsp;</td>
            <td  height="25" class="style5">
                            &nbsp;
                            
                            <asp:Label ID="Label4" runat="server" Text="Title" CssClass="style11"></asp:Label>
            </td>
            <td  height="25" style="height: 12px">
                            :
                            <asp:TextBox ID="txtTitle" runat="server" CssClass="box3" Width="370px"></asp:TextBox>
                            <asp:Label ID="lblTitle" runat="server"></asp:Label>
            </td>
        </tr>
        <tr>
            <td class="style10">
                &nbsp;</td>
            <td class="style6">
                &nbsp;
                            
                            <asp:Label ID="Label5" runat="server" Text="Upload Details" 
                    CssClass="style11"></asp:Label>
            </td>
            <td>
                :</td>
        </tr>
        <tr>
            <td class="style10" colspan="3">
                
                    <asp:GridView ID="GridView3" runat="server"  
                        ShowFooter="True" 
                        AutoGenerateColumns="False" CssClass="yui-datatable-theme" DataKeyNames="Id" 
                        OnRowCommand="GridView3_RowCommand" PageSize="17" Width="100%" 
                        AllowPaging="True" onpageindexchanging="GridView3_PageIndexChanging"><Columns>
                            <asp:TemplateField 
                                HeaderText="SN"><ItemTemplate><%#Container.DataItemIndex+1  %>
                                    </ItemTemplate><HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" Width="3%" />
                                </asp:TemplateField>
                                <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="false">
                                    <ItemTemplate>
                                        <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>'>  </asp:Label>
                                    </ItemTemplate><ItemStyle Width="2%" VerticalAlign="Top" />
                                </asp:TemplateField>
                                <asp:TemplateField HeaderText="DId" Visible="false">
                                <ItemTemplate>
                                        <asp:Label ID="lblDId" runat="server" Text='<%#Eval("DId") %>'>  </asp:Label>
                                    </ItemTemplate>
                                    <ItemStyle VerticalAlign="Top" />
                                </asp:TemplateField><asp:TemplateField><ItemTemplate>
                                <asp:LinkButton ID="linkBtn" runat="server" CommandName="del" 
                                        OnClientClick=" return confirmationDelete()" Text="Delete"> </asp:LinkButton>
                                    </ItemTemplate><HeaderStyle Font-Size="10pt" />
                                    <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" Width="5%" />
                                </asp:TemplateField>
                                <asp:TemplateField HeaderText="Date" >
                                    <ItemTemplate>
                                        <asp:Label ID="lblPLNDate" runat="server" Text='<%# Bind("PLNDate") %>'></asp:Label>
                                    </ItemTemplate>
                                    <ItemStyle HorizontalAlign="Center" Width="5%" VerticalAlign="Top" />
                                </asp:TemplateField>
                                <asp:TemplateField HeaderText="Time">
                                <ItemTemplate>
                                <asp:Label runat="server" ID="lbltime" Text='<%#Eval("Time") %>'></asp:Label>
                                </ItemTemplate>
                                    <ItemStyle HorizontalAlign="Center" Width="5%" VerticalAlign="Top" />
                            </asp:TemplateField>
                                <asp:TemplateField HeaderText="File" >
                                    <ItemTemplate>
                                        <asp:LinkButton ID="btnlnkImg" CommandName="downloadImg" Visible="true"  
                            Text='<%# Bind("FileName") %>' runat="server"></asp:LinkButton>
                                    </ItemTemplate>
                                    <FooterTemplate>
                                        <asp:FileUpload ID="FileUpload1"  runat="server" />
                                    </FooterTemplate>
                                    <FooterStyle HorizontalAlign="Center" Width="5%" />
                                    <ItemStyle HorizontalAlign="Left" Width="250px" VerticalAlign="Top" />
                                </asp:TemplateField>
                                
                                <asp:TemplateField HeaderText="Mail To">
                                <ItemTemplate>                                
                                <asp:Label runat="server" ID="lblmailTo" Text='<%#Eval("MailTo") %>'></asp:Label>
                                </ItemTemplate>
                                <FooterTemplate>
                                <asp:TextBox runat="server" ID="txtmailto" CssClass="box3" Width="90%"></asp:TextBox>
       <asp:RegularExpressionValidator ID="RegmailTo" runat="server" ValidationGroup="A"
                ControlToValidate="txtmailto" ErrorMessage="*" 
                ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*">*</asp:RegularExpressionValidator>
                                
                                </FooterTemplate>
                                    <ItemStyle HorizontalAlign="Left" Width="12%" VerticalAlign="Top" />
                            </asp:TemplateField>
                                
                                <asp:TemplateField HeaderText="Message">
                                <ItemTemplate>                                
                                <asp:Label runat="server" ID="lblmsg" Text='<%#Eval("msg") %>'></asp:Label>
                                </ItemTemplate>
                                <FooterTemplate>
                                <asp:TextBox runat="server" ID="txtmsg" CssClass="box3" Width="99%"></asp:TextBox>
                                </FooterTemplate>
                                    <ItemStyle HorizontalAlign="Left" Width="20%" VerticalAlign="Top" />
                              </asp:TemplateField>
                                <asp:TemplateField HeaderText="Remarks">
                                <ItemTemplate>                                
                                <asp:Label runat="server" ID="lblrks" Text='<%#Eval("Remarks") %>'></asp:Label>
                                </ItemTemplate>
                                <FooterTemplate>
                                <asp:TextBox runat="server" ID="txtRemarks" CssClass="box3" Width="99%"></asp:TextBox>
                                </FooterTemplate>
                                    <ItemStyle HorizontalAlign="Left" Width="20%" VerticalAlign="Top" />
                            </asp:TemplateField>
                                <asp:TemplateField HeaderText="" >
                                    <FooterTemplate>
                                        <asp:Button ID="btnFAdd" ValidationGroup="A"  runat="server" Text="Add" CssClass="redbox" 
                            CommandName="Add" OnClientClick=" return confirmationAdd()" />
                                    </FooterTemplate>
                                    <FooterStyle HorizontalAlign="Center" Width="3%" />
                                    <ItemStyle HorizontalAlign="Center" VerticalAlign="Top" />
                                </asp:TemplateField>
                            </Columns>
                            <EmptyDataTemplate>
                                <table border="1pt" style="border-color:GrayText" width="100%">
                                    <tr>
                                        <th>
                                            SN
                                             </th><th >File </th><th>Mail To</th><th>Message</th><th>Remarks</th><th></th></tr><tr>
                                    <td 
                                        align="center"><asp:Label ID="lblSN" runat="server"  Text="1"></asp:Label></td>
                                    <td width="10%" >
                                        <asp:FileUpload  
                                                ID="FileUpload2"   runat="server" />
                                        </td>
                                        <td>
                                         <asp:TextBox runat="server" ID="txtmailTo" CssClass="box3" Width="96%"></asp:TextBox>
                                         
                                        <asp:RegularExpressionValidator ID="RegmailToE" runat="server" ValidationGroup="B"
                ControlToValidate="txtmailTo" ErrorMessage="*" 
                ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*">*</asp:RegularExpressionValidator>
                                
                                        </td>
                                        <td>
                                         <asp:TextBox runat="server" ID="txtmsg" CssClass="box3" Width="100%"></asp:TextBox>
                                        </td>
                                         <td >
                                        <asp:TextBox runat="server" ID="txtRemarks" CssClass="box3" Width="100%"></asp:TextBox>
                                        </td>
                                        <td align="center">
                                            <asp:Button ID="btnFAdd1" ValidationGroup="B"  runat="server" Text="Add" CssClass="redbox"  
                                          OnClientClick=" return confirmationAdd()" CommandName="Add1" />
                                        </td>
                                    </tr>
                                </table>
                            </EmptyDataTemplate>
                        </asp:GridView>
            </td>
        </tr>
    </table>
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/ProjectManagement/Transactions/ForCustomers.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;
using System.IO;
using System.Net;
using System.Net.Mail;
using CrystalDecisions.Shared;
public partial class Module_ProjectManagement_Transactions_ForCustomers : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    SqlConnection con;
    string sId = "";
    int FinYearId = 0;
    int CompId = 0;
    string connStr = "";   
    MailMessage msg = new MailMessage();
    protected void Page_Load(object sender, EventArgs e)
    {
       try
        {
           // GC.Collect();
            sId = Session["username"].ToString();
            FinYearId = Convert.ToInt32(Session["finyear"]);
            CompId = Convert.ToInt32(Session["compid"]);            
            connStr = fun.Connection();
            con = new SqlConnection(connStr);
            
        }
      catch (Exception ex) { }
    }

    protected void Search_Click(object sender, EventArgs e)
    {
        if (fun.getCode(TxtSearchValue.Text) != "")
        {
            this.FillDataUpLoad(fun.getCode(TxtSearchValue.Text));          
        }         
    }

    public void FillDataUpLoad(string CustId)
    {
      try
        {            
            DataTable dt = new DataTable();
            DataRow dr;

            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("PLNDate", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("FileName", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("DId", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Remarks", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Time", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("MailTo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("msg", typeof(string)));
            string sql = fun.select("tblPM_ForCustomer_Master.Id,tblPM_ForCustomer_Details.MailTo,tblPM_ForCustomer_Details.Message,tblPM_ForCustomer_Details.Id as DId,tblPM_ForCustomer_Master.SysDate,tblPM_ForCustomer_Master.SysTime,tblPM_ForCustomer_Details.FileName,tblPM_ForCustomer_Details.Remarks,tblPM_ForCustomer_Master.EmpId,tblPM_ForCustomer_Master.Title", "tblPM_ForCustomer_Master,tblPM_ForCustomer_Details", "tblPM_ForCustomer_Master.Id=tblPM_ForCustomer_Details.MId AND tblPM_ForCustomer_Master.FinYearId<='" + FinYearId + "' AND tblPM_ForCustomer_Master.CompId='" + CompId + "' AND tblPM_ForCustomer_Master.CustId='" + CustId + "'");
           
            SqlCommand cmd = new SqlCommand(sql,con);
            SqlDataAdapter da = new SqlDataAdapter(cmd);
            DataSet DS = new DataSet();
            da.Fill(DS);

            if (DS.Tables[0].Rows.Count>0)
            {
                TxtEmpName.Visible=false;
                txtTitle.Visible=false;
                lblUser.Visible=true;
                lblTitle.Visible=true;

                string sql2 = fun.select("Title+'. '+EmployeeName as Name", "tblHR_OfficeStaff", "CompId='" + CompId + "' AND EmpId='"+DS.Tables[0].Rows[0]["EmpId"].ToString()+"'");
                SqlCommand cmd2 = new SqlCommand(sql2, con);
                SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                DataSet DS2 = new DataSet();
                da2.Fill(DS2);

                lblUser.Text = DS2.Tables[0].Rows[0][0].ToString() + " [" + DS.Tables[0].Rows[0]["EmpId"].ToString()+"]";
                lblTitle.Text = DS.Tables[0].Rows[0]["Title"].ToString();
            }else
            {
                TxtEmpName.Text = "";
                txtTitle.Text = "";
                TxtEmpName.Visible = true;
                txtTitle.Visible = true;
                lblUser.Visible = false;
                lblTitle.Visible = false;
            }

            for (int q = 0; q < DS.Tables[0].Rows.Count; q++)
            {
                dr = dt.NewRow();
                dr[0] = DS.Tables[0].Rows[q]["Id"].ToString();
                dr[1] = fun.FromDateDMY(DS.Tables[0].Rows[q]["SysDate"].ToString());
                
                if (DS.Tables[0].Rows[q]["FileName"].ToString() != "" && DS.Tables[0].Rows[q]["FileName"] != DBNull.Value)
                {
                    dr[2] = DS.Tables[0].Rows[q]["FileName"].ToString();
                }

                dr[3] = DS.Tables[0].Rows[q]["DId"].ToString();
                dr[4] = DS.Tables[0].Rows[q]["Remarks"].ToString();
                dr[5] = DS.Tables[0].Rows[q]["SysTime"].ToString();
                dr[6] = DS.Tables[0].Rows[q]["MailTo"].ToString();
                dr[7] = DS.Tables[0].Rows[q]["Message"].ToString();               
                dt.Rows.Add(dr);
                dt.AcceptChanges();
            }
            GridView3.DataSource = dt;
            GridView3.DataBind();            
        }
       catch (Exception ex) { }
    }

    protected void GridView3_RowCommand(object sender, GridViewCommandEventArgs e)
    {
    //try
        {
            con.Open();
            string CDate = fun.getCurrDate();
            string CTime = fun.getCurrTime();
            string CustId = fun.getCode(TxtSearchValue.Text);
            if (e.CommandName == "Add")
            {
                               
                string EmpId = fun.getCode(lblUser.Text);
                string Title = lblTitle.Text;
                string strcv = "";
                string remarks = ((TextBox)GridView3.FooterRow.FindControl("txtRemarks")).Text;
                string MailTo = ((TextBox)GridView3.FooterRow.FindControl("txtmailto")).Text;
                string Message=((TextBox)GridView3.FooterRow.FindControl("txtmsg")).Text;
                FileUpload FileUpload1 = GridView3.FooterRow.FindControl("FileUpload1") as FileUpload;               
                string ErpMail = "";
               // if (FileUpload1.PostedFile.FileName != null && MailTo != "" && fun.EmailValidation(MailTo) == true)
                //if (FileUpload1.PostedFile.FileName != null && MailTo != "")
                //{
                //    string sqlmailserverip = fun.select("MailServerIp,ErpSysmail", "tblCompany_master", "CompId = '" + CompId + "'");
                //    SqlCommand cmd4 = new SqlCommand(sqlmailserverip, con);
                //    SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
                //    DataSet ds4 = new DataSet();
                //    da4.Fill(ds4);                    
                //    if (ds4.Tables[0].Rows.Count > 0)
                //    {
                //        ErpMail = ds4.Tables[0].Rows[0]["ErpSysmail"].ToString();
                //    }
                //    msg.From = new MailAddress(ErpMail);
                //    msg.To.Add(MailTo);
                //    msg.Subject = "";
                //    msg.Body = Message;
                //    if (FileUpload1.HasFile)
                //    {
                //        Attachment myattach = new Attachment(FileUpload1.FileContent, FileUpload1.PostedFile.FileName);
                //        msg.Attachments.Add(myattach);
                //    }
                //    SmtpClient mysmtpclient = new SmtpClient();
                //    mysmtpclient.Host = ds4.Tables[0].Rows[0]["MailServerIp"].ToString();
                //    mysmtpclient.Send(msg);
                //}
                    if (FileUpload1 != null)
                    {
                        HttpPostedFile mycv = FileUpload1.PostedFile;
                        Byte[] mycvdata = null;
                        Stream fscv = FileUpload1.PostedFile.InputStream;
                        BinaryReader brcv = new BinaryReader(fscv);
                        mycvdata = brcv.ReadBytes((Int32)fscv.Length);
                        strcv = Path.GetFileName(mycv.FileName);
                        if (CustId != string.Empty && EmpId != string.Empty && Title != string.Empty && strcv != string.Empty)
                        {
                            string StrUp1 = fun.insert("tblPM_ForCustomer_Master", "SysDate, SysTime , CompId, FinYearId , SessionId, CustId,EmpId, Title", "'" + CDate + "','" + CTime + "','" + CompId + "','" + FinYearId + "','" + sId + "','" + CustId + "','" + EmpId + "','" + Title + "'");

                            SqlCommand cmdUp1 = new SqlCommand(StrUp1, con);
                            cmdUp1.Parameters.AddWithValue("@Data", mycvdata);
                            cmdUp1.ExecuteNonQuery();
                            string sql = fun.select("Id", "tblPM_ForCustomer_Master", "CompId='" + CompId + "' Order by Id Desc");
                            SqlCommand cmd = new SqlCommand(sql, con);
                            SqlDataAdapter da = new SqlDataAdapter(cmd);
                            DataSet DS = new DataSet();
                            da.Fill(DS);
                            string StrUpFile = fun.insert("tblPM_ForCustomer_Details", "MId, FileName , FileSize, ContentType , FileData,MailTo,Message,Remarks", "'" + DS.Tables[0].Rows[0][0].ToString() + "','" + strcv + "','" + mycvdata.Length + "','" + mycv.ContentType + "',@Data,'" + MailTo + "','" + Message + "','" + remarks + "'");
                            SqlCommand cmdUpFile = new SqlCommand(StrUpFile, con);
                            cmdUpFile.Parameters.AddWithValue("@Data", mycvdata);
                            cmdUpFile.ExecuteNonQuery();
                            this.FillDataUpLoad(CustId);
                        }
                        else
                        {
                            string myStringVariable = string.Empty;
                            myStringVariable = "Invalid input data.";
                            ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);
                        }

                        brcv.Close();
                        fscv.Close();
                    }
                

            }

            if (e.CommandName == "Add1")
            {
               
                string EmpId = fun.getCode(TxtEmpName.Text);
                string Title = txtTitle.Text;
                string strcv = "";
                string remarks = ((TextBox)GridView3.Controls[0].Controls[0].FindControl("txtRemarks")).Text;
                string MailTo = ((TextBox)GridView3.Controls[0].Controls[0].FindControl("txtmailTo")).Text;
                string Message = ((TextBox)GridView3.Controls[0].Controls[0].FindControl("txtmsg")).Text;
                FileUpload FileUpload2 = GridView3.Controls[0].Controls[0].FindControl("FileUpload2") as FileUpload;
                string ErpMail = "";
                //if (FileUpload2.PostedFile.FileName != null && MailTo != "" && fun.EmailValidation(MailTo) == true)
                //if (FileUpload2.PostedFile.FileName != null && MailTo != "")
                //{
                //    string sqlmailserverip = fun.select("MailServerIp,ErpSysmail", "tblCompany_master", "CompId = '" + CompId + "'");
                //    SqlCommand cmd4 = new SqlCommand(sqlmailserverip, con);
                //    SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
                //    DataSet ds4 = new DataSet();
                //    da4.Fill(ds4);
                //    if (ds4.Tables[0].Rows.Count > 0)
                //    {
                //        ErpMail = ds4.Tables[0].Rows[0]["ErpSysmail"].ToString();
                //    }
                //    msg.From = new MailAddress(ErpMail);
                //    msg.To.Add(MailTo);
                //    msg.Subject = "";
                //    msg.Body = Message;
                //    if (FileUpload2.HasFile)
                //    {
                //        Attachment myattach = new Attachment(FileUpload2.FileContent, FileUpload2.PostedFile.FileName);
                //        msg.Attachments.Add(myattach);
                //    }
                //    SmtpClient mysmtpclient = new SmtpClient();
                //    mysmtpclient.Host = ds4.Tables[0].Rows[0]["MailServerIp"].ToString();
                //    mysmtpclient.Send(msg);

                //}
                    HttpPostedFile mycv = FileUpload2.PostedFile;
                    Byte[] mycvdata = null;
                    if (FileUpload2 != null)
                    {
                        Stream fscv = FileUpload2.PostedFile.InputStream;
                        BinaryReader brcv = new BinaryReader(fscv);
                        mycvdata = brcv.ReadBytes((Int32)fscv.Length);
                        strcv = Path.GetFileName(mycv.FileName);
                    

                    if (CustId != string.Empty && EmpId != string.Empty && Title != string.Empty && strcv != string.Empty)
                    {
                        string StrUp1 = fun.insert("tblPM_ForCustomer_Master", "SysDate, SysTime , CompId, FinYearId , SessionId, CustId,EmpId, Title", "'" + CDate + "','" + CTime + "','" + CompId + "','" + FinYearId + "','" + sId + "','" + CustId + "','" + EmpId + "','" + Title + "'");
                        SqlCommand cmdUp1 = new SqlCommand(StrUp1, con);
                        cmdUp1.Parameters.AddWithValue("@Data", mycvdata);
                        cmdUp1.ExecuteNonQuery();
                        string sql = fun.select("Id", "tblPM_ForCustomer_Master", "CompId='" + CompId + "' Order by Id Desc");
                        SqlCommand cmd = new SqlCommand(sql, con);
                        SqlDataAdapter da = new SqlDataAdapter(cmd);
                        DataSet DS = new DataSet();
                        da.Fill(DS);
                        string StrUpFile = fun.insert("tblPM_ForCustomer_Details", "MId, FileName , FileSize, ContentType , FileData,MailTo,Message,Remarks", "'" + DS.Tables[0].Rows[0][0].ToString() + "','" + strcv + "','" + mycvdata.Length + "','" + mycv.ContentType + "',@Data,'"+MailTo+"','"+Message+"','" + remarks + "'");
                        SqlCommand cmdUpFile = new SqlCommand(StrUpFile, con);
                        cmdUpFile.Parameters.AddWithValue("@Data", mycvdata);
                        cmdUpFile.ExecuteNonQuery();
                        this.FillDataUpLoad(CustId);
                    }
                    else
                    {
                        string myStringVariable = string.Empty;
                        myStringVariable = "Invalid input data.";
                        ClientScript.RegisterStartupScript(this.GetType(), "myalert", "alert('" + myStringVariable + "');", true);
                    }
                    brcv.Close();
                    fscv.Close();

                }

            }

            if (e.CommandName == "del")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int id = Convert.ToInt32(((Label)row.FindControl("lblId")).Text);
                int did = Convert.ToInt32(((Label)row.FindControl("lblDId")).Text);
                string sql = fun.delete("tblPM_ForCustomer_Details", "Id='" + did + "'");
                SqlCommand cmd = new SqlCommand(sql, con);
                cmd.ExecuteNonQuery();
                string sql4 = fun.select("Id", "tblPM_ForCustomer_Details", "MId='" + id + "'");
                SqlCommand cmd4 = new SqlCommand(sql4, con);
                SqlDataAdapter da4 = new SqlDataAdapter(cmd4);
                DataSet DS4 = new DataSet();
                da4.Fill(DS4);
                if (DS4.Tables[0].Rows.Count == 0)
                {
                    string sql1 = fun.delete("tblPM_ForCustomer_Master", "Id='" + id + "'");
                    SqlCommand cmd1 = new SqlCommand(sql1, con);
                    cmd1.ExecuteNonQuery();
                    //Page.Response.Redirect(Page.Request.Url.ToString(),true);
                    this.FillDataUpLoad(CustId);
                }
                this.FillDataUpLoad(CustId);

            }

            if (e.CommandName == "downloadImg")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int id = Convert.ToInt32(((Label)row.FindControl("lblDId")).Text);

                Response.Redirect("~/Controls/DownloadFile.aspx?Id=" + id + "&tbl=tblPM_ForCustomer_Details&qfd=FileData&qfn=FileName&qct=ContentType");

            }
        }
        // catch (Exception ex) { }
        //finally
        {
            con.Close();
        }
    }

    [System.Web.Services.WebMethodAttribute(), System.Web.Script.Services.ScriptMethodAttribute()]
    public static string[] sql(string prefixText, int count, string contextKey)
    {
        clsFunctions fun = new clsFunctions();
        string connStr = fun.Connection();
        DataSet ds = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        int CompId = Convert.ToInt32(HttpContext.Current.Session["compid"]);
        con.Open();
        string cmdStr = fun.select("CustomerId,CustomerName", "SD_Cust_master", "CompId='" + CompId + "'");
        SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
        da.Fill(ds, "SD_Cust_master");
        con.Close();
        string[] main = new string[0];
        for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        {
            if (ds.Tables[0].Rows[i].ItemArray[1].ToString().ToLower().StartsWith(prefixText.ToLower()))
            {
                Array.Resize(ref main, main.Length + 1);
                main[main.Length - 1] = ds.Tables[0].Rows[i].ItemArray[1].ToString() + " [" + ds.Tables[0].Rows[i].ItemArray[0].ToString() + "]";
                //if (main.Length == 10)
                //    break;
            }
        }
        Array.Sort(main);
        return main;
    }

    [System.Web.Services.WebMethodAttribute(), System.Web.Script.Services.ScriptMethodAttribute()]
    public static string[] GetCompletionList(string prefixText, int count, string contextKey)
    {
        clsFunctions fun = new clsFunctions();
        string connStr = fun.Connection();
        DataSet ds = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        con.Open();
        int CompId = Convert.ToInt32(HttpContext.Current.Session["compid"]);
        string cmdStr = fun.select("EmpId,EmployeeName", "tblHR_OfficeStaff", "CompId='" + CompId + "'");
        SqlDataAdapter da = new SqlDataAdapter(cmdStr, con);
        da.Fill(ds, "tblHR_OfficeStaff");
        con.Close();
        string[] main = new string[0];
        for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
        {
            if (ds.Tables[0].Rows[i].ItemArray[1].ToString().ToLower().StartsWith(prefixText.ToLower()))
            {
                Array.Resize(ref main, main.Length + 1);
                main[main.Length - 1] = ds.Tables[0].Rows[i].ItemArray[1].ToString() + " [" + ds.Tables[0].Rows[i].ItemArray[0].ToString() + "]";
                //if (main.Length == 10)
                //    break;
            }
        }
        Array.Sort(main);
        return main;
    }
    
    protected void GridView3_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        try
        {
            GridView3.PageIndex = e.NewPageIndex;
            if (fun.getCode(TxtSearchValue.Text) != "")
            {
                this.FillDataUpLoad(fun.getCode(TxtSearchValue.Text));
            }
        }catch(Exception sx)
        {

        }
    }

}
