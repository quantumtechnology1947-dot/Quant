=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Machinery/Transactions/PMBM_Edit.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="PMBM_Edit.aspx.cs" Inherits="Module_Machinery_Transactions_PMBM_Edit" Title="ERP"  Theme ="Default"%>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">

    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <link href="../../../Css/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .style5
        {
            height: 31px;
        }
        </style>

</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

<table align="left" cellpadding="0" cellspacing="0" width="100%">
        <tr>
            <td height="20" align="left" valign="middle"  scope="col" class="fontcsswhite" 
                style="background:url(../../../images/hdbg.JPG)" colspan="2">
        &nbsp;<b>Preventive /Breckdown Maintenance- Edit</b></td>
        </tr>
        <tr>
            <td valign="top" colspan="2">
<table align="left" cellpadding="0" 
            cellspacing="0" width="100%" style="height: 162px">
            <tr>
        <td colspan="2" rowspan="1" height="30" valign="middle">
        
        <asp:DropDownList ID="DrpCategory" runat="server" AutoPostBack="True" 
                CssClass="box3" Height="21px" 
                OnSelectedIndexChanged="DrpCategory_SelectedIndexChanged"></asp:DropDownList>&nbsp;<asp:DropDownList 
                ID="DrpSubCategory" runat="server" AutoPostBack="True" 
                CssClass="box3" 
                OnSelectedIndexChanged="DrpSubCategory_SelectedIndexChanged"></asp:DropDownList>
            &nbsp;<asp:DropDownList 
                ID="DrpSearchCode" runat="server" AutoPostBack="True" 
                CssClass="box3" 
                onselectedindexchanged="DrpSearchCode_SelectedIndexChanged" >
                
                <asp:ListItem Value="Select">Select</asp:ListItem>
                <asp:ListItem Value="tblDG_Item_Master.ItemCode">Machine Code</asp:ListItem>
                <asp:ListItem Value="tblDG_Item_Master.ManfDesc">Description</asp:ListItem>
            </asp:DropDownList>
            <asp:TextBox 
                ID="txtSearchItemCode" runat="server" CssClass="box3" Width="200px"></asp:TextBox>&nbsp; <asp:Button ID="btnSearch" runat="server" CssClass="redbox" 
                OnClick="btnSearch_Click" Text="Search" />&nbsp;</td>
                </tr>
                
                <tr>
        <td width="49%" valign="top">
        

        
            <asp:GridView ID="GridView2" runat="server" AllowPaging="True" 
                    AutoGenerateColumns="False" CssClass="yui-datatable-theme" 
                    OnPageIndexChanging="GridView2_PageIndexChanging" 
                    OnRowCommand="GridView2_RowCommand" PageSize="20" Width="95%"><FooterStyle Font-Bold="False" /><Columns>
                    
                    <asp:TemplateField HeaderText="SN">
                                                    <ItemTemplate>
                                                        <%# Container.DataItemIndex + 1%>
                                                    </ItemTemplate>
                                                    <ItemStyle HorizontalAlign="Right" />
                                                </asp:TemplateField>
                                                <asp:TemplateField HeaderText="Machine Code" >
                        <ItemTemplate>
                        
                                                       <asp:LinkButton ID="LinkButton1" CommandName="Sel" Text='<%# Bind("ItemCode") %>' runat="server"></asp:LinkButton>
                        </ItemTemplate>
                        <ItemStyle HorizontalAlign="Center" />
                    </asp:TemplateField>
                                                
                    <asp:TemplateField HeaderText="Id" Visible="False">
                        <ItemTemplate>
                            <asp:Label ID="lblId" runat="server" Text='<%# Bind("Id") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" />
                    </asp:TemplateField>
                    
                <asp:BoundField DataField="Id" HeaderText="Id" Visible="False"><ItemStyle VerticalAlign="Top" /></asp:BoundField>
                    <asp:BoundField DataField="SubCategory" HeaderText="SubCategory" 
                        Visible="False"><ItemStyle VerticalAlign="Top" /></asp:BoundField>
                    <asp:BoundField DataField="ManfDesc" HeaderText="Description">
                <ItemStyle VerticalAlign="Top" Width="45%" /></asp:BoundField>
                
                <asp:TemplateField HeaderText="Last PM Date" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lblLastPMBMDate" runat="server" Text='<%# Bind("LastPMBMDate") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" />
                      </asp:TemplateField> 
                                                   
                    <asp:TemplateField HeaderText="MId" Visible="False">
                        <ItemTemplate>
                            <asp:Label ID="lblMSId" runat="server" Text='<%# Bind("MSId") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" />
                    </asp:TemplateField>
                    
                </Columns>
                
                <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate><HeaderStyle Font-Size="9pt" />
                    </asp:GridView>
             
             
             
                    </td>
                    <td valign="top" width="49%">
<asp:UpdatePanel ID="Up" UpdateMode="Conditional" runat="server">    
<ContentTemplate>
<fieldset >
       
                       <asp:GridView ID="GridView1" runat="server" AllowPaging="True" 
                    AutoGenerateColumns="False" CssClass="yui-datatable-theme" 
                    OnPageIndexChanging="GridView1_PageIndexChanging" 
                    OnRowCommand="GridView1_RowCommand" PageSize="20" Width="95%"><FooterStyle Font-Bold="False" />
                    <Columns>
                    
                    <asp:TemplateField HeaderText="SN">
                                                    <ItemTemplate>
                                                        <%# Container.DataItemIndex + 1%>
                                                    </ItemTemplate>
                                                    <ItemStyle HorizontalAlign="Right" />
                                                </asp:TemplateField>
                                                <asp:TemplateField HeaderText="" >
                        <ItemTemplate>
                        
                                                       <asp:LinkButton ID="LinkButton1" CommandName="Sel" Text="Select" runat="server"></asp:LinkButton>
                        </ItemTemplate>
                        <ItemStyle HorizontalAlign="Center" />
                    </asp:TemplateField>
                                                
                    <asp:TemplateField HeaderText="Id" Visible="False">
                        <ItemTemplate>
                            <asp:Label ID="lblId" runat="server" Text='<%# Bind("Id") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" />
                    </asp:TemplateField>
                    
                
                
                <asp:TemplateField HeaderText="PM Date" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lblPMBMDate" runat="server" Text='<%# Bind("PMBMDate") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" />
                      </asp:TemplateField>               
                
                <asp:TemplateField HeaderText="Type" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lbltype" runat="server" Text='<%# Bind("type") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" HorizontalAlign="Center" />
                      </asp:TemplateField>
                                   
                       <asp:TemplateField HeaderText="Name of Agency" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lblNmAgency" runat="server" Text='<%# Bind("AgencyName") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" />
                      </asp:TemplateField>
                      
                       <asp:TemplateField HeaderText="Name of Engineer" Visible="true">
                        <ItemTemplate>
                        <asp:Label ID="lblNmEng" runat="server" Text='<%# Bind("EngName") %>'></asp:Label>
                        </ItemTemplate>                                                                       
                         <ItemStyle VerticalAlign="Top" />
                      </asp:TemplateField>                      
                      
                    
                </Columns>
                
                <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate><HeaderStyle Font-Size="9pt" />
                    </asp:GridView>
                    
                    
</fieldset>
</ContentTemplate>
</asp:UpdatePanel> 
                    
                        
                        </td>
                    </tr>                    
                    </table>
    </td> 
    
   
    </tr> 
    
    
       
    </table>
 
 
 
</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/Machinery/Transactions/PMBM_Edit.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_Machinery_Transactions_PMBM_Edit : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();
    string connStr = "";
    SqlConnection con;
    string sId = "";
    int CompId = 0;
    int FinYearId = 0;

    protected void Page_Load(object sender, EventArgs e)
    {
       try
        {
            connStr = fun.Connection();
            con = new SqlConnection(connStr);
            CompId = Convert.ToInt32(Session["compid"]);
            sId = Session["username"].ToString();
            FinYearId = Convert.ToInt32(Session["finyear"]);

            if (!IsPostBack)
            {
                fun.drpDesignCategory(DrpCategory, DrpSubCategory);

            }
            string sd = DrpCategory.SelectedValue;
            string b = DrpSubCategory.SelectedValue;
            string c = DrpSearchCode.SelectedValue;
            string d = txtSearchItemCode.Text;
            this.Fillgridview(sd, b, c, d);
            Up.Visible = true;
        }

       catch (Exception ex)
        { }
    }

    public void Fillgridview(string sd, string A, string B, string s)
    {
        try
        {
            string sql = "";

            string x = "";

            if (sd != "Select Category")
            {
                string y = "";
                if (A != "Select SubCategory")
                {
                    y = "  And tblDG_Item_Master.SCId='" + A + "'";
                }
                x = " AND  tblDG_Item_Master.CId='" + sd + "'";

                string p = "";

                txtSearchItemCode.Visible = true;

                if (B != "Select")
                {
                    if (B == "tblDG_Item_Master.ItemCode")
                    {
                        txtSearchItemCode.Visible = true;
                        p = " And tblDG_Item_Master.ItemCode Like '" + s + "%'";
                    }

                    if (B == "tblDG_Item_Master.ManfDesc")
                    {
                        txtSearchItemCode.Visible = true;
                        p = " And tblDG_Item_Master.ManfDesc Like '%" + s + "%'";
                    }
                    

                }
                sql = fun.select("tblMS_Master.SysDate As LastPMBMDate,tblMS_Master.Id As MSId,tblDG_Item_Master.Id,SUBSTRING(tblDG_Item_Master.ManfDesc,0,80)+'...' AS ManfDesc ,tblDG_Item_Master.StockQty, tblDG_Item_Master.ItemCode,tblDG_Item_Master.Location,tblDG_Item_Master.UOMBasic", " tblDG_Category_Master,tblDG_Item_Master,tblMS_Master", " tblDG_Item_Master.CId=tblDG_Category_Master.CId " + x + "" + y + "" + p + " AND tblDG_Item_Master.CompId='" + CompId + "'And tblDG_Item_Master.Absolute!='1' And tblMS_Master.ItemId=tblDG_Item_Master.Id Order By tblDG_Item_Master.Id Desc ");

            }
            else
            {
                sql = fun.select("tblMS_Master.SysDate As LastPMBMDate, tblMS_Master.Id As MSId,tblDG_Item_Master.Id,SUBSTRING(tblDG_Item_Master.ManfDesc,0,80)+'...' AS ManfDesc ,tblDG_Item_Master.StockQty, tblDG_Item_Master.ItemCode,tblDG_Item_Master.Location,tblDG_Item_Master.UOMBasic", "tblDG_Category_Master,tblDG_Item_Master,tblMS_Master", "tblDG_Item_Master.CId=tblDG_Category_Master.CId AND tblDG_Item_Master.CompId='" + CompId + "'And tblDG_Item_Master.Absolute!='1'And tblMS_Master.ItemId=tblDG_Item_Master.Id Order By tblDG_Item_Master.Id Desc");


            }

            this.fillGrid(sql, GridView2);
        }
        catch (Exception ex) { }
       
       
    }

    public void fillGrid(string sql, GridView GridView2)
    {
        string connStr = fun.Connection();
        DataSet DS3 = new DataSet();
        SqlConnection con = new SqlConnection(connStr);
        try
        {
            SqlCommand cmd = new SqlCommand(sql, con);
            SqlDataAdapter DA2 = new SqlDataAdapter(cmd);
            DA2.Fill(DS3);

            DataTable dt = new DataTable();

            dt.Columns.Add("Id", typeof(string));
            dt.Columns.Add("ItemCode", typeof(string));
            dt.Columns.Add("ManfDesc", typeof(string));
            dt.Columns.Add("LastPMBMDate", typeof(string));
            dt.Columns.Add("MSId", typeof(string));
            DataRow dr;

            for (int k = 0; k < DS3.Tables[0].Rows.Count; k++)
            {
                dr = dt.NewRow();
                dr[0] = DS3.Tables[0].Rows[k]["Id"].ToString();
                dr[1] = DS3.Tables[0].Rows[k]["ItemCode"].ToString();
                dr[2] = DS3.Tables[0].Rows[k]["ManfDesc"].ToString();
                dr[3] = fun.FromDateDMY(DS3.Tables[0].Rows[k]["LastPMBMDate"].ToString());
                dr[4] = DS3.Tables[0].Rows[k]["MSId"].ToString();
                dt.Rows.Add(dr);
                dt.AcceptChanges();
            }

            GridView2.DataSource = dt;
            GridView2.DataBind();
        } 
        catch (Exception ex) {}  
       finally
        {
            con.Close();
        }
    }

    protected void GridView2_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        try
        {
            if (e.CommandName == "Sel")
            {

                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int msid = 0;
                msid = Convert.ToInt32(((Label)row.FindControl("lblMSId")).Text); 
                int id = 0;
                id = Convert.ToInt32(((Label)row.FindControl("lblId")).Text);
                ViewState["MSId"] = msid;
                ViewState["Id"] = id; 
                this.PMBMGrid();
               
            }
        }
        catch (Exception es)  { } 
    }

    public void PMBMGrid()
    {
        try
        {
            int ID1 = 0;
            if (!string.IsNullOrEmpty(ViewState["Id"].ToString()))
            {
                ID1 = Convert.ToInt32(ViewState["Id"]);
            }

            int MSId1 = 0;
            if (!string.IsNullOrEmpty(ViewState["MSId"].ToString()))
            {
                MSId1 = Convert.ToInt32(ViewState["MSId"]);
            }

            string StrMachine = fun.select("*", "tblMS_PMBM_Master", " MachineId='" + MSId1 + "' AND CompId='" + CompId + "' And FinYearId<='" + FinYearId + "'");

            SqlCommand cmdMachine = new SqlCommand(StrMachine, con);
            SqlDataAdapter DAMachine = new SqlDataAdapter(cmdMachine);
            DataSet DSMachine = new DataSet();
            DAMachine.Fill(DSMachine);
            DataTable dt = new DataTable();
            dt.Columns.Add("Id", typeof(int));
            dt.Columns.Add("PMBMDate", typeof(string));
            dt.Columns.Add("type", typeof(string));
            dt.Columns.Add("AgencyName", typeof(string));
            dt.Columns.Add("EngName", typeof(string));
            DataRow dr;

            for (int k = 0; k < DSMachine.Tables[0].Rows.Count; k++)
            {

                dr = dt.NewRow();
                dr[0] = DSMachine.Tables[0].Rows[k]["Id"].ToString();
                dr[1] = fun.FromDateDMY(DSMachine.Tables[0].Rows[k]["SysDate"].ToString());

                if (DSMachine.Tables[0].Rows[k]["PMBM"].ToString() == "0")
                {
                    dr[2] = "Preventive";
                }

                else
                {
                    dr[2] = "Breakdown";
                }
                dr[3] = DSMachine.Tables[0].Rows[k]["NameOfAgency"].ToString();
                dr[4] = DSMachine.Tables[0].Rows[k]["NameOfEngineer"].ToString();
                dt.Rows.Add(dr);
                dt.AcceptChanges();
            }

            GridView1.DataSource = dt;
            GridView1.DataBind();
            con.Close();
        }
        catch(Exception ex){}

    }

    protected void DrpCategory_SelectedIndexChanged(object sender, EventArgs e)
    {
        try
        {
            if (DrpCategory.SelectedValue != "Select Category")
            {
                SqlCommand Cmd1 = new SqlCommand(fun.select(" CId,SCId,Symbol+' - '+SCName As SubCatName ", "tblDG_SubCategory_Master ", " CId=" + DrpCategory.SelectedValue + ""), con);
                SqlDataAdapter DA1 = new SqlDataAdapter(Cmd1);
                DataSet DS2 = new DataSet();
                DA1.Fill(DS2, "tblDG_SubCategory_Master");
                DrpSubCategory.DataSource = DS2.Tables["tblDG_SubCategory_Master"];
                DrpSubCategory.DataTextField = "SubCatName";
                DrpSubCategory.DataValueField = "SCId";
                DrpSubCategory.DataBind();
                DrpSubCategory.Items.Insert(0, "Select SubCategory");
                string sd = DrpCategory.SelectedValue;
                string b = DrpSubCategory.SelectedValue;
                string c = DrpSearchCode.SelectedValue;
                string d = txtSearchItemCode.Text;
                this.Fillgridview(sd, b, c, d);
                DrpSubCategory.SelectedIndex = 0;
                DrpSearchCode.SelectedIndex = 0;
                txtSearchItemCode.Text = "";               
            }
        }

      catch (Exception ch) {}
       finally
        {
            con.Close();
            DrpSearchCode.SelectedValue = "Select";
            Up.Visible = false;
        }

    }
    protected void DrpSubCategory_SelectedIndexChanged(object sender, EventArgs e)
    {
        try
        {
            string sd = DrpCategory.SelectedValue;
            string b = DrpSubCategory.SelectedValue;
            string c = DrpSearchCode.SelectedValue;
            string d = txtSearchItemCode.Text;
            this.Fillgridview(sd, b, c, d);
            Up.Visible = false;
        }
        catch (Exception ch) { }       
       
       finally
        {
            DrpSearchCode.SelectedValue = "Select";
        }
    }
    protected void btnSearch_Click(object sender, EventArgs e)
    {
        try
        {
            string sd = DrpCategory.SelectedValue;
            string b = DrpSubCategory.SelectedValue;
            string c = DrpSearchCode.SelectedValue;
            string d = txtSearchItemCode.Text;
            this.Fillgridview(sd, b, c, d);
            Up.Visible = false;

        }
        catch (Exception ch)
        {
        }

    }
    protected void GridView2_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        try
        {
            GridView2.PageIndex = e.NewPageIndex;
            string sd = DrpCategory.SelectedValue;
            string b = DrpSubCategory.SelectedValue;
            string c = DrpSearchCode.SelectedValue;
            string d = txtSearchItemCode.Text;
            this.Fillgridview(sd, b, c, d);

        }
        catch (Exception ch)
        {
        }
    }

    protected void GridView1_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        GridView1.PageIndex = e.NewPageIndex;
        this.PMBMGrid();
    }
    protected void GridView1_RowCommand(object sender, GridViewCommandEventArgs e)
    {
       try
        {
            if (e.CommandName == "Sel")
            {
                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int PMBMid = 0;
                PMBMid = Convert.ToInt32(((Label)row.FindControl("lblId")).Text);
                if (PMBMid != 0)
                {
                    Response.Redirect("~/Module/Machinery/Transactions/PMBM_Edit_Details.aspx?PMBMId=" + PMBMid + "&ModId=15&SubModId=68");
                }
            }
        }
       catch (Exception es)
        {
        }
    }
    protected void DrpSearchCode_SelectedIndexChanged(object sender, EventArgs e)
    {
        Up.Visible = false;
    }
}
