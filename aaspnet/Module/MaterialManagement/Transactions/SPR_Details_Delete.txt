=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialManagement/Transactions/SPR_Details_Delete.aspx.txt ===

﻿<%@ Page Language="C#" MasterPageFile="~/MasterPage.master" AutoEventWireup="true" CodeFile="SPR_Details_Delete.aspx.cs" Inherits="Module_MaterialManagement_Transactions_SPR_Details_Delete" Title="ERP" Theme="Default" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" Runat="Server">
    <link href="../../../Css/StyleSheet.css" rel="stylesheet" type="text/css" />
    <link href="../../../Css/yui-datatable.css" rel="stylesheet" type="text/css" />
    <script src="../../../Javascript/PopUpMsg.js" type="text/javascript"></script>
    <script src="../../../Javascript/loadingNotifier.js" type="text/javascript"></script>
    <style type="text/css">
        .style2
        {
            height: 1px;
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="cp3" Runat="Server">
</asp:Content>
<asp:Content ID="Content3" ContentPlaceHolderID="cp1" Runat="Server">
</asp:Content>
<asp:Content ID="Content4" ContentPlaceHolderID="cp2" Runat="Server">
</asp:Content>
<asp:Content ID="Content5" ContentPlaceHolderID="MainContent" Runat="Server">
</asp:Content>
<asp:Content ID="Content6" ContentPlaceHolderID="ContentPlaceHolder2" Runat="Server">
</asp:Content>
<asp:Content ID="Content7" ContentPlaceHolderID="ContentPlaceHolder3" Runat="Server">

<table width="100%">
 <tr>
            <td align="left" valign="middle"  scope="col" height="21"
                style="background:url(../../../images/hdbg.JPG)" class="fontcsswhite">
        &nbsp;<b>SPR - Delete </b>
</td>
</tr>
 <tr>
            <td valign="top"  width="100%">
            <asp:Panel ID="Panel1" runat="server" ScrollBars="Auto" Height="445px">
<asp:GridView ID="GridView3" runat="server" AllowPaging="True" 
        CssClass="yui-datatable-theme"  onpageindexchanging="GridView3_PageIndexChanging" 
        onrowcommand="GridView3_RowCommand" PageSize="14" ShowFooter="false" Width="100%" 
                    AutoGenerateColumns="False" onrowdeleting="GridView3_RowDeleting" >
        
                <FooterStyle Wrap="True"></FooterStyle>

                    <EmptyDataTemplate>
                    <table width="100%" class="fontcss">
                    <tr>
                    <td align="center">
                    <asp:Label ID="Label1" runat="server"  Text="No data to display !" Font-Size="Larger" ForeColor="maroon">
                    </asp:Label>
                    </td>
                    </tr>
                    </table>
                    </EmptyDataTemplate>
    <Columns>
    
<asp:TemplateField HeaderText="SN" ItemStyle-HorizontalAlign="Right">
                <ItemTemplate><%#Container.DataItemIndex+1  %></ItemTemplate>             
                <HeaderStyle Font-Size="10pt" />
                <ItemStyle HorizontalAlign="Right" VerticalAlign="Top" />
</asp:TemplateField>
        <%--<asp:ButtonField Text="Edit" CommandName="edt" />--%>
        <asp:TemplateField HeaderText="" ItemStyle-HorizontalAlign="Center">
                <ItemTemplate>
                <asp:LinkButton ID="linkBtn" runat="server" Text="Delete"   OnClientClick=" return confirmationDelete()" CommandName="delete" ></asp:LinkButton>
                <asp:Label ID="lblDel" runat="server" Text="PO" Visible="false"></asp:Label>
                
                </ItemTemplate>  
                           
                <HeaderStyle Font-Size="10pt" />
                <ItemStyle HorizontalAlign="Center" Width="3%" VerticalAlign="Top" />
                
</asp:TemplateField>
        
        <asp:TemplateField HeaderText="SPR No.">        
        <ItemTemplate>
        <asp:Label ID="lblsprno" runat="server" Text='<%#Eval("SPRNo") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Center" Width="6%"  />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Item Code">
        <ItemTemplate>
        <asp:Label ID="lblCode" runat="server" Text='<%#Eval("ItemCode") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Center" Width="8%"  />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Description">
        <ItemTemplate>
        <asp:Label ID="lblDesc" runat="server" Text='<%#Eval("Description") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Left" Width="20%" />
        </asp:TemplateField>
         <asp:TemplateField HeaderText="UOM">                            
                            <ItemTemplate>
                                    <asp:Label ID="lblUOM" runat="server" Text='<%#Eval("UOM") %>'></asp:Label>
                                </ItemTemplate>
                                <ItemStyle Width="4%" HorizontalAlign="Center"/>
                            </asp:TemplateField>
        <asp:TemplateField HeaderText="Supplier">
        <ItemTemplate>
        <asp:Label ID="lblSupplier" runat="server" Text='<%#Eval("Supplier") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Left" Width="15%" />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="A/c Head">
        <ItemTemplate>
        <asp:Label ID="lblAc" runat="server" Text='<%#Eval("AcHead") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Center" Width="6%" />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="WONo">
        <ItemTemplate>
        <asp:Label ID="lblwono" runat="server" Text='<%#Eval("WONo") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Center" Width="6%"  />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="BG Group">
        <ItemTemplate>
        <asp:Label ID="lblDept" runat="server" Text='<%#Eval("Dept") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Center" Width="6%"  />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Qty">
        <ItemTemplate>
        <asp:Label ID="lblQty" runat="server" Text='<%#Eval("Qty") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Right" Width="7%" />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Rate">
        <ItemTemplate>
        <asp:Label ID="lblrate" runat="server" Text='<%#Eval("Rate") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Right" Width="5%" />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Dis">
        <ItemTemplate>
        <asp:Label ID="lblDiscount" runat="server" Text='<%#Eval("Discount") %>'></asp:Label>
        </ItemTemplate>
            <ItemStyle HorizontalAlign="Right" Width="5%" />
        </asp:TemplateField>
        
        
        
        
        
        <asp:TemplateField HeaderText="Remarks">
        <ItemTemplate>
        <asp:Label ID="lblremark" runat="server" Text='<%#Eval("Remarks") %>'></asp:Label>
        </ItemTemplate>
        
            <ItemStyle HorizontalAlign="Left" Width="20%" />
        </asp:TemplateField>
        <asp:TemplateField HeaderText="Id" SortExpression="Id" Visible="false">
                        <ItemTemplate>
                        <asp:Label ID="lblId" runat="server" Text='<%#Eval("Id") %>'>    </asp:Label>  
                        </ItemTemplate>                       
                        </asp:TemplateField>
        
    </Columns>
</asp:GridView>
</asp:Panel>

       
</td>

</tr>
<tr>
<td align="center"> <asp:Button ID="btncancel" CssClass="redbox"  runat="server" Text="Cancel" 
                    onclick="btncancel_Click" />
        </td>
</tr>
</table>


</asp:Content>
<asp:Content ID="Content8" ContentPlaceHolderID="ContentPlaceHolder4" Runat="Server">
</asp:Content>



=== FILE: /Users/shiv/workspace/syncortext/NewERP/Module/MaterialManagement/Transactions/SPR_Details_Delete.aspx.cs ===

﻿using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using System.Data.SqlClient;

public partial class Module_MaterialManagement_Transactions_SPR_Details_Delete : System.Web.UI.Page
{
    clsFunctions fun = new clsFunctions();   
    string sId = "";
    int CompId = 0;
    string SPRNo = "";
    string MId = "";

    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            SPRNo = Request.QueryString["SPRNo"];
            sId = Session["username"].ToString();
            MId = Request.QueryString["Id"];

            CompId = Convert.ToInt32(Session["compid"]);
            if (!IsPostBack)
            {
                this.LoadData();
            }
        }
        catch (Exception exc)
        {
        }
    }

    public void disableDelete()
    {
        string str = fun.Connection();
        SqlConnection con = new SqlConnection(str);
        foreach (GridViewRow grv in GridView3.Rows)
        {
            string Id = ((Label)grv.FindControl("lblId")).Text;
            string StrSql2 = fun.select("tblMM_PO_Details.Id", "tblMM_PO_Details,tblMM_PO_Master", "tblMM_PO_Details.SPRNo='" + SPRNo + "' AND tblMM_PO_Master.PONo=tblMM_PO_Details.PONo AND tblMM_PO_Master.CompId='" + CompId + "' AND tblMM_PO_Details.SPRId='" + Id + "' AND tblMM_PO_Details.MId=tblMM_PO_Master.Id");

            SqlCommand cmdsupId2 = new SqlCommand(StrSql2, con);
            SqlDataAdapter dasupId2 = new SqlDataAdapter(cmdsupId2);
            DataSet DSSql2 = new DataSet();
            dasupId2.Fill(DSSql2);

            if (DSSql2.Tables[0].Rows.Count > 0)
            {
                ((LinkButton)grv.FindControl("linkBtn")).Visible = false;
                ((Label)grv.FindControl("lblDel")).Visible = true;
            }
            else
            {
                ((LinkButton)grv.FindControl("linkBtn")).Visible = true;
                ((Label)grv.FindControl("lblDel")).Visible = false;
            }
        }
    }

    public void LoadData()
    {

        string str = fun.Connection();
        SqlConnection con = new SqlConnection(str);
        con.Open();
        try
        {

            DataTable dt = new DataTable();

            dt.Columns.Add(new System.Data.DataColumn("SPRNo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("ItemCode", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Description", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Supplier", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("AcHead", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("WONo", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Dept", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Qty", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("Rate", typeof(double)));
            dt.Columns.Add(new System.Data.DataColumn("Remarks", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Id", typeof(int)));
            dt.Columns.Add(new System.Data.DataColumn("UOM", typeof(string)));
            dt.Columns.Add(new System.Data.DataColumn("Discount", typeof(string)));
            DataRow dr;

            string sql = fun.select("tblMM_SPR_Master.SPRNo,tblMM_SPR_Details.Discount,tblMM_SPR_Details.ItemId,tblMM_SPR_Details.SupplierId,tblMM_SPR_Details.AHId,tblMM_SPR_Details.WONo,tblMM_SPR_Details.DeptId,tblMM_SPR_Details.Qty,tblMM_SPR_Details.Rate,tblMM_SPR_Details.Remarks,tblMM_SPR_Details.Id", "tblMM_SPR_Master,tblMM_SPR_Details", "tblMM_SPR_Master.SPRNo='" + SPRNo + "' AND tblMM_SPR_Master.SPRNo=tblMM_SPR_Details.SPRNo AND tblMM_SPR_Master.Id=tblMM_SPR_Details.MId AND tblMM_SPR_Details.MId='" + MId + "' AND tblMM_SPR_Master.CompId='" + CompId + "'");

            SqlCommand cmd = new SqlCommand(sql, con);
            SqlDataAdapter da = new SqlDataAdapter(cmd);
            DataSet DS = new DataSet();
            da.Fill(DS);

            for (int p = 0; p < DS.Tables[0].Rows.Count; p++)
            {
                dr = dt.NewRow();
                dr[0] = DS.Tables[0].Rows[p]["SPRNo"].ToString();

                // For Item Code
                string sql1 = fun.select("ItemCode,ManfDesc,UOMBasic", "tblDG_Item_Master", "Id='" + Convert.ToInt32(DS.Tables[0].Rows[p]["ItemId"]) + "'  AND CompId='" + CompId + "' ");
                SqlCommand cmd1 = new SqlCommand(sql1, con);
                SqlDataAdapter da1 = new SqlDataAdapter(cmd1);
                DataSet DS1 = new DataSet();
                da1.Fill(DS1);
                dr[1] = fun.GetItemCode_PartNo(CompId, Convert.ToInt32(DS.Tables[0].Rows[p]["ItemId"].ToString()));

                dr[2] = DS1.Tables[0].Rows[0]["ManfDesc"].ToString();

                string sqlUOM = fun.select("Symbol", "Unit_Master", "Id='" + DS1.Tables[0].Rows[0]["UOMBasic"].ToString() + "'");
                SqlCommand cmdUOM = new SqlCommand(sqlUOM, con);
                SqlDataAdapter DAUOM = new SqlDataAdapter(cmdUOM);
                DataSet DSUOM = new DataSet();
                DAUOM.Fill(DSUOM);

                if (DSUOM.Tables[0].Rows.Count > 0)
                {
                    dr[11] = DSUOM.Tables[0].Rows[0]["Symbol"].ToString();
                }

                // For Supplier Name
                string sql2 = fun.select("SupplierName", "tblMM_Supplier_master", "SupplierId ='" + DS.Tables[0].Rows[p]["SupplierId"] + "' AND  CompId='" + CompId + "'");

                SqlCommand cmd2 = new SqlCommand(sql2, con);
                SqlDataAdapter da2 = new SqlDataAdapter(cmd2);
                DataSet DS2 = new DataSet();
                da2.Fill(DS2);

                dr[3] = DS2.Tables[0].Rows[0]["SupplierName"].ToString();
   
                // For A/c Head
                string sql3 = fun.select("Symbol AS Head", "AccHead", "Id ='" + Convert.ToInt32(DS.Tables[0].Rows[p]["AHId"]) + "' ");
                SqlCommand cmd3 = new SqlCommand(sql3, con);
                SqlDataAdapter da3 = new SqlDataAdapter(cmd3);
                DataSet DS3 = new DataSet();
                da3.Fill(DS3);
                dr[4] = DS3.Tables[0].Rows[0]["Head"].ToString();
                dr[5] = DS.Tables[0].Rows[p]["WONo"].ToString();

                // For Dept. Name 
                string sql5 = fun.select("Symbol AS Dept", "BusinessGroup", "Id ='" + Convert.ToInt32(DS.Tables[0].Rows[p]["DeptId"]) + "'");

                SqlCommand cmd5 = new SqlCommand(sql5, con);
                SqlDataAdapter da5 = new SqlDataAdapter(cmd5);
                DataSet DS5 = new DataSet();
                da5.Fill(DS5);

                if (DS5.Tables[0].Rows.Count > 0)
                {
                    dr[6] = DS5.Tables[0].Rows[0]["Dept"].ToString();
                }

                dr[7] = decimal.Parse(DS.Tables[0].Rows[p]["Qty"].ToString()).ToString("N3");
                dr[8] = DS.Tables[0].Rows[p]["Rate"].ToString();
                dr[9] = DS.Tables[0].Rows[p]["Remarks"].ToString();
                dr[10] = DS.Tables[0].Rows[p]["Id"].ToString();
                dr[12] = DS.Tables[0].Rows[p]["Discount"].ToString();
                dt.Rows.Add(dr);
            }

            dt.AcceptChanges();
            GridView3.DataSource = dt;
            GridView3.DataBind();
            this.disableDelete();
        }
        catch(Exception ex){}

    }

    protected void GridView3_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        GridView3.PageIndex = e.NewPageIndex;
        this.LoadData();
    }
    protected void GridView3_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        string str = fun.Connection();
        SqlConnection con = new SqlConnection(str);
        try
        {
            if (e.CommandName == "delete")
            {
                con.Open();

                GridViewRow row = (GridViewRow)(((LinkButton)e.CommandSource).NamingContainer);
                int id = Convert.ToInt32(((Label)row.FindControl("lblId")).Text);
                sId = Session["username"].ToString();
                CompId = Convert.ToInt32(Session["compid"]);

                string sql = fun.delete("tblMM_SPR_Details", "Id='" + id + "'");
                SqlCommand cmd = new SqlCommand(sql, con);
                cmd.ExecuteNonQuery();

                string Strdel = fun.select("*", "tblMM_SPR_Details", "MId='" + MId + "'");
                SqlCommand cmddel = new SqlCommand(Strdel, con);
                SqlDataAdapter dadel = new SqlDataAdapter(cmddel);
                DataSet DSdel = new DataSet();
                dadel.Fill(DSdel);

                if (DSdel.Tables[0].Rows.Count == 0)
                {
                    string sqlDelM = fun.delete("tblMM_SPR_Master", "SPRNo='" + SPRNo + "' AND Id='" + MId + "' AND CompId='" + CompId + "' ");
                    SqlCommand cmdDelM = new SqlCommand(sqlDelM, con);
                    cmdDelM.ExecuteNonQuery();
                    Response.Redirect("SPR_Delete.aspx?ModId=6&SubModId=31");
                }
                this.LoadData();
                
            }

            
        }
        catch (Exception ex) { }
        finally
        {
            con.Close();
        }

    }


    protected void GridView3_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {

    }
    protected void btncancel_Click(object sender, EventArgs e)
    {
        
            Response.Redirect("SPR_Delete.aspx?ModId=6&SubModId=31");
        
    }
}